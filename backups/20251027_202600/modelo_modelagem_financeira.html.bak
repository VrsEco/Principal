{% extends "base.html" %}
{% block title %}Modelagem Financeira | Implantacao{% endblock %}
{% block body %}{{ super() }}{% endblock %}

{% block header_actions %}
  <div class="header-nav">
    <a href="/main" class="nav-link">Ecossistema</a>
    <a href="{{ url_for('pev.pev_dashboard') }}" class="nav-link active">PEV</a>
    <a href="{{ url_for('grv.grv_dashboard') }}" class="nav-link">GRV</a>
  </div>
  <div class="user-pill">
    <span class="user-name">{{ user_name | default('Fabiano Ferreira') }}</span>
  </div>
  <div class="header-nav">
    <select id="themeSelect" class="nav-link" style="padding:8px 12px; color:#64748b;">
      <option value="versus">Tema Versus</option>
      <option value="alt">Tema Azul/Branco/Amarelo</option>
    </select>
  </div>
{% endblock %}

{% block content %}
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
      color: #0f172a !important;
    }

    .finance-wrapper {
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .finance-card {
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
      backdrop-filter: blur(12px);
      padding: 32px;
    }

    .finance-card h1,
    .finance-card h2 {
      margin: 0 0 16px;
      color: #0f172a;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .btn-add {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-add:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      color: #64748b;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .btn-icon.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    table.finance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: #475569;
    }

    table.finance-table th,
    table.finance-table td {
      border: 1px solid rgba(148, 163, 184, 0.28);
      padding: 12px 14px;
      vertical-align: top;
      text-align: left;
    }

    table.finance-table thead tr {
      background: rgba(59, 130, 246, 0.12);
    }

    table.finance-table th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #1d4ed8;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .info-box {
      background: rgba(248, 250, 252, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 16px;
      padding: 16px;
      font-size: 13px;
      color: #475569;
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .analysis-card {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.28);
      border-radius: 16px;
      padding: 18px;
      color: #166534;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }

    .capacity-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 18px;
    }

    .capacity-chip {
      background: rgba(148, 163, 184, 0.08);
      border: 1px dashed rgba(148, 163, 184, 0.45);
      border-radius: 12px;
      padding: 12px 16px;
      min-width: 190px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #64748b;
    }

    .capacity-chip span {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(100, 116, 139, 0.85);
    }

    .capacity-chip strong {
      font-size: 16px;
      font-weight: 500;
      color: #475569;
    }

    .capacity-chip.capacity-chip--complementary {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.3);
      border-style: dotted;
      color: #94a3b8;
    }

    .capacity-chip.capacity-chip--complementary span {
      color: rgba(148, 163, 184, 0.8);
    }

    .capacity-chip.capacity-chip--complementary strong {
      font-size: 15px;
      font-weight: 500;
      color: #64748b;
    }

    .section-note {
      font-size: 12px;
      color: #64748b;
      margin-top: 12px;
    }

    /* Modal Styles - Padr√£o PFPN (Centralizado no Topo) */
    .modal {
      display: none;
      position: fixed;
      z-index: 999999 !important;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .modal.show {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 1000000 !important;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px 16px 0 0;
      background: rgba(248, 250, 252, 0.5);
    }

    .modal-header h3 {
      margin: 0;
      color: #0f172a;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-body {
      padding: 24px;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: #0f172a;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #0f172a;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    @media (max-width: 768px) {
      .finance-wrapper {
        padding: 20px;
      }

      .finance-card {
        padding: 24px;
      }

      table.finance-table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>

  <section class="finance-wrapper">
    <!-- Header -->
    <article class="finance-card">
      <h1>Modelagem financeira do planejamento</h1>
      <p style="margin:12px 0 0; color:#475569; line-height:1.6;">
        Premissas e demonstrativos base para conectar estrutura operacional, investimentos e retorno dos s√≥cios.
        Gerencie os dados financeiros do seu planejamento de forma interativa.
      </p>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.history.back()">‚Üê Voltar</button>
      </div>
    </article>



    <!-- CAPACIDADES OPERACIONAIS -->
    <article class="finance-card" id="capacities-section">
      <div class="section-header">
        <h2>Capacidade operacional suportada</h2>
        <a
          class="btn btn-secondary"
          href="{{ url_for('pev.implantacao_estruturas') }}?plan_id={{ plan_id }}"
          style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;"
        >
          Atualizar nas Estruturas
        </a>
      </div>

      <table class="finance-table">
        <thead>
          <tr>
            <th>Area</th>
            <th>Faturamento suportado</th>
            <th>Observacoes</th>
          </tr>
        </thead>
        <tbody>
          {%- if capacidades -%}
            {%- for item in capacidades -%}
              <tr>
                <td>{{ item.area }}</td>
                <td>{{ item.valor_formatado or item.valor or '-' }}</td>
                <td>{{ item.observacoes or '-' }}</td>
              </tr>
            {%- endfor -%}
          {%- else -%}
            <tr>
              <td colspan="3" style="text-align:center; color:#64748b;">Nenhuma capacidade registrada nas estruturas.</td>
            </tr>
          {%- endif -%}
        </tbody>
      </table>

      <div class="capacity-summary" style="margin-top: 16px;">
        <div class="capacity-chip capacity-chip--complementary" aria-live="polite">
          <span>Gargalo atual</span>
          {%- if resumo_capacidades.gargalo_valor_formatado -%}
            <strong>{{ resumo_capacidades.gargalo_valor_formatado }}{{ ' (' + resumo_capacidades.gargalo_area + ')' if resumo_capacidades.gargalo_area else '' }}</strong>
          {%- else -%}
            <strong>-</strong>
          {%- endif -%}
        </div>
      </div>
      <p class="section-note">
        Dados sincronizados com a etapa de <a href="{{ url_for('pev.implantacao_estruturas') }}?plan_id={{ plan_id }}">Estruturas de execucao</a>. Ajuste por la para refletir novos limites operacionais.
      </p>
    </article>
    <!-- PREMISSAS -->
    <article class="finance-card" id="premissas-section">
      <div class="section-header">
        <h2>Premissas</h2>
        <button class="btn-add" onclick="openPremiseModal()">
          <span>+</span>
          <span>Adicionar Premissa</span>
        </button>
      </div>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Sugest√£o do sistema</th>
            <th>Valor ajustado</th>
            <th>Observa√ß√µes</th>
            <th>Mem√≥ria de c√°lculo</th>
            <th style="width: 100px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="premises-tbody">
          {% for item in premissas %}
            <tr data-id="{{ item.id }}">
              <td>{{ item.indicador }}</td>
              <td>{{ item.sugestao }}</td>
              <td>{{ item.ajustado }}</td>
              <td>{{ item.observacoes }}</td>
              <td>{{ item.memoria }}</td>
              <td>
                <button class="btn-icon" onclick="editPremise({{ item.id }})" title="Editar">‚úèÔ∏è</button>
                <button class="btn-icon delete" onclick="deletePremise({{ item.id }})" title="Deletar">üóëÔ∏è</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="section-note">
        * Ajuste valores e insira coment√°rios conforme necess√°rio.
      </p>
    </article>

    <!-- MARGEM DE CONTRIBUI√á√ÉO E DESTINA√á√ÉO DE RESULTADOS -->
    <article class="finance-card">
      <h2>Margem de Contribui√ß√£o e Destina√ß√£o de Resultados</h2>
      <div class="grid-two">
        <!-- Margem de Contribui√ß√£o -->
        <div id="variable-costs-section">
          <div class="section-header" style="margin-bottom: 12px;">
            <h3 style="margin:0;">Margem de Contribui√ß√£o</h3>
            <button class="btn-add" onclick="openVariableCostModal()" style="padding: 6px 12px; font-size: 13px;">
              <span>+</span>
            </button>
          </div>
          
          <!-- Card de Totalizados de Produtos e Margens -->
          <div id="products-summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 16px; margin-bottom: 16px; color: white;">
            <div style="font-size: 12px; font-weight: 500; opacity: 0.9; margin-bottom: 12px;">
              üìä Totalizados de Modelo e Mercado ‚Üí Produtos e Margens
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <!-- Faturamento -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Faturamento</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-revenue-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-revenue-percent">100%</div>
              </div>
              
              <!-- Custos Vari√°veis -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Custos Vari√°veis</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-costs-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-costs-percent">0%</div>
              </div>
              
              <!-- Despesas Vari√°veis -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Despesas Vari√°veis</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-expenses-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-expenses-percent">0%</div>
              </div>
              
              <!-- Margem de Contribui√ß√£o -->
              <div style="background: rgba(255, 255, 255, 0.25); border-radius: 8px; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">üí∞ Margem de Contribui√ß√£o</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-margin-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-margin-percent">0%</div>
              </div>
            </div>
            
            <div style="margin-top: 12px; font-size: 11px; opacity: 0.8; text-align: center;">
              ‚ÑπÔ∏è Valores calculados com base nas metas de market share dos produtos cadastrados
            </div>
          </div>
          
          <table class="finance-table">
            <thead>
              <tr>
                <th>Descri√ß√£o</th>
                <th>% sobre faturamento</th>
                <th style="width: 80px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="variable-costs-tbody">
              {% for item in fluxo_negocio.variaveis %}
                <tr data-id="{{ item.id }}">
                  <td>{{ item.descricao }}</td>
                  <td>{{ item.percentual }}</td>
                  <td>
                    <button class="btn-icon" onclick="editVariableCost({{ item.id }})" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-icon delete" onclick="deleteVariableCost({{ item.id }})" title="Deletar">üóëÔ∏è</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Distribui√ß√£o de Lucros e outras Destina√ß√µes -->
        <div id="profit-distribution-section">
          <div class="section-header" style="margin-bottom: 12px;">
            <h3 style="margin:0;">Distribui√ß√£o de Lucros e outras Destina√ß√µes de Resultados</h3>
          </div>

          <!-- Campo Fixo: Distribui√ß√£o de Lucros -->
          <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <strong style="color: #1e40af;">Distribui√ß√£o de Lucros</strong>
              <button class="btn-icon" onclick="openProfitDistributionModal()" title="Editar">‚úèÔ∏è</button>
            </div>
            <div style="font-size: 13px; color: #475569;">
              <span style="font-weight: 500;">% sobre resultado operacional:</span>
              <span id="profit-distribution-percentage" style="font-weight: 600; color: #1e40af; margin-left: 8px;">
                {{ fluxo_negocio.distribuicao_lucros.percentual or '-' }}
              </span>
            </div>
            {% if fluxo_negocio.distribuicao_lucros.observacoes %}
              <div style="margin-top: 8px; font-size: 12px; color: #64748b; font-style: italic;">
                {{ fluxo_negocio.distribuicao_lucros.observacoes }}
              </div>
            {% endif %}
          </div>

          <!-- Outras Destina√ß√µes (Cadastro Livre) -->
          <div>
            <div class="section-header" style="margin-bottom: 12px;">
              <h4 style="margin:0; font-size: 14px; color: #64748b;">Outras Destina√ß√µes</h4>
              <button class="btn-add" onclick="openResultRuleModal()" style="padding: 6px 12px; font-size: 13px;">
                <span>+</span>
              </button>
            </div>
            <table class="finance-table">
              <thead>
                <tr>
                  <th>Descri√ß√£o</th>
                  <th>% sobre resultado operacional</th>
                  <th style="width: 80px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="result-rules-tbody">
                {% for item in fluxo_negocio.destinacao_regras %}
                  <tr data-id="{{ item.id }}">
                    <td>{{ item.descricao }}</td>
                    <td>{{ item.percentual }}</td>
                    <td>
                      <button class="btn-icon" onclick="editResultRule({{ item.id }})" title="Editar">‚úèÔ∏è</button>
                      <button class="btn-icon delete" onclick="deleteResultRule({{ item.id }})" title="Deletar">üóëÔ∏è</button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </article>

    <!-- INVESTIMENTOS COM DATAS -->
    <article class="finance-card">
      <div class="section-header">
        <h2>Investimentos com Datas de Aporte</h2>
        <button class="btn-add" onclick="openContributionModal()">
          <span>+</span>
          <span>Adicionar Aporte</span>
        </button>
      </div>
      
      <div class="grid-two">
        <!-- Capital de Giro -->
        <div>
          <h3 style="margin:12px 0 8px; color:#0f172a; font-size:16px;">Capital de Giro</h3>
          <table class="finance-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Total</th>
                <th>Aportes</th>
              </tr>
            </thead>
            <tbody id="capital-giro-tbody">
              <tr>
                <td>Caixa</td>
                <td id="caixa-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('caixa')" title="Gerenciar">üìã</button>
                </td>
              </tr>
              <tr>
                <td>Receb√≠veis</td>
                <td id="recebiveis-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('recebiveis')" title="Gerenciar">üìã</button>
                </td>
              </tr>
              <tr>
                <td>Estoques</td>
                <td id="estoques-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('estoques')" title="Gerenciar">üìã</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Imobilizado -->
        <div>
          <h3 style="margin:12px 0 8px; color:#0f172a; font-size:16px;">Imobilizado</h3>
          <table class="finance-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Total</th>
                <th>Aportes</th>
              </tr>
            </thead>
            <tbody id="imobilizado-tbody">
              <tr>
                <td>Instala√ß√µes</td>
                <td id="instalacoes-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('instalacoes')" title="Gerenciar">üìã</button>
                </td>
              </tr>
              <tr>
                <td>M√°quinas e Equipamentos</td>
                <td id="maquinas-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('maquinas')" title="Gerenciar">üìã</button>
                </td>
              </tr>
              <tr>
                <td>Outros Investimentos</td>
                <td id="outros-total">R$ 0,00</td>
                <td>
                  <button class="btn-icon" onclick="manageContributions('outros')" title="Gerenciar">üìã</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div style="margin-top: 24px;">
        <h3 style="margin:0 0 16px; color:#0f172a; font-size:16px;">Planilha por Per√≠odo</h3>
        <div style="overflow-x: auto;">
          <table class="finance-table" id="investments-spreadsheet">
            <thead>
              <tr>
                <th rowspan="2">Categoria</th>
                <th rowspan="2">Item</th>
                <th rowspan="2">Total</th>
                <th colspan="12">Per√≠odos</th>
              </tr>
              <tr id="month-headers">
                <!-- Headers ser√£o preenchidos via JavaScript -->
              </tr>
            </thead>
            <tbody id="spreadsheet-tbody">
              <!-- Linhas ser√£o preenchidas via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </article>

    <!-- FONTES DE RECURSOS -->
    <article class="finance-card">
      <div class="section-header">
        <h2>Fontes de Recursos</h2>
        <button class="btn-add" onclick="openFundingSourceModal()">
          <span>+</span>
          <span>Adicionar Fonte</span>
        </button>
      </div>
      
      <table class="finance-table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Data</th>
            <th>Valor</th>
            <th>Observa√ß√µes</th>
            <th style="width: 80px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="funding-sources-tbody">
          <!-- Ser√° preenchido via JavaScript -->
        </tbody>
      </table>
    </article>

    <!-- M√âTRICAS -->
    <article class="finance-card">
      <div class="section-header">
        <h2>An√°lise de Viabilidade</h2>
        <button class="btn-add" onclick="openMetricsModal()">
          <span>‚úèÔ∏è</span>
          <span>Editar M√©tricas</span>
        </button>
      </div>
      <div class="analysis-grid" id="metrics-section">
        <div class="analysis-card">
          <strong>Payback</strong>
          <span id="metric-payback">{{ fluxo_investidor.analises.payback or 'N√£o definido' }}</span>
        </div>
        <div class="analysis-card">
          <strong>TIR 5 anos</strong>
          <span id="metric-tir">{{ fluxo_investidor.analises.tir_5_anos or 'N√£o definido' }}</span>
        </div>
        <div class="analysis-card" style="grid-column: span 2;">
          <strong>Coment√°rios</strong>
          <span id="metric-notes">{{ fluxo_investidor.analises.comentarios or 'Sem coment√°rios' }}</span>
        </div>
      </div>
    </article>

    <!-- FLUXO DE CAIXA DO NEG√ìCIO (Read-only) -->
    <article class="finance-card">
      <h2>Fluxo de caixa do neg√≥cio</h2>
      <p class="section-note" style="margin-top: 0;">
        * Esta se√ß√£o √© calculada automaticamente com base nos dados inseridos acima.
      </p>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Per√≠odo</th>
            <th>Receita</th>
            <th>Vari√°veis</th>
            <th>Margem de contribui√ß√£o</th>
            <th>Fixos</th>
            <th>Resultado operacional</th>
            <th>Destina√ß√£o de resultados</th>
            <th>Resultado do per√≠odo</th>
          </tr>
        </thead>
        <tbody>
          {% for linha in fluxo_negocio.periodos %}
            <tr>
              <td>{{ linha.periodo }}</td>
              <td>{{ linha.receita }}</td>
              <td>{{ linha.variaveis }}</td>
              <td>{{ linha.margem_contribuicao }}</td>
              <td>{{ linha.fixos }}</td>
              <td>{{ linha.resultado_operacional }}</td>
              <td>
                <ul style="margin:0; padding-left:18px;">
                  {% for destino in linha.destinacao %}
                    <li>{{ destino.descricao }} ‚Äì {{ destino.valor }}</li>
                  {% endfor %}
                </ul>
              </td>
              <td>{{ linha.resultado_periodo }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>

    <!-- FLUXO DE CAIXA DO INVESTIDOR (Read-only) -->
    <article class="finance-card">
      <h2>Fluxo de caixa do investidor</h2>
      <p class="section-note" style="margin-top: 0;">
        * Esta se√ß√£o √© calculada automaticamente com base nos dados inseridos acima.
      </p>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Per√≠odo</th>
            <th>Aporte / Investimento</th>
            <th>Distribui√ß√£o de lucros</th>
            <th>Saldo do per√≠odo</th>
            <th>Saldo acumulado</th>
          </tr>
        </thead>
        <tbody>
          {% for linha in fluxo_investidor.periodos %}
            <tr>
              <td>{{ linha.periodo }}</td>
              <td>{{ linha.aporte }}</td>
              <td>{{ linha.distribuicao }}</td>
              <td>{{ linha.saldo }}</td>
              <td>{{ linha.acumulado }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>
  </section>

  <!-- MODALS -->
  
  <!-- Modal Premissa -->
  <div class="modal" id="premiseModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="premiseModalTitle">Adicionar Premissa</h3>
        <button class="btn-close" onclick="closePremiseModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="premiseForm">
          <input type="hidden" id="premiseId">
          <div class="form-group">
            <label for="premiseDescription">Descri√ß√£o *</label>
            <input type="text" id="premiseDescription" required>
          </div>
          <div class="form-group">
            <label for="premiseSuggestion">Sugest√£o do sistema</label>
            <input type="text" id="premiseSuggestion">
          </div>
          <div class="form-group">
            <label for="premiseAdjusted">Valor ajustado</label>
            <input type="text" id="premiseAdjusted">
          </div>
          <div class="form-group">
            <label for="premiseObservations">Observa√ß√µes</label>
            <textarea id="premiseObservations"></textarea>
          </div>
          <div class="form-group">
            <label for="premiseMemory">Mem√≥ria de c√°lculo</label>
            <textarea id="premiseMemory"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePremiseModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Custo Vari√°vel -->
  <div class="modal" id="variableCostModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="variableCostModalTitle">Adicionar Custo Vari√°vel</h3>
        <button class="btn-close" onclick="closeVariableCostModal()">√ó</button>
      </div>
      <form id="variableCostForm">
        <input type="hidden" id="variableCostId">
        <div class="form-group">
          <label for="variableCostDescription">Descri√ß√£o *</label>
          <input type="text" id="variableCostDescription" required>
        </div>
        <div class="form-group">
          <label for="variableCostPercentage">Percentual</label>
          <input type="text" id="variableCostPercentage" placeholder="Ex: 15%">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeVariableCostModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Outras Destina√ß√µes -->
  <div class="modal" id="resultRuleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="resultRuleModalTitle">Adicionar Outra Destina√ß√£o</h3>
        <button class="btn-close" onclick="closeResultRuleModal()">√ó</button>
      </div>
      <form id="resultRuleForm">
        <input type="hidden" id="resultRuleId">
        <div class="form-group">
          <label for="resultRuleDescription">Descri√ß√£o *</label>
          <input type="text" id="resultRuleDescription" required placeholder="Ex: Reserva de Conting√™ncia, Fundo de Investimento">
        </div>
        <div class="form-group">
          <label for="resultRulePercentage">% sobre resultado operacional *</label>
          <input type="text" id="resultRulePercentage" required placeholder="Ex: 15%">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeResultRuleModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Distribui√ß√£o de Lucros -->
  <div class="modal" id="profitDistributionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Distribui√ß√£o de Lucros</h3>
        <button class="btn-close" onclick="closeProfitDistributionModal()">√ó</button>
      </div>
      <form id="profitDistributionForm">
        <div class="form-group">
          <label for="profitDistributionPercentage">% sobre resultado operacional *</label>
          <input type="text" id="profitDistributionPercentage" required placeholder="Ex: 40%">
        </div>
        <div class="form-group">
          <label for="profitDistributionNotes">Observa√ß√µes</label>
          <textarea id="profitDistributionNotes" rows="3" placeholder="Ex: Distribui√ß√£o mensal aos s√≥cios"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeProfitDistributionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal M√©tricas -->
  <div class="modal" id="metricsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar M√©tricas</h3>
        <button class="btn-close" onclick="closeMetricsModal()">√ó</button>
      </div>
      <form id="metricsForm">
        <div class="form-group">
          <label for="metricPayback">Payback</label>
          <input type="text" id="metricPayback" placeholder="Ex: 18 meses">
        </div>
        <div class="form-group">
          <label for="metricTir">TIR 5 anos</label>
          <input type="text" id="metricTir" placeholder="Ex: 24%">
        </div>
        <div class="form-group">
          <label for="metricNotes">Coment√°rios</label>
          <textarea id="metricNotes" rows="4"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeMetricsModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Aporte de Investimento -->
  <div class="modal" id="contributionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="contributionModalTitle">Adicionar Aporte</h3>
        <button class="btn-close" onclick="closeContributionModal()">√ó</button>
      </div>
      <form id="contributionForm">
        <input type="hidden" id="contributionId">
        <div class="form-group">
          <label for="contributionItemId">Tipo de Investimento *</label>
          <select id="contributionItemId" required>
            <option value="">Selecione...</option>
            <optgroup label="Capital de Giro">
              <option value="1">Caixa</option>
              <option value="2">Receb√≠veis</option>
              <option value="3">Estoques</option>
            </optgroup>
            <optgroup label="Imobilizado">
              <option value="4">Instala√ß√µes</option>
              <option value="5">M√°quinas e Equipamentos</option>
              <option value="6">Outros Investimentos</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="contributionDate">Data do Aporte *</label>
          <input type="date" id="contributionDate" required>
        </div>
        <div class="form-group">
          <label for="contributionAmount">Valor *</label>
          <input type="number" id="contributionAmount" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="contributionNotes">Observa√ß√µes</label>
          <textarea id="contributionNotes" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeContributionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Fonte de Recursos -->
  <div class="modal" id="fundingSourceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="fundingSourceModalTitle">Adicionar Fonte de Recursos</h3>
        <button class="btn-close" onclick="closeFundingSourceModal()">√ó</button>
      </div>
      <form id="fundingSourceForm">
        <input type="hidden" id="fundingSourceId">
        <div class="form-group">
          <label for="fundingSourceType">Tipo *</label>
          <select id="fundingSourceType" required>
            <option value="">Selecione...</option>
            <option value="Fornecedores">Fornecedores</option>
            <option value="Empr√©stimos e Financiamentos">Empr√©stimos e Financiamentos</option>
            <option value="Aporte dos S√≥cios">Aporte dos S√≥cios</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fundingSourceDate">Data do Aporte *</label>
          <input type="date" id="fundingSourceDate" required>
        </div>
        <div class="form-group">
          <label for="fundingSourceAmount">Valor *</label>
          <input type="number" id="fundingSourceAmount" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="fundingSourceNotes">Observa√ß√µes</label>
          <textarea id="fundingSourceNotes" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeFundingSourceModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Debug: Log para verificar se o script est√° carregando
    console.log('üîµ Script de Modelagem Financeira carregado!');
    
    // Global variables
    const urlParams = new URLSearchParams(window.location.search);
    const planId = urlParams.get('plan_id');
    
    console.log('üîµ plan_id:', planId);
    
    // Parse data with safety checks
    let premisesData = {{ premissas | tojson | safe }};
    let variableCostsData = {{ fluxo_negocio.variaveis | tojson | safe }};
    let resultRulesData = {{ fluxo_negocio.destinacao_regras | tojson | safe }};
    let metricsData = {{ fluxo_investidor.analises | tojson | safe }};
    let profitDistributionData = {{ fluxo_negocio.distribuicao_lucros | tojson | safe }};
    
    console.log('üîµ Dados carregados:', {
      premissas: premisesData.length,
      custos: variableCostsData.length,
      regras: resultRulesData.length,
      distribuicao_lucros: profitDistributionData
    });

    // ==================== TOTALIZADOS DE PRODUTOS ====================
    async function loadProductsTotals() {
      console.log('üü¢ Carregando totalizados de produtos...');
      
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/products/totals`);
        const result = await response.json();
        
        if (result.success && result.totals) {
          const totals = result.totals;
          
          // Atualizar Faturamento
          document.getElementById('products-revenue-value').textContent = 
            formatCurrency(totals.faturamento.valor);
          document.getElementById('products-revenue-percent').textContent = 
            `${totals.faturamento.percentual.toFixed(1)}%`;
          
          // Atualizar Custos Vari√°veis
          document.getElementById('products-costs-value').textContent = 
            formatCurrency(totals.custos_variaveis.valor);
          document.getElementById('products-costs-percent').textContent = 
            `${totals.custos_variaveis.percentual.toFixed(1)}%`;
          
          // Atualizar Despesas Vari√°veis
          document.getElementById('products-expenses-value').textContent = 
            formatCurrency(totals.despesas_variaveis.valor);
          document.getElementById('products-expenses-percent').textContent = 
            `${totals.despesas_variaveis.percentual.toFixed(1)}%`;
          
          // Atualizar Margem de Contribui√ß√£o
          document.getElementById('products-margin-value').textContent = 
            formatCurrency(totals.margem_contribuicao.valor);
          document.getElementById('products-margin-percent').textContent = 
            `${totals.margem_contribuicao.percentual.toFixed(1)}%`;
          
          console.log('‚úÖ Totalizados carregados:', totals);
        } else {
          console.error('‚ùå Erro ao carregar totalizados:', result.error);
        }
      } catch (error) {
        console.error('‚ùå Erro ao buscar totalizados:', error);
      }
    }
    
    // Helper para formatar moeda
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    // Carregar totalizados ao iniciar
    if (planId) {
      loadProductsTotals();
    }

    // ==================== PREMISSAS ====================
    function openPremiseModal(premiseId = null) {
      console.log('üü¢ openPremiseModal chamado! premiseId:', premiseId);
      
      const modal = document.getElementById('premiseModal');
      const form = document.getElementById('premiseForm');
      const title = document.getElementById('premiseModalTitle');
      
      console.log('üü¢ Modal encontrado:', modal ? 'SIM' : 'N√ÉO');
      
      if (!modal) {
        console.error('‚ùå Modal n√£o encontrado! Abortando.');
        return;
      }
      
      if (premiseId) {
        const premise = premisesData.find(p => p.id === premiseId);
        if (premise) {
          title.textContent = 'Editar Premissa';
          document.getElementById('premiseId').value = premise.id;
          document.getElementById('premiseDescription').value = premise.indicador || '';
          document.getElementById('premiseSuggestion').value = premise.sugestao || '';
          document.getElementById('premiseAdjusted').value = premise.ajustado || '';
          document.getElementById('premiseObservations').value = premise.observacoes || '';
          document.getElementById('premiseMemory').value = premise.memoria || '';
        }
      } else {
        title.textContent = 'Adicionar Premissa';
        form.reset();
      }
      
      // Padr√£o PFPN: display block + classe show
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
      console.log('üü¢ Modal aberto com padr√£o PFPN');
    }

    function closePremiseModal() {
      const modal = document.getElementById('premiseModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('premiseForm').reset();
    }

    document.getElementById('premiseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const premiseId = document.getElementById('premiseId').value;
      const data = {
        description: document.getElementById('premiseDescription').value,
        suggestion: document.getElementById('premiseSuggestion').value,
        adjusted: document.getElementById('premiseAdjusted').value,
        observations: document.getElementById('premiseObservations').value,
        memory: document.getElementById('premiseMemory').value
      };

      console.log('üì§ Enviando dados:', data);
      console.log('üì§ URL:', `/pev/api/implantacao/${planId}/finance/premises`);

      try {
        let response;
        if (premiseId) {
          console.log('üìù Modo: EDITAR (PUT)');
          response = await fetch(`/pev/api/implantacao/${planId}/finance/premises/${premiseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          console.log('üìù Modo: CRIAR (POST)');
          response = await fetch(`/pev/api/implantacao/${planId}/finance/premises`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        console.log('üì• Response status:', response.status);
        const responseData = await response.json();
        console.log('üì• Response data:', responseData);

        if (response.ok) {
          alert('Premissa salva com sucesso!');
          closePremiseModal();
          location.reload();
        } else {
          console.error('‚ùå Erro do servidor:', responseData);
          alert(`Erro ao salvar premissa: ${responseData.error || 'Erro desconhecido'}`);
        }
      } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        alert(`Erro ao salvar premissa: ${error.message}`);
      }
    });

    function editPremise(id) {
      openPremiseModal(id);
    }

    async function deletePremise(id) {
      if (!confirm('Tem certeza que deseja deletar esta premissa?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/premises/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Premissa deletada com sucesso!');
          location.reload();
        } else {
          alert('Erro ao deletar premissa');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar premissa');
      }
    }

    // ==================== CUSTOS VARI√ÅVEIS ====================
    function openVariableCostModal(costId = null) {
      const modal = document.getElementById('variableCostModal');
      const form = document.getElementById('variableCostForm');
      const title = document.getElementById('variableCostModalTitle');
      
      if (costId) {
        const cost = variableCostsData.find(c => c.id === costId);
        if (cost) {
          title.textContent = 'Editar Custo Vari√°vel';
          document.getElementById('variableCostId').value = cost.id;
          document.getElementById('variableCostDescription').value = cost.descricao || '';
          document.getElementById('variableCostPercentage').value = cost.percentual || '';
        }
      } else {
        title.textContent = 'Adicionar Custo Vari√°vel';
        form.reset();
      }
      
      // Padr√£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeVariableCostModal() {
      const modal = document.getElementById('variableCostModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('variableCostForm').reset();
    }

    document.getElementById('variableCostForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const costId = document.getElementById('variableCostId').value;
      const data = {
        description: document.getElementById('variableCostDescription').value,
        percentage: document.getElementById('variableCostPercentage').value
      };

      try {
        let response;
        if (costId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs/${costId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Custo vari√°vel salvo com sucesso!');
          closeVariableCostModal();
          location.reload();
        } else {
          alert('Erro ao salvar custo vari√°vel');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar custo vari√°vel');
      }
    });

    function editVariableCost(id) {
      openVariableCostModal(id);
    }

    async function deleteVariableCost(id) {
      if (!confirm('Tem certeza que deseja deletar este custo vari√°vel?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Custo vari√°vel deletado com sucesso!');
          location.reload();
        } else {
          alert('Erro ao deletar custo vari√°vel');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar custo vari√°vel');
      }
    }

    // ==================== OUTRAS DESTINA√á√ïES ====================
    function openResultRuleModal(ruleId = null) {
      const modal = document.getElementById('resultRuleModal');
      const form = document.getElementById('resultRuleForm');
      const title = document.getElementById('resultRuleModalTitle');
      
      if (ruleId) {
        const rule = resultRulesData.find(r => r.id === ruleId);
        if (rule) {
          title.textContent = 'Editar Outra Destina√ß√£o';
          document.getElementById('resultRuleId').value = rule.id;
          document.getElementById('resultRuleDescription').value = rule.descricao || '';
          document.getElementById('resultRulePercentage').value = rule.percentual || '';
        }
      } else {
        title.textContent = 'Adicionar Outra Destina√ß√£o';
        form.reset();
      }
      
      // Padr√£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeResultRuleModal() {
      const modal = document.getElementById('resultRuleModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('resultRuleForm').reset();
    }

    document.getElementById('resultRuleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const ruleId = document.getElementById('resultRuleId').value;
      const data = {
        description: document.getElementById('resultRuleDescription').value,
        percentage: document.getElementById('resultRulePercentage').value,
        periodicity: ''  // N√£o usamos mais periodicidade
      };

      try {
        let response;
        if (ruleId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules/${ruleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Destina√ß√£o salva com sucesso!');
          closeResultRuleModal();
          location.reload();
        } else {
          alert('Erro ao salvar destina√ß√£o');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar destina√ß√£o');
      }
    });

    function editResultRule(id) {
      openResultRuleModal(id);
    }

    async function deleteResultRule(id) {
      if (!confirm('Tem certeza que deseja deletar esta destina√ß√£o?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Destina√ß√£o deletada com sucesso!');
          location.reload();
        } else {
          alert('Erro ao deletar destina√ß√£o');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar destina√ß√£o');
      }
    }

    // ==================== DISTRIBUI√á√ÉO DE LUCROS ====================
    function openProfitDistributionModal() {
      const modal = document.getElementById('profitDistributionModal');
      
      document.getElementById('profitDistributionPercentage').value = profitDistributionData.percentual || '';
      document.getElementById('profitDistributionNotes').value = profitDistributionData.observacoes || '';
      
      // Padr√£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeProfitDistributionModal() {
      const modal = document.getElementById('profitDistributionModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('profitDistributionForm').reset();
    }

    document.getElementById('profitDistributionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        percentage: document.getElementById('profitDistributionPercentage').value,
        notes: document.getElementById('profitDistributionNotes').value
      };

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/profit_distribution`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Distribui√ß√£o de lucros atualizada com sucesso!');
          closeProfitDistributionModal();
          location.reload();
        } else {
          alert('Erro ao atualizar distribui√ß√£o de lucros');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao atualizar distribui√ß√£o de lucros');
      }
    });

    // ==================== M√âTRICAS ====================
    function openMetricsModal() {
      const modal = document.getElementById('metricsModal');
      
      document.getElementById('metricPayback').value = metricsData.payback || '';
      document.getElementById('metricTir').value = metricsData.tir_5_anos || '';
      document.getElementById('metricNotes').value = metricsData.comentarios || '';
      
      // Padr√£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeMetricsModal() {
      const modal = document.getElementById('metricsModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('metricsForm').reset();
    }

    document.getElementById('metricsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        payback: document.getElementById('metricPayback').value,
        tir: document.getElementById('metricTir').value,
        notes: document.getElementById('metricNotes').value
      };

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/metrics`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('M√©tricas atualizadas com sucesso!');
          closeMetricsModal();
          location.reload();
        } else {
          alert('Erro ao atualizar m√©tricas');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao atualizar m√©tricas');
      }
    });

    // ==================== INVESTMENT CONTRIBUTIONS ====================
    function openContributionModal(contributionId = null) {
      const modal = document.getElementById('contributionModal');
      const form = document.getElementById('contributionForm');
      const title = document.getElementById('contributionModalTitle');
      
      if (contributionId) {
        title.textContent = 'Editar Aporte';
        document.getElementById('contributionId').value = contributionId;
      } else {
        title.textContent = 'Adicionar Aporte';
        form.reset();
      }
      
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeContributionModal() {
      const modal = document.getElementById('contributionModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('contributionForm').reset();
    }

    document.getElementById('contributionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const contributionId = document.getElementById('contributionId').value;
      const data = {
        item_id: document.getElementById('contributionItemId').value,
        contribution_date: document.getElementById('contributionDate').value,
        amount: parseFloat(document.getElementById('contributionAmount').value),
        notes: document.getElementById('contributionNotes').value
      };

      try {
        let response;
        if (contributionId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions/${contributionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Aporte salvo com sucesso!');
          closeContributionModal();
          loadInvestmentData();
        } else {
          alert('Erro ao salvar aporte');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar aporte');
      }
    });

    // Mapa de itemKey para item_id
    const itemIdMap = {
      'caixa': 1,
      'recebiveis': 2,
      'estoques': 3,
      'instalacoes': 4,
      'maquinas': 5,
      'outros': 6
    };

    function manageContributions(itemKey) {
      console.log('Gerenciar aportes de:', itemKey);
      const itemId = itemIdMap[itemKey];
      
      if (!itemId) {
        console.error('Item n√£o encontrado:', itemKey);
        return;
      }
      
      // Abrir modal diretamente para adicionar aporte
      // Pr√©-selecionar o item
      openContributionModal();
      document.getElementById('contributionItemId').value = itemId;
      document.getElementById('contributionItemId').disabled = true;
    }
    
    function openContributionModalForItem(itemId) {
      openContributionModal();
      document.getElementById('contributionItemId').value = itemId;
    }

    // ==================== FUNDING SOURCES ====================
    function openFundingSourceModal(sourceId = null) {
      const modal = document.getElementById('fundingSourceModal');
      const form = document.getElementById('fundingSourceForm');
      const title = document.getElementById('fundingSourceModalTitle');
      
      if (sourceId) {
        title.textContent = 'Editar Fonte de Recursos';
        document.getElementById('fundingSourceId').value = sourceId;
      } else {
        title.textContent = 'Adicionar Fonte de Recursos';
        form.reset();
      }
      
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeFundingSourceModal() {
      const modal = document.getElementById('fundingSourceModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('fundingSourceForm').reset();
    }

    document.getElementById('fundingSourceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const sourceId = document.getElementById('fundingSourceId').value;
      const data = {
        source_type: document.getElementById('fundingSourceType').value,
        contribution_date: document.getElementById('fundingSourceDate').value,
        amount: parseFloat(document.getElementById('fundingSourceAmount').value),
        notes: document.getElementById('fundingSourceNotes').value
      };

      try {
        let response;
        if (sourceId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources/${sourceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Fonte de recursos salva com sucesso!');
          closeFundingSourceModal();
          loadFundingSources();
        } else {
          alert('Erro ao salvar fonte de recursos');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar fonte de recursos');
      }
    });

    async function loadFundingSources() {
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources`);
        const result = await response.json();
        
        if (result.success) {
          const tbody = document.getElementById('funding-sources-tbody');
          tbody.innerHTML = '';
          
          result.data.forEach(source => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${source.source_type}</td>
              <td>${source.contribution_date}</td>
              <td>R$ ${source.amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
              <td>${source.notes || '-'}</td>
              <td>
                <button class="btn-icon" onclick="editFundingSource(${source.id})" title="Editar">‚úèÔ∏è</button>
                <button class="btn-icon delete" onclick="deleteFundingSource(${source.id})" title="Deletar">üóëÔ∏è</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading funding sources:', error);
      }
    }

    async function deleteFundingSource(sourceId) {
      if (!confirm('Tem certeza que deseja deletar esta fonte de recursos?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources/${sourceId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Fonte de recursos deletada com sucesso!');
          loadFundingSources();
        } else {
          alert('Erro ao deletar fonte de recursos');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar fonte de recursos');
      }
    }

    function editFundingSource(sourceId) {
      openFundingSourceModal(sourceId);
    }

    async function loadInvestmentData() {
      try {
        console.log('üîÑ Loading investment data...');
        
        // Buscar categorias e itens com aportes
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/categories`);
        const result = await response.json();
        
        if (!result.success) {
          console.error('‚ùå Error loading investment data:', result.error);
          return;
        }
        
        const categories = result.data;
        console.log('‚úÖ Categories loaded:', categories);
        
        // Atualizar totais por item
        const itemTotals = {};
        const itemsByMonth = {};
        
        // Para cada categoria
        for (const category of categories) {
          const itemsResponse = await fetch(`/pev/api/implantacao/${planId}/finance/investment/items/${category.id}`);
          const itemsResult = await itemsResponse.json();
          
          if (itemsResult.success && itemsResult.data) {
            for (const item of itemsResult.data) {
              // Buscar contribui√ß√µes deste item
              const contribResponse = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions?item_id=${item.id}`);
              const contribResult = await contribResponse.json();
              
              if (contribResult.success && contribResult.data) {
                let total = 0;
                const monthlyData = {};
                
                contribResult.data.forEach(contrib => {
                  total += parseFloat(contrib.amount);
                  
                  // Agrupar por m√™s
                  const date = new Date(contrib.contribution_date);
                  const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                  
                  if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                  }
                  monthlyData[monthKey] += parseFloat(contrib.amount);
                });
                
                itemTotals[item.id] = total;
                itemsByMonth[item.id] = monthlyData;
              }
            }
          }
        }
        
        // Atualizar UI com os totais
        updateInvestmentTotalsUI(itemTotals);
        
        // Renderizar planilha por per√≠odo
        renderInvestmentSpreadsheet(categories, itemsByMonth);
        
        console.log('‚úÖ Investment data loaded successfully');
        
      } catch (error) {
        console.error('‚ùå Error loading investment data:', error);
      }
    }
    
    function updateInvestmentTotalsUI(itemTotals) {
      // Mapear IDs para elementos HTML
      const mapping = {
        1: 'caixa-total',
        2: 'recebiveis-total',
        3: 'estoques-total',
        4: 'instalacoes-total',
        5: 'maquinas-total',
        6: 'outros-total'
      };
      
      Object.keys(mapping).forEach(itemId => {
        const elementId = mapping[itemId];
        const element = document.getElementById(elementId);
        if (element) {
          const total = itemTotals[itemId] || 0;
          element.textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }
      });
    }
    
    async function renderInvestmentSpreadsheet(categories, itemsByMonth) {
      try {
        // Gerar pr√≥ximos 12 meses
        const months = [];
        const today = new Date();
        for (let i = 0; i < 12; i++) {
          const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
          months.push({
            key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
            label: date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })
          });
        }
        
        // Renderizar headers
        const headerRow = document.getElementById('month-headers');
        headerRow.innerHTML = months.map(m => `<th>${m.label}</th>`).join('');
        
        // Renderizar linhas de dados
        const tbody = document.getElementById('spreadsheet-tbody');
        tbody.innerHTML = '';
        
        for (const category of categories) {
          const itemsResponse = await fetch(`/pev/api/implantacao/${planId}/finance/investment/items/${category.id}`);
          const itemsResult = await itemsResponse.json();
          
          if (itemsResult.success && itemsResult.data) {
            for (const item of itemsResult.data) {
              const row = document.createElement('tr');
              
              // Calcular total
              const monthlyData = itemsByMonth[item.id] || {};
              const total = Object.values(monthlyData).reduce((sum, val) => sum + val, 0);
              
              // Criar c√©lulas
              let cells = `
                <td>${category.category_name}</td>
                <td>${item.item_name}</td>
                <td><strong>R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
              `;
              
              // Adicionar valores por m√™s
              months.forEach(month => {
                const value = monthlyData[month.key] || 0;
                const displayValue = value > 0 ? `R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-';
                cells += `<td>${displayValue}</td>`;
              });
              
              row.innerHTML = cells;
              tbody.appendChild(row);
            }
          }
        }
        
      } catch (error) {
        console.error('Error rendering spreadsheet:', error);
      }
    }

    // Carregar dados ao inicializar
    loadFundingSources();
    loadInvestmentData();

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
{% endblock %}
