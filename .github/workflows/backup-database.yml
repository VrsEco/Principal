# ============================================
# GestaoVersus - Automated Database Backup
# ============================================
# Backup autom√°tico do banco de dados
# Schedule: Di√°rio √†s 3:00 AM UTC
# ============================================

name: üíæ Database Backup

on:
  schedule:
    # Todos os dias √†s 3:00 AM UTC (00:00 Bras√≠lia)
    - cron: '0 3 * * *'
  workflow_dispatch:  # Permite execu√ß√£o manual de qualquer branch

jobs:
  # ==========================================
  # Job: Backup Database
  # ==========================================
  backup:
    name: üíæ Backup PostgreSQL
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üíæ Create Database Backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/gestaoversos
            
            # Vari√°veis
            BACKUP_DIR="/opt/gestaoversos/backups"
            BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="backup_${BACKUP_DATE}.sql"
            BACKUP_COMPRESSED="backup_${BACKUP_DATE}.sql.gz"
            
            # Criar diret√≥rio de backup se n√£o existir
            mkdir -p $BACKUP_DIR
            
            # Fazer backup do PostgreSQL
            docker-compose exec -T db pg_dump -U postgres bd_app_versus > $BACKUP_DIR/$BACKUP_FILE
            
            # Comprimir backup
            gzip $BACKUP_DIR/$BACKUP_FILE
            
            # Verificar se backup foi criado
            if [ -f "$BACKUP_DIR/$BACKUP_COMPRESSED" ]; then
              echo "‚úÖ Backup criado: $BACKUP_COMPRESSED"
              ls -lh $BACKUP_DIR/$BACKUP_COMPRESSED
            else
              echo "‚ùå Erro ao criar backup!"
              exit 1
            fi
            
            # Manter apenas √∫ltimos 30 dias de backups
            find $BACKUP_DIR -name "backup_*.sql.gz" -type f -mtime +30 -delete
            
            echo "üóÇÔ∏è Backups dispon√≠veis:"
            ls -lh $BACKUP_DIR/backup_*.sql.gz

      - name: ‚òÅÔ∏è Upload to S3 (AWS)
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_S3_BUCKET
          script: |
            cd /opt/gestaoversos
            
            # Verificar se AWS est√° configurado
            if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_S3_BUCKET" ]; then
              echo "‚ö†Ô∏è AWS credentials n√£o configuradas, pulando upload para S3"
              exit 0
            fi
            
            # Instalar AWS CLI se n√£o existir
            if ! command -v aws &> /dev/null; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            fi
            
            # Configurar credenciais AWS
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=us-east-1
            
            # Upload para S3
            BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
            aws s3 cp backups/backup_${BACKUP_DATE}.sql.gz \
              s3://${{ secrets.AWS_S3_BUCKET }}/backups/database/backup_${BACKUP_DATE}.sql.gz
            
            echo "‚úÖ Backup enviado para S3"

      - name: ‚òÅÔ∏è Upload to Google Cloud Storage
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/gestaoversos
            
            # Verificar se GCP est√° configurado
            if [ ! -f "/app/credentials/gcp-key.json" ]; then
              echo "‚ö†Ô∏è GCP credentials n√£o configuradas, pulando upload para GCS"
              exit 0
            fi
            
            # Configurar GCloud
            if [ -f "/app/credentials/gcp-key.json" ]; then
              gcloud auth activate-service-account --key-file=/app/credentials/gcp-key.json
              
              # Upload para GCS
              BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
              gsutil cp backups/backup_${BACKUP_DATE}.sql.gz \
                gs://${{ secrets.GCS_BUCKET }}/backups/database/backup_${BACKUP_DATE}.sql.gz
              
              echo "‚úÖ Backup enviado para Google Cloud Storage"
            fi

      - name: üìä Backup Report
        run: |
          echo "üìä Relat√≥rio de Backup"
          echo "====================="
          echo "üìÖ Data: $(date)"
          echo "‚úÖ Status: Conclu√≠do"
          echo "üíæ Tipo: PostgreSQL Full Backup"
          echo "üì¶ Compress√£o: gzip"
          echo "üóÇÔ∏è Reten√ß√£o: 30 dias"

      - name: üìß Notify Success
        if: success()
        run: echo "‚úÖ Backup realizado com sucesso!"

      - name: üìß Notify Failure
        if: failure()
        run: |
          echo "‚ùå Backup falhou!"
          echo "‚ö†Ô∏è ATEN√á√ÉO: Verifique os logs imediatamente!"
          exit 1

  # ==========================================
  # Job: Verify Backup Integrity
  # ==========================================
  verify:
    name: ‚úÖ Verify Backup
    runs-on: ubuntu-latest
    needs: backup
    
    steps:
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ‚úÖ Test Backup Restoration
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/gestaoversos
            
            # Pegar √∫ltimo backup
            LAST_BACKUP=$(ls -t backups/backup_*.sql.gz | head -1)
            
            if [ -f "$LAST_BACKUP" ]; then
              echo "‚úÖ Backup encontrado: $LAST_BACKUP"
              
              # Verificar integridade do arquivo
              gunzip -t $LAST_BACKUP
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Backup √≠ntegro!"
              else
                echo "‚ùå Backup corrompido!"
                exit 1
              fi
            else
              echo "‚ùå Nenhum backup encontrado!"
              exit 1
            fi

