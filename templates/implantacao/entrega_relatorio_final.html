{#
  Relatorio Final de Implantacao - GestaoVersus
  Estruturado conforme REPORT_STANDARDS.md
  Integra projeto vinculado, agenda e governanca financeira
#}

{% extends "reports/base_report.html" %}
{% from "reports/components.html" import
  section_header,
  story_card,
  data_table,
  custom_table,
  result_grid,
  highlight_box,
  model7_card,
  responsive_grid,
  two_column,
  subsection,
  cover_meta_grid,
  status_badge,
  format_currency,
  format_percent,
  format_date
%}

{% block page_title %}Relatorio Final de Implantacao - {{ plan.plan_name }} - GestaoVersus{% endblock %}
{% block meta_description %}Relatorio final do plano {{ plan.plan_name }} para {{ plan.company_name }}, consolidando alinhamento, modelo, estruturas e viabilidade financeira.{% endblock %}

{% block extra_css %}
  <style>
    .cover-page.book-cover {
      background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.18) 0%, transparent 52%), linear-gradient(135deg, #122a5f 0%, #183877 38%, #1f4aa0 72%, #2b5bc7 100%);
      padding: 95px 82px 110px;
    }

    .cover-ribbon {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .cover-ribbon span {
      display: inline-flex;
      align-items: center;
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.16);
      color: #e2e8f0;
    }

    .cover-tagline {
      font-size: 13px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.72);
      margin-bottom: 42px;
    }

    .cover-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      position: relative;
      z-index: 1;
    }

    .cover-detail-grid h3 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .cover-detail-grid p {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.7;
    }

    .cover-upcoming h4 {
      font-size: 15px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: rgba(255, 255, 255, 0.76);
    }

    .cover-upcoming ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 10px;
    }

    .cover-upcoming li {
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.85);
      background: rgba(15, 23, 42, 0.32);
      border-radius: 14px;
      padding: 12px 16px;
    }

    .cover-upcoming li strong {
      display: block;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.56);
      margin-bottom: 4px;
    }

    .story-list.compact li {
      margin-bottom: 6px;
    }

    .section-body .report-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .section-body .report-link:hover {
      text-decoration: underline;
    }
  </style>
{% endblock %}

{% block cover_page %}
  <section class="page portrait cover-page book-cover">
    <div style="position: relative; z-index: 1;">
      <div class="cover-ribbon">
        <span>{{ plan.status }}</span>
        <span>Plano {{ plan.plan_id }}</span>
        <span>Emitido {{ issued_at }}</span>
      </div>
      <p class="cover-tagline">Book de Processos â€¢ Implantacao estrategica</p>
      <h1>Relatorio Final de Implantacao</h1>
      <h2>{{ plan.plan_name }}</h2>

      {{ cover_meta_grid([
        {"label": "Empresa", "value": plan.company_name},
        {"label": "Consultor", "value": plan.consultant},
        {"label": "Patrocinador", "value": plan.sponsor|default("N/A")},
        {"label": "Ultima atualizacao", "value": plan.last_update}
      ]) }}

      <div class="cover-detail-grid" style="margin-top: 36px;">
        <div>
          <h3>{{ projeto.nome }}</h3>
          {% if projeto.descricao %}
            <p>{{ projeto.descricao }}</p>
          {% else %}
            <p>Projeto vinculado ao plano de implantacao para acompanhamento tatico no GRV.</p>
          {% endif %}
        </div>

        {% set agenda_preview = (alinhamento.agenda or [])[:3] %}
        {% if agenda_preview %}
          <div class="cover-upcoming">
            <h4>Proximos marcos</h4>
            <ul>
              {% for item in agenda_preview %}
                <li>
                  <strong>{{ item.quando or "Em definicao" }}</strong>
                  {{ item.oque }}
                  {% if item.quem %}
                    <br><span style="opacity:0.75;">Responsavel: {{ item.quem }}</span>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}

{% block content %}

{# ---------------------------------------------------------
   01. Resumo executivo e projeto vinculado
   --------------------------------------------------------- #}
<section class="page portrait">
  {{ section_header("01", "Resumo Executivo & Projeto Vinculado", "Panorama geral do plano, do projeto associado no GRV e da cadencia de implantacao") }}
  <div class="section-body">
    {% call responsive_grid("260px") %}
      {% call model7_card("Planejamento PEV", plan.plan_name) %}
        <div style="margin-bottom: 12px;">{{ status_badge(plan.status, "info") }}</div>
        <ul class="story-list compact">
          <li><strong>Versao:</strong> {{ plan.version }}</li>
          <li><strong>Ultima atualizacao:</strong> {{ plan.last_update }}</li>
          <li><strong>Proximo checkpoint:</strong> {{ plan.next_checkpoint }}</li>
          <li><strong>Consultor responsavel:</strong> {{ plan.consultant }}</li>
        </ul>
      {% endcall %}

      {% call model7_card("Projeto Vinculado", projeto.nome) %}
        {% if projeto.descricao %}
          <p>{{ projeto.descricao }}</p>
        {% endif %}
        {% if projeto.observacoes %}
          <ul class="story-list compact">
            {% for obs in projeto.observacoes[:4] %}
              <li>{{ obs }}</li>
            {% endfor %}
          </ul>
          {% if projeto.observacoes|length > 4 %}
            <p class="story-note">+ {{ projeto.observacoes|length - 4 }} observacoes registradas no modulo de implantacao.</p>
          {% endif %}
        {% else %}
          <p class="story-note">Sem observacoes adicionais registradas para este projeto.</p>
        {% endif %}
        {% if plan.company_id and projeto.grv_project_id %}
          <p class="story-note">
            Kanban ativo:
            <a class="report-link" href="{{ url_for('grv.grv_project_manage', company_id=plan.company_id, project_id=projeto.grv_project_id) }}" target="_blank" rel="noopener">
              GRV &rsaquo; Projeto {{ projeto.grv_project_id }}
            </a>
          </p>
        {% endif %}
      {% endcall %}

      {% call model7_card("Escopo Consolidado") %}
        <ul class="story-list compact">
          <li><strong>Segmentos mapeados:</strong> {{ segmentos|length }}</li>
          <li><strong>Estruturas priorizadas:</strong> {{ estruturas|length }}</li>
          <li><strong>Premissas financeiras:</strong> {{ financeiro.premissas|length }}</li>
          <li><strong>Capacidades avaliadas:</strong> {{ financeiro.capacidades|length }}</li>
        </ul>
        <p class="story-note">Documento emitido em {{ issued_at }}.</p>
      {% endcall %}
    {% endcall %}

    {% set atividades = alinhamento.agenda or [] %}
    {% if atividades %}
      {% set proximas = atividades[:4] %}
      {% call subsection("Proximas atividades priorizadas") %}
        <p style="margin-bottom: 12px; color: #475569;">
          Destaques da agenda operacional vinculada ao projeto. Lista completa na secao de Alinhamento.
        </p>
        {% call(rows) custom_table(
          ["Atividade", "Responsavel", "Prazo", "Como vamos executar"],
          proximas
        ) %}
          {% for item in rows %}
            <tr>
              <td>{{ item.oque }}</td>
              <td>{{ item.quem or "-" }}</td>
              <td>{{ item.quando or "-" }}</td>
              <td>{{ item.como or "-" }}</td>
            </tr>
          {% endfor %}
        {% endcall %}
        {% if atividades|length > proximas|length %}
          <p class="story-note" style="margin-top: 10px;">
            + {{ atividades|length - proximas|length }} atividades adicionais registradas na agenda completa.
          </p>
        {% endif %}
      {% endcall %}
    {% endif %}
  </div>
</section>

{# ---------------------------------------------------------
   02. Alinhamento estrategico
   --------------------------------------------------------- #}
<section class="page portrait">
  {{ section_header("02", "Alinhamento Estrategico") }}

  <div class="section-body">
    {% set visao = alinhamento.visao %}
    {% if visao %}
      {% if visao is string %}
        <p class="narrative-intro">
          A visao compartilhada do negocio esta ancorada em "{{ visao }}", direcionando as decisoes de implantacao.
        </p>
      {% elif visao is iterable %}
        <p class="narrative-intro">
          Os elementos essenciais da visao compartilhada foram consolidados nos pontos a seguir:
        </p>
        <ul class="story-list">
          {% for item in visao %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endif %}

    {% if alinhamento.metas %}
      {{ story_card("Metas Financeiras Priorizadas", alinhamento.metas) }}
    {% endif %}

    {% call story_card("Equipe Decisora") %}
      {% if alinhamento.socios %}
        <div class="story-columns">
          {% for socio in alinhamento.socios %}
            <div>
              <h5>{{ socio.nome }}</h5>
              <ul class="story-list">
                {% if socio.papel %}<li><strong>Papel:</strong> {{ socio.papel }}</li>{% endif %}
                {% if socio.motivacao %}<li><strong>Motivacao:</strong> {{ socio.motivacao }}</li>{% endif %}
                {% if socio.compromisso %}<li><strong>Compromisso:</strong> {{ socio.compromisso }}</li>{% endif %}
                {% if socio.risco %}<li><strong>Tolerancia a risco:</strong> {{ socio.risco }}</li>{% endif %}
              </ul>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="story-note">
          Ainda nao registramos socios com papel definido nesta etapa. O cadastro pode ser feito no modulo de alinhamento.
        </p>
      {% endif %}
    {% endcall %}

    {% if alinhamento.principios %}
      {{ story_card("Principios Orientadores", alinhamento.principios) }}
    {% endif %}

    {% if alinhamento.agenda %}
      {% call story_card("Agenda de Convergencia") %}
        <p>A agenda consolida compromissos que sustentam a implantacao e garantem ritmo executivo.</p>
        {% call(rows) custom_table(
          ["O que", "Quem", "Quando", "Como"],
          alinhamento.agenda
        ) %}
          {% for item in rows %}
            <tr>
              <td>{{ item.oque }}</td>
              <td>{{ item.quem }}</td>
              <td>{{ item.quando }}</td>
              <td>{{ item.como }}</td>
            </tr>
          {% endfor %}
        {% endcall %}
      {% endcall %}
    {% endif %}
  </div>
</section>

{# ---------------------------------------------------------
   03. Modelo e Mercado
   --------------------------------------------------------- #}
<section class="page portrait">
  {{ section_header("03", "Modelo & Mercado") }}
  
  <div class="section-body">
    {% if segmentos %}
      {% for segmento in segmentos %}
        {% call model7_card(segmento.nome or "Segmento") %}
          {% set proposta = segmento.proposta or segmento.value_proposition or {} %}
          {% set publico = proposta.publico or proposta.segmentos or segmento.audiences or [] %}
          {% set diferenciais = proposta.diferenciais or segmento.differentials or [] %}
          {% set evidencias = proposta.comprobacoes or proposta.provas or segmento.evidences or [] %}
          {% set personas = segmento.personas or [] %}

          {% call two_column() %}
            <div>
              <strong>Publico-alvo</strong>
              <ul>
                {% if publico %}
                  {% for item in publico %}
                    <li>{{ item }}</li>
                  {% endfor %}
                {% else %}
                  <li>Sem dados mapeados.</li>
                {% endif %}
              </ul>
            </div>
            <div>
              <strong>Diferenciais</strong>
              <ul>
                {% if diferenciais %}
                  {% for item in diferenciais %}
                    <li>{{ item }}</li>
                  {% endfor %}
                {% else %}
                  <li>Sem diferenciais registrados.</li>
                {% endif %}
              </ul>
            </div>
            <div>
              <strong>Evidencias</strong>
              <ul>
                {% if evidencias %}
                  {% for item in evidencias %}
                    <li>{{ item }}</li>
                  {% endfor %}
                {% else %}
                  <li>Sem evidencias cadastradas.</li>
                {% endif %}
              </ul>
            </div>
            <div>
              <strong>Personas chave</strong>
              <ul>
                {% if personas %}
                  {% for persona in personas %}
                    <li><strong>{{ persona.nome or persona.name }}:</strong> {{ persona.perfil or persona.descricao or persona.description }}</li>
                  {% endfor %}
                {% else %}
                  <li>Personas ainda nao definidas.</li>
                {% endif %}
              </ul>
            </div>
          {% endcall %}

          {% if segmento.produtos %}
            <div style="margin-top: 20px;">
              <h5 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Portfolio de produtos</h5>
              {% call(rows) custom_table(
                ["Produto", "Preco de venda", "Custos variaveis", "Despesas variaveis", "Margem contrib. unit.", "Mercado", "Meta market share"],
                segmento.produtos
              ) %}
                {% for produto in rows %}
                  <tr>
                    <td style="min-width: 140px;">
                      <div style="font-weight: 600; color: #0f172a;">{{ produto.nome }}</div>
                      {% if produto.observacoes %}
                        <div style="font-size: 12px; color: #64748b;">{{ produto.observacoes }}</div>
                      {% endif %}
                    </td>
                    <td>{{ produto.preco_venda }}</td>
                    <td>{{ produto.custos_variaveis }}</td>
                    <td>{{ produto.despesas_variaveis }}</td>
                    <td>{{ produto.margem_contribuicao }}</td>
                    <td>{{ produto.mercado }}</td>
                    <td>{{ produto.meta_market_share }}</td>
                  </tr>
                {% endfor %}
              {% endcall %}
            </div>
          {% endif %}

          {% if segmento.totais %}
            {% set totais = segmento.totais %}
            {% call highlight_box("info", "Resumo do segmento") %}
              <ul style="margin: 12px 0 0 18px;">
                <li>Produtos cadastrados: {{ totais.produtos_registrados }}</li>
                {% if totais.faturamento_mensal.valor_formatado %}
                  <li>Faturamento mensal estimado: {{ totais.faturamento_mensal.valor_formatado }}</li>
                {% endif %}
                {% if totais.margem_contribuicao.valor_formatado or totais.margem_contribuicao.percentual_formatado %}
                  <li>Margem de contribuicao total:
                    {% if totais.margem_contribuicao.percentual_formatado %}{{ totais.margem_contribuicao.percentual_formatado }}{% endif %}
                    {% if totais.margem_contribuicao.valor_formatado %}{% if totais.margem_contribuicao.percentual_formatado %} | {% endif %}{{ totais.margem_contribuicao.valor_formatado }}{% endif %}
                  </li>
                {% endif %}
              </ul>
            {% endcall %}
          {% endif %}
        {% endcall %}
      {% endfor %}
    {% else %}
      <p class="story-note">Nenhum segmento foi cadastrado para este plano.</p>
    {% endif %}
  </div>
</section>

{# ---------------------------------------------------------
   04. Estruturas de Execucao
   --------------------------------------------------------- #}
<section class="page portrait">
  {{ section_header("04", "Estruturas de Execucao") }}
  
  <div class="section-body">
    {% if estruturas %}
      {% call responsive_grid() %}
        {% for area in estruturas %}
          {% call model7_card(area.area) %}
            {% if area.capacidade_formatada or area.capacidade %}
              <p style="font-size:13px; color:#1d4ed8; margin: 0 0 8px;">
                Capacidade suportada: {{ area.capacidade_formatada or area.capacidade }}
                {% if area.capacidade_observacoes %}<br><span style="color:#64748b;">{{ area.capacidade_observacoes }}</span>{% endif %}
              </p>
            {% endif %}
            <ul>
              {% for bloco in area.resumo %}
                <li>
                  <strong>{{ bloco.escopo }}:</strong>
                  <ul style="margin-top:4px;">
                    {% for ponto in bloco.pontos %}
                      <li>{{ ponto }}</li>
                    {% endfor %}
                  </ul>
                </li>
              {% endfor %}
            </ul>
          {% endcall %}
        {% endfor %}
      {% endcall %}
    {% else %}
      <p class="story-note">As estruturas ainda nao foram priorizadas neste plano.</p>
    {% endif %}
  </div>
</section>

{# ---------------------------------------------------------
   05. Modelagem Financeira e Indicadores
   --------------------------------------------------------- #}
<section class="page landscape">
  {{ section_header("05", "Modelagem Financeira & Indicadores") }}
  
  <div class="section-body">
    {% call subsection("Premissas") %}
      {% if financeiro.premissas %}
        {% call(rows) custom_table(
          ["Descricao", "Sugestao", "Ajustado", "Observacoes", "Memoria de calculo"],
          financeiro.premissas
        ) %}
          {% for item in rows %}
            <tr>
              <td>{{ item.indicador }}</td>
              <td>{{ item.sugestao }}</td>
              <td>{{ item.ajustado }}</td>
              <td>{{ item.observacoes }}</td>
              <td>{{ item.memoria }}</td>
            </tr>
          {% endfor %}
        {% endcall %}
      {% else %}
        <p class="story-note">Nao ha premissas cadastradas.</p>
      {% endif %}
    {% endcall %}

    {% call two_column() %}
      {% call model7_card("Investimentos") %}
        {% if financeiro.investimento.investimento %}
          <ul class="story-list">
            {% for item in financeiro.investimento.investimento %}
              <li><strong>{{ item.descricao }}:</strong> {{ item.valor }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="story-note">Sem investimentos cadastrados.</p>
        {% endif %}
      {% endcall %}
      
      {% call model7_card("Fontes") %}
        {% if financeiro.investimento.fontes %}
          <ul class="story-list">
            {% for item in financeiro.investimento.fontes %}
              <li>
                <strong>{{ item.categoria }} - {{ item.descricao }}:</strong> {{ item.valor }}
                {% if item.disponibilidade %} (disp.: {{ item.disponibilidade }}){% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="story-note">Fontes de recurso nao cadastradas.</p>
        {% endif %}
      {% endcall %}
    {% endcall %}

    {% call subsection("Capacidade operacional suportada") %}
      {% call(rows) custom_table(["Area", "Faturamento suportado", "Observacoes"], financeiro.capacidades or []) %}
        {% if rows %}
          {% for item in rows %}
            <tr>
              <td>{{ item.area }}</td>
              <td>{{ item.valor_formatado or item.valor or "-" }}</td>
              <td>{{ item.observacoes or "-" }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="3">Nenhuma capacidade registrada</td>
          </tr>
        {% endif %}
      {% endcall %}

      {% call highlight_box("success", "Resumo") %}
        <ul style="margin: 12px 0 0 18px;">
          <li>Total suportado: {{ financeiro.resumo_capacidades.total_formatado or "-" }}</li>
          <li>Gargalo:
            {% if financeiro.resumo_capacidades.gargalo_valor_formatado %}
              {{ financeiro.resumo_capacidades.gargalo_valor_formatado }}
              {% if financeiro.resumo_capacidades.gargalo_area %} ({{ financeiro.resumo_capacidades.gargalo_area }}){% endif %}
            {% else %}-{% endif %}
          </li>
        </ul>
      {% endcall %}
    {% endcall %}

    {% call subsection("Resultado do negocio") %}
      {% set fluxo_financeiro = financeiro.fluxo_financeiro or {} %}
      {% set sections = fluxo_financeiro.sections or [] %}
      {% set negocio_section = (sections | selectattr('slug', 'equalto', 'negocio') | list | first) %}
      {% set negocio_linhas = negocio_section.linhas if negocio_section else [] %}

      {% if negocio_linhas %}
        {% set linha_receita = (negocio_linhas | selectattr('slug', 'equalto', 'receita') | list | first) %}
        {% set linha_custos_variaveis = (negocio_linhas | selectattr('slug', 'equalto', 'custos_variaveis') | list | first) %}
        {% set linha_despesas_variaveis = (negocio_linhas | selectattr('slug', 'equalto', 'despesas_variaveis') | list | first) %}
        {% set linha_margem = (negocio_linhas | selectattr('slug', 'equalto', 'margem_contribuicao') | list | first) %}
        {% set linha_custos_fixos = (negocio_linhas | selectattr('slug', 'equalto', 'custos_fixos') | list | first) %}
        {% set linha_despesas_fixas = (negocio_linhas | selectattr('slug', 'equalto', 'despesas_fixas') | list | first) %}
        {% set linha_resultado_operacional = (negocio_linhas | selectattr('slug', 'equalto', 'resultado_operacional') | list | first) %}
        {% set linha_destinacao = (negocio_linhas | selectattr('slug', 'equalto', 'destinacao') | list | first) %}
        {% set linha_resultado_periodo = (negocio_linhas | selectattr('slug', 'equalto', 'resultado_periodo') | list | first) %}

        {% set resultado_operacional_decimal = linha_resultado_operacional.total_decimal if linha_resultado_operacional and linha_resultado_operacional.total_decimal is not none else 0 %}
        {% set destinacao_total_decimal = linha_destinacao.total_decimal if linha_destinacao and linha_destinacao.total_decimal is not none else 0 %}
        {% set resultado_periodo_decimal = linha_resultado_periodo.total_decimal if linha_resultado_periodo and linha_resultado_periodo.total_decimal is not none else (resultado_operacional_decimal - destinacao_total_decimal) %}
        {% set resultado_final_class = 'positive' if resultado_periodo_decimal >= 0 else 'negative' %}

        {{ result_grid([
          {"label": "Faturamento total", "value": linha_receita.total if linha_receita else "R$ 0,00", "note": "Soma dos periodos planejados"},
          {"label": "Custos variaveis", "value": linha_custos_variaveis.total if linha_custos_variaveis else "R$ 0,00"},
          {"label": "Despesas variaveis", "value": linha_despesas_variaveis.total if linha_despesas_variaveis else "R$ 0,00"},
          {"label": "Margem de contribuicao", "value": linha_margem.total if linha_margem else "R$ 0,00"}
        ]) }}

        {{ result_grid([
          {"label": "Custos fixos", "value": linha_custos_fixos.total if linha_custos_fixos else "R$ 0,00"},
          {"label": "Despesas fixas", "value": linha_despesas_fixas.total if linha_despesas_fixas else "R$ 0,00"},
          {"label": "Resultado operacional", "value": linha_resultado_operacional.total if linha_resultado_operacional else "R$ 0,00"},
          {"label": "Destinacoes de resultados", "value": format_currency(destinacao_total_decimal)},
          {"label": "Resultado final apos destinacoes", "value": format_currency(resultado_periodo_decimal), "note": "Resultado operacional - destinacoes", "status": resultado_final_class}
        ]) }}
      {% else %}
        <p class="story-note">Sem dados de resultados cadastrados.</p>
      {% endif %}
    {% endcall %}

    {% call subsection("Fluxo de caixa do investidor") %}
      {% if financeiro.fluxo_investidor.periodos %}
        {% call(rows) custom_table(
          ["Periodo", "Aporte", "Distribuicao", "Saldo periodo", "Saldo acumulado"],
          financeiro.fluxo_investidor.periodos
        ) %}
          {% for linha in rows %}
            <tr>
              <td>{{ linha.periodo }}</td>
              <td>{{ linha.aporte }}</td>
              <td>{{ linha.distribuicao }}</td>
              <td>{{ linha.saldo }}</td>
              <td>{{ linha.acumulado }}</td>
            </tr>
          {% endfor %}
        {% endcall %}
      {% else %}
        <p class="story-note">Sem dados de fluxo do investidor registrados.</p>
      {% endif %}

      {% call highlight_box("info", "Analises") %}
        {% set analises = financeiro.fluxo_investidor.analises or {} %}
        {% set tir_label = analises.tir_label or ('TIR ' ~ (analises.tir_horizon_years or 5) ~ ' anos') %}
        <ul style="margin:12px 0 0 18px;">
          <li>Payback: {{ analises.payback | default('-', true) }}</li>
          <li>Custo de oportunidade: {{ analises.opportunity_cost | default('1%', true) }}</li>
          <li>{{ tir_label }}: {{ analises.tir | default('-', true) }}</li>
        </ul>
      {% endcall %}
    {% endcall %}
  </div>
</section>

{% endblock %}

{% block footer %}
  <span>Versus Gestao Corporativa - Todos os Direitos Reservados - Emitido em: {{ issued_at }}</span>
  <span>Consultor responsavel: {{ plan.consultant }}</span>
{% endblock %}
