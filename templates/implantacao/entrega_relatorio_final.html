<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatorio Final de Implantacao</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #e9edf5;
      color: #0f172a;
      font-family: "Segoe UI", "Inter", Arial, sans-serif;
      line-height: 1.6;
      padding: 32px 16px 64px;
    }

    .model7-report {
      max-width: 1020px;
      margin: 0 auto;
    }

    .page {
      position: relative;
      background: #ffffff;
      border-radius: 28px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 34px 70px rgba(15, 23, 42, 0.16);
      margin-bottom: 42px;
      overflow: hidden;
      padding: 48mm 58px;
      page-break-after: always;
      width: 100%;
    }

    .page:last-child {
      page-break-after: auto;
    }

    .page.landscape {
      padding: 35mm 48px;
    }

    @page portrait {
      size: A4 portrait;
      margin: 18mm 16mm 22mm;
    }

    @page landscapePage {
      size: A4 landscape;
      margin: 18mm 22mm 18mm;
    }

    .page.portrait {
      page: portrait;
    }

    .page.landscape {
      page: landscapePage;
    }

    .cover-page {
      background: linear-gradient(135deg, #132b6c 0%, #2645a3 55%, #3a55c8 100%);
      color: #ffffff;
      padding: 95px 82px;
    }

    .cover-page::after {
      content: "";
      position: absolute;
      right: -70px;
      bottom: -62px;
      width: 260px;
      height: 260px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 50%;
      filter: blur(0.4px);
    }

    .cover-page h1 {
      font-size: 46px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    .cover-page h2 {
      font-size: 28px;
      font-weight: 500;
      opacity: 0.9;
      margin-bottom: 46px;
    }

    .cover-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      position: relative;
      z-index: 1;
    }

    .cover-meta-card {
      background: rgba(255, 255, 255, 0.12);
      padding: 20px;
      border-radius: 18px;
      backdrop-filter: blur(6px);
    }

    .cover-meta-card span {
      display: block;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.65;
    }

    .cover-meta-card strong {
      display: block;
      margin-top: 8px;
      font-size: 18px;
    }

    .section-header span {
      display: inline-block;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #3b82f6;
    }

    .section-header h3 {
      font-size: 30px;
      font-weight: 700;
      margin-top: 6px;
      color: #0f172a;
    }

    .section-body {
      margin-top: 26px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .narrative-intro {
      font-size: 16px;
      color: #1e293b;
      line-height: 1.8;
      margin-bottom: 18px;
    }

    .story-block {
      background: rgba(148, 163, 184, 0.12);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .story-block h4 {
      margin: 0;
      font-size: 20px;
      color: #0f172a;
    }

    .story-block h5 {
      margin: 0;
      font-size: 16px;
      color: #1e40af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .story-block p {
      margin: 0;
      font-size: 15px;
      color: #334155;
      line-height: 1.7;
    }

    .story-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .story-list {
      margin: 6px 0 0 18px;
      padding: 0;
      color: #334155;
    }

    .story-list li {
      margin-bottom: 6px;
      line-height: 1.6;
    }

    .story-note {
      font-size: 14px;
      color: #475569;
      background: rgba(148, 163, 184, 0.2);
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.6;
    }

    .story-table-note {
      font-size: 13px;
      color: #64748b;
      margin-top: 8px;
    }

    .consultant-opinion-block {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.12));
      border: 1px solid rgba(59, 130, 246, 0.35);
      border-radius: 20px;
      padding: 26px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .consultant-opinion-block h4 {
      margin: 0;
      font-size: 22px;
      color: #0f172a;
    }

    .consultant-opinion-block p {
      margin: 0;
      font-size: 16px;
      color: #1e293b;
      line-height: 1.8;
    }

    .consultant-opinion-block ul {
      margin: 0 0 0 22px;
      color: #1e293b;
      line-height: 1.7;
    }

    .model7-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 22px;
    }

    .result-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .result-card {
      background: rgba(15, 23, 42, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .result-card .label {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #475569;
    }

    .result-card .value {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
    }

    .result-card .note {
      font-size: 12px;
      color: #64748b;
    }

    .result-card.positive .value {
      color: #047857;
    }

    .result-card.negative .value {
      color: #dc2626;
    }

    .model7-card {
      background: rgba(248, 250, 252, 0.92);
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      padding: 22px;
      box-shadow: 0 20px 35px rgba(15, 23, 42, 0.07);
      color: #475569;
      display: flex;
      flex-direction: column;
      gap: 12px;
      page-break-inside: avoid;
    }

    .model7-card h4 {
      margin: 0;
      font-size: 19px;
      color: #0f172a;
    }

    .model7-card ul {
      margin: 0;
      padding-left: 18px;
      font-size: 14px;
      line-height: 1.6;
    }

    table.model7-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      color: #394867;
      font-size: 13px;
      box-shadow: 0 18px 30px rgba(15, 23, 42, 0.05);
      page-break-inside: avoid;
    }

    table.model7-table thead tr {
      background: rgba(59, 130, 246, 0.18);
    }

    table.model7-table th,
    table.model7-table td {
      border: 1px solid rgba(148, 163, 184, 0.26);
      padding: 12px 14px;
      text-align: left;
      vertical-align: top;
    }

    table.model7-table th {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 11px;
      color: #1d4ed8;
    }

    .highlight-box {
      margin-top: 22px;
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.28);
      border-radius: 16px;
      padding: 22px;
      color: #166534;
      font-size: 14px;
      page-break-inside: avoid;
    }

    .two-column {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 18px;
    }

    .subsection {
      margin-top: 26px;
      page-break-inside: avoid;
    }

    .subsection h4 {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #1d4ed8;
      margin-bottom: 12px;
    }

    .footer-page {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 32mm 58px;
      font-size: 13px;
      background: #0f172a;
      color: rgba(255, 255, 255, 0.85);
    }

    @media print {
      body {
        background: #ffffff !important;
        padding: 0;
      }

      .model7-report {
        max-width: 100%;
        margin: 0;
      }

      .page {
        border-radius: 0;
        border: none;
        box-shadow: none;
        margin: 0;
        width: auto;
        padding: 20mm 20mm 24mm;
      }

      .page.landscape {
        padding: 18mm 18mm 20mm;
      }

      .cover-page,
      .footer-page {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .cover-page {
        padding: 60mm 35mm 50mm;
      }
    }
  </style>
</head>
<body>
{% macro format_currency_br(value) -%}
  {%- if value is not none -%}
    {%- set numeric = value|float -%}
    {%- set sign = '-' if numeric < 0 else '' -%}
    {%- set absolute = numeric|abs -%}
    {%- set formatted = '{:,.2f}'.format(absolute).replace(',', '_').replace('.', ',').replace('_', '.') -%}
    {{ sign }}R$ {{ formatted }}
  {%- else -%}
    R$ 0,00
  {%- endif -%}
{%- endmacro %}

{% macro format_percent_br(value) -%}
  {%- if value is not none -%}
    {%- set numeric = value|float -%}
    {%- set text = ('%.2f' % numeric).rstrip('0').rstrip('.') -%}
    {{ text }}%
  {%- else -%}
    0%
  {%- endif -%}
{%- endmacro %}

  <article class="model7-report">
    <!-- Capa -->
    <section class="page portrait cover-page">
      <div style="position: relative; z-index: 1;">
        <h1>Relatorio Final de Implantacao</h1>
        <h2>{{ plan.plan_name }}</h2>
        <div class="cover-meta-grid">
          <div class="cover-meta-card">
            <span>Empresa</span>
            <strong>{{ plan.company_name }}</strong>
          </div>
          <div class="cover-meta-card">
            <span>Consultor</span>
            <strong>{{ plan.consultant }}</strong>
          </div>
          <div class="cover-meta-card">
            <span>Patrocinador</span>
            <strong>{{ plan.sponsor }}</strong>
          </div>
          <div class="cover-meta-card">
            <span>Ultima atualizacao</span>
            <strong>{{ plan.last_update }}</strong>
          </div>
        </div>
      </div>
    </section>

    <!-- Alinhamento estrategico -->
    <section class="page portrait">
      <div class="section-header">
        <span>01</span>
        <h3>Alinhamento estrategico</h3>
      </div>
      <div class="section-body">
        {% set visao = alinhamento.visao %}
        {% set metas = alinhamento.metas %}
        {% if visao %}
          {% if visao is string %}
            <p class="narrative-intro">
              Consolidamos a visão compartilhada do negócio em torno de "{{ visao }}", estabelecendo a referência para todas as decisões de implantação.
            </p>
          {% elif visao is iterable %}
            <p class="narrative-intro">
              A visão compartilhada do negócio foi traduzida nos seguintes elementos centrais:
            </p>
            <ul class="story-list">
              {% for item in visao %}
                <li>{{ item }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="narrative-intro">
              Consolidamos a visão compartilhada do negócio em torno de {{ visao }}, estabelecendo a referência para todas as decisões de implantação.
            </p>
          {% endif %}
        {% endif %}

        {% if metas %}
          <div class="story-block">
            <h4>Metas financeiras priorizadas</h4>
            {% if metas is string %}
              <p>{{ metas }}</p>
            {% elif metas is mapping %}
              <div class="story-columns">
                {% for chave, valor in metas.items() %}
                  <div>
                    <h5>{{ chave }}</h5>
                    <p>{{ valor }}</p>
                  </div>
                {% endfor %}
              </div>
            {% elif metas is iterable %}
              <ul class="story-list">
                {% for meta in metas %}
                  <li>{{ meta }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>{{ metas }}</p>
            {% endif %}
          </div>
        {% endif %}

        <div class="story-block">
          <h4>Equipe decisora</h4>
          <div class="story-columns">
            {% for socio in alinhamento.socios or [] %}
              <div>
                <h5>{{ socio.nome }}</h5>
                <ul class="story-list">
                  {% if socio.papel %}<li><strong>Papel:</strong> {{ socio.papel }}</li>{% endif %}
                  {% if socio.motivacao %}<li><strong>Motivacao:</strong> {{ socio.motivacao }}</li>{% endif %}
                  {% if socio.compromisso %}<li><strong>Compromisso:</strong> {{ socio.compromisso }}</li>{% endif %}
                  {% if socio.risco %}<li><strong>Tolerancia a risco:</strong> {{ socio.risco }}</li>{% endif %}
                </ul>
              </div>
            {% else %}
              <p class="story-note">
                Ainda nao registramos os socios com papel definido nesta etapa. O registro pode ser feito no modulo de alinhamento.
              </p>
            {% endfor %}
          </div>
        </div>

        {% if alinhamento.principios %}
          <div class="story-block">
            <h4>Principios orientadores</h4>
            <ul class="story-list">
              {% for principio in alinhamento.principios %}
                <li>{{ principio }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% set agenda = alinhamento.agenda or [] %}
        {% if agenda %}
          <div class="story-block">
            <h4>Agenda de convergencia</h4>
            <p>A agenda resume os compromissos que sustentam a implantacao e garantem ritmo de execucao.</p>
            <table class="model7-table">
              <thead>
                <tr>
                  <th>O que</th>
                  <th>Quem</th>
                  <th>Quando</th>
                  <th>Como</th>
                </tr>
              </thead>
              <tbody>
                {% for item in agenda %}
                  <tr>
                    <td>{{ item.oque }}</td>
                    <td>{{ item.quem }}</td>
                    <td>{{ item.quando }}</td>
                    <td>{{ item.como }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Modelo & Mercado -->
    <section class="page portrait">
      <div class="section-header">
        <span>02</span>
        <h3>Modelo & Mercado</h3>
      </div>
      <div class="section-body">
        {% for segmento in segmentos %}
          <div class="model7-card" style="margin-bottom: 24px;">
            <h4>{{ segmento.nome }}</h4>
            <div class="two-column">
              <div>
                <strong>Publico-alvo</strong>
                <ul>
                  {% for item in segmento.proposta.publico %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
              <div>
                <strong>Diferenciais</strong>
                <ul>
                  {% for item in segmento.proposta.diferenciais %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
              <div>
                <strong>Evidencias</strong>
                <ul>
                  {% for item in segmento.proposta.comprobacoes %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              </div>
              <div>
                <strong>Personas chave</strong>
                <ul>
                  {% for persona in segmento.personas %}
                    <li><strong>{{ persona.nome }}:</strong> {{ persona.perfil }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            {% if segmento.produtos %}
              <div style="margin-top: 20px;">
                <h5 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Portfolio de produtos</h5>
                <table class="model7-table" style="font-size: 12.5px;">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th>Preco de venda</th>
                      <th>Custos variaveis</th>
                      <th>Despesas variaveis</th>
                      <th>Margem contrib. unit.</th>
                      <th>Mercado</th>
                      <th>Meta market share</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for produto in segmento.produtos %}
                      <tr>
                        <td style="min-width: 140px;">
                          <div style="font-weight: 600; color: #0f172a;">{{ produto.nome }}</div>
                          {% if produto.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>Valor:</strong> {{ produto.preco_venda.valor_formatado or '-' }}</div>
                          {% if produto.preco_venda.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.preco_venda.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>%:</strong> {{ produto.custos_variaveis.percentual_formatado or '-' }}</div>
                          <div><strong>Unit.:</strong> {{ produto.custos_variaveis.valor_formatado or '-' }}</div>
                          {% if produto.custos_variaveis.total_mensal_formatado %}
                            <div><strong>Mensal:</strong> {{ produto.custos_variaveis.total_mensal_formatado }}</div>
                          {% endif %}
                          {% if produto.custos_variaveis.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.custos_variaveis.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>%:</strong> {{ produto.despesas_variaveis.percentual_formatado or '-' }}</div>
                          <div><strong>Unit.:</strong> {{ produto.despesas_variaveis.valor_formatado or '-' }}</div>
                          {% if produto.despesas_variaveis.total_mensal_formatado %}
                            <div><strong>Mensal:</strong> {{ produto.despesas_variaveis.total_mensal_formatado }}</div>
                          {% endif %}
                          {% if produto.despesas_variaveis.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.despesas_variaveis.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>%:</strong> {{ produto.margem_contribuicao.percentual_formatado or '-' }}</div>
                          <div><strong>Unit.:</strong> {{ produto.margem_contribuicao.valor_formatado or '-' }}</div>
                          {% if produto.margem_contribuicao.total_mensal_formatado %}
                            <div><strong>Mensal:</strong> {{ produto.margem_contribuicao.total_mensal_formatado }}</div>
                          {% endif %}
                          {% if produto.margem_contribuicao.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.margem_contribuicao.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>Unid./mês:</strong> {{ produto.mercado.unidades_mensais_formatado or '-' }}</div>
                          <div><strong>Faturamento:</strong> {{ produto.mercado.faturamento_mensal_formatado or '-' }}</div>
                          {% if produto.mercado.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.mercado.observacoes }}</div>
                          {% endif %}
                        </td>
                        <td>
                          <div><strong>Unid./mês:</strong> {{ produto.meta_market_share.unidades_mensais_formatado or '-' }}</div>
                          <div><strong>%:</strong> {{ produto.meta_market_share.percentual_formatado or '-' }}</div>
                          {% if produto.meta_market_share.observacoes %}
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ produto.meta_market_share.observacoes }}</div>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}

            {% set totais = segmento.produtos_totais %}
            {% if totais.produtos_registrados %}
              <div class="highlight-box" style="margin-top: 18px;">
                <strong>Totais consolidados</strong>
                <ul style="margin: 12px 0 0 18px;">
                  <li>Produtos cadastrados: {{ totais.produtos_registrados }}</li>
                  {% if totais.faturamento_mensal.valor_formatado %}
                    <li>Faturamento mensal estimado: {{ totais.faturamento_mensal.valor_formatado }}</li>
                  {% endif %}
                  {% if totais.unidades_mensais.valor_formatado %}
                    <li>Unidades mensais estimadas: {{ totais.unidades_mensais.valor_formatado }}</li>
                  {% endif %}
                  {% set custos = totais.custos_variaveis %}
                  {% if custos.valor_formatado or custos.percentual_formatado %}
                    <li>Custos variaveis: {% if custos.percentual_formatado %}{{ custos.percentual_formatado }}{% endif %}{% if custos.valor_formatado %}{% if custos.percentual_formatado %} | {% endif %}{{ custos.valor_formatado }}{% endif %}</li>
                  {% endif %}
                  {% set despesas = totais.despesas_variaveis %}
                  {% if despesas.valor_formatado or despesas.percentual_formatado %}
                    <li>Despesas variaveis: {% if despesas.percentual_formatado %}{{ despesas.percentual_formatado }}{% endif %}{% if despesas.valor_formatado %}{% if despesas.percentual_formatado %} | {% endif %}{{ despesas.valor_formatado }}{% endif %}</li>
                  {% endif %}
                  {% set margem = totais.margem_contribuicao %}
                  {% if margem.valor_formatado or margem.percentual_formatado %}
                    <li>Margem de contribuicao total: {% if margem.percentual_formatado %}{{ margem.percentual_formatado }}{% endif %}{% if margem.valor_formatado %}{% if margem.percentual_formatado %} | {% endif %}{{ margem.valor_formatado }}{% endif %}</li>
                  {% endif %}
                  {% set share = totais.meta_market_share %}
                  {% if share.unidades_mensais.valor_formatado or share.percentual_formatado %}
                    <li>Meta de market share: {% if share.unidades_mensais.valor_formatado %}{{ share.unidades_mensais.valor_formatado }} un{% endif %}{% if share.percentual_formatado %}{% if share.unidades_mensais.valor_formatado %} | {% endif %}{{ share.percentual_formatado }}{% endif %}</li>
                  {% endif %}
                </ul>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </section>

    <!-- Estruturas de execucao -->
    <section class="page portrait">
      <div class="section-header">
        <span>03</span>
        <h3>Estruturas de execucao</h3>
      </div>
      <div class="section-body">
        <div class="model7-grid">
          {% for area in estruturas %}
            <div class="model7-card">
              <h4>{{ area.area }}</h4>
              {% if area.capacidade_formatada or area.capacidade %}
                <p style="font-size:13px; color:#1d4ed8; margin: 0 0 8px;">
                  Capacidade suportada: {{ area.capacidade_formatada or area.capacidade }}
                  {% if area.capacidade_observacoes %}<br><span style="color:#64748b;">{{ area.capacidade_observacoes }}</span>{% endif %}
                </p>
              {% endif %}
              <ul>
                {% for bloco in area.resumo %}
                  <li>
                    <strong>{{ bloco.escopo }}:</strong>
                    <ul style="margin-top:4px;">
                      {% for ponto in bloco.pontos %}
                        <li>{{ ponto }}</li>
                      {% endfor %}
                    </ul>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Modelagem financeira (paisagem) -->
    <section class="page landscape">
      <div class="section-header">
        <span>04</span>
        <h3>Modelagem financeira</h3>
      </div>
      <div class="section-body">
        <div class="subsection">
          <h4>Premissas</h4>
          <table class="model7-table">
            <thead>
              <tr>
                <th>Descricao</th>
                <th>Sugestao</th>
                <th>Ajustado</th>
                <th>Observacoes</th>
                <th>Memoria de calculo</th>
              </tr>
            </thead>
            <tbody>
          {% for item in financeiro.premissas or [] %}
            <tr>
              <td>{{ item.indicador }}</td>
              <td>{{ item.sugestao }}</td>
              <td>{{ item.ajustado }}</td>
              <td>{{ item.observacoes }}</td>
              <td>{{ item.memoria }}</td>
            </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="two-column">
          <div class="model7-card">
            <h4>Investimentos</h4>
            <ul>
              {% for item in financeiro.investimento.investimento or [] %}
                <li><strong>{{ item.descricao }}:</strong> {{ item.valor }}</li>
              {% endfor %}
            </ul>
          </div>
          <div class="model7-card">
            <h4>Fontes</h4>
            <ul>
              {% for item in financeiro.investimento.fontes or [] %}
                <li><strong>{{ item.categoria }} - {{ item.descricao }}:</strong> {{ item.valor }}{% if item.disponibilidade %} (disp.: {{ item.disponibilidade }}){% endif %}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="subsection">
          <h4>Capacidade operacional suportada</h4>
          <table class="model7-table">
            <thead>
              <tr>
                <th>Area</th>
                <th>Faturamento suportado</th>
                <th>Observacoes</th>
              </tr>
            </thead>
            <tbody>
              {% if financeiro.capacidades %}
                {% for item in financeiro.capacidades %}
                  <tr>
                    <td>{{ item.area }}</td>
                    <td>{{ item.valor_formatado or item.valor or '-' }}</td>
                    <td>{{ item.observacoes or '-' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="3">Nenhuma capacidade registrada</td>
                </tr>
              {% endif %}
            </tbody>
          </table>

          <div class="highlight-box" style="margin-top: 16px;">
            <strong>Resumo</strong>
            <ul style="margin: 12px 0 0 18px;">
              <li>Total suportado: {{ financeiro.resumo_capacidades.total_formatado or '-' }}</li>
              <li>Gargalo: {% if financeiro.resumo_capacidades.gargalo_valor_formatado %}{{ financeiro.resumo_capacidades.gargalo_valor_formatado }}{% if financeiro.resumo_capacidades.gargalo_area %} ({{ financeiro.resumo_capacidades.gargalo_area }}){% endif %}{% else %}-{% endif %}</li>
            </ul>
          </div>
        </div>

        <div class="subsection">
          <h4>Resultados</h4>
          {% set fluxo_financeiro = financeiro.fluxo_financeiro or {} %}
          {% set sections = fluxo_financeiro.sections or [] %}
          {% set negocio_section = (sections | selectattr('slug', 'equalto', 'negocio') | list | first) %}
          {% set negocio_linhas = negocio_section.linhas if negocio_section else [] %}
          {% if negocio_linhas %}
            {% set linha_receita = (negocio_linhas | selectattr('slug', 'equalto', 'receita') | list | first) %}
            {% set linha_custos_variaveis = (negocio_linhas | selectattr('slug', 'equalto', 'custos_variaveis') | list | first) %}
            {% set linha_despesas_variaveis = (negocio_linhas | selectattr('slug', 'equalto', 'despesas_variaveis') | list | first) %}
            {% set linha_margem = (negocio_linhas | selectattr('slug', 'equalto', 'margem_contribuicao') | list | first) %}
            {% set linha_custos_fixos = (negocio_linhas | selectattr('slug', 'equalto', 'custos_fixos') | list | first) %}
            {% set linha_despesas_fixas = (negocio_linhas | selectattr('slug', 'equalto', 'despesas_fixas') | list | first) %}
            {% set linha_resultado_operacional = (negocio_linhas | selectattr('slug', 'equalto', 'resultado_operacional') | list | first) %}
            {% set linha_destinacao = (negocio_linhas | selectattr('slug', 'equalto', 'destinacao') | list | first) %}
            {% set linha_resultado_periodo = (negocio_linhas | selectattr('slug', 'equalto', 'resultado_periodo') | list | first) %}
            {% set resultado_operacional_decimal = linha_resultado_operacional.total_decimal if linha_resultado_operacional and linha_resultado_operacional.total_decimal is not none else 0 %}
            {% set distrib_raw = (financeiro.fluxo_negocio.distribuicao_lucros.percentual or '').strip() %}
            {% set distrib_clean = distrib_raw|replace('%', '')|replace(',', '.') %}
            {% set distrib_percent = distrib_clean|float if distrib_clean else 0 %}
            {% set distrib_valor = resultado_operacional_decimal * distrib_percent / 100 %}
            {% set outras_regras = financeiro.fluxo_negocio.destinacao_regras or [] %}
            {% set outros = namespace(percent=0.0) %}
            {% for regra in outras_regras %}
              {% set regra_raw = (regra.percentual or '').strip() %}
              {% set regra_clean = regra_raw|replace('%', '')|replace(',', '.') %}
              {% if regra_clean %}
                {% set outros.percent = outros.percent + (regra_clean|float) %}
              {% endif %}
            {% endfor %}
            {% set outros_percent = outros.percent %}
            {% set outros_valor = resultado_operacional_decimal * outros_percent / 100 %}
            {% set destinacao_total_decimal = linha_destinacao.total_decimal if linha_destinacao and linha_destinacao.total_decimal is not none else (distrib_valor + outros_valor) %}
            {% set resultado_periodo_decimal = linha_resultado_periodo.total_decimal if linha_resultado_periodo and linha_resultado_periodo.total_decimal is not none else (resultado_operacional_decimal - destinacao_total_decimal) %}
            {% set resultado_final_class = 'positive' if resultado_periodo_decimal >= 0 else 'negative' %}
            <div class="result-summary-grid">
              <div class="result-card">
                <span class="label">Faturamento total</span>
                <span class="value">{{ linha_receita.total if linha_receita else 'R$ 0,00' }}</span>
                <span class="note">Soma dos períodos planejados</span>
              </div>
              <div class="result-card">
                <span class="label">Custos variáveis</span>
                <span class="value">{{ linha_custos_variaveis.total if linha_custos_variaveis else 'R$ 0,00' }}</span>
              </div>
              <div class="result-card">
                <span class="label">Despesas variáveis</span>
                <span class="value">{{ linha_despesas_variaveis.total if linha_despesas_variaveis else 'R$ 0,00' }}</span>
              </div>
              <div class="result-card">
                <span class="label">Margem de contribuição</span>
                <span class="value">{{ linha_margem.total if linha_margem else 'R$ 0,00' }}</span>
              </div>
            </div>
            <div class="result-summary-grid">
              <div class="result-card">
                <span class="label">Custos fixos</span>
                <span class="value">{{ linha_custos_fixos.total if linha_custos_fixos else 'R$ 0,00' }}</span>
              </div>
              <div class="result-card">
                <span class="label">Despesas fixas</span>
                <span class="value">{{ linha_despesas_fixas.total if linha_despesas_fixas else 'R$ 0,00' }}</span>
              </div>
              <div class="result-card">
                <span class="label">Resultado operacional</span>
                <span class="value">{{ linha_resultado_operacional.total if linha_resultado_operacional else 'R$ 0,00' }}</span>
              </div>
              <div class="result-card">
                <span class="label">Destinações de resultados</span>
                <span class="value">{{ format_currency_br(destinacao_total_decimal) }}</span>
                <span class="note">
                  Distribuição: {{ format_percent_br(distrib_percent) }}
                  {% if outros_percent %}
                    • Outras: {{ format_percent_br(outros_percent) }}
                  {% endif %}
                </span>
              </div>
              <div class="result-card {{ resultado_final_class }}">
                <span class="label">Resultado final após destinações</span>
                <span class="value">{{ format_currency_br(resultado_periodo_decimal) }}</span>
                <span class="note">Resultado operacional - destinações</span>
              </div>
            </div>
          {% else %}
            <p style="margin: 12px 0 0; color: #64748b;">Sem dados de resultados cadastrados.</p>
          {% endif %}
        </div>

        <div class="subsection">
          <h4>Fluxo de caixa do negocio</h4>
          <table class="model7-table">
            <thead>
              <tr>
                <th>Periodo</th>
                <th>Receita</th>
                <th>Variaveis</th>
                <th>Margem contrib.</th>
                <th>Fixos</th>
                <th>Resultado operativo</th>
                <th>Destinacao</th>
                <th>Resultado periodo</th>
              </tr>
            </thead>
            <tbody>
              {% for linha in financeiro.fluxo_negocio.periodos or [] %}
                <tr>
                  <td>{{ linha.periodo }}</td>
                  <td>{{ linha.receita }}</td>
                  <td>{{ linha.variaveis }}</td>
                  <td>{{ linha.margem_contribuicao }}</td>
                  <td>{{ linha.fixos }}</td>
                  <td>{{ linha.resultado_operacional }}</td>
                  <td>
                    <ul style="margin:0; padding-left:16px;">
                      {% for destino in linha.destinacao %}
                        <li>{{ destino.descricao }} - {{ destino.valor }}</li>
                      {% endfor %}
                    </ul>
                  </td>
                  <td>{{ linha.resultado_periodo }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="two-column">
            <table class="model7-table">
              <thead>
                <tr>
                  <th>Custos e despesas variaveis</th>
                  <th>% sobre faturamento</th>
                </tr>
              </thead>
              <tbody>
              {% for item in financeiro.fluxo_negocio.variaveis or [] %}
                  <tr>
                    <td>{{ item.descricao }}</td>
                    <td>{{ item.percentual }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            <table class="model7-table">
              <thead>
                <tr>
                  <th>Destinacao de resultados</th>
                  <th>% resultado operativo</th>
                  <th>Periodicidade</th>
                </tr>
              </thead>
              <tbody>
                {% for item in financeiro.fluxo_negocio.destinacao_regras or [] %}
                  <tr>
                    <td>{{ item.descricao }}</td>
                    <td>{{ item.percentual }}</td>
                    <td>{{ item.periodicidade }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="subsection">
          <h4>Fluxo de caixa do investidor</h4>
          <table class="model7-table">
            <thead>
              <tr>
                <th>Periodo</th>
                <th>Aporte</th>
                <th>Distribuicao</th>
                <th>Saldo periodo</th>
                <th>Saldo acumulado</th>
              </tr>
            </thead>
            <tbody>
              {% for linha in financeiro.fluxo_investidor.periodos or [] %}
                <tr>
                  <td>{{ linha.periodo }}</td>
                  <td>{{ linha.aporte }}</td>
                  <td>{{ linha.distribuicao }}</td>
                  <td>{{ linha.saldo }}</td>
                  <td>{{ linha.acumulado }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="highlight-box" style="margin-top: 18px;">
            <strong>Analises</strong>
            <ul style="margin:12px 0 0 18px;">
              {% set analises = financeiro.fluxo_investidor.analises or {} %}
              {% set tir_label = analises.tir_label or ('TIR ' ~ (analises.tir_horizon_years or 5) ~ ' anos') %}
              <li>Payback: {{ analises.payback | default('-', true) }}</li>
              <li>Custo de oportunidade: {{ analises.opportunity_cost | default('1%', true) }}</li>
              <li>{{ tir_label }}: {{ analises.tir | default('-', true) }}</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Rodape -->
    <section class="page portrait footer-page" style="page-break-after: auto;">
      <span>Versus Gestao Corporativa - Todos os Direitos Reservados - Emitido em: {{ issued_at }}</span>
      <span>Consultor responsavel: {{ plan.consultant }}</span>
    </section>
  </article>
</body>
</html>
