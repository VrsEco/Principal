{% extends "base.html" %}
{% block title %}ModeFin - Modelagem Financeira | Implantacao{% endblock %}
{% block body %}{% set active_nav = 'pev' %}{{ super() }}{% endblock %}

{% block content %}
<div class="project-layout plan-layout" data-sidebar-toggle>
  
  {# Sidebar de Implantacao #}
  {% set active_id = 'modefin' %}
  
  <section class="project-content plan-content">

<style>
  /* Layout Padrao GRV */
  .app-main {
    padding: 40px 20px 64px !important;
    background: linear-gradient(135deg, #ffffff 0%, #f7f7f9 50%, #f1f2f4 100%) !important;
    color: #0f172a !important;
    overflow-x: hidden !important;
  }

  .project-layout.plan-layout {
    max-width: 100% !important;
    width: 100% !important;
    grid-template-columns: 1fr !important;
    gap: 0 !important;
  }
  
  .project-content.plan-content {
    max-width: 1120px !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: auto !important;
    transform: scale(0.9);
    transform-origin: top left;
    /* Compensa a reducao para manter a largura visual e evitar sobra */
    width: calc(100% / 0.9) !important;
    max-width: calc(1120px / 0.9) !important;
  }
  
  /* Cards adaptados ao padrao GRV */
  .modefin-section {
    margin-bottom: 24px;
    padding: 16px;
    border-radius: 12px;
    background: linear-gradient(180deg, #f6f7f9 0%, #f1f2f4 100%);
    border: 1px solid #e5e7eb;
  }
  
  .surface-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .modefin-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  
  .modefin-card h2 {
    margin: 0 0 20px;
    font-size: 20px;
    font-weight: 600;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Card com destaque/gradiente para resumos */
  .modefin-card-highlight {
    background: #ffffff;
    border: 1px solid rgba(148, 163, 184, 0.2);
    color: #0f172a;
  }
  
  .modefin-card-highlight h2,
  .modefin-card-highlight h3 {
    color: #0f172a;
  }
  
  .modefin-card h3 {
    margin: 0 0 16px;
    font-size: 16px;
    font-weight: 600;
    color: #0f172a;
  }
  
  /* Grid de valores */
  .values-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .value-box {
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
  }
  
  .value-box:hover {
    background: linear-gradient(180deg, #ffffff 0%, #f6f7f9 100%);
    box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
  }
  
  .value-box.highlighted {
    background: linear-gradient(180deg, #eef2ff 0%, #e2e8f0 100%);
    border: 1px solid #c7d2fe;
    box-shadow: 0 2px 10px rgba(79, 70, 229, 0.08);
  }
  
  .value-label {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 6px;
  }
  
  .value-amount {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  
  .value-percent {
    font-size: 13px;
    opacity: 0.85;
  }
  
  /* Botoes Padrao GRV/PEV */
  .button {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #ffffff;
    color: #0f172a;
    position: relative;
    overflow: hidden;
  }
  
  .button:hover {
    background: #f8fafc;
  }
  
  .button::before,
  .button::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 3px;
    pointer-events: none;
  }
  
  .button::before {
    left: 0;
    background: linear-gradient(180deg, #a78bfa 0%, #22d3ee 50%, #60a5fa 100%);
    opacity: 0.6;
  }
  
  .button::after {
    right: 0;
    background: linear-gradient(180deg, #60a5fa 0%, #22d3ee 50%, #a78bfa 100%);
    opacity: 0.6;
  }
  
  .button-ghost {
    background: transparent;
    border: 1px solid rgba(148, 163, 184, 0.3);
    color: #475569;
  }
  
  .button-ghost:hover {
    background: rgba(148, 163, 184, 0.1);
  }
  
  .button-primary {
    background: #ffffff;
    color: #0f172a;
    border-color: #94a3b8;
  }
  
  .button-primary:hover {
    background: #f8fafc;
  }
  
  .button-secondary {
    background: #ffffff;
    color: #0f172a;
    border-color: #cbd5e1;
  }
  
  .button-secondary:hover {
    background: #f8fafc;
  }
  
  /* Tabelas */
  .modefin-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    margin-top: 16px;
  }
  
  .modefin-table thead {
    background: #e5e7eb !important; /* titulos */
  }
  
  .modefin-table th {
    padding: 12px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #e5e7eb;
    background: #e5e7eb !important; /* garante cor nos th mesmo com inline no thead */
    border-right: 1px solid #e5e7eb;
  }
  
  .modefin-table td {
    padding: 12px;
    color: #1e293b;
    font-size: 14px;
    border-top: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb; /* linhas verticais (grade) */
  }
  .modefin-table th:last-child,
  .modefin-table td:last-child { border-right: none; }

  /* Subtitulos: linhas especiais no corpo */
  .modefin-table tbody tr.subheader > td,
  .modefin-table tbody tr.subheader > th,
  .modefin-table tbody tr.section-subtitle > td,
  .modefin-table tbody tr.section-subtitle > th {
    background: #f1f5f9;
    font-weight: 600;
  }

  /* Zebra striping nos dados */
  .modefin-table tbody tr:nth-child(odd) { background: #ffffff; }
  .modefin-table tbody tr:nth-child(even) { background: #f8fafc; }
  
  .modefin-table tbody tr:hover {
    background: #f8fafc;
  }
  
  /* Planilha de investimentos (layout especial) */
  .investment-sheet {
    display: flex;
    gap: 0;
    overflow: hidden;
    border-radius: 12px;
    background: white;
    margin-top: 16px;
  }
  
  .sheet-fixed {
    flex-shrink: 0;
    min-width: 250px;
    border-right: 2px solid #e2e8f0;
  }
  
  .sheet-scrollable {
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
  }
  
  .sheet-row {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    min-height: 44px;
    align-items: center;
  }
  
  .sheet-row:first-child {
    background: #f8fafc;
    font-weight: 600;
    color: #475569;
  }
  
  .sheet-row.total-row {
    background: #fef3c7;
    font-weight: 700;
  }
  
  .sheet-cell {
    padding: 12px;
    font-size: 14px;
    color: #1e293b;
    white-space: nowrap;
  }
  
  .sheet-cell-header {
    min-width: 120px;
    text-align: center;
    font-weight: 600;
    color: #475569;
    font-size: 12px;
    text-transform: uppercase;
  }
  
  /* Modals */
  .modal {
    display: none;
    position: fixed;
    z-index: 25000; /* Padrao do sistema - modais sempre acima de botoes flutuantes (10000-19999) */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }
  
  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    color: #0f172a;
  }
  
  .modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #94a3b8;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
  }
  
  .modal-close:hover {
    color: #64748b;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    font-weight: 500;
    color: #334155;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    font-size: 14px;
    color: #1e293b;
    transition: all 0.2s;
    box-sizing: border-box;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .form-group textarea {
    min-height: 100px;
    resize: vertical;
  }
  
  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
  }
  
  /* Alert/Info boxes */
  .info-box {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    margin-top: 16px;
  }
  
  .info-box.info {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
    border-left: 3px solid #3b82f6;
  }
  
  .info-box.success {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
    border-left: 3px solid #22c55e;
  }
  
  .info-box.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #92400e;
    border-left: 3px solid #f59e0b;
  }
  
  /* Action buttons in tables */
  .action-btn {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .action-btn.edit {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .action-btn.edit:hover {
    background: #bfdbfe;
  }
  
  .action-btn.delete {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .action-btn.delete:hover {
    background: #fecaca;
  }
</style>

<!-- Header -->
<div class="surface-card" style="padding: 24px; margin-bottom: 20px;" {{ ui_attrs.get('1', '')|safe }}>
  <h1 style="margin: 0 0 8px; font-size: 28px; color: #0f172a; font-weight: 600;">
     ModeFin - Modelagem Financeira
  </h1>
  <p style="margin: 0; color: #64748b; font-size: 14px;">
    Plano: <strong style="color: #0f172a;">{{ plan.name }}</strong>
  </p>
  <div style="margin-top: 12px;">
    <a href="{{ url_for('pev.pev_implantacao_overview', plan_id=plan_id) }}" class="button button-ghost" style="font-size: 13px; padding: 8px 16px;" {{ ui_attrs.get('2', '')|safe }}>
      ‚Üê Voltar para Implantacao
    </a>
  </div>
</div>

<!-- Secoes -->
<div id="secao-resultados" class="modefin-section" {{ ui_attrs.get('10', '')|safe }}></div>
<div id="secao-investimentos" class="modefin-section" {{ ui_attrs.get('20', '')|safe }}></div>
<div id="secao-fontes" class="modefin-section" {{ ui_attrs.get('30', '')|safe }}></div>
<div id="secao-distribuicao" class="modefin-section" {{ ui_attrs.get('40', '')|safe }}></div>
<div id="secao-fluxo-investimento" class="modefin-section" {{ ui_attrs.get('50', '')|safe }}></div>
<div id="secao-fluxo-negocio" class="modefin-section" {{ ui_attrs.get('60', '')|safe }}></div>
<div id="secao-fluxo-investidor" class="modefin-section" {{ ui_attrs.get('70', '')|safe }}></div>
<div id="secao-analise" class="modefin-section" {{ ui_attrs.get('80', '')|safe }}></div>

  </section>
</div>

<!-- ========== MODALS ========== -->
<div class="modal" id="capitalGiroModal"></div>
<div class="modal" id="fundingSourceModal"></div>
<div class="modal" id="profitDistributionModal"></div>
<div class="modal" id="resultRuleModal"></div>
<div class="modal" id="executiveSummaryModal"></div>

<script>
  // =========================================
  // DADOS DO BACKEND
  // =========================================
  const planId = {{ plan_id }};
  const uiScreenCode = {{ ui_screen_code }};
  const uiCatalog = {{ ui_catalog_payload | tojson | safe }};
  const productsTotals = {{ products_totals | tojson | safe }};
  const fixedCostsSummary = {{ fixed_costs_summary | tojson | safe }};
  const investimentosEstruturas = {{ investimentos_estruturas | tojson | safe }};
  const capitalGiroItems = {{ capital_giro_items | tojson | safe }};
  const fundingSources = {{ funding_sources | tojson | safe }};
  const profitDistribution = {{ profit_distribution | tojson | safe }};
  const resultRules = {{ result_rules | tojson | safe }};
  const executiveSummary = {{ executive_summary | tojson | safe }};
  const parcelasEstruturas = {{ parcelas_estruturas | tojson | safe }};
  const fixedCostEntries = {{ fixed_cost_entries | tojson | safe }};
  const rampProducts = {{ modefin_ramp | tojson | safe }};
  const financeiro = {{ financeiro | tojson | safe }};
  const businessPrecalc = (() => {
    const map = {};
    const periodos = financeiro?.fluxo_negocio?.periodos || [];
    periodos.forEach(periodo => {
      const key =
        normalizeMonthKey(periodo?.periodo_chave) ||
        normalizeMonthKey(periodo?.periodo) ||
        normalizeMonthKey(periodo?.periodo_curto);
      if (!key) {
        return;
      }
      map[key] = {
        revenue: parseNumeric(periodo?.receita),
        cost: parseNumeric(periodo?.variaveis),
        expense: parseNumeric(periodo?.despesas_variaveis),
        margin: parseNumeric(periodo?.margem_contribuicao),
      };
    });
    return map;
  })();
  
  // =========================================
  // UI Catalog Helpers
  // =========================================
  function escapeAttr(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function uiAttr(objectCode, fallbackUiCode) {
    const key = String(objectCode);
    const entry = uiCatalog && uiCatalog[key];
    if (!entry) {
      const fallback = fallbackUiCode || `${uiScreenCode}-${key}`;
      return `data-ui-code="${escapeAttr(fallback)}"`;
    }
    const attrs = [`data-ui-code="${escapeAttr(entry.ui_code)}"`];
    if (entry.name) {
      attrs.push(`data-ui-name="${escapeAttr(entry.name)}"`);
    }
    if (entry.object_type) {
      attrs.push(`data-ui-type="${escapeAttr(entry.object_type)}"`);
    }
    if (entry.route) {
      attrs.push(`data-ui-route="${escapeAttr(entry.route)}"`);
    }
    return attrs.join(' ');
  }

  // =========================================
  // UTILIDADES
  // =========================================
  
  function formatCurrency(value) {
    if (!value) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value);
  }
  
  function formatPercent(value) {
    if (!value) return '0%';
    return `${parseFloat(value).toFixed(1)}%`;
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('pt-BR');
  }

  function parseNumeric(value) {
    if (value === null || value === undefined) {
      return null;
    }
    if (typeof value === 'number') {
      return Number.isFinite(value) ? value : null;
    }
    const text = String(value).trim();
    if (!text) {
      return null;
    }
    const normalized = text
      .replace(/R\$/gi, '')
      .replace(/\s+/g, '')
      .replace(/\./g, '')
      .replace(',', '.');
    const result = Number(normalized);
    return Number.isFinite(result) ? result : null;
  }

  function formatMonthLabel(monthKey) {
    const normalized = normalizeMonthKey(monthKey);
    if (!normalized) {
      return '-';
    }
    const date = new Date(`${normalized}-01T00:00:00`);
    if (Number.isNaN(date.getTime())) {
      return normalized;
    }
    return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace('.', '');
  }

  function formatMonthYear(monthKey) {
    const normalized = normalizeMonthKey(monthKey);
    if (!normalized) {
      return '-';
    }
    const date = new Date(`${normalized}-01T00:00:00`);
    if (Number.isNaN(date.getTime())) {
      return normalized;
    }
    const monthName = date.toLocaleDateString('pt-BR', { month: 'long' });
    const year = date.getFullYear();
    return `${monthName.charAt(0).toUpperCase() + monthName.slice(1)}/${year}`;
  }

  function buildFixedCostsTimeline(meses) {
    const timeline = {};
    meses.forEach(mes => {
      timeline[mes] = { custo: 0, despesa: 0 };
    });

    if (!Array.isArray(fixedCostEntries)) {
      return timeline;
    }

    fixedCostEntries.forEach(entry => {
      if (!entry) {
        return;
      }
      const startMonth = entry.start_month || entry.startMonth;
      if (!startMonth) {
        return;
      }
      const tipo = entry.type === 'despesa' ? 'despesa' : 'custo';
      const rawValue = entry.monthly_value ?? entry.monthlyValue ?? 0;
      const monthlyValue = Number(rawValue);
      if (!Number.isFinite(monthlyValue) || monthlyValue <= 0) {
        return;
      }
      meses.forEach(mes => {
        if (mes >= startMonth) {
          if (!timeline[mes]) {
            timeline[mes] = { custo: 0, despesa: 0 };
          }
          timeline[mes][tipo] += monthlyValue;
        }
      });
    });

    return timeline;
  }
  function nextMonthKey(monthKey) {
    const normalized = normalizeMonthKey(monthKey);
    if (!normalized) {
      return null;
    }
    const [yearStr, monthStr] = normalized.split('-');
    let year = Number(yearStr);
    let month = Number(monthStr);
    if (!Number.isInteger(year) || !Number.isInteger(month)) {
      return null;
    }
    month += 1;
    if (month > 12) {
      month = 1;
      year += 1;
    }
    return year + '-' + String(month).padStart(2, '0');
  }

  function monthDiff(startKey, endKey) {
    const start = normalizeMonthKey(startKey);
    const end = normalizeMonthKey(endKey);
    if (!start || !end) {
      return 0;
    }
    const [startYear, startMonth] = start.split('-').map(Number);
    const [endYear, endMonth] = end.split('-').map(Number);
    return (endYear - startYear) * 12 + (endMonth - startMonth);
  }

  function gerarSequenciaMeses(primeiroMes) {
    const mesesSet = new Set();

    const primeiraReferencia =
      normalizeMonthKey(primeiroMes) ||
      normalizeMonthKey(rampDataset?.startMonth) ||
      normalizeMonthKey((new Date()).toISOString().slice(0, 7));

    if (primeiraReferencia) {
      mesesSet.add(primeiraReferencia);
    }

    function coletarMes(valor) {
      const key = normalizeMonthKey(valor);
      if (key) {
        mesesSet.add(key);
      }
    }

    (rampDataset?.products || []).forEach(item => {
      (item.entries || []).forEach(entry => coletarMes(entry.month));
    });

    (fixedCostEntries || []).forEach(entry => coletarMes(entry?.start_month || entry?.startMonth));

    (parcelasEstruturas || []).forEach(parcela => {
      coletarMes(parcela?.due_info || parcela?.vencimento || parcela?.month || parcela?.reference_month);
    });

    (capitalGiroItems || []).forEach(item => coletarMes(item?.contribution_date));

    (fundingSources || []).forEach(fonte => coletarMes(fonte?.contribution_date || fonte?.availability || fonte?.date));

    (profitDistribution || []).forEach(dist => coletarMes(dist?.start_date));

    (resultRules || []).forEach(regra => coletarMes(regra?.start_date));

    const valoresOrdenados = Array.from(mesesSet).filter(Boolean).sort();
    const inicio = valoresOrdenados.length ? valoresOrdenados[0] : primeiraReferencia;
    const ultimo = valoresOrdenados.length ? valoresOrdenados[valoresOrdenados.length - 1] : inicio;

    let horizonte = monthDiff(inicio, ultimo) + 12;
    if (!Number.isFinite(horizonte) || horizonte < 0) {
      horizonte = 0;
    }
    const tamanhoDesejado = Math.max(horizonte, 60);

    const mesesSequencia = [];
    let atual = inicio;
    for (let index = 0; index <= tamanhoDesejado; index += 1) {
      const chave = normalizeMonthKey(atual);
      if (chave) {
        mesesSequencia.push(chave);
      }
      const proximo = nextMonthKey(atual);
      if (!proximo) {
        break;
      }
      atual = proximo;
    }

    return mesesSequencia;
  }

  function normalizeMonthKey(value) {
    if (value === null || value === undefined) {
      return '';
    }
    const text = String(value).trim();
    if (!text) {
      return '';
    }
    if (/^\d{4}-\d{2}$/.test(text)) {
      return text;
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(text)) {
      return text.slice(0, 7);
    }
    const match = text.match(/^(\d{2})\/(\d{4})$/);
    if (match) {
      return `${match[2]}-${match[1]}`;
    }
    return '';
  }

  function clampRampPercentage(value) {
    if (value === null || value === undefined) {
      return 0;
    }
    const numberValue = typeof value === 'number'
      ? value
      : Number(String(value).trim().replace(',', '.'));
    if (!Number.isFinite(numberValue)) {
      return 0;
    }
    if (numberValue < 0) {
      return 0;
    }
    if (numberValue > 100) {
      return 100;
    }
    return numberValue;
  }

  function resolveRampPercentage(entries, monthKey) {
    if (!entries || entries.length === 0) {
      return 100;
    }
    if (!monthKey) {
      return 0;
    }
    const firstMonth = entries[0].month;
    if (monthKey < firstMonth) {
      return 0;
    }
    let current = entries[0].percentage;
    for (let index = 0; index < entries.length; index += 1) {
      const entry = entries[index];
      if (entry.month <= monthKey) {
        current = entry.percentage;
      } else {
        break;
      }
    }
    const lastMonth = entries[entries.length - 1].month;
    if (monthKey > lastMonth) {
      return 100;
    }
    return clampRampPercentage(current);
  }

  function buildRampDataset(products, totals) {
    const dataset = {
      base: { revenue: 0, cost: 0, expense: 0, margin: 0 },
      products: [],
      cache: {},
      startMonth: null,
    };

    const items = Array.isArray(products) ? products : [];

    items.forEach(item => {
      const summary = item && item.ramp_up_summary ? item.ramp_up_summary : {};
      const baseRevenue = Number(summary.base_revenue || 0);
      const baseCost = Number(summary.base_cost || 0);
      const baseExpense = Number(summary.base_expense || 0);
      let baseMargin = Number(summary.base_margin || 0);
      if (!baseMargin && baseRevenue) {
        baseMargin = baseRevenue - baseCost - baseExpense;
      }

      dataset.base.revenue += baseRevenue;
      dataset.base.cost += baseCost;
      dataset.base.expense += baseExpense;
      dataset.base.margin += baseMargin;

      const rawEntries = Array.isArray(item?.ramp_up_entries)
        ? item.ramp_up_entries
        : [];
      const normalizedEntries = [];

      rawEntries.forEach(entry => {
        const monthKey = normalizeMonthKey(entry && (entry.month || entry.reference_month));
        if (!monthKey) {
          return;
        }
        const percentage = clampRampPercentage(entry && (entry.percentage ?? entry.percent ?? entry.value));
        normalizedEntries.push({ month: monthKey, percentage });
      });

      normalizedEntries.sort((a, b) => a.month.localeCompare(b.month));
      if (normalizedEntries.length) {
        const firstMonth = normalizedEntries[0].month;
        if (!dataset.startMonth || firstMonth < dataset.startMonth) {
          dataset.startMonth = firstMonth;
        }
      }

      dataset.products.push({
        base: {
          revenue: baseRevenue,
          cost: baseCost,
          expense: baseExpense,
          margin: baseMargin,
        },
        entries: normalizedEntries,
      });
    });

    if (!dataset.base.revenue && totals && totals.faturamento && totals.faturamento.valor) {
      dataset.base.revenue = Number(totals.faturamento.valor) || 0;
    }
    if (!dataset.base.cost && totals && totals.custos_variaveis && totals.custos_variaveis.valor) {
      dataset.base.cost = Number(totals.custos_variaveis.valor) || 0;
    }
    if (!dataset.base.expense && totals && totals.despesas_variaveis && totals.despesas_variaveis.valor) {
      dataset.base.expense = Number(totals.despesas_variaveis.valor) || 0;
    }
    if (!dataset.base.margin) {
      dataset.base.margin = dataset.base.revenue - dataset.base.cost - dataset.base.expense;
    }

    return dataset;
  }

  function getRampMetrics(monthKey) {
    const key = normalizeMonthKey(monthKey);
    if (!key) {
      return { revenue: 0, cost: 0, expense: 0, margin: 0 };
    }

    if (rampDataset.cache[key]) {
      return rampDataset.cache[key];
    }

    if (!rampDataset.products.length) {
      const fallbackRevenue = rampDataset.base.revenue || Number(productsTotals?.faturamento?.valor || 0);
      const fallbackCost = rampDataset.base.cost || Number(productsTotals?.custos_variaveis?.valor || 0);
      const fallbackExpense = rampDataset.base.expense || Number(productsTotals?.despesas_variaveis?.valor || 0);
      const fallbackMargin = fallbackRevenue - fallbackCost - fallbackExpense;
      const cached = {
        revenue: fallbackRevenue,
        cost: fallbackCost,
        expense: fallbackExpense,
        margin: fallbackMargin,
      };
      rampDataset.cache[key] = cached;
      return cached;
    }

    if (rampDataset.startMonth && key < rampDataset.startMonth) {
      const zeroMetrics = { revenue: 0, cost: 0, expense: 0, margin: 0 };
      rampDataset.cache[key] = zeroMetrics;
      return zeroMetrics;
    }

    let revenue = 0;
    let cost = 0;
    let expense = 0;
    let percentageWeightedSum = 0;
    let percentageWeight = 0;

    const hasRampEntries = rampDataset.products.some(product => (product.entries || []).length > 0);

    rampDataset.products.forEach(item => {
      const entries = item.entries || [];
      const percentage = resolveRampPercentage(entries, key) / 100;
      const base = item.base || {};
      const baseRevenue = Number(base.revenue || 0);
      const baseCost = Number(base.cost || 0);
      const baseExpense = Number(base.expense || 0);
      revenue += baseRevenue * percentage;
      cost += baseCost * percentage;
      expense += baseExpense * percentage;

      const weight = baseRevenue || baseCost || baseExpense ? Math.max(baseRevenue, baseCost, baseExpense, 1) : 1;
      percentageWeightedSum += percentage * weight;
      percentageWeight += weight;
    });

    let effectivePercentage;
    if (percentageWeight > 0) {
      effectivePercentage = percentageWeightedSum / percentageWeight;
    } else if (rampDataset.startMonth) {
      effectivePercentage = key >= rampDataset.startMonth ? 1 : 0;
    } else {
      effectivePercentage = 1;
    }
    if (effectivePercentage < 0) effectivePercentage = 0;
    if (effectivePercentage > 1) effectivePercentage = 1;

    const fallbackRevenueBase = rampDataset.base.revenue || Number(productsTotals?.faturamento?.valor || 0);
    const fallbackCostBase = rampDataset.base.cost || Number(productsTotals?.custos_variaveis?.valor || 0);
    const fallbackExpenseBase = rampDataset.base.expense || Number(productsTotals?.despesas_variaveis?.valor || 0);

    if (hasRampEntries && rampDataset.startMonth && key < rampDataset.startMonth) {
      revenue = 0;
      cost = 0;
      expense = 0;
    } else {
      if (revenue <= 0 && fallbackRevenueBase > 0) {
        revenue = fallbackRevenueBase * effectivePercentage;
      }
      if (cost <= 0 && fallbackCostBase > 0) {
        cost = fallbackCostBase * effectivePercentage;
      }
      if (expense <= 0 && fallbackExpenseBase > 0) {
        expense = fallbackExpenseBase * effectivePercentage;
      }
    }

    let margin;
    if (!hasRampEntries) {
      const precomputed = businessPrecalc[key] || null;
      if (precomputed) {
        if (precomputed.revenue !== null) {
          revenue = precomputed.revenue;
        }
        if (precomputed.cost !== null) {
          cost = precomputed.cost;
        }
        if (precomputed.expense !== null) {
          expense = precomputed.expense;
        }
        if (precomputed.margin !== null) {
          margin = precomputed.margin;
        }
      }
    }

    if (margin === undefined) {
      margin = revenue - cost - expense;
    }

    const metrics = { revenue, cost, expense, margin };
    rampDataset.cache[key] = metrics;
    return metrics;
  }
  function logStub(functionName) {
    console.warn(`${functionName} ainda nao foi implementada neste modo de visualizacao.`);
  }

  function openCapitalGiroModal() { logStub('openCapitalGiroModal'); }
  function closeCapitalGiroModal() { logStub('closeCapitalGiroModal'); }
  function saveCapitalGiro() { logStub('saveCapitalGiro'); }
  function editCapitalGiro() { logStub('editCapitalGiro'); }
  function deleteCapitalGiro() { logStub('deleteCapitalGiro'); }

  function openFundingSourceModal() { logStub('openFundingSourceModal'); }
  function closeFundingSourceModal() { logStub('closeFundingSourceModal'); }
  function saveFundingSource() { logStub('saveFundingSource'); }
  function editFundingSource() { logStub('editFundingSource'); }
  function deleteFundingSource() { logStub('deleteFundingSource'); }

  function openProfitDistributionModal() { logStub('openProfitDistributionModal'); }
  function closeProfitDistributionModal() { logStub('closeProfitDistributionModal'); }
  function saveProfitDistribution() { logStub('saveProfitDistribution'); }

  function openResultRuleModal() { logStub('openResultRuleModal'); }
  function closeResultRuleModal() { logStub('closeResultRuleModal'); }
  function saveResultRule() { logStub('saveResultRule'); }
  function editResultRule() { logStub('editResultRule'); }
  function deleteResultRule() { logStub('deleteResultRule'); }

  function toggleResultRuleType() { logStub('toggleResultRuleType'); }
  const rampDataset = buildRampDataset(rampProducts || [], productsTotals || {});

  
  async function apiCall(url, method = 'GET', data = null) {
    try {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      };
      
      if (data && method !== 'GET') {
        options.body = JSON.stringify(data);
      }
      
      const response = await fetch(url, options);
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Erro na requisicao');
      }
      
      return result;
    } catch (error) {
      console.error('[API Error]', error);
      alert('Erro: ' + error.message);
      throw error;
    }
  }
  
  // =========================================
  // SEO 1: RESULTADOS
  // =========================================
  
  function renderResultados() {
    const faturamento = productsTotals?.faturamento?.valor || 0;
    const custosVariaveis = productsTotals?.custos_variaveis?.valor || 0;
    const despesasVariaveis = productsTotals?.despesas_variaveis?.valor || 0;
    const margemContribuicao = productsTotals?.margem_contribuicao?.valor || 0;
    
    const custosFixos = fixedCostsSummary?.custos_fixos_mensal || 0;
    const despesasFixas = fixedCostsSummary?.despesas_fixas_mensal || 0;
    const resultadoOperacional = margemContribuicao - custosFixos - despesasFixas;
    
    const html = `
      <div class="modefin-card" ${uiAttr('11')}>
        <h2> Resultados</h2>
        
        <!-- Card de Destaque com Gradiente para Resumo -->
        <div class="modefin-card-highlight" style="border-radius: 12px; padding: 20px; margin-bottom: 20px;"
>
        
        <h3>Margem de Contribuicao</h3>
        <div class="values-grid">
          <div class="value-box">
            <div class="value-label">Faturamento</div>
            <div class="value-amount">${formatCurrency(faturamento)}</div>
            <div class="value-percent">${formatPercent(productsTotals?.faturamento?.percentual)}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Custos Variaveis</div>
            <div class="value-amount">${formatCurrency(custosVariaveis)}</div>
            <div class="value-percent">${formatPercent(productsTotals?.custos_variaveis?.percentual)}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Despesas Variaveis</div>
            <div class="value-amount">${formatCurrency(despesasVariaveis)}</div>
            <div class="value-percent">${formatPercent(productsTotals?.despesas_variaveis?.percentual)}</div>
          </div>
          <div class="value-box highlighted">
            <div class="value-label"> Margem de Contribuicao</div>
            <div class="value-amount">${formatCurrency(margemContribuicao)}</div>
            <div class="value-percent">${formatPercent(productsTotals?.margem_contribuicao?.percentual)}</div>
          </div>
        </div>
        
        <h3 style="margin-top: 24px;">Custos e Despesas Fixas</h3>
        <div class="values-grid">
          <div class="value-box">
            <div class="value-label">Custos Fixos</div>
            <div class="value-amount">${formatCurrency(custosFixos)}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Despesas Fixas</div>
            <div class="value-amount">${formatCurrency(despesasFixas)}</div>
          </div>
          <div class="value-box highlighted">
            <div class="value-label"> Resultado Operacional</div>
            <div class="value-amount">${formatCurrency(resultadoOperacional)}</div>
          </div>
        </div>
        
        </div>
        
        <div class="info-box info">
           <strong>Valores automaticos:</strong> Calculados com base em 
          <a href="/pev/implantacao/modelo/produtos?plan_id=${planId}" style="color: #3b82f6; text-decoration: underline;">Produtos</a> e 
          <a href="/pev/implantacao/executivo/estruturas?plan_id=${planId}" style="color: #3b82f6; text-decoration: underline;">Estruturas</a>.
        </div>
      </div>
    `;
    
    document.getElementById('secao-resultados').innerHTML = html;
  }
  
  // =========================================
  // SEO 2: INVESTIMENTOS
  // =========================================
  
  function renderInvestimentos() {
    const totais = {
      caixa: 0,
      recebiveis: 0,
      estoques: 0,
      instalacoes: 0,
      maquinas: 0,
      moveis: 0,
      ti: 0,
      outros: 0
    };
  
    (capitalGiroItems || []).forEach(item => {
      const tipo = (item.item_type || '').toLowerCase();
      const valor = parseFloat(item.amount || 0);
      if (!Number.isFinite(valor) || !tipo) return;
      if (totais[tipo] !== undefined) {
        totais[tipo] += valor;
      }
    });
  
    if (investimentosEstruturas) {
      const mapaEstruturas = {
        instalacoes: investimentosEstruturas.instalacoes,
        maquinas: investimentosEstruturas.maquinas,
        moveis: investimentosEstruturas.moveis,
        ti: investimentosEstruturas.ti,
        outros: investimentosEstruturas.outros_investimentos
      };
      Object.entries(mapaEstruturas).forEach(([chave, dados]) => {
        const total = parseFloat(dados?.total || 0);
        if (Number.isFinite(total)) {
          totais[chave] += total;
        }
      });
    }
  
    const totalCapitalGiro = totais.caixa + totais.recebiveis + totais.estoques;
    const totalImobilizado = totais.instalacoes + totais.maquinas + totais.moveis + totais.ti + totais.outros;
    const totalGeral = totalCapitalGiro + totalImobilizado;
  
    const capitalLabels = { caixa: 'Caixa', recebiveis: 'Recebiveis', estoques: 'Estoques' };
    const capitalDetalhes = (capitalGiroItems || [])
      .map(item => {
        const tipo = capitalLabels[item.item_type?.toLowerCase()] || 'Outro';
        const descricao = (item.description || '').trim() || '-';
        const data = formatDate(item.contribution_date);
        const valor = formatCurrency(parseFloat(item.amount || 0));
        const id = item.id || '';
        return `
          <tr>
            <td>${tipo}</td>
            <td>${descricao}</td>
            <td>${data}</td>
            <td style="text-align: right;">${valor}</td>
            <td style="text-align: center;">
              <button class="action-btn edit" onclick="editCapitalGiro('${id}')">Editar</button>
              <button class="action-btn delete" onclick="deleteCapitalGiro('${id}')">Excluir</button>
            </td>
          </tr>
        `;
      })
      .join('');
  
    const imobilizadoDetalhes = Object.entries(investimentosEstruturas || {})
      .map(([slug, dados]) => {
        const total = parseFloat(dados?.total || 0);
        if (!Number.isFinite(total) || total <= 0) {
          return '';
        }
        const nome = dados?.label || dados?.nome || slug.replace(/_/g, ' ');
        return `
          <tr>
            <td>${nome}</td>
            <td style="text-align: right;">${formatCurrency(total)}</td>
          </tr>
        `;
      })
      .filter(Boolean)
      .join('');
  
    const html = `
      <div class="modefin-card" ${uiAttr('20')}>
        <h2>Investimentos</h2>
  
        <div class="values-grid">
          <div class="value-box highlighted">
            <div class="value-label">Total Investimentos</div>
            <div class="value-amount">${formatCurrency(totalGeral)}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Capital de Giro</div>
            <div class="value-amount">${formatCurrency(totalCapitalGiro)}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Imobilizado</div>
            <div class="value-amount">${formatCurrency(totalImobilizado)}</div>
          </div>
        </div>
  
        <div style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">Investimentos por Bloco</h3>
          <button class="button" ${uiAttr('21')} onclick="openCapitalGiroModal()">+ Capital de Giro</button>
        </div>
  
        <table class="modefin-table">
          <thead>
            <tr>
              <th>Bloco</th>
              <th style="text-align: right;">Total</th>
              <th>Origem</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Caixa</strong></td>
              <td style="text-align: right;">${formatCurrency(totais.caixa)}</td>
              <td><span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Capital de Giro</span></td>
            </tr>
            <tr>
              <td><strong>Recebiveis</strong></td>
              <td style="text-align: right;">${formatCurrency(totais.recebiveis)}</td>
              <td><span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Capital de Giro</span></td>
            </tr>
            <tr>
              <td><strong>Estoques</strong></td>
              <td style="text-align: right;">${formatCurrency(totais.estoques)}</td>
              <td><span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Capital de Giro</span></td>
            </tr>
            ${totais.instalacoes > 0 ? `
              <tr>
                <td><strong>Instalacoes</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.instalacoes)}</td>
                <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Estruturas</span></td>
              </tr>
            ` : ''}
            ${totais.maquinas > 0 ? `
              <tr>
                <td><strong>Maquinas</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.maquinas)}</td>
                <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Estruturas</span></td>
              </tr>
            ` : ''}
            ${totais.moveis > 0 ? `
              <tr>
                <td><strong>Moveis</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.moveis)}</td>
                <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Estruturas</span></td>
              </tr>
            ` : ''}
            ${totais.ti > 0 ? `
              <tr>
                <td><strong>TI</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.ti)}</td>
                <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Estruturas</span></td>
              </tr>
            ` : ''}
            ${totais.outros > 0 ? `
              <tr>
                <td><strong>Outros</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.outros)}</td>
                <td><span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Estruturas</span></td>
              </tr>
            ` : ''}
          </tbody>
        </table>
  
        <div style="margin-top: 32px;">
          <h3 style="margin-bottom: 12px;">Capital de Giro Detalhado</h3>
          <table class="modefin-table">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Descricao</th>
                <th>Data</th>
                <th style="text-align: right;">Valor</th>
                <th style="text-align: center;">Acoes</th>
              </tr>
            </thead>
            <tbody>
              ${capitalDetalhes || `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 16px; color: #64748b;">
                    Nenhum investimento de capital de giro cadastrado.
                  </td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
  
        <div style="margin-top: 32px;">
          <h3 style="margin-bottom: 12px;">Imobilizado por Categoria</h3>
          <table class="modefin-table">
            <thead>
              <tr>
                <th>Categoria</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${imobilizadoDetalhes || `
                <tr>
                  <td colspan="2" style="text-align: center; padding: 16px; color: #64748b;">
                    Nenhum investimento em imobilizado registrado.
                  </td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
    </div>
    `;
  
    document.getElementById('secao-investimentos').innerHTML = html;
  }

  function renderFontes() {
    const fontes = Array.isArray(fundingSources) ? fundingSources : [];
    const categoriaLabels = {
      capital_proprio: 'Capital Proprio',
      capital: 'Capital Proprio',
      aporte: 'Aporte',
      emprestimos: 'Emprestimos',
      emprestimo: 'Emprestimos',
      fornecedores: 'Fornecedores',
      investidores: 'Investidores',
      investors: 'Investidores',
      outros: 'Outros'
    };

    const totais = fontes.reduce((acc, fonte) => {
      const categoriaNorm = (fonte.category || 'outros').toLowerCase();
      const valor = parseFloat(fonte.amount || 0);
      if (!Number.isFinite(valor)) {
        return acc;
      }
      acc.total += valor;
      if (!acc.categorias[categoriaNorm]) {
        acc.categorias[categoriaNorm] = 0;
      }
      acc.categorias[categoriaNorm] += valor;
      return acc;
    }, { total: 0, categorias: {} });

    const cards = Object.entries(totais.categorias).map(([categoria, valor]) => `
      <div class="value-box">
        <div class="value-label">${categoriaLabels[categoria] || categoria}</div>
        <div class="value-amount">${formatCurrency(valor)}</div>
      </div>
    `).join('');

    const linhas = fontes.map(fonte => {
      const categoria = (fonte.category || 'outros').toLowerCase();
      const descricao = (fonte.description || '').trim() || '-';
      const disponibilidade = formatDate(fonte.availability || fonte.contribution_date);
      const valor = formatCurrency(parseFloat(fonte.amount || 0));
      const id = fonte.id || '';
      return `
        <tr>
          <td>${categoriaLabels[categoria] || categoria}</td>
          <td>${descricao}</td>
          <td>${disponibilidade}</td>
          <td style="text-align: right;">${valor}</td>
          <td style="text-align: center;">
            <button class="action-btn edit" onclick="editFundingSource('${id}')">Editar</button>
            <button class="action-btn delete" onclick="deleteFundingSource('${id}')">Excluir</button>
          </td>
        </tr>
      `;
    }).join('');

    const html = `
      <div class="modefin-card" ${uiAttr('30')}>
        <h2>Fontes de Recursos</h2>

        <div class="values-grid">
          <div class="value-box highlighted">
            <div class="value-label">Total de Recursos</div>
            <div class="value-amount">${formatCurrency(totais.total)}</div>
          </div>
          ${cards || `
            <div class="value-box">
              <div class="value-label">Sem categorias</div>
              <div class="value-amount">R$ 0,00</div>
            </div>
          `}
        </div>

        <div style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;">Fontes cadastradas</h3>
          <button class="button" ${uiAttr('31')} onclick="openFundingSourceModal()">+ Nova Fonte</button>
        </div>

        <table class="modefin-table">
          <thead>
            <tr>
              <th>Categoria</th>
              <th>Descricao</th>
              <th>Disponibilidade</th>
              <th style="text-align: right;">Valor</th>
              <th style="text-align: center;">Acoes</th>
            </tr>
          </thead>
          <tbody>
            ${linhas || `
              <tr>
                <td colspan="5" style="text-align: center; padding: 16px; color: #64748b;">
                  Nenhuma fonte cadastrada ate o momento.
                </td>
              </tr>
            `}
          </tbody>
        </table>
      </div>
    `;

    document.getElementById('secao-fontes').innerHTML = html;
  }

  function renderDistribuicao() {
    const percDistribuicao = profitDistribution && profitDistribution.length > 0
      ? parseFloat(profitDistribution[0].percentage || profitDistribution[0].profit_distribution_percent || profitDistribution[0].value || 0)
      : 0;
    const inicioDistribuicao = profitDistribution && profitDistribution.length > 0
      ? formatDate(profitDistribution[0].start_date)
      : '-';

    const totaisDestinacoes = (resultRules || []).reduce((acc, regra) => {
      if (!regra) {
        return acc;
      }
      if ((regra.rule_type || '').toLowerCase() === 'percentage') {
        const perc = parseFloat(regra.percentage ?? regra.value ?? 0);
        if (Number.isFinite(perc)) {
          acc.percentual += perc;
        }
      } else {
        const valor = parseFloat(regra.value ?? 0);
        if (Number.isFinite(valor)) {
          acc.fixo += valor;
        }
      }
      return acc;
    }, { percentual: 0, fixo: 0 });

    const linhas = (resultRules || []).map(regra => {
      const id = regra.id || '';
      const tipo = (regra.rule_type || '').toLowerCase() === 'percentage' ? 'Percentual' : 'Valor Fixo';
      const valor = (regra.rule_type || '').toLowerCase() === 'percentage'
        ? formatPercent(regra.percentage ?? regra.value ?? 0)
        : formatCurrency(regra.value || 0);
      const inicio = regra.start_date ? formatDate(regra.start_date) : '-';
      const periodicidade = (regra.periodicity || '').trim() || '-';
      const descricao = (regra.description || '').trim() || '-';
      const observacoes = (regra.notes || '').trim() || '-';
      return `
        <tr>
          <td>${descricao}</td>
          <td>${tipo}</td>
          <td style="text-align: right;">${valor}</td>
          <td>${inicio}</td>
          <td>${periodicidade}</td>
          <td>${observacoes}</td>
          <td style="text-align: center;">
            <button class="action-btn edit" onclick="editResultRule('${id}')">Editar</button>
            <button class="action-btn delete" onclick="deleteResultRule('${id}')">Excluir</button>
          </td>
        </tr>
      `;
    }).join('');

    const html = `
      <div class="modefin-card" ${uiAttr('40')}>
        <h2>Distribuicao de Resultados</h2>
        <p style="font-size: 14px; opacity: 0.85; margin-bottom: 18px;">
          Configure como o resultado operacional sera distribuido entre lucros e outras destinacoes estrategicas.
        </p>

        <div class="values-grid">
          <div class="value-box">
            <div class="value-label">Distribuicao de Lucros (%)</div>
            <div class="value-amount">${formatPercent(percDistribuicao)}</div>
            <div class="value-percent" style="font-size: 11px;">Inicio ${inicioDistribuicao}</div>
          </div>
          <div class="value-box">
            <div class="value-label">Outras destinacoes (%)</div>
            <div class="value-amount">${totaisDestinacoes.percentual.toFixed(1)}%</div>
            <div class="value-percent" style="font-size: 11px;">Regras percentuais cadastradas</div>
          </div>
          <div class="value-box">
            <div class="value-label">Destinacoes fixas mensais</div>
            <div class="value-amount">${formatCurrency(totaisDestinacoes.fixo)}</div>
            <div class="value-percent" style="font-size: 11px;">Valores fixos aplicados por periodo</div>
          </div>
        </div>

        <div style="margin-top: 24px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
          <button class="button button-ghost" ${uiAttr('41')} onclick="openProfitDistributionModal()">Configurar distribuicao de lucros</button>
          <button class="button" onclick="openResultRuleModal()">+ Nova destinacao</button>
        </div>

        <table class="modefin-table" style="margin-top: 20px;">
          <thead>
            <tr>
              <th>Descricao</th>
              <th>Tipo</th>
              <th style="text-align: right;">Valor / Percentual</th>
              <th>Inicio</th>
              <th>Periodicidade</th>
              <th>Observacoes</th>
              <th style="text-align: center;">Acoes</th>
            </tr>
          </thead>
          <tbody>
            ${linhas || `
              <tr>
                <td colspan="7" style="text-align: center; padding: 16px; color: #64748b;">
                  Nenhuma destinacao adicional cadastrada.
                </td>
              </tr>
            `}
          </tbody>
        </table>

        <div class="info-box info" style="margin-top: 16px;">
          Defina percentuais para aplicar sobre o resultado operacional positivo ou valores fixos para provisionamentos recorrentes.
        </div>
      </div>
    `;

    document.getElementById('secao-distribuicao').innerHTML = html;
  }

  function calcularFluxoInvestimento() {
    const timeline = {};
    const mesesSet = new Set();

    function registrar(mesBruto, campo, valor) {
      const chave = normalizeMonthKey(mesBruto);
      if (!chave) {
        return;
      }
      const numero = parseFloat(valor || 0);
      if (!Number.isFinite(numero) || numero === 0) {
        return;
      }
      if (!timeline[chave]) {
        timeline[chave] = { investimentos: 0, fontes: 0 };
      }
      timeline[chave][campo] += numero;
      mesesSet.add(chave);
    }

    (capitalGiroItems || []).forEach(item => {
      registrar(item.contribution_date, 'investimentos', item.amount);
    });

    (parcelasEstruturas || []).forEach(parcela => {
      const valor = parcela.valor || parcela.amount || parcela.total || parcela.valor_parcela;
      const data = parcela.due_info || parcela.vencimento || parcela.month || parcela.reference_month;
      registrar(data, 'investimentos', valor);
    });

    (fundingSources || []).forEach(fonte => {
      registrar(fonte.contribution_date || fonte.availability || fonte.date, 'fontes', fonte.amount);
    });

    const meses = Array.from(mesesSet).sort();
    let saldoAcumulado = 0;

    const fluxoPorMes = {};
    meses.forEach(mes => {
      const investimento = timeline[mes]?.investimentos || 0;
      const fonte = timeline[mes]?.fontes || 0;
      const saldoPeriodo = fonte - investimento;
      saldoAcumulado += saldoPeriodo;
      fluxoPorMes[mes] = {
        mes,
        investimentos: investimento,
        fontes: fonte,
        saldoPeriodo,
        saldoAcumulado
      };
    });

    const totais = meses.reduce((acc, mes) => {
      const dados = fluxoPorMes[mes];
      acc.investimentos += dados.investimentos;
      acc.fontes += dados.fontes;
      acc.saldoPeriodo += dados.saldoPeriodo;
      return acc;
    }, { investimentos: 0, fontes: 0, saldoPeriodo: 0 });

    return {
      meses,
      fluxoPorMes,
      totais,
      saldoFinal: saldoAcumulado
    };
  }

  function renderFluxoInvestimento() {
    const fluxoData = calcularFluxoInvestimento();

    const html = `
      <div class="modefin-card" ${uiAttr('50')}>
        <h2>Fluxo de Caixa do Investimento</h2>
        <p style="font-size: 14px; opacity: 0.85; margin-bottom: 18px;">
          Acompanhe os desembolsos planejados e as fontes de financiamento ao longo do tempo.
        </p>

        <div style="overflow-x: auto;">
          <table class="modefin-table">
            <thead>
              <tr>
                <th style="min-width: 120px;">Periodo</th>
                <th style="min-width: 150px; text-align: right;">Investimentos</th>
                <th style="min-width: 150px; text-align: right;">Fontes de Recursos</th>
                <th style="min-width: 150px; text-align: right;">Saldo do Periodo</th>
                <th style="min-width: 150px; text-align: right;">Saldo Acumulado</th>
              </tr>
            </thead>
            <tbody>
              ${renderFluxoInvestimentoRows(fluxoData)}
            </tbody>
            <tfoot>
              <tr>
                <td><strong>TOTAL</strong></td>
                <td style="text-align: right;">${formatCurrency(fluxoData.totais.investimentos)}</td>
                <td style="text-align: right;">${formatCurrency(fluxoData.totais.fontes)}</td>
                <td style="text-align: right;">${formatCurrency(fluxoData.totais.saldoPeriodo)}</td>
                <td style="text-align: right; color: ${fluxoData.saldoFinal >= 0 ? '#059669' : '#dc2626'};">
                  <strong>${formatCurrency(fluxoData.saldoFinal)}</strong>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="info-box info" style="margin-top: 16px;">
          Use esta visao para verificar se as fontes de financiamento cobrem os desembolsos de capital planejados.
        </div>
      </div>
    `;

    document.getElementById('secao-fluxo-investimento').innerHTML = html;
  }

  function renderFluxoInvestimentoRows(fluxoData) {
    if (!fluxoData.meses.length) {
      return `
        <tr>
          <td colspan="5" style="text-align: center; padding: 16px; color: #64748b;">
            Nenhum investimento planejado registrado.
          </td>
        </tr>
      `;
    }

    return fluxoData.meses.map(mes => {
      const dados = fluxoData.fluxoPorMes[mes];
      return `
        <tr>
          <td><strong>${formatMonthLabel(mes)}</strong></td>
          <td style="text-align: right; color: #dc2626;">${formatCurrency(dados.investimentos)}</td>
          <td style="text-align: right; color: #059669;">${formatCurrency(dados.fontes)}</td>
          <td style="text-align: right; color: ${dados.saldoPeriodo >= 0 ? '#059669' : '#dc2626'};">
            ${formatCurrency(dados.saldoPeriodo)}
          </td>
          <td style="text-align: right; color: ${dados.saldoAcumulado >= 0 ? '#059669' : '#dc2626'};">
            ${formatCurrency(dados.saldoAcumulado)}
          </td>
        </tr>
      `;
    }).join('');
  }
  
  function calcularFluxoNegocio() {
    const fluxoInv = calcularFluxoInvestimento();

    let primeiroMes = fluxoInv.meses.length > 0 ? fluxoInv.meses[0] : '2026-05';
    const meses = gerarSequenciaMeses(primeiroMes);

    const percDistribuicao = profitDistribution && profitDistribution.length > 0
      ? parseFloat(profitDistribution[0].percentage || profitDistribution[0].profit_distribution_percent || 0)
      : 0;

    const hasDetailedFixedCosts = Array.isArray(fixedCostEntries) && fixedCostEntries.length > 0;
    const fixedCostsTimeline = hasDetailedFixedCosts ? buildFixedCostsTimeline(meses) : {};
    const fallbackCustosFixos = fixedCostsSummary?.custos_fixos_mensal || 0;
    const fallbackDespesasFixas = fixedCostsSummary?.despesas_fixas_mensal || 0;

    const fluxoPorMes = {};
    let resultadoAcumulado = 0;

    meses.forEach(mes => {
      const metrics = getRampMetrics(mes);
      const receitaMes = metrics.revenue;
      const custoVariavelMes = metrics.cost;
      const despesaVariavelMes = metrics.expense;
      const margemMes = metrics.margin !== undefined ? metrics.margin : (receitaMes - custoVariavelMes - despesaVariavelMes);

      const custosFixosMes = hasDetailedFixedCosts
        ? (fixedCostsTimeline[mes]?.custo || 0)
        : fallbackCustosFixos;
      const despesasFixasMes = hasDetailedFixedCosts
        ? (fixedCostsTimeline[mes]?.despesa || 0)
        : fallbackDespesasFixas;
      const fixosMes = custosFixosMes + despesasFixasMes;

      const resultadoOpMes = margemMes - fixosMes;

      const mesDate = new Date(mes + '-01');
      let distribuicaoMesAtual = 0;
      if (resultadoOpMes > 0 && profitDistribution.length > 0) {
        const profitStartDate = profitDistribution[0]?.start_date;
        if (!profitStartDate || mesDate >= new Date(profitStartDate)) {
          distribuicaoMesAtual = resultadoOpMes * (percDistribuicao / 100);
        }
      }

      const outrasDestMesAtual = (resultRules || []).reduce((sum, rule) => {
        if (!rule) {
          return sum;
        }

        if (rule.start_date) {
          const inicioRegra = new Date(rule.start_date);
          if (mesDate < inicioRegra) {
            return sum;
          }
        }

        if (rule.rule_type === 'percentage') {
          if (resultadoOpMes > 0) {
            const perc = parseFloat(rule.value ?? rule.percentage ?? 0) / 100;
            if (Number.isFinite(perc) && perc > 0) {
              return sum + (resultadoOpMes * perc);
            }
          }
          return sum;
        }

        const valor = parseFloat(rule.value ?? 0);
        return sum + (Number.isFinite(valor) ? valor : 0);
      }, 0);

      const destinacaoTotal = distribuicaoMesAtual + outrasDestMesAtual;
      const resultadoPeriodo = resultadoOpMes - destinacaoTotal;
      resultadoAcumulado += resultadoPeriodo;

      fluxoPorMes[mes] = {
        mes: mes,
        receita: receitaMes,
        variaveis: custoVariavelMes + despesaVariavelMes,
        margem: margemMes,
        fixos: fixosMes,
        resultadoOp: resultadoOpMes,
        destinacoes: destinacaoTotal,
        resultadoPeriodo: resultadoPeriodo,
        resultadoAcumulado: resultadoAcumulado,
        saldoInvestimentos: fluxoInv.fluxoPorMes[mes]?.saldoAcumulado || 0,
        saldoTotal: resultadoAcumulado + (fluxoInv.fluxoPorMes[mes]?.saldoAcumulado || 0)
      };
    });

    return {
      meses: meses,
      fluxoPorMes: fluxoPorMes
    };
  }

  function renderFluxoNegocio() {
    const fluxoData = calcularFluxoNegocio();

    const totais = fluxoData.meses.reduce((acc, mes, index) => {
      const dados = fluxoData.fluxoPorMes[mes];
      acc.receita += dados.receita;
      acc.variaveis += dados.variaveis;
      acc.margem += dados.margem;
      acc.fixos += dados.fixos;
      acc.resultadoOp += dados.resultadoOp;
      acc.destinacoes += dados.destinacoes;
      acc.resultadoPeriodo += dados.resultadoPeriodo;
      if (index === fluxoData.meses.length - 1) {
        acc.resultadoAcumulado = dados.resultadoAcumulado;
        acc.saldoInvestimentos = dados.saldoInvestimentos;
        acc.saldoTotal = dados.saldoTotal;
      }
      return acc;
    }, {
      receita: 0,
      variaveis: 0,
      margem: 0,
      fixos: 0,
      resultadoOp: 0,
      destinacoes: 0,
      resultadoPeriodo: 0,
      resultadoAcumulado: 0,
      saldoInvestimentos: 0,
      saldoTotal: 0
    });

    const html = `
      <div class="modefin-card" ${uiAttr('60')}>
        <h2>Fluxo de Caixa do Negocio</h2>
        <p style="font-size: 14px; opacity: 0.85; margin-bottom: 18px;">
          Resultado operacional mensal considerando receitas projetadas (ramp-up), custos variaveis e fixos configurados.
        </p>

        <div style="overflow-x: auto; max-height: 600px;">
          <table class="modefin-table">
            <thead>
              <tr>
                <th style="min-width: 120px;">Periodo</th>
                <th style="min-width: 140px; text-align: right;">Receita</th>
                <th style="min-width: 140px; text-align: right;">Variaveis</th>
                <th style="min-width: 140px; text-align: right;">Margem de Contribuicao</th>
                <th style="min-width: 140px; text-align: right;">Fixos</th>
                <th style="min-width: 150px; text-align: right;">Resultado Operacional</th>
                <th style="min-width: 150px; text-align: right;">Destinacoes</th>
                <th style="min-width: 150px; text-align: right;">Resultado do Periodo</th>
                <th style="min-width: 150px; text-align: right;">Resultado Acumulado</th>
                <th style="min-width: 150px; text-align: right;">Saldo Investimentos</th>
                <th style="min-width: 150px; text-align: right;">Saldo Total</th>
              </tr>
            </thead>
            <tbody>
              ${renderFluxoNegocioRows(fluxoData)}
            </tbody>
            <tfoot>
              <tr>
                <td><strong>TOTAL</strong></td>
                <td style="text-align: right;">${formatCurrency(totais.receita)}</td>
                <td style="text-align: right;">${formatCurrency(totais.variaveis)}</td>
                <td style="text-align: right;">${formatCurrency(totais.margem)}</td>
                <td style="text-align: right;">${formatCurrency(totais.fixos)}</td>
                <td style="text-align: right;">${formatCurrency(totais.resultadoOp)}</td>
                <td style="text-align: right;">${formatCurrency(totais.destinacoes)}</td>
                <td style="text-align: right; color: ${totais.resultadoPeriodo >= 0 ? '#059669' : '#dc2626'};">
                  ${formatCurrency(totais.resultadoPeriodo)}
                </td>
                <td style="text-align: right; color: ${totais.resultadoAcumulado >= 0 ? '#059669' : '#dc2626'};">
                  ${formatCurrency(totais.resultadoAcumulado)}
                </td>
                <td style="text-align: right; color: ${totais.saldoInvestimentos >= 0 ? '#059669' : '#dc2626'};">
                  ${formatCurrency(totais.saldoInvestimentos)}
                </td>
                <td style="text-align: right; color: ${totais.saldoTotal >= 0 ? '#059669' : '#dc2626'};">
                  ${formatCurrency(totais.saldoTotal)}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="info-box info" style="margin-top: 16px;">
          Receita segue o ramp-up configurado em Produtos. Custos fixos respeitam as datas de aquisicao e contratacao definidas nas Estruturas de Execucao e destinacoes somente sao aplicadas quando ha resultado operacional positivo.
        </div>
      </div>
    `;

    document.getElementById('secao-fluxo-negocio').innerHTML = html;
  }

  function renderFluxoNegocioRows(fluxoData) {
    if (fluxoData.meses.length === 0) {
      return `
        <tr>
          <td colspan="11" style="text-align: center; padding: 24px; color: #64748b;">
            Nenhum periodo cadastrado.
          </td>
        </tr>
      `;
    }
    
    return fluxoData.meses.map(mes => {
      const data = fluxoData.fluxoPorMes[mes];
      
      return `
        <tr>
          <td><strong>${formatMonthLabel(mes)}</strong></td>
          <td style="text-align: right; color: #059669;">${formatCurrency(data.receita)}</td>
          <td style="text-align: right; color: #dc2626;">${formatCurrency(data.variaveis)}</td>
          <td style="text-align: right;"><strong>${formatCurrency(data.margem)}</strong></td>
          <td style="text-align: right; color: #dc2626;">${formatCurrency(data.fixos)}</td>
          <td style="text-align: right;"><strong>${formatCurrency(data.resultadoOp)}</strong></td>
          <td style="text-align: right; color: #dc2626;">${formatCurrency(data.destinacoes)}</td>
          <td style="text-align: right; color: ${data.resultadoPeriodo >= 0 ? '#059669' : '#dc2626'};">
            <strong>${formatCurrency(data.resultadoPeriodo)}</strong>
          </td>
          <td style="text-align: right; background: #fef3c7; color: ${data.resultadoAcumulado >= 0 ? '#166534' : '#991b1b'};">
            <strong>${formatCurrency(data.resultadoAcumulado)}</strong>
          </td>
          <td style="text-align: right; background: #dbeafe; color: ${data.saldoInvestimentos >= 0 ? '#166534' : '#991b1b'};">
            <strong>${formatCurrency(data.saldoInvestimentos)}</strong>
          </td>
          <td style="text-align: right; background: #dcfce7; color: ${data.saldoTotal >= 0 ? '#166534' : '#991b1b'};">
            <strong>${formatCurrency(data.saldoTotal)}</strong>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // =========================================
  // SEO 7: FLUXO DE CAIXA DO INVESTIDOR
  // =========================================
  
  function renderFluxoInvestidor() {
    const fluxoData = calcularFluxoInvestidor();
    
    const html = `
      <div class="modefin-card" ${uiAttr('70')}>
        <h2> Fluxo de Caixa do Investidor</h2>
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">
          Visao do investidor: aportes, investimentos, retornos e distribuicoes
        </p>
        
        <div style="overflow-x: auto; max-height: 600px; overflow-y: auto; border-radius: 8px;">
          <table class="modefin-table">
            <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
              <tr>
                <th style="min-width: 100px; position: sticky; top: 0; background: #f8fafc;">Periodo</th>
                <th style="min-width: 150px; text-align: right;">Aporte / Investimento</th>
                <th style="min-width: 160px; text-align: right;">Distribuicao de Lucros</th>
                <th style="min-width: 140px; text-align: right;">Saldo do Periodo</th>
                <th style="min-width: 140px; text-align: right;">Saldo Acumulado</th>
              </tr>
            </thead>
            <tbody>
              ${renderFluxoInvestidorRows(fluxoData)}
            </tbody>
            <tfoot style="position: sticky; bottom: 0; background: #f8fafc; font-weight: 700; box-shadow: 0 -2px 4px rgba(0,0,0,0.1);">
              <tr>
                <td><strong>TOTAL</strong></td>
                <td style="text-align: right;">${formatCurrency(fluxoData.totais.aportes)}</td>
                <td style="text-align: right;">${formatCurrency(fluxoData.totais.distribuicao)}</td>
                <td style="text-align: right;">-</td>
                <td style="text-align: right;">-</td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <div class="info-box ${fluxoData.saldoFinal >= 0 ? 'success' : 'info'}" style="margin-top: 16px;">
          ${fluxoData.saldoFinal >= 0 
            ? ' <strong>Retorno Positivo:</strong> O investidor esta recuperando o capital investido.'
            : ' <strong>Em Recuperacao:</strong> O investidor ainda esta na fase de aporte. O retorno vira dos lucros futuros.'
          }
        </div>
      </div>
    `;
    
    document.getElementById('secao-fluxo-investidor').innerHTML = html;
  }
  
  function calcularFluxoInvestidor() {
    // Combinar fluxos de investimento e negocio
    const fluxoInv = calcularFluxoInvestimento();
    const fluxoNeg = calcularFluxoNegocio();
    
    // Unir todos os meses
    const mesesSet = new Set([...fluxoInv.meses, ...fluxoNeg.meses]);
    const meses = Array.from(mesesSet).sort();
    
    const fluxoPorMes = {};
    let saldoAcumulado = 0;
    
    const totais = {
      aportes: 0,
      distribuicao: 0,
      saldoPeriodo: 0
    };
    
    // Distribuicao mensal
    const percDistribuicao = profitDistribution && profitDistribution.length > 0 
      ? parseFloat(profitDistribution[0].percentage || profitDistribution[0].profit_distribution_percent || 0) 
      : 0;
    
    meses.forEach(mes => {
      const mesData = {
        mes: mes,
        aportes: 0,
        distribuicao: 0,
        saldoPeriodo: 0,
        saldoAcumulado: 0
      };
      
      // Aportes/Investimentos = Fontes de Recursos (capital aportado)
      const invMes = fluxoInv.fluxoPorMes[mes];
      if (invMes && invMes.fontes > 0) {
        mesData.aportes = invMes.fontes; // Fontes de Recursos
      }
      
      // Distribuicao de Lucros (positivo - recebimento)
      const negMes = fluxoNeg.fluxoPorMes[mes];
      if (negMes && negMes.resultadoOp > 0) {
        // Verificar data de inicio da distribuicao de lucros
        const mesDate = new Date(mes + '-01');
        const profitStartDate = profitDistribution && profitDistribution.length > 0 
          ? profitDistribution[0]?.start_date 
          : null;
        
        if (!profitStartDate || mesDate >= new Date(profitStartDate)) {
          mesData.distribuicao = negMes.resultadoOp * (percDistribuicao / 100);
        }
      }
      
      // Saldo do periodo (perspectiva do investidor: recebe - coloca)
      mesData.saldoPeriodo = mesData.distribuicao - mesData.aportes;
      saldoAcumulado += mesData.saldoPeriodo;
      mesData.saldoAcumulado = saldoAcumulado;
      
      // Totais
      totais.aportes += mesData.aportes;
      totais.distribuicao += mesData.distribuicao;
      totais.saldoPeriodo += mesData.saldoPeriodo;
      
      fluxoPorMes[mes] = mesData;
    });
    
    return {
      meses: meses,
      fluxoPorMes: fluxoPorMes,
      totais: totais,
      saldoFinal: saldoAcumulado
    };
  }
  
  function renderFluxoInvestidorRows(fluxoData) {
    if (fluxoData.meses.length === 0) {
      return `
        <tr>
          <td colspan="5" style="text-align: center; padding: 24px; color: #64748b;">
            Nenhum periodo com movimentacao.
          </td>
        </tr>
      `;
    }
    
    return fluxoData.meses.map(mes => {
      const data = fluxoData.fluxoPorMes[mes];
      
      return `
        <tr>
          <td><strong>${formatMonthLabel(mes)}</strong></td>
          <td style="text-align: right; color: ${data.aportes >= 0 ? '#059669' : '#dc2626'};">
            <strong>${formatCurrency(data.aportes)}</strong>
          </td>
          <td style="text-align: right; color: #059669;">
            ${data.distribuicao > 0 ? formatCurrency(data.distribuicao) : '-'}
          </td>
          <td style="text-align: right; color: ${data.saldoPeriodo >= 0 ? '#059669' : '#dc2626'};">
            <strong>${formatCurrency(data.saldoPeriodo)}</strong>
          </td>
          <td style="text-align: right; color: ${data.saldoAcumulado >= 0 ? '#059669' : '#dc2626'};">
            <strong>${formatCurrency(data.saldoAcumulado)}</strong>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // =========================================
  // SEO 8: ANALISE DE VIABILIDADE
  // =========================================
  
  function calcularMetricasFinanceiras(fluxoInvestidor, periodoAnalise, taxaAnualCustoOportunidade) {
    // Extrair fluxos de caixa (aportes e distribuicoes)
    const fluxos = [];
    const mesesLimitados = fluxoInvestidor.meses.slice(0, periodoAnalise);
    
    mesesLimitados.forEach(mes => {
      const dados = fluxoInvestidor.fluxoPorMes[mes];
      // Fluxo do investidor: negativo = aporte (sa√≠da), positivo = distribui√ß√£o (entrada)
      const fluxo = dados.distribuicao - dados.aportes;
      fluxos.push(fluxo);
    });
    
    if (fluxos.length === 0) {
      return { roi: 0, vpl: 0, tir: 0 };
    }
    
    // Calcular totais
    const totalAportes = fluxos.reduce((sum, f) => f < 0 ? sum + Math.abs(f) : sum, 0);
    const totalDistribuicoes = fluxos.reduce((sum, f) => f > 0 ? sum + f : sum, 0);
    
    // ROI = (Retorno Total / Investimento Total) * 100
    const roi = totalAportes > 0 ? ((totalDistribuicoes / totalAportes) * 100) : 0;
    
    // VPL = Soma dos fluxos descontados
    const taxaMensal = Math.pow(1 + (taxaAnualCustoOportunidade / 100), 1/12) - 1;
    let vpl = 0;
    
    fluxos.forEach((fluxo, index) => {
      const periodo = index + 1;
      const valorPresente = fluxo / Math.pow(1 + taxaMensal, periodo);
      vpl += valorPresente;
    });
    
    // TIR = Taxa que zera o VPL (m√©todo de Newton-Raphson simplificado)
    let tir = 0;
    
    // S√≥ calcular TIR se houver aportes e distribui√ß√µes
    if (totalAportes > 0 && totalDistribuicoes > 0) {
      tir = calcularTIR(fluxos);
    }
    
    return { roi, vpl, tir };
  }
  
  function calcularTIR(fluxos) {
    // M√©todo de Newton-Raphson para encontrar a taxa que zera o VPL
    // Come√ßar com um chute inicial de 10% ao m√™s
    let taxa = 0.10;
    const maxIteracoes = 100;
    const precisao = 0.0001;
    
    for (let i = 0; i < maxIteracoes; i++) {
      let vpl = 0;
      let derivada = 0;
      
      fluxos.forEach((fluxo, index) => {
        const periodo = index + 1;
        vpl += fluxo / Math.pow(1 + taxa, periodo);
        derivada -= (periodo * fluxo) / Math.pow(1 + taxa, periodo + 1);
      });
      
      // Se VPL est√° pr√≥ximo de zero, encontramos a TIR
      if (Math.abs(vpl) < precisao) {
        break;
      }
      
      // Evitar divis√£o por zero
      if (Math.abs(derivada) < 0.000001) {
        break;
      }
      
      // Newton-Raphson: x_novo = x_velho - f(x) / f'(x)
      taxa = taxa - vpl / derivada;
      
      // Limitar taxa entre -50% e 200% ao m√™s (valores razo√°veis)
      if (taxa < -0.5) taxa = -0.5;
      if (taxa > 2.0) taxa = 2.0;
    }
    
    // Converter para taxa anual equivalente
    const tirAnual = (Math.pow(1 + taxa, 12) - 1) * 100;
    
    return tirAnual;
  }
  
  function renderAnalise() {
    // Parametros de analise (buscar do financeiro ou usar defaults)
    const financeiroDados = typeof financeiro !== 'undefined' ? financeiro : {};
    const periodoAnalise = financeiroDados?.fluxo_investidor?.analises?.periodo_meses || 60; // Default: 60 meses (5 anos)
    const custoOportunidade = financeiroDados?.investimento?.custo_oportunidade || 12; // Default: 12% ao ano
    
    // Calcular Fluxo de Caixa do Investidor para metricas precisas
    const fluxoInvestidor = calcularFluxoInvestidor();
    
    // Calculos
    const totalInvestimentos = Object.values(calcularTotaisInvestimentos()).reduce((sum, val) => sum + val, 0);
    const resultadoOperacional = (productsTotals?.margem_contribuicao?.valor || 0) - 
                                  (fixedCostsSummary?.custos_fixos_mensal || 0) - 
                                  (fixedCostsSummary?.despesas_fixas_mensal || 0);
    
    // Payback (meses) - usando fluxo real do investidor
    let payback = 0;
    let paybackMes = null;
    let paybackMesInicio = null;
    let indiceInicio = -1;
    
    if (fluxoInvestidor.meses.length > 0) {
      // Encontrar primeiro mes com aporte (inicio do investimento)
      for (let i = 0; i < fluxoInvestidor.meses.length; i++) {
        const mes = fluxoInvestidor.meses[i];
        const dados = fluxoInvestidor.fluxoPorMes[mes];
        if (dados.aportes > 0) {
          paybackMesInicio = mes;
          indiceInicio = i;
          break;
        }
      }
      
      // Encontrar mes onde saldo acumulado fica positivo ou zero
      if (indiceInicio >= 0) {
        for (let i = indiceInicio; i < fluxoInvestidor.meses.length; i++) {
          const mes = fluxoInvestidor.meses[i];
          const dados = fluxoInvestidor.fluxoPorMes[mes];
          if (dados.saldoAcumulado >= 0) {
            paybackMes = mes;
            payback = (i - indiceInicio) + 1; // Numero de meses desde o primeiro aporte
            break;
          }
        }
        
        // Se tem inicio mas nao recuperou ainda, calcular meses ate o ultimo periodo
        if (!paybackMes) {
          payback = (fluxoInvestidor.meses.length - indiceInicio);
        }
      }
    }
    
    // Calcular metricas usando fluxo real do investidor
    const metricas = calcularMetricasFinanceiras(fluxoInvestidor, periodoAnalise, custoOportunidade);
    const roi = metricas.roi;
    const vpl = metricas.vpl;
    const tir = metricas.tir;
    
    const html = `
      <div class="modefin-card" ${uiAttr('80')}>
        <h2> Analise de Viabilidade</h2>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="margin: 0;">Metricas Calculadas</h3>
          <button class="button button-ghost" onclick="openAnalysisConfigModal()" title="Configurar parametros">
             Configurar Analise
          </button>
        </div>
        
        <div class="info-box info" style="margin-bottom: 16px;">
           <strong>Parametros:</strong> 
          Periodo de analise: <strong>${periodoAnalise} meses</strong> | 
          Custo de oportunidade: <strong>${custoOportunidade}% ao ano</strong>
          <span style="opacity: 0.8; font-size: 11px;"> (clique em "Configurar" para alterar)</span>
        </div>
        
        <div class="values-grid">
          <div class="value-box">
            <div class="value-label">Payback</div>
            <div class="value-amount">${payback > 0 ? Math.ceil(payback) + ' meses' : '-'}</div>
            <div class="value-percent" style="font-size: 11px;">
              ${paybackMesInicio && paybackMes 
                ? `${formatMonthYear(paybackMesInicio)} a ${formatMonthYear(paybackMes)}`
                : paybackMesInicio && !paybackMes
                  ? `Inicio: ${formatMonthYear(paybackMesInicio)} (ainda n√£o recuperado)`
                  : 'Tempo para recuperar investimento'
              }
            </div>
          </div>
          <div class="value-box">
            <div class="value-label">ROI (${periodoAnalise} meses)</div>
            <div class="value-amount">${roi > 0 ? roi.toFixed(1) + '%' : '-'}</div>
            <div class="value-percent" style="font-size: 11px;">Retorno sobre investimento</div>
          </div>
          <div class="value-box">
            <div class="value-label">TIR</div>
            <div class="value-amount">${tir > 0 ? tir.toFixed(1) + '% a.a.' : '-'}</div>
            <div class="value-percent" style="font-size: 11px;">Taxa Interna de Retorno</div>
          </div>
          <div class="value-box">
            <div class="value-label">VPL</div>
            <div class="value-amount">${vpl !== 0 ? formatCurrency(vpl) : '-'}</div>
            <div class="value-percent" style="font-size: 11px;">Valor Presente Liquido (${custoOportunidade}% a.a.)</div>
          </div>
        </div>
        
        <h3 style="margin-top: 32px;">Resumo Executivo</h3>
        <p style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
          Texto editavel que sera incluido no relatorio final
        </p>
        
        <div id="executive-summary-display" style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 8px; min-height: 100px; margin-top: 12px; white-space: pre-wrap;">
          ${executiveSummary || 'Nenhum resumo executivo cadastrado. Clique em "Editar" para adicionar.'}
        </div>
        
        <button class="button" onclick="openExecutiveSummaryModal()" style="margin-top: 12px;">
           Editar Resumo Executivo
        </button>
      </div>
    `;
    
    document.getElementById('secao-analise').innerHTML = html;
  }
  
  function calcularTotaisInvestimentos() {
    const totais = { caixa: 0, recebiveis: 0, estoques: 0, instalacoes: 0, maquinas: 0, moveis: 0, ti: 0, outros: 0 };
    
    capitalGiroItems.forEach(item => {
      const tipo = item.item_type?.toLowerCase();
      if (totais[tipo] !== undefined) {
        totais[tipo] += parseFloat(item.amount || 0);
      }
    });
    
    if (investimentosEstruturas.instalacoes) totais.instalacoes = parseFloat(investimentosEstruturas.instalacoes.total || 0);
    if (investimentosEstruturas.maquinas) totais.maquinas = parseFloat(investimentosEstruturas.maquinas.total || 0);
    if (investimentosEstruturas.moveis) totais.moveis = parseFloat(investimentosEstruturas.moveis.total || 0);
    if (investimentosEstruturas.ti) totais.ti = parseFloat(investimentosEstruturas.ti.total || 0);
    if (investimentosEstruturas.outros_investimentos) totais.outros = parseFloat(investimentosEstruturas.outros_investimentos.total || 0);
    
    return totais;
  }

  function openResultRuleModal(ruleId = null) {
    const modalElement = document.getElementById('resultRuleModal');
    if (!modalElement) {
      return;
    }

    const regras = Array.isArray(resultRules) ? resultRules : [];
    const regraAtual = regra => String(regra?.id) === String(ruleId);
    const dadosRegra = regraAtual ? regras.find(regraAtual) : null;
    const tipoInicial = (dadosRegra?.rule_type || 'percentage').toLowerCase() === 'fixed' ? 'fixed' : 'percentage';

    modalElement.dataset.editingId = ruleId ? String(ruleId) : '';
    modalElement.dataset.ruleType = tipoInicial;

    const modalHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>${ruleId ? 'Editar Destinacao' : 'Nova Destinacao'}</h3>
          <button class="modal-close" onclick="closeResultRuleModal()"></button>
        </div>

        <div class="form-group">
          <label>Descricao</label>
          <input type="text" id="rr-description" value="${dadosRegra?.description || ''}" placeholder="Ex: Reserva de contingencia" required>
        </div>

        <div class="form-group">
          <label>Tipo de Regra</label>
          <div id="rr-type-toggle" style="display: flex; gap: 8px;">
            <button type="button" class="button button-ghost" data-rule-type="percentage" onclick="toggleResultRuleType('percentage')">Percentual</button>
            <button type="button" class="button button-ghost" data-rule-type="fixed" onclick="toggleResultRuleType('fixed')">Valor Fixo</button>
          </div>
        </div>

        <div class="form-group" data-field="percentage">
          <label>Percentual (%)</label>
          <input type="number" id="rr-percentage" min="0" max="100" step="0.1" value="${dadosRegra?.percentage ?? dadosRegra?.value ?? ''}" placeholder="Ex: 10">
          <small style="font-size: 12px; color: #64748b;">Sera aplicado sobre o resultado operacional positivo.</small>
        </div>

        <div class="form-group" data-field="value">
          <label>Valor Fixo (R$)</label>
          <input type="number" id="rr-value" min="0" step="0.01" value="${dadosRegra?.value ?? ''}" placeholder="Ex: 5000,00">
          <small style="font-size: 12px; color: #64748b;">Valor mensal fixo a ser provisionado.</small>
        </div>

        <div class="form-group">
          <label>Data de Inicio</label>
          <input type="date" id="rr-start-date" value="${dadosRegra?.start_date || ''}">
        </div>

        <div class="form-group">
          <label>Periodicidade</label>
          <input type="text" id="rr-periodicity" value="${dadosRegra?.periodicity || ''}" placeholder="Ex: mensal, trimestral">
        </div>

        <div class="form-group">
          <label>Observacoes</label>
          <textarea id="rr-notes" rows="3" placeholder="Detalhes adicionais">${dadosRegra?.notes || ''}</textarea>
        </div>

        <div class="modal-actions">
          <button class="button button-ghost" onclick="closeResultRuleModal()">Cancelar</button>
          <button class="button button-primary" onclick="saveResultRule()">${ruleId ? 'Atualizar' : 'Salvar'}</button>
        </div>
      </div>
    `;

    modalElement.innerHTML = modalHTML;
    modalElement.className = '';
    modalElement.style.cssText = `
      display: flex !important;
      opacity: 1 !important;
      position: fixed !important;
      z-index: 25000 !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
      align-items: center !important;
      justify-content: center !important;
    `;

    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        color: #000000 !important;
        padding: 32px !important;
        border-radius: 16px !important;
        max-width: 720px !important;
        width: 90% !important;
      `;
    }

    toggleResultRuleType(tipoInicial, { skipDatasetUpdate: true });
  }

  function closeResultRuleModal() {
    const modalElement = document.getElementById('resultRuleModal');
    if (!modalElement) {
      return;
    }
    modalElement.style.cssText = 'display: none !important;';
    modalElement.className = 'modal';
    modalElement.innerHTML = '';
  }

  function toggleResultRuleType(tipo, options = {}) {
    const modalElement = document.getElementById('resultRuleModal');
    if (!modalElement) {
      return;
    }

    if (!options.skipDatasetUpdate) {
      modalElement.dataset.ruleType = tipo;
    }

    const botoes = modalElement.querySelectorAll('#rr-type-toggle [data-rule-type]');
    botoes.forEach(botao => {
      const ativo = botao.dataset.ruleType === tipo;
      botao.classList.toggle('active', ativo);
      botao.classList.toggle('button-primary', ativo);
    });

    const campoPercentual = modalElement.querySelector('[data-field="percentage"]');
    const campoValor = modalElement.querySelector('[data-field="value"]');
    if (campoPercentual) {
      campoPercentual.style.display = tipo === 'percentage' ? 'block' : 'none';
    }
    if (campoValor) {
      campoValor.style.display = tipo === 'fixed' ? 'block' : 'none';
    }
  }

  async function saveResultRule() {
    const modalElement = document.getElementById('resultRuleModal');
    if (!modalElement) {
      return;
    }

    const descricao = document.getElementById('rr-description').value.trim();
    if (!descricao) {
      alert('Informe a descricao da destinacao.');
      return;
    }

    const tipo = modalElement.dataset.ruleType || 'percentage';
    const percentualInput = document.getElementById('rr-percentage');
    const valorInput = document.getElementById('rr-value');
    const inicio = document.getElementById('rr-start-date').value || null;
    const periodicidade = document.getElementById('rr-periodicity').value || null;
    const observacoes = document.getElementById('rr-notes').value || null;

    let payload = {
      description: descricao,
      rule_type: tipo,
      start_date: inicio,
      periodicity: periodicidade,
      notes: observacoes
    };

    if (tipo === 'percentage') {
      const percentual = parseFloat(percentualInput?.value || 0);
      if (!Number.isFinite(percentual) || percentual < 0 || percentual > 100) {
        alert('Informe um percentual valido entre 0 e 100.');
        return;
      }
      payload.percentage = percentual;
      payload.value = null;
    } else {
      const valor = parseFloat(valorInput?.value || 0);
      if (!Number.isFinite(valor) || valor < 0) {
        alert('Informe um valor fixo valido.');
        return;
      }
      payload.value = valor;
      payload.percentage = null;
    }

    const regraId = modalElement.dataset.editingId;

    try {
      if (regraId) {
        await apiCall(`/pev/api/implantacao/${planId}/finance/result_rules/${regraId}`, 'PUT', payload);
        const regras = Array.isArray(resultRules) ? resultRules : [];
        const indice = regras.findIndex(regra => String(regra.id) === String(regraId));
        if (indice >= 0) {
          regras[indice] = { ...regras[indice], ...payload, id: regras[indice].id };
        }
        alert('Destinacao atualizada com sucesso!');
      } else {
        const resposta = await apiCall(`/pev/api/implantacao/${planId}/finance/result_rules`, 'POST', payload);
        const novoId = resposta?.id;
        if (Array.isArray(resultRules)) {
          resultRules.push({ ...payload, id: novoId || Date.now() });
        }
        alert('Destinacao cadastrada com sucesso!');
      }

      closeResultRuleModal();
      renderDistribuicao();
      renderFluxoNegocio();
      renderFluxoInvestidor();
    } catch (error) {
      console.error('Erro ao salvar destinacao:', error);
    }
  }

  function editResultRule(ruleId) {
    if (ruleId === undefined || ruleId === null) {
      return;
    }
    openResultRuleModal(ruleId);
  }

  async function deleteResultRule(ruleId) {
    if (ruleId === undefined || ruleId === null) {
      return;
    }

    if (!confirm('Deseja realmente excluir esta destinacao?')) {
      return;
    }

    try {
      await apiCall(`/pev/api/implantacao/${planId}/finance/result_rules/${ruleId}`, 'DELETE');
      const regras = Array.isArray(resultRules) ? resultRules : [];
      const indice = regras.findIndex(regra => String(regra.id) === String(ruleId));
      if (indice >= 0) {
        regras.splice(indice, 1);
      }
      alert('Destinacao removida com sucesso!');
      renderDistribuicao();
      renderFluxoNegocio();
      renderFluxoInvestidor();
    } catch (error) {
      console.error('Erro ao deletar destinacao:', error);
    }
  }

  // Modal de Distribuicao de Lucros
  function openProfitDistributionModal() {
    const percAtual = profitDistribution && profitDistribution.length > 0 
      ? parseFloat(profitDistribution[0].percentage || profitDistribution[0].profit_distribution_percent || 0) 
      : 0;
    
    const modalHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>Configurar Distribuicao de Lucros</h3>
          <button class="modal-close" onclick="closeProfitDistributionModal()"></button>
        </div>
        
        <div class="info-box info" style="margin-bottom: 20px;">
           <strong>Distribuicao de Lucros:</strong> Define o percentual do Resultado Operacional 
          que sera distribuido aos socios/acionistas.
        </div>
        
        <div class="form-group">
          <label>Percentual de Distribuicao (%)</label>
          <input type="number" id="pd-percent" step="0.1" min="0" max="100" value="${percAtual}" required>
          <small style="color: #64748b; font-size: 12px;">
            Ex: 30% significa que 30% do Resultado Operacional sera distribuido como lucros
          </small>
        </div>
        
        <div class="form-group">
          <label>Data de Inicio</label>
          <input type="date" id="pd-data" value="${profitDistribution[0]?.start_date || ''}">
        </div>
        
        <div class="form-group">
          <label>Observacoes</label>
          <textarea id="pd-obs" rows="3">${profitDistribution[0]?.notes || ''}</textarea>
        </div>
        
        <div class="modal-actions">
          <button class="button button-ghost" onclick="closeProfitDistributionModal()">
            Cancelar
          </button>
          <button class="button button-primary" onclick="saveProfitDistribution()">
            Salvar
          </button>
        </div>
      </div>
    `;
    
    const modalElement = document.getElementById('profitDistributionModal');
    if (!modalElement) return;
    
    modalElement.innerHTML = modalHTML;
    modalElement.className = '';
    modalElement.style.cssText = `
      display: flex !important;
      opacity: 1 !important;
      position: fixed !important;
      z-index: 25000 !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
      align-items: center !important;
      justify-content: center !important;
    `;
    
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        color: #000000 !important;
        padding: 32px !important;
        border-radius: 16px !important;
        max-width: 600px !important;
        width: 90% !important;
      `;
    }
  }
  
  function closeProfitDistributionModal() {
    const modalElement = document.getElementById('profitDistributionModal');
    if (modalElement) {
      modalElement.style.cssText = 'display: none !important;';
      modalElement.className = 'modal';
    }
  }
  
  async function saveProfitDistribution() {
    const percent = document.getElementById('pd-percent').value;
    const data = document.getElementById('pd-data').value;
    const obs = document.getElementById('pd-obs').value;
    
    if (!percent) {
      alert('Informe o percentual de distribuicao');
      return;
    }
    
    try {
      const payload = {
        profit_distribution_percent: parseFloat(percent),
        start_date: data,
        notes: obs
      };
      
      // API para atualizar distribuicao
      await apiCall(`/pev/api/implantacao/${planId}/finance/profit-distribution`, 'PUT', payload);
      
      // Atualizar dados locais
      if (profitDistribution.length === 0) {
        profitDistribution.push(payload);
      } else {
        profitDistribution[0] = { ...profitDistribution[0], ...payload };
      }
      
      closeProfitDistributionModal();
      renderDistribuicao();
      
      alert('Distribuicao de lucros salva com sucesso!');
      
    } catch (error) {
      console.error('Erro ao salvar distribuicao:', error);
    }
  }
  
  // Modal de Resumo Executivo
  function openExecutiveSummaryModal() {
    // Pegar o valor atual do display
    const displayElement = document.getElementById('executive-summary-display');
    let textoAtual = executiveSummary || '';
    
    if (displayElement) {
      const displayText = displayElement.textContent || '';
      if (displayText && displayText !== 'Nenhum resumo executivo cadastrado. Clique em "Editar" para adicionar.') {
        textoAtual = displayText;
      }
    }
    
    const modalHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>Editar Resumo Executivo</h3>
          <button class="modal-close" onclick="closeExecutiveSummaryModal()"></button>
        </div>
        
        <div class="form-group">
          <label>Resumo Executivo</label>
          <textarea id="es-texto" rows="10" style="font-family: Arial, sans-serif;">${textoAtual}</textarea>
          <small style="color: #64748b; font-size: 12px;">Este texto sera incluido no relatorio final de planejamento.</small>
        </div>
        
        <div class="modal-actions">
          <button class="button button-ghost" onclick="closeExecutiveSummaryModal()">
            Cancelar
          </button>
          <button class="button button-primary" onclick="saveExecutiveSummary()">
            Salvar
          </button>
        </div>
      </div>
    `;
    
    const modalElement = document.getElementById('executiveSummaryModal');
    if (!modalElement) return;
    
    modalElement.innerHTML = modalHTML;
    modalElement.className = '';
    modalElement.style.cssText = `
      display: flex !important;
      opacity: 1 !important;
      position: fixed !important;
      z-index: 25000 !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
      align-items: center !important;
      justify-content: center !important;
    `;
    
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        color: #000000 !important;
        padding: 32px !important;
        border-radius: 16px !important;
        max-width: 700px !important;
        width: 90% !important;
      `;
    }
  }
  
  function closeExecutiveSummaryModal() {
    const modalElement = document.getElementById('executiveSummaryModal');
    if (modalElement) {
      modalElement.style.cssText = 'display: none !important;';
      modalElement.className = 'modal';
    }
  }
  
  async function saveExecutiveSummary() {
    const texto = document.getElementById('es-texto').value;
    
    try {
      await apiCall(`/pev/api/implantacao/${planId}/finance/executive-summary`, 'PUT', {
        executive_summary: texto
      });
      
      closeExecutiveSummaryModal();
      
      // Atualizar display diretamente
      const displayElement = document.getElementById('executive-summary-display');
      if (displayElement) {
        displayElement.textContent = texto || 'Nenhum resumo executivo cadastrado. Clique em "Editar" para adicionar.';
      }
      
      alert('Resumo executivo salvo com sucesso!');
      
    } catch (error) {
      console.error('Erro ao salvar resumo:', error);
      alert('Erro ao salvar resumo executivo. Verifique o console para detalhes.');
    }
  }
  
  // Calculo de VPL simplificado
  function calcularVPLSimplificado(investimentoInicial, fluxoMensal, periodoMeses, taxaAnual) {
    if (fluxoMensal <= 0 || investimentoInicial <= 0) return 0;
    
    // Converter taxa anual para mensal
    const taxaMensal = Math.pow(1 + (taxaAnual / 100), 1/12) - 1;
    
    let vpl = -investimentoInicial; // Investimento inicial (negativo)
    
    // Somar fluxos descontados
    for (let mes = 1; mes <= periodoMeses; mes++) {
      const valorPresente = fluxoMensal / Math.pow(1 + taxaMensal, mes);
      vpl += valorPresente;
    }
    
    return vpl;
  }
  
  // Modal de Configuracao da Analise
  function openAnalysisConfigModal() {
    const financeiroDados = typeof financeiro !== 'undefined' ? financeiro : {};
    const periodoAtual = financeiroDados?.fluxo_investidor?.analises?.periodo_meses || 60;
    const custoAtual = financeiroDados?.investimento?.custo_oportunidade || 12;
    
    const modalHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3> Configurar Parametros da Analise</h3>
          <button class="modal-close" onclick="closeAnalysisConfigModal()"></button>
        </div>
        
        <div class="info-box info" style="margin-bottom: 20px;">
           <strong>Parametros:</strong> Estes valores influenciam os calculos de ROI, VPL e TIR.
        </div>
        
        <div class="form-group">
          <label>Periodo de Analise (meses)</label>
          <input type="number" id="ac-periodo" min="12" max="120" step="1" value="${periodoAtual}" required>
          <small style="color: #64748b; font-size: 12px;">
            Quantos meses considerar na analise (ex: 60 meses = 5 anos)
          </small>
        </div>
        
        <div class="form-group">
          <label>Custo de Oportunidade (% ao ano)</label>
          <input type="number" id="ac-custo" min="0" max="100" step="0.1" value="${custoAtual}" required>
          <small style="color: #64748b; font-size: 12px;">
            Taxa de retorno alternativa (ex: 12% = poupanca/CDI, 20% = investimento de risco)
          </small>
        </div>
        
        <div class="info-box warning" style="margin-top: 16px;">
           <strong>Importante:</strong> O custo de oportunidade e usado para calcular o VPL.
          Quanto maior a taxa, mais "exigente" e a analise.
        </div>
        
        <div class="modal-actions">
          <button class="button button-ghost" onclick="closeAnalysisConfigModal()">
            Cancelar
          </button>
          <button class="button button-primary" onclick="saveAnalysisConfig()">
            Salvar e Recalcular
          </button>
        </div>
      </div>
    `;
    
    const modalElement = document.getElementById('executiveSummaryModal'); // Reusar modal
    if (!modalElement) return;
    
    modalElement.innerHTML = modalHTML;
    modalElement.className = '';
    modalElement.style.cssText = `
      display: flex !important;
      opacity: 1 !important;
      position: fixed !important;
      z-index: 25000 !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
      align-items: center !important;
      justify-content: center !important;
    `;
    
    const modalContent = modalElement.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        color: #000000 !important;
        padding: 32px !important;
        border-radius: 16px !important;
        max-width: 600px !important;
        width: 90% !important;
      `;
    }
  }
  
  function closeAnalysisConfigModal() {
    const modalElement = document.getElementById('executiveSummaryModal');
    if (modalElement) {
      modalElement.style.cssText = 'display: none !important;';
      modalElement.className = 'modal';
    }
  }
  
  async function saveAnalysisConfig() {
    const periodo = document.getElementById('ac-periodo').value;
    const custo = document.getElementById('ac-custo').value;
    
    if (!periodo || !custo) {
      alert('Preencha todos os campos');
      return;
    }
    
    try {
      const payload = {
        periodo_analise_meses: parseInt(periodo),
        custo_oportunidade_anual: parseFloat(custo)
      };
      
      // Salvar via API de metricas
      await apiCall(`/pev/api/implantacao/${planId}/finance/metrics`, 'PUT', payload);
      
      // Atualizar variavel global (se existir)
      if (typeof financeiro !== 'undefined') {
        if (!financeiro.fluxo_investidor) financeiro.fluxo_investidor = {};
        if (!financeiro.fluxo_investidor.analises) financeiro.fluxo_investidor.analises = {};
        financeiro.fluxo_investidor.analises.periodo_meses = parseInt(periodo);
        
        if (!financeiro.investimento) financeiro.investimento = {};
        financeiro.investimento.custo_oportunidade = parseFloat(custo);
      }
      
      closeAnalysisConfigModal();
      renderAnalise();
      
      alert('Parametros salvos! Metricas recalculadas.');
      
    } catch (error) {
      console.error('Erro ao salvar configuracao:', error);
    }
  }
  
  // =========================================
  // EXPOR FUNES NO ESCOPO GLOBAL
  // =========================================
  
  // Tornar funcoes acessiveis via onclick
  
  // Capital de Giro
  window.openCapitalGiroModal = openCapitalGiroModal;
  window.closeCapitalGiroModal = closeCapitalGiroModal;
  window.saveCapitalGiro = saveCapitalGiro;
  window.editCapitalGiro = editCapitalGiro;
  window.deleteCapitalGiro = deleteCapitalGiro;
  
  // Fontes de Recursos
  window.openFundingSourceModal = openFundingSourceModal;
  window.closeFundingSourceModal = closeFundingSourceModal;
  window.saveFundingSource = saveFundingSource;
  window.editFundingSource = editFundingSource;
  window.deleteFundingSource = deleteFundingSource;
  
  // Distribuicao de Lucros
  window.openProfitDistributionModal = openProfitDistributionModal;
  window.closeProfitDistributionModal = closeProfitDistributionModal;
  window.saveProfitDistribution = saveProfitDistribution;
  
  // Outras Destinacoes (Result Rules)
  window.openResultRuleModal = openResultRuleModal;
  window.closeResultRuleModal = closeResultRuleModal;
  window.saveResultRule = saveResultRule;
  window.editResultRule = editResultRule;
  window.deleteResultRule = deleteResultRule;
  window.toggleResultRuleType = toggleResultRuleType;
  
  // Resumo Executivo
  window.openExecutiveSummaryModal = openExecutiveSummaryModal;
  window.closeExecutiveSummaryModal = closeExecutiveSummaryModal;
  window.saveExecutiveSummary = saveExecutiveSummary;
  
  // Configuracao de Analise
  window.openAnalysisConfigModal = openAnalysisConfigModal;
  window.closeAnalysisConfigModal = closeAnalysisConfigModal;
  window.saveAnalysisConfig = saveAnalysisConfig;
  
  // =========================================
  // INICIALIZAO
  // =========================================
  
  console.log('[ModeFin] Iniciando...');
  console.log('Plan ID:', planId);
  console.log('Products Totals:', productsTotals);
  console.log('Fixed Costs:', fixedCostsSummary);
  console.log('Capital Giro Items:', capitalGiroItems);
  console.log('Ramp Products:', rampProducts);
  
  // Renderizar todas as secoes com tratamento de erro
  try {
    renderResultados();
    console.log('[ModeFin] Secao 1 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 1:', e); }
  
  try {
    renderInvestimentos();
    console.log('[ModeFin] Secao 2 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 2:', e); }
  
  try {
    renderFontes();
    console.log('[ModeFin] Secao 3 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 3:', e); }
  
  try {
    renderDistribuicao();
    console.log('[ModeFin] Secao 4 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 4:', e); }
  
  try {
    renderFluxoInvestimento();
    console.log('[ModeFin] Secao 5 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 5:', e); }
  
  try {
    renderFluxoNegocio();
    console.log('[ModeFin] Secao 6 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 6:', e); }
  
  try {
    renderFluxoInvestidor();
    console.log('[ModeFin] Secao 7 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 7:', e); }
  
  try {
    renderAnalise();
    console.log('[ModeFin] Secao 8 OK');
  } catch (e) { console.error('[ModeFin] Erro na Secao 8:', e); }
  
  console.log('[ModeFin] Renderizacao completa!');
  console.log('[ModeFin] Funcoes expostas no window:', {
    openCapitalGiroModal: typeof window.openCapitalGiroModal,
    closeCapitalGiroModal: typeof window.closeCapitalGiroModal,
    saveCapitalGiro: typeof window.saveCapitalGiro,
    editCapitalGiro: typeof window.editCapitalGiro,
    deleteCapitalGiro: typeof window.deleteCapitalGiro
  });
</script>

{% endblock %}


