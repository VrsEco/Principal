{% extends "base.html" %}
{% block title %}Produtos | Modelo & Mercado{% endblock %}
{% block body %}{{ super() }}{% endblock %}

{% block content %}
<style>
  .page{max-width:1100px;margin:0 auto;padding:32px 24px 72px;}
  body.modal-open{overflow:hidden;}
  .head{display:flex;justify-content:space-between;gap:24px;align-items:flex-start;margin-bottom:24px;}
  .head h1{margin:0 0 6px;font-size:30px;color:#0f172a;}
  .head p{margin:0;color:#475569;line-height:1.6;}
  .actions{display:flex;gap:12px;flex-wrap:wrap;}
  .btn{padding:9px 16px;border-radius:10px;border:none;font-weight:600;font-size:14px;cursor:pointer;transition:transform .2s,box-shadow .2s;}
  .btn-primary{background:#2563eb;color:#fff;}
  .btn-primary:hover{box-shadow:0 10px 24px rgba(37,99,235,.25);transform:translateY(-1px);}
  .btn-secondary{background:rgba(148,163,184,.2);color:#1f2937;border:1px solid rgba(148,163,184,.4);}
  .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:22px;}
  .summary div{padding:16px;border-radius:14px;background:#fff;border:1px solid rgba(148,163,184,.2);box-shadow:0 12px 24px rgba(15,23,42,.07);}
  .summary .label{text-transform:uppercase;font-size:11px;letter-spacing:.08em;color:#64748b;margin-bottom:4px;}
  .summary .value{font-size:20px;font-weight:600;color:#0f172a;}
  .card{background:#fff;border-radius:18px;border:1px solid rgba(148,163,184,.2);box-shadow:0 18px 32px rgba(15,23,42,.08);}
  .card header{padding:18px 20px;border-bottom:1px solid rgba(148,163,184,.15);font-weight:600;color:#1f2937;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.12);text-align:left;font-size:14px;color:#1f2937;}
  th{text-transform:uppercase;font-size:12px;letter-spacing:.04em;background:rgba(59,130,246,.06);}
  tbody tr:hover{background:rgba(59,130,246,.05);}
  .table-actions{display:flex;gap:6px;}
  .table-btn{padding:6px 10px;border-radius:8px;border:none;font-size:12px;font-weight:600;cursor:pointer;}
  .table-btn.edit{background:rgba(37,99,235,.16);color:#1d4ed8;}
  .table-btn.delete{background:rgba(239,68,68,.16);color:#b91c1c;}
  .empty{padding:46px 20px;text-align:center;color:#64748b;}
  dialog{border:none;border-radius:16px;padding:0;width:min(720px,92vw);box-shadow:0 28px 70px rgba(15,23,42,.28);}
  dialog::backdrop{background:rgba(15,23,42,.55);}
  .dialog-body{padding:24px;max-height:65vh;overflow:auto;}
  .dialog-footer{display:flex;justify-content:flex-end;gap:12px;padding:18px 24px;border-top:1px solid rgba(148,163,184,.12);background:#f8fafc;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;}
  .field{display:flex;flex-direction:column;gap:6px;}
  .field label{font-size:13px;font-weight:600;color:#1f2937;}
  .field input,.field textarea{border-radius:10px;border:1px solid rgba(148,163,184,.45);padding:9px 10px;font-size:13px;}
  .field textarea{min-height:90px;resize:vertical;}
  .field input:focus,.field textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.18);}
  .readonly{background:rgba(226,232,240,.5);}
  @media (max-width:780px){.head{flex-direction:column;}}
</style>

<div class="page">
  <header class="head">
    <div>
      <h1>Produtos e Margens</h1>
      <p>Cadastre e acompanhe os produtos do plano <strong>{{ plan.name }}</strong>.</p>
    </div>
    <div class="actions">
      <a class="btn btn-secondary" href="{{ url_for('pev.pev_implantacao_overview') }}?plan_id={{ plan_id }}">Voltar</a>
      <button type="button" class="btn btn-primary" id="btnNew">Novo produto</button>
    </div>
  </header>

  <section class="summary">
    <div><span class="label">Produtos</span><span class="value" id="summaryCount">0</span></div>
    <div><span class="label">Faturamento</span><span class="value" id="summaryRevenue">R$ 0,00</span></div>
    <div><span class="label">Margem mÃ©dia</span><span class="value" id="summaryMargin">0,00%</span></div>
    <div><span class="label">Meta share</span><span class="value" id="summaryShare">0 un</span></div>
  </section>

  <section class="card">
    <header>Produtos cadastrados</header>
    <div class="empty" id="emptyState">Nenhum produto cadastrado.</div>
    <table id="productsTable" hidden>
      <thead>
        <tr>
          <th>Produto</th><th>PreÃ§o</th><th>Custos</th><th>Despesas</th><th>Margem %</th><th>Mercado</th><th>Share</th><th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="productsBody"></tbody>
    </table>
  </section>
</div>

<dialog id="productDialog">
  <form id="productForm">
    <div class="dialog-body">
      <input type="hidden" id="productId">
      <div class="grid">
        <div class="field"><label for="fieldName">Nome *</label><input id="fieldName" name="name" required></div>
        <div class="field"><label for="fieldPrice">PreÃ§o (R$) *</label><input id="fieldPrice" name="sale_price" type="number" step="0.01" min="0" required></div>
        <div class="field"><label for="fieldDescription">DescriÃ§Ã£o</label><textarea id="fieldDescription" name="description"></textarea></div>
        <div class="field"><label for="fieldPriceNotes">Obs. preÃ§o</label><textarea id="fieldPriceNotes" name="sale_price_notes"></textarea></div>
        <div class="field"><label for="fieldCostPercent">Custos (%)</label><input id="fieldCostPercent" name="variable_costs_percent" type="number" step="0.01"></div>
        <div class="field"><label for="fieldCostValue">Custos (R$)</label><input id="fieldCostValue" name="variable_costs_value" type="number" step="0.01"></div>
        <div class="field"><label for="fieldCostNotes">Obs. custos</label><textarea id="fieldCostNotes" name="variable_costs_notes"></textarea></div>
        <div class="field"><label for="fieldExpensePercent">Despesas (%)</label><input id="fieldExpensePercent" name="variable_expenses_percent" type="number" step="0.01"></div>
        <div class="field"><label for="fieldExpenseValue">Despesas (R$)</label><input id="fieldExpenseValue" name="variable_expenses_value" type="number" step="0.01"></div>
        <div class="field"><label for="fieldExpenseNotes">Obs. despesas</label><textarea id="fieldExpenseNotes" name="variable_expenses_notes"></textarea></div>
        <div class="field"><label for="fieldMarginPercent">Margem (%)</label><input id="fieldMarginPercent" readonly class="readonly"></div>
        <div class="field"><label for="fieldMarginValue">Margem (R$)</label><input id="fieldMarginValue" readonly class="readonly"></div>
        <div class="field"><label for="fieldMarginNotes">Obs. margem</label><textarea id="fieldMarginNotes" name="unit_contribution_margin_notes"></textarea></div>
        <div class="field"><label for="fieldMarketUnits">Mercado (un)</label><input id="fieldMarketUnits" name="market_size_monthly_units" type="number" step="0.01"></div>
        <div class="field"><label for="fieldMarketRevenue">Faturamento (R$)</label><input id="fieldMarketRevenue" readonly class="readonly"></div>
        <div class="field"><label for="fieldMarketNotes">Obs. mercado</label><textarea id="fieldMarketNotes" name="market_size_notes"></textarea></div>
        <div class="field"><label for="fieldShareUnits">Share (un)</label><input id="fieldShareUnits" name="market_share_goal_monthly_units" type="number" step="0.01"></div>
        <div class="field"><label for="fieldSharePercent">Share (%)</label><input id="fieldSharePercent" name="market_share_goal_percent" type="number" step="0.01"></div>
        <div class="field"><label for="fieldShareNotes">Obs. share</label><textarea id="fieldShareNotes" name="market_share_goal_notes"></textarea></div>
      </div>
    </div>
    <div class="dialog-footer">
      <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>
</dialog>

<script>
(() => {
  // Remove leftover legacy markup/modal if the server rendered cached content
  document.querySelectorAll('.products-wrapper').forEach(el => el.remove());
  const legacyModal = document.getElementById('productModal');
  if (legacyModal && legacyModal.parentElement) {
    legacyModal.parentElement.removeChild(legacyModal);
  }
  document.body.classList.remove('modal-open');

  const PLAN_ID = {{ plan_id | int }};
  const API = `/pev/api/implantacao/${PLAN_ID}/products`;
  const state = { items: [], editing: null, lock: false };
  const els = {
    table: document.getElementById('productsTable'),
    body: document.getElementById('productsBody'),
    empty: document.getElementById('emptyState'),
    count: document.getElementById('summaryCount'),
    revenue: document.getElementById('summaryRevenue'),
    margin: document.getElementById('summaryMargin'),
    share: document.getElementById('summaryShare'),
    dialog: document.getElementById('productDialog'),
    form: document.getElementById('productForm'),
    btnNew: document.getElementById('btnNew'),
    id: document.getElementById('productId'),
    name: document.getElementById('fieldName'),
    price: document.getElementById('fieldPrice'),
    description: document.getElementById('fieldDescription'),
    priceNotes: document.getElementById('fieldPriceNotes'),
    costPercent: document.getElementById('fieldCostPercent'),
    costValue: document.getElementById('fieldCostValue'),
    costNotes: document.getElementById('fieldCostNotes'),
    expPercent: document.getElementById('fieldExpensePercent'),
    expValue: document.getElementById('fieldExpenseValue'),
    expNotes: document.getElementById('fieldExpenseNotes'),
    marginPercent: document.getElementById('fieldMarginPercent'),
    marginValue: document.getElementById('fieldMarginValue'),
    marginNotes: document.getElementById('fieldMarginNotes'),
    marketUnits: document.getElementById('fieldMarketUnits'),
    marketRevenue: document.getElementById('fieldMarketRevenue'),
    marketNotes: document.getElementById('fieldMarketNotes'),
    shareUnits: document.getElementById('fieldShareUnits'),
    sharePercent: document.getElementById('fieldSharePercent'),
    shareNotes: document.getElementById('fieldShareNotes'),
  };

  function init() {
    els.btnNew.addEventListener('click', () => openForm());
    els.form.addEventListener('submit', submitForm);
    els.dialog.addEventListener('cancel', closeForm);
    els.dialog.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', closeForm));
    els.body.addEventListener('click', handleTableClick);
    [els.price, els.costPercent, els.costValue, els.expPercent, els.expValue, els.marketUnits, els.shareUnits].forEach((input) => input.addEventListener('input', handleDerivedChanges));
    loadProducts();
  }

  async function loadProducts() {
    try {
      const res = await fetch(API);
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || 'Erro ao carregar produtos.');
      state.items = Array.isArray(data.products) ? data.products : [];
      renderTable();
      applyTotals(data.totals || {});
    } catch (err) {
      console.error(err);
      alert(err.message || 'Falha ao carregar produtos.');
    }
  }

  function renderTable() {
    if (!state.items.length) {
      els.table.hidden = true;
      els.empty.hidden = false;
      els.body.innerHTML = '';
      return;
    }
    els.table.hidden = false;
    els.empty.hidden = true;
    els.body.innerHTML = state.items.map(item => `
      <tr data-id="${item.id}">
        <td><strong>${escapeHtml(item.name || 'Produto')}</strong>${item.description ? `<br><small style="color:#64748b;">${escapeHtml(item.description)}</small>` : ''}</td>
        <td>R$ ${fmt(item.sale_price)}</td>
        <td>R$ ${fmt(item.variable_costs_value)} (${fmt(item.variable_costs_percent)}%)</td>
        <td>R$ ${fmt(item.variable_expenses_value)} (${fmt(item.variable_expenses_percent)}%)</td>
        <td>${fmt(item.unit_contribution_margin_percent)}%</td>
        <td>${fmt(item.market_size_monthly_units)} un</td>
        <td>${fmt(item.market_share_goal_monthly_units)} un</td>
        <td><div class="table-actions"><button class="table-btn edit" data-action="edit" data-id="${item.id}">Editar</button><button class="table-btn delete" data-action="delete" data-id="${item.id}">Excluir</button></div></td>
      </tr>`).join('');
  }

  function applyTotals(totals) {
    els.count.textContent = String(totals.count || 0);
    els.revenue.textContent = `R$ ${fmt(totals.market_revenue || 0)}`;
    els.margin.textContent = `${fmt(totals.average_margin_percent || 0)}%`;
    els.share.textContent = `${fmt(totals.share_goal_units || 0)} un`;
  }

  function openForm(product) {
    state.editing = product ? product.id : null;
    els.form.reset();
    if (product) {
      els.id.value = product.id;
      setField(els.name, product.name);
      setField(els.price, product.sale_price);
      setField(els.description, product.description);
      setField(els.priceNotes, product.sale_price_notes);
      setField(els.costPercent, product.variable_costs_percent);
      setField(els.costValue, product.variable_costs_value);
      setField(els.costNotes, product.variable_costs_notes);
      setField(els.expPercent, product.variable_expenses_percent);
      setField(els.expValue, product.variable_expenses_value);
      setField(els.expNotes, product.variable_expenses_notes);
      setField(els.marginPercent, product.unit_contribution_margin_percent);
      setField(els.marginValue, product.unit_contribution_margin_value);
      setField(els.marginNotes, product.unit_contribution_margin_notes);
      setField(els.marketUnits, product.market_size_monthly_units);
      setField(els.marketRevenue, product.market_size_monthly_revenue);
      setField(els.marketNotes, product.market_size_notes);
      setField(els.shareUnits, product.market_share_goal_monthly_units);
      setField(els.sharePercent, product.market_share_goal_percent);
      setField(els.shareNotes, product.market_share_goal_notes);
    } else {
      els.id.value = '';
      setField(els.marginPercent, 0);
      setField(els.marginValue, 0);
      setField(els.marketRevenue, 0);
    }
    if (typeof els.dialog.showModal === 'function') els.dialog.showModal(); else els.dialog.setAttribute('open','open');
    document.body.classList.add('modal-open');
    els.name.focus();
  }

  function closeForm() {
    state.editing = null;
    els.form.reset();
    if (els.dialog.open) els.dialog.close(); else els.dialog.removeAttribute('open');
    document.body.classList.remove('modal-open');
  }

  function submitForm(evt) {
    evt.preventDefault();
    
    // Validação no frontend
    if (!els.name.value.trim()) {
      alert('ERRO: Nome do produto é obrigatório!');
      els.name.focus();
      return;
    }
    
    const priceValue = parse(els.price.value);
    if (priceValue <= 0) {
      alert('ERRO: Preço deve ser maior que zero!');
      els.price.focus();
      return;
    }
    
    const payload = buildPayload();
    const endpoint = state.editing ? `${API}/${state.editing}` : API;
    const method = state.editing ? 'PUT' : 'POST';
    
    // LOG: Payload sendo enviado
    console.log('=== SUBMITTING PRODUCT ===');
    console.log('Endpoint:', endpoint);
    console.log('Method:', method);
    console.log('Payload:', payload);
    
    fetch(endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
      .then(res => {
        console.log('Response status:', res.status);
        console.log('Response ok:', res.ok);
        return res.json().then(body => {
          console.log('Response body:', body);
          return { ok: res.ok, status: res.status, body };
        });
      })
      .then(({ ok, status, body }) => {
        if (status === 400) {
          console.error('Validation error:', body.error);
          throw new Error(body.error || 'Dados invÃ¡lidos.');
        }
        if (!ok || !body.success) {
          console.error('Server error:', body.error);
          throw new Error(body.error || 'Erro ao salvar produto.');
        }
        console.log('Product saved successfully:', body);
        return loadProducts();
      })
      .then(closeForm)
      .catch(err => {
        console.error('=== ERROR SAVING PRODUCT ===');
        console.error('Error type:', err.constructor.name);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        alert('ERRO: ' + (err.message || 'NÃ£o foi possÃ­vel salvar o produto.'));
      });
  }

  function buildPayload() {
    return {
      name: els.name.value.trim(),
      description: els.description.value.trim(),
      sale_price: parse(els.price.value),
      sale_price_notes: els.priceNotes.value.trim(),
      variable_costs_percent: parse(els.costPercent.value),
      variable_costs_value: parse(els.costValue.value),
      variable_costs_notes: els.costNotes.value.trim(),
      variable_expenses_percent: parse(els.expPercent.value),
      variable_expenses_value: parse(els.expValue.value),
      variable_expenses_notes: els.expNotes.value.trim(),
      unit_contribution_margin_notes: els.marginNotes.value.trim(),
      market_size_monthly_units: parse(els.marketUnits.value),
      market_size_notes: els.marketNotes.value.trim(),
      market_share_goal_monthly_units: parse(els.shareUnits.value),
      market_share_goal_percent: parse(els.sharePercent.value),
      market_share_goal_notes: els.shareNotes.value.trim(),
    };
  }

  function handleTableClick(evt) {
    const btn = evt.target.closest('[data-action]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    if (!Number.isFinite(id)) return;
    if (btn.dataset.action === 'edit') {
      const product = state.items.find(item => item.id === id);
      if (product) openForm(product);
    } else if (btn.dataset.action === 'delete') {
      if (!confirm('Excluir produto selecionado?')) return;
      fetch(`${API}/${id}`, { method: 'DELETE' })
        .then(res => res.json().then(body => ({ ok: res.ok, body })))
        .then(({ ok, body }) => {
          if (!ok || !body.success) throw new Error(body.error || 'Erro ao excluir produto.');
          return loadProducts();
        })
        .catch(err => {
          console.error(err);
          alert(err.message || 'NÃ£o foi possÃ­vel excluir o produto.');
        });
    }
  }

  function handleDerivedChanges() {
    syncCosts();
    syncExpenses();
    updateDerived();
  }

  function syncCosts() {
    if (state.lock) return;
    state.lock = true;
    const price = parse(els.price.value);
    if (document.activeElement === els.costValue) {
      const calcPercent = price > 0 ? (parse(els.costValue.value) / price) * 100 : 0;
      els.costPercent.value = calcPercent > 0 ? calcPercent.toFixed(2) : '';
    } else {
      const calcValue = price > 0 ? (price * parse(els.costPercent.value)) / 100 : 0;
      els.costValue.value = calcValue > 0 ? calcValue.toFixed(2) : '';
    }
    state.lock = false;
  }

  function syncExpenses() {
    if (state.lock) return;
    state.lock = true;
    const price = parse(els.price.value);
    if (document.activeElement === els.expValue) {
      const calcPercent = price > 0 ? (parse(els.expValue.value) / price) * 100 : 0;
      els.expPercent.value = calcPercent > 0 ? calcPercent.toFixed(2) : '';
    } else {
      const calcValue = price > 0 ? (price * parse(els.expPercent.value)) / 100 : 0;
      els.expValue.value = calcValue > 0 ? calcValue.toFixed(2) : '';
    }
    state.lock = false;
  }

  function updateDerived() {
    const price = parse(els.price.value);
    const costs = parse(els.costValue.value);
    const expenses = parse(els.expValue.value);
    const marginValue = price - costs - expenses;
    const marginPercent = price > 0 ? (marginValue / price) * 100 : 0;
    const marketUnits = parse(els.marketUnits.value);
    const marketRevenue = price * marketUnits;
    const shareUnits = parse(els.shareUnits.value);
    const sharePercent = marketUnits > 0 ? (shareUnits / marketUnits) * 100 : parse(els.sharePercent.value);
    els.marginValue.value = marginValue.toFixed(2);
    els.marginPercent.value = marginPercent.toFixed(2);
    els.marketRevenue.value = marketRevenue.toFixed(2);
    if (document.activeElement !== els.sharePercent) {
      els.sharePercent.value = sharePercent ? sharePercent.toFixed(2) : '';
    }
  }

  function parse(value) {
    if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
    
    let normalized = String(value || '').trim();
    if (!normalized) return 0;
    
    // Remove espaços
    normalized = normalized.replace(/\s+/g, '');
    
    // Se tem vírgula, assume formato brasileiro (1.234,56 ou 1234,56)
    if (normalized.includes(',')) {
      // Remove pontos (separador de milhares) e troca vírgula por ponto
      normalized = normalized.replace(/\./g, '').replace(',', '.');
    }
    // Se não tem vírgula mas tem múltiplos pontos, assume formato brasileiro sem vírgula (1.234)
    else {
      const dotCount = (normalized.match(/\./g) || []).length;
      if (dotCount > 1) {
        // Remove todos os pontos (são separadores de milhares)
        normalized = normalized.replace(/\./g, '');
      }
      // Se tem apenas um ponto, verifica se é separador de milhares ou decimal
      else if (dotCount === 1) {
        const dotIndex = normalized.indexOf('.');
        const afterDot = normalized.length - dotIndex - 1;
        // Se tem 3 dígitos após o ponto, provavelmente é separador de milhares
        if (afterDot === 3 && normalized.length > 4) {
          normalized = normalized.replace('.', '');
        }
        // Caso contrário, mantém como decimal
      }
    }
    
    const number = Number(normalized);
    return Number.isFinite(number) ? number : 0;
  }

  function fmt(value) {
    const number = parse(value);
    return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function setField(field, value) {
    if (!field) return;
    if (field.tagName === 'TEXTAREA' || field.type === 'text') {
      field.value = value ? String(value) : '';
    } else {
      // Para campos numéricos, não usar formatação pt-BR (vírgula)
      // Usar ponto como separador decimal (padrão internacional)
      if (value === null || value === undefined || value === '') {
        field.value = '';
      } else {
        const num = typeof value === 'number' ? value : parse(value);
        field.value = num.toFixed(2);
      }
    }
  }

  function escapeHtml(value) {
    if (value === undefined || value === null) return '';
    return String(value).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  init();
})();
</script>
{% endblock %}

