{% extends "base.html" %}
{% block title %}Estruturas de Execu√ß√£o | PEV 2.0{% endblock %}
{% block body %}{{ super() }}{% endblock %}

{% block header_actions %}
  <div class="header-nav">
    <a href="/main" class="nav-link">Ecossistema</a>
    <a href="{{ url_for('pev.pev_dashboard') }}" class="nav-link active">PEV</a>
    <a href="{{ url_for('grv.grv_dashboard') }}" class="nav-link">GRV</a>
  </div>
  <div class="user-pill">
    <span class="user-name">{{ user_name | default('Fabiano Ferreira') }}</span>
  </div>
  <div class="header-nav">
    <select id="themeSelect" class="nav-link" style="padding:8px 12px; color:#64748b;">
      <option value="versus">Tema Versus</option>
      <option value="alt">Tema Azul/Branco/Amarelo</option>
    </select>
  </div>
{% endblock %}

{% block content %}
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%) !important;
      color: #0f172a !important;
    }

    .execution-wrapper {
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .execution-hero {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(12px);
      padding: 32px;
    }

    .execution-hero .page-eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 12px;
      color: rgba(15, 23, 42, 0.6);
      display: block;
      margin-bottom: 8px;
    }

    .execution-hero h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
    }

    .execution-hero p {
      font-size: 16px;
      color: #475569;
      max-width: 720px;
      margin-top: 12px;
      line-height: 1.6;
    }

    .execution-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .investment-summary-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(12px);
      padding: 32px;
    }

    .investment-summary-card h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #0f172a;
      font-weight: 600;
    }

    .investment-summary-card .subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 24px;
    }

    .investment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .investment-table thead tr {
      background: rgba(59, 130, 246, 0.08);
    }

    .investment-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #1e40af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
    }

    .investment-table th:not(:first-child) {
      text-align: right;
    }

    .investment-table tbody tr {
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      transition: background-color 0.2s ease;
    }

    .investment-table tbody tr:hover:not(.total-row) {
      background: rgba(59, 130, 246, 0.04);
    }

    .investment-table tbody tr.total-row {
      background: rgba(59, 130, 246, 0.12);
      font-weight: 600;
    }

    .investment-table tbody tr.total-row td {
      padding-top: 16px;
      padding-bottom: 16px;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }

    .investment-table td {
      padding: 12px 16px;
      color: #334155;
    }

    .investment-table td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .investment-table td.block-name {
      font-weight: 500;
      color: #0f172a;
    }

    .investment-table td.total-label {
      color: #1e40af;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 13px;
    }

    .investment-table td.amount {
      font-weight: 500;
    }

    .investment-table .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #64748b;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .execution-wrapper {
        padding: 20px;
      }

      .execution-hero,
      .investment-summary-card {
        padding: 24px;
      }

      .investment-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
  </style>

  <div class="execution-wrapper">
    <!-- Hero Section -->
    <article class="execution-hero">
      <span class="page-eyebrow">PEV - Fase 03</span>
      <h1>Estruturas de Execu√ß√£o</h1>
      <p>
        Ancorar opera√ß√£o, comercial e finan√ßas para suportar o plano. Esta fase consolida 
        todas as estruturas necess√°rias para viabilizar o neg√≥cio, desde pessoas e processos 
        at√© instala√ß√µes e equipamentos.
      </p>
      
      <div class="execution-actions">
        <a href="{{ url_for('pev.implantacao_estruturas', plan_id=plan.id) }}" class="button button-primary">
          üìã Ver Estruturas Detalhadas
        </a>
        <a href="{{ url_for('pev.pev_implantacao_overview', plan_id=plan.id) }}" class="button button-secondary">
          ‚Üê Voltar ao Dashboard
        </a>
      </div>
    </article>

    <!-- Investment Summary Table -->
    <article class="investment-summary-card">
      <h2>Resumo de Investimentos por Estrutura</h2>
      <p class="subtitle">
        Consolida√ß√£o dos investimentos e gastos operacionais organizados por bloco estruturante. 
        Os valores s√£o calculados com base nas <strong>classifica√ß√µes e repeti√ß√µes de cada parcela</strong> cadastrada nas estruturas.
      </p>

      {% if resumo_investimentos and resumo_investimentos|length > 0 %}
        <table class="investment-table">
          <thead>
            <tr>
              <th rowspan="2" style="width: 20%; vertical-align: middle;">Bloco Estruturante</th>
              <th rowspan="2" style="width: 12%; vertical-align: middle;">Investimentos</th>
              <th colspan="3" style="text-align: center; background: #fef3c7; border-bottom: 1px solid #cbd5e1;">Gastos Mensais</th>
              <th colspan="3" style="text-align: center; background: #dbeafe; border-bottom: 1px solid #cbd5e1;">Gastos Anuais</th>
            </tr>
            <tr>
              <th style="width: 11%; background: #fefce8;">Custos Fixos</th>
              <th style="width: 11%; background: #fefce8;">Despesas Fixas</th>
              <th style="width: 11%; background: #fef3c7; font-weight: 700;">Total</th>
              <th style="width: 11%; background: #eff6ff;">Custos Fixos</th>
              <th style="width: 11%; background: #eff6ff;">Despesas Fixas</th>
              <th style="width: 11%; background: #dbeafe; font-weight: 700;">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in resumo_investimentos %}
              {% if item.get('is_total') %}
                <tr class="total-row">
                  <td class="total-label">{{ item.bloco }}</td>
                  <td class="amount">{{ item.investimentos_formatado }}</td>
                  <td class="amount">{{ item.custos_fixos_mensal_formatado }}</td>
                  <td class="amount">{{ item.despesas_fixas_mensal_formatado }}</td>
                  <td class="amount" style="font-weight: 700; background: #fef9c3;">{{ item.total_gastos_mensal_formatado }}</td>
                  <td class="amount">{{ item.custos_fixos_anual_formatado }}</td>
                  <td class="amount">{{ item.despesas_fixas_anual_formatado }}</td>
                  <td class="amount" style="font-weight: 700; background: #bfdbfe;">{{ item.total_gastos_anual_formatado }}</td>
                </tr>
              {% else %}
                <tr>
                  <td class="block-name">{{ item.bloco }}</td>
                  <td class="amount">{{ item.investimentos_formatado }}</td>
                  <td class="amount">{{ item.custos_fixos_mensal_formatado }}</td>
                  <td class="amount">{{ item.despesas_fixas_mensal_formatado }}</td>
                  <td class="amount" style="font-weight: 600; background: #fefce8;">{{ item.total_gastos_mensal_formatado }}</td>
                  <td class="amount">{{ item.custos_fixos_anual_formatado }}</td>
                  <td class="amount">{{ item.despesas_fixas_anual_formatado }}</td>
                  <td class="amount" style="font-weight: 600; background: #eff6ff;">{{ item.total_gastos_anual_formatado }}</td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <table class="investment-table">
          <thead>
            <tr>
              <th rowspan="2" style="width: 20%; vertical-align: middle;">Bloco Estruturante</th>
              <th rowspan="2" style="width: 12%; vertical-align: middle;">Investimentos</th>
              <th colspan="3" style="text-align: center; background: #fef3c7; border-bottom: 1px solid #cbd5e1;">Gastos Mensais</th>
              <th colspan="3" style="text-align: center; background: #dbeafe; border-bottom: 1px solid #cbd5e1;">Gastos Anuais</th>
            </tr>
            <tr>
              <th style="width: 11%; background: #fefce8;">Custos Fixos</th>
              <th style="width: 11%; background: #fefce8;">Despesas Fixas</th>
              <th style="width: 11%; background: #fef3c7; font-weight: 700;">Total</th>
              <th style="width: 11%; background: #eff6ff;">Custos Fixos</th>
              <th style="width: 11%; background: #eff6ff;">Despesas Fixas</th>
              <th style="width: 11%; background: #dbeafe; font-weight: 700;">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="8" class="empty-state">
                Nenhuma estrutura cadastrada ainda. 
                <a href="{{ url_for('pev.implantacao_estruturas', plan_id=plan.id) }}" style="color: #3b82f6; text-decoration: underline;">
                  Clique aqui para cadastrar estruturas
                </a>.
              </td>
            </tr>
          </tbody>
        </table>
      {% endif %}

      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
        <p style="font-size: 13px; color: #64748b; margin: 0; line-height: 1.6;">
          <strong style="color: #0f172a;">Nota:</strong> 
          Os valores s√£o calculados com base nas <strong>classifica√ß√µes e repeti√ß√µes das parcelas</strong> cadastradas em cada estrutura.
          <span style="color: #1e40af;">‚óè Investimentos</span> s√£o parcelas classificadas como "Investimento".
          <span style="color: #92400e;">‚óè Custos Fixos</span> s√£o parcelas classificadas como "Custo Fixo" (operacionais).
          <span style="color: #9f1239;">‚óè Despesas Fixas</span> s√£o parcelas classificadas como "Despesa Fixa" (comercial/administrativo).
          Os valores de "Total Gastos Anuais" incluem gastos anuais diretos + proje√ß√£o anual dos gastos mensais (√ó 12).
        </p>
      </div>
    </article>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
{% endblock %}

