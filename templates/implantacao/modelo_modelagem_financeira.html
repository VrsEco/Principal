{% extends "base.html" %}
{% block title %}Modelagem Financeira | Implantacao{% endblock %}
{% block body %}{{ super() }}{% endblock %}

{% block header_actions %}
  <div class="header-nav">
    <a href="/main" class="nav-link">Ecossistema</a>
    <a href="{{ url_for('pev.pev_dashboard') }}" class="nav-link active">PEV</a>
    <a href="{{ url_for('grv.grv_dashboard') }}" class="nav-link">GRV</a>
  </div>
  <div class="user-pill">
    <span class="user-name">{{ user_name | default('Fabiano Ferreira') }}</span>
  </div>
  <div class="header-nav">
    <select id="themeSelect" class="nav-link" style="padding:8px 12px; color:#64748b;">
      <option value="versus">Tema Versus</option>
      <option value="alt">Tema Azul/Branco/Amarelo</option>
    </select>
  </div>
{% endblock %}

{% block content %}
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
      color: #0f172a !important;
    }

    .finance-wrapper {
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .finance-card {
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
      backdrop-filter: blur(12px);
      padding: 32px;
    }

    .finance-card h1,
    .finance-card h2 {
      margin: 0 0 16px;
      color: #0f172a;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .btn-add {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-add:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      color: #64748b;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .btn-icon.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    table.finance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: #475569;
    }

    table.finance-table th,
    table.finance-table td {
      border: 1px solid rgba(148, 163, 184, 0.28);
      padding: 12px 14px;
      vertical-align: top;
      text-align: left;
    }

    table.finance-table thead tr {
      background: rgba(59, 130, 246, 0.12);
    }

    table.finance-table th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #1d4ed8;
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .info-box {
      background: rgba(248, 250, 252, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 16px;
      padding: 16px;
      font-size: 13px;
      color: #475569;
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .analysis-card {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.28);
      border-radius: 16px;
      padding: 18px;
      color: #166534;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }

    .section-note {
      font-size: 12px;
      color: #64748b;
      margin-top: 12px;
    }

    /* Modal Styles - PadrÃ£o PFPN (Centralizado no Topo) */
    .modal {
      display: none;
      position: fixed;
      z-index: 999999 !important;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .modal.show {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 16px;
      max-width: 700px;
      width: 90%;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 1000000 !important;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px 16px 0 0;
      background: rgba(248, 250, 252, 0.5);
    }

    .modal-header h3 {
      margin: 0;
      color: #0f172a;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-body {
      padding: 24px;
    }

    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: #0f172a;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #0f172a;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    /* Estilos para tabela de investimentos com scroll */
    #spreadsheet-tbody-fixed tr,
    #spreadsheet-tbody tr {
      height: 44px;
    }
    
    #spreadsheet-tbody-fixed td,
    #spreadsheet-tbody td {
      vertical-align: middle;
    }

    @media (max-width: 768px) {
      .finance-wrapper {
        padding: 20px;
      }

      .finance-card {
        padding: 24px;
      }

      table.finance-table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>

  <section class="finance-wrapper">
    <!-- Header -->
    <article class="finance-card">
      <h1>Modelagem financeira do planejamento</h1>
      <p style="margin:12px 0 0; color:#475569; line-height:1.6;">
        Demonstrativos base para conectar estrutura operacional, investimentos e retorno dos sócios.
        Gerencie os dados financeiros do seu planejamento de forma interativa.
      </p>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="window.history.back()">â† Voltar</button>
      </div>
    </article>

    <!-- ==================== INVESTIMENTOS (RECONSTRUÍDO) ==================== -->
    <article class="finance-card">
      <div class="section-header">
        <h2>💼 Investimentos</h2>
        <button class="btn-add" onclick="openCapitalGiroModal()">
          <span>+</span>
          <span>Novo Investimento em Capital de Giro</span>
        </button>
      </div>
      
      <!-- Card de Resumo -->
      <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 12px; padding: 20px; color: white; margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 500; opacity: 0.9; margin-bottom: 16px;">
          📊 Investimentos Totais das Estruturas
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
          <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Caixa</div>
            <div style="font-size: 18px; font-weight: 700;" id="invest-caixa-value">R$ 0,00</div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Estoques</div>
            <div style="font-size: 18px; font-weight: 700;" id="invest-estoques-value">R$ 0,00</div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Instalações</div>
            <div style="font-size: 18px; font-weight: 700;" id="invest-instalacoes-value">R$ 0,00</div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Máquinas e Equipamentos</div>
            <div style="font-size: 16px; font-weight: 700;" id="invest-maquinas-value">R$ 0,00</div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.25); border-radius: 8px; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">💰 Total de Investimentos</div>
            <div style="font-size: 18px; font-weight: 700;" id="invest-total-value">R$ 0,00</div>
          </div>
        </div>
        
        <div style="font-size: 11px; opacity: 0.8; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
          ℹ️ Valores calculados com base nas estruturas cadastradas
        </div>
      </div>
      
      <!-- Planilha: Distribuição por Período -->
      <div style="margin-top: 24px;">
        <h3 style="margin: 0 0 16px; color: #0f172a; font-size: 16px;">📈 Distribuição por Período</h3>
      
      <div style="display: flex; border: 1px solid rgba(148, 163, 184, 0.28); border-radius: 8px; overflow: hidden;">
        <!-- Colunas fixas (Categoria, Item, Total) -->
        <div style="flex-shrink: 0; background: white;">
          <table class="finance-table" style="border: none; margin: 0;">
            <thead>
              <tr>
                <th style="border-left: none; border-top: none;">Categoria</th>
                <th style="border-top: none;">Item</th>
                <th style="border-top: none; border-right: none;">Total</th>
              </tr>
              <tr style="height: 44px;">
                <th colspan="3" style="border-left: none; border-right: none; visibility: hidden;"></th>
              </tr>
            </thead>
            <tbody id="spreadsheet-tbody-fixed">
              <!-- Linhas fixas serão preenchidas via JavaScript -->
            </tbody>
          </table>
        </div>
        
        <!-- Ãrea com scroll horizontal (apenas períodos) -->
        <div style="overflow-x: auto; flex-grow: 1;">
          <table class="finance-table" id="investments-spreadsheet" style="border: none; margin: 0; width: auto;">
            <thead>
              <tr id="month-totals-row">
                <!-- Totais por mês serão preenchidos via JavaScript -->
              </tr>
              <tr id="month-headers">
                <!-- Headers dos meses serão preenchidos via JavaScript -->
              </tr>
            </thead>
            <tbody id="spreadsheet-tbody">
              <!-- Valores por período serão preenchidos via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.08); border-radius: 8px; border-left: 3px solid #22c55e;">
        <p style="margin: 0; font-size: 12px; color: #166534; line-height: 1.5;">
          <strong>ℹ️ Valores Automáticos:</strong> Os valores de Imobilizado são calculados automaticamente com base nos dados cadastrados em 
          <a href="{{ url_for('pev.implantacao_estruturas', plan_id=plan_id) }}" style="color: #059669; text-decoration: underline; font-weight: 600;">Estruturas de Execução → Resumo de Investimentos</a>.
        </p>
      </div>
      
      <!-- Tabela de Investimentos em Capital de Giro Cadastrados -->
      <div style="margin-top: 24px;">
        <h3 style="margin:0 0 16px; color:#0f172a; font-size:16px;">Investimentos em Capital de Giro Cadastrados</h3>
        <table class="finance-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Data</th>
              <th>Descrição</th>
              <th>Valor</th>
              <th>Observações</th>
              <th style="width: 80px;">Ações</th>
            </tr>
          </thead>
          <tbody id="capital-giro-contributions-tbody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 24px; color: #64748b;">
                Carregando investimentos...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- MARGEM DE CONTRIBUIÃ‡ÃƒO E DESTINAÃ‡ÃƒO DE RESULTADOS -->
    <article class="finance-card">
      <h2>Resultados</h2>
      <div class="grid-two">
        <!-- Margem de Contribuição -->
        <div id="variable-costs-section">
          <div class="section-header" style="margin-bottom: 12px;">
            <h3 style="margin:0;">Margem de Contribuição</h3>
            <a href="/pev/implantacao/modelo/produtos?plan_id={{ plan_id }}" 
               class="btn-add" 
               style="padding: 6px 12px; font-size: 13px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;"
               title="Gerenciar produtos">
              <span>ðŸ“¦</span>
              <span style="font-size: 11px;">Gerenciar Produtos</span>
            </a>
          </div>
          
          <!-- Card de Totalizados de Produtos e Margens -->
          <div id="products-summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 16px; margin-bottom: 16px; color: white;">
            <div style="font-size: 12px; font-weight: 500; opacity: 0.9; margin-bottom: 12px;">
              📊 Totalizados de Modelo e Mercado → Produtos e Margens
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <!-- Faturamento -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Faturamento</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-revenue-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-revenue-percent">100%</div>
              </div>
              
              <!-- Custos VariÃ¡veis -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Custos VariÃ¡veis</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-costs-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-costs-percent">0%</div>
              </div>
              
              <!-- Despesas VariÃ¡veis -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Despesas VariÃ¡veis</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-expenses-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-expenses-percent">0%</div>
              </div>
              
              <!-- Margem de Contribuição -->
              <div style="background: rgba(255, 255, 255, 0.25); border-radius: 8px; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">💰 Margem de Contribuição</div>
                <div style="font-size: 18px; font-weight: 700;" id="products-margin-value">R$ 0,00</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;" id="products-margin-percent">0%</div>
              </div>
            </div>
            
            <div style="margin-top: 12px; font-size: 11px; opacity: 0.8; text-align: center;">
              ℹ️ Valores calculados com base nas metas de market share dos produtos cadastrados
            </div>
          </div>
          
          <!-- Tabela de Produtos -->
          <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #475569;">
              <span>ðŸ“¦</span>
              <span>Produtos cadastrados em <strong>Modelo & Mercado → Produtos e Margens</strong></span>
            </div>
          </div>
          
          <table class="finance-table">
            <thead>
              <tr>
                <th>Produto</th>
                <th>PreÃ§o Venda</th>
                <th>Custos Var. (%)</th>
                <th>Despesas Var. (%)</th>
                <th>MCU (%)</th>
                <th>Meta Market Share</th>
              </tr>
            </thead>
            <tbody id="products-list-tbody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 24px; color: #64748b;">
                  <div style="font-size: 48px; margin-bottom: 8px;">ðŸ“¦</div>
                  <div style="font-size: 14px;">Nenhum produto cadastrado</div>
                  <div style="font-size: 12px; margin-top: 4px;">Clique em "Gerenciar Produtos" para cadastrar</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Resultados -->
        <div id="results-section">
          <div class="section-header" style="margin-bottom: 12px;">
            <h3 style="margin:0;">Resultados</h3>
            <a href="/pev/implantacao/executivo/estruturas?plan_id={{ plan_id }}" 
               class="btn-add" 
               style="padding: 6px 12px; font-size: 13px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;"
               title="Gerenciar estruturas">
              <span>ðŸ—ï¸</span>
              <span style="font-size: 11px;">Gerenciar Estruturas</span>
            </a>
          </div>
          
          <!-- Card de Custos e Despesas Fixas -->
          <div id="fixed-costs-summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 16px; margin-bottom: 16px; color: white;">
            <div style="font-size: 12px; font-weight: 500; opacity: 0.9; margin-bottom: 12px;">
              ðŸ—ï¸ Custos e Despesas Fixas de Estruturas de Execução
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
              <!-- Custos Fixos -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Custos Fixos</div>
                <div style="font-size: 18px; font-weight: 700;" id="fixed-costs-value">R$ 0,00</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">Estrutura Operacional</div>
              </div>
              
              <!-- Despesas Fixas -->
              <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Despesas Fixas</div>
                <div style="font-size: 18px; font-weight: 700;" id="fixed-expenses-value">R$ 0,00</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">Estrutura Comercial e Adm/Fin</div>
              </div>
              
              <!-- Resultado Operacional -->
              <div style="background: rgba(255, 255, 255, 0.25); border-radius: 8px; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">ðŸ’Ž Resultado Operacional</div>
                <div style="font-size: 18px; font-weight: 700;" id="operational-result-value">R$ 0,00</div>
                <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">= Margem - Custos Fixos - Despesas Fixas</div>
              </div>
            </div>
            
            <div style="margin-top: 12px; font-size: 11px; opacity: 0.8; text-align: center;">
              ℹ️ Valores baseados nas estruturas cadastradas em Implantação → Estruturas de Execução
            </div>
          </div>
          
          <!-- Info sobre Estruturas -->
          <div style="background: rgba(245, 87, 108, 0.05); border: 1px solid rgba(245, 87, 108, 0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #475569;">
              <span>ðŸ—ï¸</span>
              <span>Dados vindos de <strong>Implantação → Estruturas de Execução</strong></span>
            </div>
          </div>
        </div>
      </div>
    </article>

    <!-- Distribuição de Lucros e Outras Destinações de Resultados -->
    <article class="finance-card">
      <h2>Distribuição de Lucros e Outras Destinações de Resultados</h2>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        <!-- Card 1: Distribuição de Lucros -->
        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px; padding: 20px; color: #0f172a;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">💰 Distribuição de Lucros</h3>
            <button class="btn-icon" onclick="openProfitDistributionModal()" title="Editar" style="background: rgba(255, 255, 255, 0.5);">âœï¸</button>
          </div>
          <div style="font-size: 13px; margin-bottom: 4px;">
            <span style="font-weight: 500; color: #64748b;">% sobre resultado operacional:</span>
          </div>
          <div style="font-size: 28px; font-weight: 700; color: #0f172a;" id="profit-distribution-percentage-display">
            {{ fluxo_negocio.distribuicao_lucros.percentual or '-' }}
          </div>
          <div style="font-size: 13px; margin-top: 8px; margin-bottom: 4px;">
            <span style="font-weight: 500; color: #64748b;">Valor estimado:</span>
          </div>
          <div style="font-size: 20px; font-weight: 600; color: #0f172a;" id="profit-distribution-value-display">
            R$ 0,00
          </div>
          {% if fluxo_negocio.distribuicao_lucros.start_date %}
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(15, 23, 42, 0.1);">
              <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">
                <strong>ðŸ“… InÃ­cio do pagamento:</strong>
              </div>
              <div style="font-size: 14px; color: #0f172a; font-weight: 600;" id="profit-distribution-start-date-display">
                {{ fluxo_negocio.distribuicao_lucros.start_date | format_date_br if fluxo_negocio.distribuicao_lucros.start_date else '-' }}
              </div>
            </div>
          {% endif %}
          {% if fluxo_negocio.distribuicao_lucros.observacoes %}
            <div style="margin-top: 12px; font-size: 12px; color: #64748b; font-style: italic; padding-top: 12px; border-top: 1px solid rgba(15, 23, 42, 0.1);">
              {{ fluxo_negocio.distribuicao_lucros.observacoes }}
            </div>
          {% endif %}
        </div>

        <!-- Card 2: Outras Destinações -->
        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 12px; padding: 20px; color: #0f172a;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">📊 Outras Destinações</h3>
            <button class="btn-add" onclick="openResultRuleModal()" style="padding: 6px 12px; font-size: 12px; background: rgba(255, 255, 255, 0.8); color: #0f172a;">
              <span>+</span>
            </button>
          </div>
          <div style="font-size: 13px; margin-bottom: 4px; color: #64748b;">
            <span>Total de destinaÃ§Ãµes (%):</span>
          </div>
          <div style="font-size: 28px; font-weight: 700; color: #0f172a;" id="other-destinations-total">
            0%
          </div>
          <div style="font-size: 13px; margin-top: 8px; margin-bottom: 4px; color: #64748b;">
            <span>Valor estimado:</span>
          </div>
          <div style="font-size: 20px; font-weight: 600; color: #0f172a;" id="other-destinations-value-display">
            R$ 0,00
          </div>
          <div style="margin-top: 12px; max-height: 80px; overflow-y: auto;">
            <div id="other-destinations-list" style="font-size: 12px; color: #64748b;">
              {% if fluxo_negocio.destinacao_regras %}
                {% for item in fluxo_negocio.destinacao_regras %}
                  <div style="padding: 4px 0; border-bottom: 1px solid rgba(15, 23, 42, 0.05);">
                    <strong>{{ item.descricao }}:</strong> {{ item.percentual }}
                  </div>
                {% endfor %}
              {% else %}
                <div style="padding: 12px; text-align: center; color: #94a3b8;">Nenhuma destinaÃ§Ã£o cadastrada</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Card 3: Resultado Final do Período -->
        <div style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); border-radius: 12px; padding: 20px; color: #0f172a; border: 3px solid rgba(16, 185, 129, 0.3);">
          <div style="margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">🎯 Resultado Final do Período</h3>
          </div>
          <div style="font-size: 13px; margin-bottom: 4px; color: #64748b;">
            <span>Valor apÃ³s todas as destinaÃ§Ãµes:</span>
          </div>
          <div style="font-size: 32px; font-weight: 800; color: #059669;" id="final-result-value">
            R$ 0,00
          </div>
          <div style="font-size: 13px; margin-top: 8px; margin-bottom: 4px; color: #64748b;">
            <span>% sobre resultado operacional:</span>
          </div>
          <div style="font-size: 20px; font-weight: 600; color: #059669;" id="final-result-percentage">
            0%
          </div>
          <div style="margin-top: 12px; font-size: 11px; color: #64748b; padding-top: 12px; border-top: 1px solid rgba(15, 23, 42, 0.1);">
            = Resultado Operacional - Distribuição de Lucros - Outras Destinações
          </div>
        </div>
      </div>

      <!-- Tabela de Outras Destinações (expandida) -->
      <div style="margin-top: 24px;">
        <div class="section-header" style="margin-bottom: 12px;">
          <h4 style="margin:0; font-size: 14px; color: #64748b;">Detalhamento de Outras Destinações</h4>
          <button class="btn-add" onclick="openResultRuleModal()" style="padding: 6px 12px; font-size: 13px;">
            <span>+ Adicionar DestinaÃ§Ã£o</span>
          </button>
        </div>
        <table class="finance-table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>% sobre resultado operacional</th>
              <th style="width: 80px;">Ações</th>
            </tr>
          </thead>
          <tbody id="result-rules-tbody">
            {% for item in fluxo_negocio.destinacao_regras %}
              <tr data-id="{{ item.id }}">
                <td>{{ item.descricao }}</td>
                <td>{{ item.percentual }}</td>
                <td>
                  <button class="btn-icon" onclick="editResultRule({{ item.id }})" title="Editar">âœï¸</button>
                  <button class="btn-icon delete" onclick="deleteResultRule({{ item.id }})" title="Deletar">ðŸ—‘ï¸</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>

    <!-- FONTES DE RECURSOS -->
    <article class="finance-card">
      <div class="section-header">
        <h2>Fontes de Recursos</h2>
        <button class="btn-add" onclick="openFundingSourceModal()">
          <span>+</span>
          <span>Adicionar Fonte</span>
        </button>
      </div>
      
      <table class="finance-table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Data</th>
            <th>Valor</th>
            <th>Observações</th>
            <th style="width: 80px;">Ações</th>
          </tr>
        </thead>
        <tbody id="funding-sources-tbody">
          <!-- SerÃ¡ preenchido via JavaScript -->
        </tbody>
      </table>
    </article>

    <!-- FLUXO DE CAIXA DO INVESTIMENTO -->
    <article class="finance-card">
      <h2>Fluxo de Caixa do Investimento</h2>
      <p class="section-note" style="margin-top: 0;">
        * Resumo mensal dos investimentos planejados com base nos valores cadastrados.
      </p>
      <div style="overflow-x: auto;">
        <table class="finance-table" id="investment-cashflow-table">
          <thead>
            <tr>
              <th>Período</th>
              <th>Capital de Giro</th>
              <th>Imobilizado</th>
              <th>Total Investimentos</th>
              <th>Fontes de Recursos</th>
              <th>Saldo do Período</th>
              <th>Saldo Acumulado</th>
            </tr>
          </thead>
          <tbody id="investment-cashflow-tbody">
            <!-- SerÃ¡ preenchido via JavaScript -->
            <tr>
              <td colspan="7" style="text-align: center; color: #64748b; padding: 24px;">
                Aguardando dados de investimento...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- FLUXO DE CAIXA DO NEGÃ“CIO (Read-only) -->
    <article class="finance-card">
      <h2>Fluxo de caixa do negócio</h2>
      <p class="section-note" style="margin-top: 0;">
        * Esta seÃ§Ã£o Ã© calculada automaticamente com base nos dados inseridos acima.
      </p>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Período</th>
            <th>Receita</th>
            <th>VariÃ¡veis</th>
            <th>Margem de contribuiÃ§Ã£o</th>
            <th>Fixos</th>
            <th>Resultado operacional</th>
            <th>DestinaÃ§Ã£o de resultados</th>
            <th>Resultado do período</th>
          </tr>
        </thead>
        <tbody>
          {% for linha in fluxo_negocio.periodos %}
            <tr>
              <td>{{ linha.periodo }}</td>
              <td>{{ linha.receita }}</td>
              <td>{{ linha.variaveis }}</td>
              <td>{{ linha.margem_contribuicao }}</td>
              <td>{{ linha.fixos }}</td>
              <td>{{ linha.resultado_operacional }}</td>
              <td>
                <ul style="margin:0; padding-left:18px;">
                  {% for destino in linha.destinacao %}
                    <li>{{ destino.descricao }} â€“ {{ destino.valor }}</li>
                  {% endfor %}
                </ul>
              </td>
              <td>{{ linha.resultado_periodo }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>

    <!-- FLUXO DE CAIXA DO INVESTIDOR (Read-only) -->
    <article class="finance-card">
      <h2>Fluxo de caixa do investidor</h2>
      <p class="section-note" style="margin-top: 0;">
        * Esta seÃ§Ã£o Ã© calculada automaticamente com base nos dados inseridos acima.
      </p>
      <table class="finance-table">
        <thead>
          <tr>
            <th>Período</th>
            <th>Aporte / Investimento</th>
            <th>DistribuiÃ§Ã£o de lucros</th>
            <th>Saldo do período</th>
            <th>Saldo acumulado</th>
          </tr>
        </thead>
        <tbody>
          {% for linha in fluxo_investidor.periodos %}
            <tr>
              <td>{{ linha.periodo }}</td>
              <td>{{ linha.aporte }}</td>
              <td>{{ linha.distribuicao }}</td>
              <td>{{ linha.saldo }}</td>
              <td>{{ linha.acumulado }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </article>

    <!-- ANÃLISE DE VIABILIDADE -->
    <article class="finance-card">
      <div class="section-header">
        <h2>Análise de Viabilidade</h2>
        <button class="btn-add" onclick="openMetricsModal()">
          <span>âœï¸</span>
          <span>Editar MÃ©tricas</span>
        </button>
      </div>
      <div class="analysis-grid" id="metrics-section">
        <div class="analysis-card">
          <strong>Payback</strong>
          <span id="metric-payback">{{ fluxo_investidor.analises.payback or 'Não definido' }}</span>
        </div>
        <div class="analysis-card">
          <strong>Custo de oportunidade</strong>
          <span id="metric-opportunity-cost">{{ fluxo_investidor.analises.opportunity_cost or '1%' }}</span>
          <small style="display: block; margin-top: 4px; color: #64748b;">Taxa de atratividade do investidor</small>
        </div>
        <div class="analysis-card">
          <strong>{{ fluxo_investidor.analises.tir_label or 'TIR 5 anos' }}</strong>
          <span id="metric-tir">{{ fluxo_investidor.analises.tir or 'Não definido' }}</span>
          <small style="display: block; margin-top: 4px; color: #64748b;">Horizonte: {{ fluxo_investidor.analises.tir_horizon_years or 5 }} anos</small>
        </div>
        <div class="analysis-card" style="grid-column: span 3;">
          <strong>Comentários</strong>
          <span id="metric-notes">{{ fluxo_investidor.analises.comentarios or 'Sem comentários' }}</span>
        </div>
      </div>
    </article>
  </section>

        <h3 id="variableCostModalTitle">Adicionar Custo Variável</h3>
        <button class="btn-close" onclick="closeVariableCostModal()">×</button>
      </div>
      <form id="variableCostForm">
        <input type="hidden" id="variableCostId">
        <div class="form-group">
          <label for="variableCostDescription">Descrição *</label>
          <input type="text" id="variableCostDescription" required>
        </div>
        <div class="form-group">
          <label for="variableCostPercentage">Percentual</label>
          <input type="text" id="variableCostPercentage" placeholder="Ex: 15%">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeVariableCostModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Outras Destinações -->
  <div class="modal" id="resultRuleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="resultRuleModalTitle">Adicionar Outra DestinaÃ§Ã£o</h3>
        <button class="btn-close" onclick="closeResultRuleModal()">×</button>
      </div>
      <form id="resultRuleForm">
        <input type="hidden" id="resultRuleId">
        <div class="form-group">
          <label for="resultRuleDescription">Descrição *</label>
          <input type="text" id="resultRuleDescription" required placeholder="Ex: Reserva de ContingÃªncia, Fundo de Investimento">
        </div>
        <div class="form-group">
          <label for="resultRulePercentage">% sobre resultado operacional *</label>
          <input type="text" id="resultRulePercentage" required placeholder="Ex: 15%">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeResultRuleModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Distribuição de Lucros -->
  <div class="modal" id="profitDistributionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Distribuição de Lucros</h3>
        <button class="btn-close" onclick="closeProfitDistributionModal()">×</button>
      </div>
      <form id="profitDistributionForm">
        <div class="form-group">
          <label for="profitDistributionPercentage">% sobre resultado operacional *</label>
          <input type="text" id="profitDistributionPercentage" required placeholder="Ex: 40%">
        </div>
        <div class="form-group">
          <label for="profitDistributionStartDate">Data de inÃ­cio do pagamento *</label>
          <input type="date" id="profitDistributionStartDate" required>
          <small style="display: block; margin-top: 4px; color: #64748b;">Data a partir da qual a distribuição de lucros começará a ser paga</small>
        </div>
        <div class="form-group">
          <label for="profitDistributionNotes">Observações</label>
          <textarea id="profitDistributionNotes" rows="3" placeholder="Ex: DistribuiÃ§Ã£o mensal aos sócios"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeProfitDistributionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Métricas -->
  <div class="modal" id="metricsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Métricas</h3>
        <button class="btn-close" onclick="closeMetricsModal()">�-</button>
      </div>
      <form id="metricsForm">
        <div class="form-group">
          <label for="metricPayback">Payback</label>
          <input type="text" id="metricPayback" placeholder="Ex: 18 meses">
        </div>
        <div class="form-group">
          <label for="metricOpportunityCost">Custo de oportunidade do investidor</label>
          <input type="text" id="metricOpportunityCost" placeholder="Ex: 1% a.a.">
          <small style="display: block; margin-top: 4px; color: #64748b;">Informe a taxa m�nima de atratividade utilizada como refer�ncia</small>
        </div>
        <div class="form-group">
          <label for="metricTirHorizon">Prazo da TIR</label>
          <select id="metricTirHorizon">
            <option value="2">2 anos</option>
            <option value="3">3 anos</option>
            <option value="5">5 anos</option>
          </select>
        </div>
        <div class="form-group">
          <label for="metricTir">TIR calculada</label>
          <input type="text" id="metricTir" placeholder="Ex: 24%">
        </div>
        <div class="form-group">
          <label for="metricNotes">Comentǭrios</label>
          <textarea id="metricNotes" rows="4"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeMetricsModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
            <option value="">Selecione...</option>
            <option value="Caixa">Caixa</option>
            <option value="Recebíveis">Recebíveis</option>
            <option value="Estoques">Estoques</option>
          </select>
        </div>
        <div class="form-group">
          <label for="capitalGiroDate">Data *</label>
          <input type="date" id="capitalGiroDate" required>
        </div>
        <div class="form-group">
          <label for="capitalGiroDescription">Descrição</label>
          <input type="text" id="capitalGiroDescription" placeholder="Descrição do investimento">
        </div>
        <div class="form-group">
          <label for="capitalGiroAmount">Valor *</label>
          <input type="number" id="capitalGiroAmount" step="0.01" min="0" required placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="capitalGiroNotes">Observações</label>
          <textarea id="capitalGiroNotes" rows="2" placeholder="Observações adicionais"></textarea>
        </div>
        <div class="form-group">
          <label for="capitalGiroCalculationMemo">Memória de cálculo</label>
          <textarea id="capitalGiroCalculationMemo" rows="3" placeholder="Detalhes do cálculo"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeCapitalGiroModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Fonte de Recursos -->
  <div class="modal" id="fundingSourceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="fundingSourceModalTitle">Adicionar Fonte de Recursos</h3>
        <button class="btn-close" onclick="closeFundingSourceModal()">×</button>
      </div>
      <form id="fundingSourceForm">
        <input type="hidden" id="fundingSourceId">
        <div class="form-group">
          <label for="fundingSourceType">Tipo *</label>
          <select id="fundingSourceType" required>
            <option value="">Selecione...</option>
            <option value="Fornecedores">Fornecedores</option>
            <option value="Empréstimos e Financiamentos">Empréstimos e Financiamentos</option>
            <option value="Aporte dos Sócios">Aporte dos Sócios</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fundingSourceDate">Data do Aporte *</label>
          <input type="date" id="fundingSourceDate" required>
        </div>
        <div class="form-group">
          <label for="fundingSourceAmount">Valor *</label>
          <input type="number" id="fundingSourceAmount" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="fundingSourceNotes">Observações</label>
          <textarea id="fundingSourceNotes" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeFundingSourceModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Debug: Log para verificar se o script estÃ¡ carregando
    console.log('[DEBUG] Script de Modelagem Financeira carregado!');
    
    // Global variables
    const urlParams = new URLSearchParams(window.location.search);
    const planId = urlParams.get('plan_id');
    
    console.log('[DEBUG] plan_id:', planId);
    
    const initialProductsTotals = {{ products_totals | tojson | safe }} || {};
    const initialFixedCostsSummary = {{ fixed_costs_summary | tojson | safe }} || {};
    
    // DEBUG: Log dados iniciais do backend
    console.log('📊 [BACKEND] initialProductsTotals:', initialProductsTotals);
    console.log('🏗️ [BACKEND] initialFixedCostsSummary:', initialFixedCostsSummary);
    
    // Parse data with safety checks
    let variableCostsData = {{ fluxo_negocio.variaveis | tojson | safe }};
    let resultRulesData = {{ fluxo_negocio.destinacao_regras | tojson | safe }};
    let metricsData = {{ fluxo_investidor.analises | tojson | safe }};
    if (!metricsData || typeof metricsData !== 'object') {
      metricsData = {};
    }
    if (!metricsData.opportunity_cost || metricsData.opportunity_cost === '') {
      metricsData.opportunity_cost = '1%';
    }
    let tirHorizonYears = parseInt(metricsData.tir_horizon_years, 10);
    if (![2, 3, 5].includes(tirHorizonYears)) {
      tirHorizonYears = 5;
    }
    metricsData.tir_horizon_years = tirHorizonYears;
    if (typeof metricsData.tir !== 'string') {
      metricsData.tir = metricsData.tir ? String(metricsData.tir) : '';
    }
    if (typeof metricsData.payback !== 'string') {
      metricsData.payback = metricsData.payback ? String(metricsData.payback) : '';
    }
    if (typeof metricsData.comentarios !== 'string') {
      metricsData.comentarios = metricsData.comentarios ? String(metricsData.comentarios) : '';
    }
    let profitDistributionData = {{ fluxo_negocio.distribuicao_lucros | tojson | safe }};
    
    // Dados de investimentos vindos das estruturas
    let investimentosEstruturasData = {{ investimentos_estruturas | tojson | safe }};
    
    console.log('[DEBUG] Dados carregados:', {
      custos: variableCostsData.length,
      regras: resultRulesData.length,
      distribuicao_lucros: profitDistributionData,
      investimentos_estruturas: investimentosEstruturasData
    });
    
    // ==================== PRODUTOS E TOTALIZADOS ====================
    let productsData = [];
    
    async function loadProducts() {
      console.log('[PRODUCTS] Carregando produtos...');
      
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/products`);
        const result = await response.json();
        
        if (result.success && result.products) {
          productsData = Array.isArray(result.products) ? result.products : [];
          renderProductsTable();
          console.log('Produtos carregados:', productsData.length);

          const totalsFromApi = result.totals && typeof result.totals === 'object'
            ? normalizeProductsTotals(result.totals)
            : calculateTotalsFromProducts(productsData);

          renderProductsTotals(totalsFromApi);
          await loadFixedCostsSummary();
        } else {
          console.error('Erro ao carregar produtos:', result.error);
          const fallbackTotals = calculateTotalsFromProducts(productsData);
          renderProductsTotals(fallbackTotals);
          await loadFixedCostsSummary();
        }
      } catch (error) {
        console.error('Erro ao buscar produtos:', error);
        const fallbackTotals = calculateTotalsFromProducts(productsData);
        renderProductsTotals(fallbackTotals);
        await loadFixedCostsSummary();
      }
    }
    
    function renderProductsTable() {
      const tbody = document.getElementById('products-list-tbody');
      
      if (!productsData || productsData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 24px; color: #64748b;">
              <div style="font-size: 48px; margin-bottom: 8px;">ðŸ“¦</div>
              <div style="font-size: 14px;">Nenhum produto cadastrado</div>
              <div style="font-size: 12px; margin-top: 4px;">Clique em "Gerenciar Produtos" para cadastrar</div>
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      productsData.forEach(product => {
        const marketShareUnits = product.market_share_goal_monthly_units || 0;
        const marketSharePercent = product.market_share_goal_percent || 0;
        
        html += `
          <tr>
            <td>
              <strong>${product.name || 'Sem nome'}</strong>
              ${product.description ? `<br><small style="color: #64748b;">${product.description}</small>` : ''}
            </td>
            <td>R$ ${formatNumber(product.sale_price || 0)}</td>
            <td>${formatNumber(product.variable_costs_percent || 0)}%</td>
            <td>${formatNumber(product.variable_expenses_percent || 0)}%</td>
            <td><strong style="color: #059669;">${formatNumber(product.unit_contribution_margin_percent || 0)}%</strong></td>
            <td>${formatNumber(marketShareUnits)} un (${formatNumber(marketSharePercent)}%)</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }
    
    function renderProductsTotals(totals) {
      console.log('🎨 [RENDER] renderProductsTotals chamada com:', totals);
      
      const normalizedTotals = normalizeProductsTotals(totals);
      console.log('🔄 [RENDER] Totals normalizados:', normalizedTotals);
      
      if (!normalizedTotals || typeof normalizedTotals !== 'object') {
        console.warn('[WARN] [RENDER] normalizedTotals inválido ou não é objeto');
        return;
      }

      const formatPercent = (value) => `${Number(value ?? 0).toFixed(1)}%`;

      const faturamento = normalizedTotals.faturamento || {};
      console.log('💰 [RENDER] Faturamento a renderizar:', faturamento);
      
      document.getElementById('products-revenue-value').textContent =
        formatCurrency(Number(faturamento.valor ?? 0));
      document.getElementById('products-revenue-percent').textContent =
        formatPercent(faturamento.percentual);

      const custos = normalizedTotals.custos_variaveis || {};
      document.getElementById('products-costs-value').textContent =
        formatCurrency(Number(custos.valor ?? 0));
      document.getElementById('products-costs-percent').textContent =
        formatPercent(custos.percentual);

      const despesas = normalizedTotals.despesas_variaveis || {};
      document.getElementById('products-expenses-value').textContent =
        formatCurrency(Number(despesas.valor ?? 0));
      document.getElementById('products-expenses-percent').textContent =
        formatPercent(despesas.percentual);

      const margem = normalizedTotals.margem_contribuicao || {};
      document.getElementById('products-margin-value').textContent =
        formatCurrency(Number(margem.valor ?? 0));
      document.getElementById('products-margin-percent').textContent =
        formatPercent(margem.percentual);

      window.margemContribuicaoValor = Number(margem.valor ?? 0);
      window.currentProductsTotals = normalizedTotals;

      if (typeof window.resultadoOperacionalValor === 'number') {
        calculateFinalResults();
      }
    }

    function renderFixedCostsSummary(data) {
      if (!data || typeof data !== 'object') {
        return;
      }

      const custosFixos = Number(data.custos_fixos_mensal ?? data.custos_fixos ?? 0);
      const despesasFixas = Number(data.despesas_fixas_mensal ?? data.despesas_fixas ?? 0);

      document.getElementById('fixed-costs-value').textContent =
        formatCurrency(custosFixos);
      document.getElementById('fixed-expenses-value').textContent =
        formatCurrency(despesasFixas);

      const margemContribuicao = Number(window.margemContribuicaoValor || 0);
      const resultadoOperacional = margemContribuicao - custosFixos - despesasFixas;

      document.getElementById('operational-result-value').textContent =
        formatCurrency(resultadoOperacional);

      window.resultadoOperacionalValor = resultadoOperacional;

      calculateFinalResults();
    }

    async function loadProductsTotals() {
      console.log('Carregando totalizados de produtos...');
      
      const fallbackTotals = calculateTotalsFromProducts(productsData);
      renderProductsTotals(fallbackTotals);

      let totalsResolved = false;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/products/totals`);
        const result = await response.json();
        
        if (result.success && result.totals) {
          renderProductsTotals(normalizeProductsTotals(result.totals));
          console.log('Totalizados carregados:', result.totals);
          totalsResolved = true;
        } else {
          console.error('Erro ao carregar totalizados:', result.error);
        }
      } catch (error) {
        console.error('Erro ao buscar totalizados:', error);
      } finally {
        if (!totalsResolved) {
          renderProductsTotals(fallbackTotals);
        }
        await loadFixedCostsSummary();
      }
    }

    async function loadFixedCostsSummary() {
      console.log('[LOAD] Carregando custos e despesas fixas...');
      
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/structures/fixed-costs-summary`);
        const result = await response.json();
        
        if (result.success && result.data) {
          renderFixedCostsSummary(result.data);
          console.log('[OK] Custos fixos carregados:', result.data);
        } else {
          console.error('[ERROR] Erro ao carregar custos fixos:', result.error);
        }
      } catch (error) {
        console.error('[ERROR] Erro ao buscar custos fixos:', error);
      }
    }

    function calculateFinalResults() {
      console.log('[CALC] Calculando resultados finais...');
      
      const resultadoOperacional = window.resultadoOperacionalValor || 0;
      
      // Obter percentual de distribuição de lucros
      const profitDistributionElement = document.getElementById('profit-distribution-percentage-display');
      const profitDistributionText = profitDistributionElement ? profitDistributionElement.textContent.trim() : '-';
      
      let profitDistributionPercent = 0;
      if (profitDistributionText && profitDistributionText !== '-') {
        // Extrair nÃºmero do texto (ex: "30%" -> 30)
        const match = profitDistributionText.match(/(\d+(?:\.\d+)?)/);
        if (match) {
          profitDistributionPercent = parseFloat(match[1]);
        }
      }
      
      // Calcular valor de distribuição de lucros
      const profitDistributionValue = (resultadoOperacional * profitDistributionPercent) / 100;
      
      // Atualizar valor de distribuição de lucros no card
      const profitDistributionValueElement = document.getElementById('profit-distribution-value-display');
      if (profitDistributionValueElement) {
        profitDistributionValueElement.textContent = formatCurrency(profitDistributionValue);
      }
      
      // Calcular total de outras destinaÃ§Ãµes
      let otherDestinationsPercent = 0;
      const resultRulesTbody = document.getElementById('result-rules-tbody');
      if (resultRulesTbody) {
        const rows = resultRulesTbody.querySelectorAll('tr[data-id]');
        rows.forEach(row => {
          const percentCell = row.cells[1]; // Segunda coluna (percentual)
          if (percentCell) {
            const percentText = percentCell.textContent.trim();
            const match = percentText.match(/(\d+(?:\.\d+)?)/);
            if (match) {
              otherDestinationsPercent += parseFloat(match[1]);
            }
          }
        });
      }
      
      // Atualizar total de outras destinaÃ§Ãµes (percentual)
      const otherDestinationsTotalElement = document.getElementById('other-destinations-total');
      if (otherDestinationsTotalElement) {
        otherDestinationsTotalElement.textContent = `${otherDestinationsPercent.toFixed(1)}%`;
      }
      
      // Calcular valor de outras destinaÃ§Ãµes
      const otherDestinationsValue = (resultadoOperacional * otherDestinationsPercent) / 100;
      
      // Atualizar valor de outras destinaÃ§Ãµes no card
      const otherDestinationsValueElement = document.getElementById('other-destinations-value-display');
      if (otherDestinationsValueElement) {
        otherDestinationsValueElement.textContent = formatCurrency(otherDestinationsValue);
      }
      
      // Calcular resultado final
      const finalResult = resultadoOperacional - profitDistributionValue - otherDestinationsValue;
      
      // Calcular percentual do resultado final sobre resultado operacional
      let finalResultPercent = 0;
      if (resultadoOperacional !== 0) {
        finalResultPercent = (finalResult / resultadoOperacional) * 100;
      }
      
      // Atualizar resultado final (valor)
      const finalResultElement = document.getElementById('final-result-value');
      if (finalResultElement) {
        finalResultElement.textContent = formatCurrency(finalResult);
        
        // Adicionar classe de cor baseada no resultado
        if (finalResult < 0) {
          finalResultElement.style.color = '#dc2626'; // vermelho
        } else {
          finalResultElement.style.color = '#059669'; // verde
        }
      }
      
      // Atualizar resultado final (percentual)
      const finalResultPercentElement = document.getElementById('final-result-percentage');
      if (finalResultPercentElement) {
        finalResultPercentElement.textContent = `${finalResultPercent.toFixed(1)}%`;
        
        // Adicionar classe de cor baseada no resultado
        if (finalResult < 0) {
          finalResultPercentElement.style.color = '#dc2626'; // vermelho
        } else {
          finalResultPercentElement.style.color = '#059669'; // verde
        }
      }
      
      console.log('[OK] Resultados finais calculados:');
      console.log('   - Resultado Operacional:', resultadoOperacional);
      console.log('   - Distribuição de Lucros:', profitDistributionPercent + '%', profitDistributionValue);
      console.log('   - Outras Destinações:', otherDestinationsPercent + '%', otherDestinationsValue);
      console.log('   - Resultado Final:', finalResultPercent.toFixed(1) + '%', finalResult);
    }
    
    // Helper para formatar nÃºmeros
    function formatNumber(value) {
      if (value === null || value === undefined) return '0,00';
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }
    
    // Helper para formatar moeda
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    const ensureNumber = (value) => {
      if (value === null || value === undefined) return 0;
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value : 0;
      }

      let sanitized = String(value).trim();
      if (!sanitized) return 0;

      sanitized = sanitized.replace(/[R$%\s]/g, '');

      const commaCount = (sanitized.match(/,/g) || []).length;
      const dotCount = (sanitized.match(/\./g) || []).length;

      if (commaCount && dotCount) {
        sanitized = sanitized.replace(/\./g, '').replace(',', '.');
      } else if (commaCount === 1 && dotCount === 0) {
        sanitized = sanitized.replace(',', '.');
      } else {
        sanitized = sanitized.replace(/,/g, '');
      }

      const parsed = Number(sanitized);
      return Number.isFinite(parsed) ? parsed : 0;
    };

    function calculateTotalsFromProducts(products) {
      if (!Array.isArray(products) || products.length === 0) {
        return {
          count: 0,
          market_revenue: 0,
          average_margin_percent: 0,
          share_goal_units: 0,
          faturamento: { valor: 0, percentual: 0 },
          custos_variaveis: { valor: 0, percentual: 0 },
          despesas_variaveis: { valor: 0, percentual: 0 },
          margem_contribuicao: { valor: 0, percentual: 0 },
          meta_market_share: { unidades: 0, percentual: 0 }
        };
      }

      let totalMarketRevenue = 0;
      let totalUnitsGoal = 0;
      let totalRevenueGoal = 0;
      let totalCostValue = 0;
      let totalExpenseValue = 0;
      let totalMarginValue = 0;
      let marginPercentSum = 0;
      let sharePercentWeighted = 0;
      let shareWeight = 0;

      products.forEach((item) => {
        const marketRevenue = ensureNumber(item.market_size_monthly_revenue);
        totalMarketRevenue += marketRevenue;

        let sharePercent = ensureNumber(item.market_share_goal_percent);
        const marketUnits = ensureNumber(item.market_size_monthly_units);
        let unitsGoal = ensureNumber(item.market_share_goal_monthly_units);

        if (!unitsGoal && sharePercent > 0 && marketUnits > 0) {
          unitsGoal = (sharePercent / 100) * marketUnits;
        }
        totalUnitsGoal += unitsGoal;

        const salePrice = ensureNumber(item.sale_price);
        const revenueGoal = salePrice * unitsGoal;
        totalRevenueGoal += revenueGoal;

        let costPercent = ensureNumber(item.variable_costs_percent);
        let costUnit = ensureNumber(item.variable_costs_value);
        if (!costUnit && costPercent && salePrice) {
          costUnit = (salePrice * costPercent) / 100;
        }

        let expensePercent = ensureNumber(item.variable_expenses_percent);
        let expenseUnit = ensureNumber(item.variable_expenses_value);
        if (!expenseUnit && expensePercent && salePrice) {
          expenseUnit = (salePrice * expensePercent) / 100;
        }

        let marginPercent = ensureNumber(item.unit_contribution_margin_percent);
        let marginUnit = ensureNumber(item.unit_contribution_margin_value);
        if (!marginUnit && salePrice) {
          marginUnit = salePrice - costUnit - expenseUnit;
        }
        if (!marginPercent && salePrice) {
          marginPercent = salePrice ? (marginUnit / salePrice) * 100 : 0;
        }

        const costTotal = costUnit * unitsGoal;
        const expenseTotal = expenseUnit * unitsGoal;
        let marginTotal = marginUnit * unitsGoal;
        if (!marginTotal && revenueGoal > 0) {
          marginTotal = revenueGoal - costTotal - expenseTotal;
        }

        totalCostValue += costTotal;
        totalExpenseValue += expenseTotal;
        totalMarginValue += marginTotal;
        marginPercentSum += marginPercent;

        if (sharePercent > 0) {
          if (marketUnits > 0) {
            sharePercentWeighted += sharePercent * marketUnits;
            shareWeight += marketUnits;
          } else {
            sharePercentWeighted += sharePercent;
            shareWeight += 1;
          }
        }
      });

      const percent = (part, whole) => (whole > 0 ? (part / whole) * 100 : 0);
      const averageMargin = products.length ? marginPercentSum / products.length : 0;
      const sharePercentOverall = shareWeight > 0 ? sharePercentWeighted / shareWeight : 0;

      return {
        count: products.length,
        market_revenue: totalMarketRevenue,
        average_margin_percent: averageMargin,
        share_goal_units: totalUnitsGoal,
        faturamento: {
          valor: totalRevenueGoal,
          percentual: totalRevenueGoal > 0 ? 100 : 0,
        },
        custos_variaveis: {
          valor: totalCostValue,
          percentual: percent(totalCostValue, totalRevenueGoal),
        },
        despesas_variaveis: {
          valor: totalExpenseValue,
          percentual: percent(totalExpenseValue, totalRevenueGoal),
        },
        margem_contribuicao: {
          valor: totalMarginValue,
          percentual: percent(totalMarginValue, totalRevenueGoal),
        },
        meta_market_share: {
          unidades: totalUnitsGoal,
          percentual: sharePercentOverall,
        },
      };
    }

    function normalizeProductsTotals(rawTotals) {
      const ensureBucket = (bucket) => ({
        valor: ensureNumber(bucket?.valor),
        percentual: ensureNumber(bucket?.percentual),
      });

      if (rawTotals && typeof rawTotals === 'object' && rawTotals.faturamento) {
        return {
          count: ensureNumber(rawTotals.count ?? productsData.length),
          market_revenue: ensureNumber(rawTotals.market_revenue),
          average_margin_percent: ensureNumber(rawTotals.average_margin_percent),
          share_goal_units: ensureNumber(rawTotals.share_goal_units),
          faturamento: ensureBucket(rawTotals.faturamento),
          custos_variaveis: ensureBucket(rawTotals.custos_variaveis),
          despesas_variaveis: ensureBucket(rawTotals.despesas_variaveis),
          margem_contribuicao: ensureBucket(rawTotals.margem_contribuicao),
          meta_market_share: {
            unidades: ensureNumber(
              rawTotals.meta_market_share?.unidades ?? rawTotals.share_goal_units
            ),
            percentual: ensureNumber(
              rawTotals.meta_market_share?.percentual ??
              rawTotals.share_goal_percent ??
              rawTotals.share_percent
            ),
          },
        };
      }

      if (rawTotals && typeof rawTotals === 'object') {
        const fallback = calculateTotalsFromProducts(productsData);
        const revenue = ensureNumber(
          rawTotals.revenue ??
          rawTotals.revenue_total ??
          rawTotals.market_revenue ??
          fallback.faturamento.valor
        );
        const costs = ensureNumber(
          rawTotals.cost ??
          rawTotals.costs ??
          rawTotals.total_cost ??
          rawTotals.custos_variaveis_valor ??
          fallback.custos_variaveis.valor
        );
        const expenses = ensureNumber(
          rawTotals.expense ??
          rawTotals.expenses ??
          rawTotals.total_expense ??
          rawTotals.despesas_variaveis_valor ??
          fallback.despesas_variaveis.valor
        );
        const margin = ensureNumber(
          rawTotals.margin ??
          rawTotals.margem ??
          rawTotals.margem_contribuicao_valor ??
          (revenue - costs - expenses)
        );
        const percent = (part, whole) => (whole > 0 ? (part / whole) * 100 : 0);

        return {
          count: ensureNumber(rawTotals.count ?? fallback.count),
          market_revenue: ensureNumber(rawTotals.market_revenue ?? fallback.market_revenue),
          average_margin_percent: ensureNumber(
            rawTotals.average_margin_percent ?? fallback.average_margin_percent
          ),
          share_goal_units: ensureNumber(rawTotals.share_goal_units ?? fallback.share_goal_units),
          faturamento: {
            valor: revenue,
            percentual: revenue > 0 ? 100 : 0,
          },
          custos_variaveis: {
            valor: costs,
            percentual: percent(costs, revenue),
          },
          despesas_variaveis: {
            valor: expenses,
            percentual: percent(expenses, revenue),
          },
          margem_contribuicao: {
            valor: margin,
            percentual: percent(margin, revenue),
          },
          meta_market_share: {
            unidades: ensureNumber(
              rawTotals.share_goal_units ?? fallback.meta_market_share.unidades
            ),
            percentual: ensureNumber(
              rawTotals.share_goal_percent ??
              rawTotals.share_percent ??
              fallback.meta_market_share.percentual
            ),
          },
        };
      }

      return calculateTotalsFromProducts(productsData);
    }

    console.log('🚀 [INIT] Iniciando renderização...');
    console.log('🔍 [INIT] Has initialProductsTotals?', !!initialProductsTotals, 'Keys:', Object.keys(initialProductsTotals).length);
    console.log('🔍 [INIT] Has initialFixedCostsSummary?', !!initialFixedCostsSummary, 'Keys:', Object.keys(initialFixedCostsSummary).length);
    
    if (initialProductsTotals && Object.keys(initialProductsTotals).length) {
      console.log('✅ [INIT] Renderizando products totals iniciais...');
      renderProductsTotals(initialProductsTotals);
    } else {
      console.warn('[WARN] [INIT] initialProductsTotals vazio, pulando renderização inicial');
    }

    if (initialFixedCostsSummary && Object.keys(initialFixedCostsSummary).length) {
      console.log('✅ [INIT] Renderizando fixed costs summary iniciais...');
      renderFixedCostsSummary(initialFixedCostsSummary);
    } else {
      console.warn('[WARN] [INIT] initialFixedCostsSummary vazio, pulando renderização inicial');
    }

    // Carregar produtos e totalizados ao iniciar
    if (planId) {
      console.log('🌐 [INIT] Carregando dados via AJAX...');
      loadProducts();
    } else {
      console.error('❌ [INIT] plan_id não encontrado!');
    }

    // ==================== CUSTOS VARIÃVEIS ====================
    function openVariableCostModal(costId = null) {
      const modal = document.getElementById('variableCostModal');
      const form = document.getElementById('variableCostForm');
      const title = document.getElementById('variableCostModalTitle');
      
      if (costId) {
        const cost = variableCostsData.find(c => c.id === costId);
        if (cost) {
          title.textContent = 'Editar Custo Variável';
          document.getElementById('variableCostId').value = cost.id;
          document.getElementById('variableCostDescription').value = cost.descricao || '';
          document.getElementById('variableCostPercentage').value = cost.percentual || '';
        }
      } else {
        title.textContent = 'Adicionar Custo Variável';
        form.reset();
      }
      
      // PadrÃ£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeVariableCostModal() {
      const modal = document.getElementById('variableCostModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('variableCostForm').reset();
    }

    document.getElementById('variableCostForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const costId = document.getElementById('variableCostId').value;
      const data = {
        description: document.getElementById('variableCostDescription').value,
        percentage: document.getElementById('variableCostPercentage').value
      };

      try {
        let response;
        if (costId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs/${costId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Custo variÃ¡vel salvo com sucesso!');
          closeVariableCostModal();
          location.reload();
        } else {
          alert('Erro ao salvar custo variÃ¡vel');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar custo variÃ¡vel');
      }
    });

    function editVariableCost(id) {
      openVariableCostModal(id);
    }

    async function deleteVariableCost(id) {
      if (!confirm('Tem certeza que deseja deletar este custo variÃ¡vel?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/variable_costs/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Custo variÃ¡vel deletado com sucesso!');
          location.reload();
        } else {
          alert('Erro ao deletar custo variÃ¡vel');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar custo variÃ¡vel');
      }
    }

    // ==================== OUTRAS DESTINAÃ‡Ã•ES ====================
    function openResultRuleModal(ruleId = null) {
      const modal = document.getElementById('resultRuleModal');
      const form = document.getElementById('resultRuleForm');
      const title = document.getElementById('resultRuleModalTitle');
      
      if (ruleId) {
        const rule = resultRulesData.find(r => r.id === ruleId);
        if (rule) {
          title.textContent = 'Editar Outra DestinaÃ§Ã£o';
          document.getElementById('resultRuleId').value = rule.id;
          document.getElementById('resultRuleDescription').value = rule.descricao || '';
          document.getElementById('resultRulePercentage').value = rule.percentual || '';
        }
      } else {
        title.textContent = 'Adicionar Outra DestinaÃ§Ã£o';
        form.reset();
      }
      
      // PadrÃ£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeResultRuleModal() {
      const modal = document.getElementById('resultRuleModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('resultRuleForm').reset();
    }

    document.getElementById('resultRuleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const ruleId = document.getElementById('resultRuleId').value;
      const data = {
        description: document.getElementById('resultRuleDescription').value,
        percentage: document.getElementById('resultRulePercentage').value,
        periodicity: ''  // NÃ£o usamos mais periodicidade
      };

      try {
        let response;
        if (ruleId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules/${ruleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('DestinaÃ§Ã£o salva com sucesso!');
          closeResultRuleModal();
          location.reload();
        } else {
          alert('Erro ao salvar destinaÃ§Ã£o');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar destinaÃ§Ã£o');
      }
    });

    function editResultRule(id) {
      openResultRuleModal(id);
    }

    async function deleteResultRule(id) {
      if (!confirm('Tem certeza que deseja deletar esta destinaÃ§Ã£o?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/result_rules/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('DestinaÃ§Ã£o deletada com sucesso!');
          location.reload();
        } else {
          alert('Erro ao deletar destinaÃ§Ã£o');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar destinaÃ§Ã£o');
      }
    }

    // ==================== DISTRIBUIÃ‡ÃƒO DE LUCROS ====================
    function openProfitDistributionModal() {
      const modal = document.getElementById('profitDistributionModal');
      
      document.getElementById('profitDistributionPercentage').value = profitDistributionData.percentual || '';
      document.getElementById('profitDistributionStartDate').value = profitDistributionData.start_date || '';
      document.getElementById('profitDistributionNotes').value = profitDistributionData.observacoes || '';
      
      // PadrÃ£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeProfitDistributionModal() {
      const modal = document.getElementById('profitDistributionModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('profitDistributionForm').reset();
    }

    document.getElementById('profitDistributionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        percentage: document.getElementById('profitDistributionPercentage').value,
        start_date: document.getElementById('profitDistributionStartDate').value,
        notes: document.getElementById('profitDistributionNotes').value
      };

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/profit_distribution`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('DistribuiÃ§Ã£o de lucros atualizada com sucesso!');
          closeProfitDistributionModal();
          location.reload();
        } else {
          alert('Erro ao atualizar distribuição de lucros');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao atualizar distribuição de lucros');
      }
    });

    // ==================== MÃ‰TRICAS ====================
    function openMetricsModal() {
      const modal = document.getElementById('metricsModal');
      
      document.getElementById('metricPayback').value = metricsData.payback || '';
      document.getElementById('metricOpportunityCost').value = metricsData.opportunity_cost || '1%';
      const tirHorizonField = document.getElementById('metricTirHorizon');
      const horizonValue = metricsData.tir_horizon_years ? String(metricsData.tir_horizon_years) : '5';
      if (tirHorizonField) {
        tirHorizonField.value = ['2', '3', '5'].includes(horizonValue) ? horizonValue : '5';
      }
      document.getElementById('metricTir').value = metricsData.tir || '';
      document.getElementById('metricNotes').value = metricsData.comentarios || '';
      
      // PadrÃ£o PFPN
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeMetricsModal() {
      const modal = document.getElementById('metricsModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('metricsForm').reset();
    }

    document.getElementById('metricsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const opportunityField = document.getElementById('metricOpportunityCost');
      const horizonField = document.getElementById('metricTirHorizon');
      const selectedHorizon = horizonField ? parseInt(horizonField.value, 10) : 5;
      const normalizedHorizon = [2, 3, 5].includes(selectedHorizon) ? selectedHorizon : 5;
      const data = {
        payback: document.getElementById('metricPayback').value,
        tir: document.getElementById('metricTir').value,
        notes: document.getElementById('metricNotes').value,
        opportunity_cost: opportunityField ? opportunityField.value : '',
        tir_horizon_years: normalizedHorizon
      };

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/metrics`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('MÃ©tricas atualizadas com sucesso!');
          closeMetricsModal();
          location.reload();
        } else {
          alert('Erro ao atualizar mÃ©tricas');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao atualizar mÃ©tricas');
      }
    });

    // ==================== INVESTIMENTO EM CAPITAL DE GIRO ====================
    function openCapitalGiroModal(contributionId = null) {
      const modal = document.getElementById('capitalGiroModal');
      const form = document.getElementById('capitalGiroForm');
      const title = document.getElementById('capitalGiroModalTitle');
      
      if (contributionId) {
        title.textContent = 'Editar Investimento em Capital de Giro';
        document.getElementById('capitalGiroId').value = contributionId;
        // Aqui carregarÃ­amos os dados existentes se necessÃ¡rio
      } else {
        title.textContent = 'Cadastrar Investimento em Capital de Giro';
        form.reset();
      }
      
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeCapitalGiroModal() {
      const modal = document.getElementById('capitalGiroModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('capitalGiroForm').reset();
    }

    document.getElementById('capitalGiroForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const contributionId = document.getElementById('capitalGiroId').value;
      const type = document.getElementById('capitalGiroType').value;
      const amount = parseFloat(document.getElementById('capitalGiroAmount').value);
      
      console.log('[DEBUG] Salvando investimento:', { type, amount });
      
      // Mapear tipo para item_id
      const typeToItemId = {
        'Caixa': 1,
        'Recebíveis': 2,
        'Estoques': 3
      };
      
      const itemId = typeToItemId[type];
      if (!itemId) {
        alert('Tipo de investimento invÃ¡lido');
        return;
      }
      
      const data = {
        item_id: itemId,
        contribution_date: document.getElementById('capitalGiroDate').value,
        description: document.getElementById('capitalGiroDescription').value,
        adjusted_value: amount,
        amount: amount,
        calculation_memo: document.getElementById('capitalGiroCalculationMemo').value,
        notes: document.getElementById('capitalGiroNotes').value
      };

      console.log('[DEBUG] Dados a serem enviados:', data);

      try {
        let response;
        if (contributionId) {
          console.log('[DEBUG] Atualizando investimento ID:', contributionId);
          response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions/${contributionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          console.log('[DEBUG] Criando novo investimento');
          response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        const result = await response.json();
        console.log('[DEBUG] Resposta da API:', result);

        if (response.ok && result.success) {
          console.log('[OK] Investimento salvo com sucesso!');
          alert('Investimento cadastrado com sucesso!');
          closeCapitalGiroModal();
          loadInvestmentData();
          loadCapitalGiroContributions();
        } else {
          console.error('âŒ Erro ao salvar:', result);
          alert('Erro ao cadastrar investimento: ' + (result.error || 'Erro desconhecido'));
        }
      } catch (error) {
        console.error('âŒ Exception:', error);
        alert('Erro ao cadastrar investimento: ' + error.message);
      }
    });

    // ==================== INVESTMENT CONTRIBUTIONS ====================
    // Armazenar itens carregados (usado apenas para cache interno)
    let investmentItemsCache = [];
    
    // Carregar e exibir investimentos em capital de giro
    async function loadCapitalGiroContributions() {
      try {
        console.log('[LOAD] Carregando investimentos de capital de giro...');
        
        const tbody = document.getElementById('capital-giro-contributions-tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: #64748b;">Carregando...</td></tr>';
        
        // Mapear item_id para nome
        const itemIdToName = {
          1: 'Caixa',
          2: 'Recebíveis',
          3: 'Estoques'
        };
        
        // Buscar contribuiÃ§Ãµes de todos os itens de capital de giro (IDs 1, 2, 3)
        const allContributions = [];
        
        for (const itemId of [1, 2, 3]) {
          try {
            const response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions?item_id=${itemId}`);
            const result = await response.json();
            
            console.log(`[ITEMS] Contribuições do item ${itemId}:`, result);
            
            if (result.success && result.data && result.data.length > 0) {
              result.data.forEach(contrib => {
                allContributions.push({
                  ...contrib,
                  type_name: itemIdToName[itemId],
                  item_id: itemId
                });
              });
            }
          } catch (error) {
            console.error(`âŒ Erro ao carregar contribuiÃ§Ãµes do item ${itemId}:`, error);
          }
        }
        
        console.log('📊 Total de contribuiÃ§Ãµes encontradas:', allContributions.length);
        console.log('📊 Contribuições:', allContributions);
        
        tbody.innerHTML = '';
        
        if (allContributions.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 24px; color: #64748b;">
                <div style="font-size: 48px; margin-bottom: 8px;">ðŸ’¼</div>
                <div style="font-size: 14px;">Nenhum investimento cadastrado</div>
                <div style="font-size: 12px; margin-top: 4px;">Clique em "Cadastrar Investimento em Capital de Giro" para adicionar</div>
              </td>
            </tr>
          `;
          return;
        }
        
        // Ordenar por data (mais recentes primeiro)
        allContributions.sort((a, b) => new Date(b.contribution_date) - new Date(a.contribution_date));
        
        allContributions.forEach(contrib => {
          const row = document.createElement('tr');
          const date = new Date(contrib.contribution_date);
          const formattedDate = date.toLocaleDateString('pt-BR');
          const amount = parseFloat(contrib.amount || 0);
          
          row.innerHTML = `
            <td><strong>${contrib.type_name}</strong></td>
            <td>${formattedDate}</td>
            <td>${contrib.description || '-'}</td>
            <td style="font-weight: 600; color: #059669;">R$ ${amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            <td>${contrib.notes || '-'}</td>
            <td>
              <button class="btn-icon delete" onclick="deleteCapitalGiroContribution(${contrib.id})" title="Deletar">ðŸ—‘ï¸</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        console.log('[OK] Tabela de investimentos atualizada');
        
      } catch (error) {
        console.error('âŒ Erro ao carregar investimentos:', error);
        const tbody = document.getElementById('capital-giro-contributions-tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 24px; color: #ef4444;">
              Erro ao carregar investimentos
            </td>
          </tr>
        `;
      }
    }
    
    async function deleteCapitalGiroContribution(contributionId) {
      if (!confirm('Tem certeza que deseja deletar este investimento?')) return;
      
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions/${contributionId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Investimento deletado com sucesso!');
          loadCapitalGiroContributions();
          loadInvestmentData();
        } else {
          alert('Erro ao deletar investimento');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar investimento');
      }
    }

    // ==================== FUNDING SOURCES ====================
    function openFundingSourceModal(sourceId = null) {
      const modal = document.getElementById('fundingSourceModal');
      const form = document.getElementById('fundingSourceForm');
      const title = document.getElementById('fundingSourceModalTitle');
      
      if (sourceId) {
        title.textContent = 'Editar Fonte de Recursos';
        document.getElementById('fundingSourceId').value = sourceId;
      } else {
        title.textContent = 'Adicionar Fonte de Recursos';
        form.reset();
      }
      
      modal.style.display = 'block';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeFundingSourceModal() {
      const modal = document.getElementById('fundingSourceModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
      document.getElementById('fundingSourceForm').reset();
    }

    document.getElementById('fundingSourceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const sourceId = document.getElementById('fundingSourceId').value;
      const data = {
        source_type: document.getElementById('fundingSourceType').value,
        contribution_date: document.getElementById('fundingSourceDate').value,
        amount: parseFloat(document.getElementById('fundingSourceAmount').value),
        notes: document.getElementById('fundingSourceNotes').value
      };

      try {
        let response;
        if (sourceId) {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources/${sourceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (response.ok) {
          alert('Fonte de recursos salva com sucesso!');
          closeFundingSourceModal();
          loadFundingSources();
        } else {
          alert('Erro ao salvar fonte de recursos');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao salvar fonte de recursos');
      }
    });

    async function loadFundingSources() {
      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources`);
        const result = await response.json();
        
        if (result.success) {
          const tbody = document.getElementById('funding-sources-tbody');
          tbody.innerHTML = '';
          
          result.data.forEach(source => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${source.source_type}</td>
              <td>${source.contribution_date}</td>
              <td>R$ ${source.amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
              <td>${source.notes || '-'}</td>
              <td>
                <button class="btn-icon" onclick="editFundingSource(${source.id})" title="Editar">âœï¸</button>
                <button class="btn-icon delete" onclick="deleteFundingSource(${source.id})" title="Deletar">ðŸ—‘ï¸</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading funding sources:', error);
      }
    }

    async function deleteFundingSource(sourceId) {
      if (!confirm('Tem certeza que deseja deletar esta fonte de recursos?')) return;

      try {
        const response = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources/${sourceId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Fonte de recursos deletada com sucesso!');
          loadFundingSources();
        } else {
          alert('Erro ao deletar fonte de recursos');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erro ao deletar fonte de recursos');
      }
    }

    function editFundingSource(sourceId) {
      openFundingSourceModal(sourceId);
    }

    async function loadInvestmentData() {
      try {
        console.log('[LOAD] Loading investment data...');
        
        // Criar estrutura de categorias e itens manualmente
        const categories = [
          {
            id: 1,
            category_name: 'Capital de Giro',
            category_type: 'capital_giro'
          },
          {
            id: 2,
            category_name: 'Imobilizado',
            category_type: 'imobilizado'
          }
        ];
        
        const items = [
          // Capital de Giro
          { id: 1, item_name: 'Caixa', category_id: 1 },
          { id: 2, item_name: 'Recebíveis', category_id: 1 },
          { id: 3, item_name: 'Estoques', category_id: 1 },
          // Imobilizado
          { id: 4, item_name: 'Instalações', category_id: 2 },
          { id: 5, item_name: 'Máquinas e Equipamentos', category_id: 2 },
          { id: 6, item_name: 'Outros Investimentos', category_id: 2 }
        ];
        
        console.log('[OK] Categories and items structure created');
        console.log('ðŸ—ï¸ Investimentos das Estruturas:', investimentosEstruturasData);
        
        // Atualizar totais por item
        const itemTotals = {};
        const itemsByMonth = {};
        
        // Limpar cache de itens
        investmentItemsCache = [];
        
        // Para cada item, buscar suas contribuiÃ§Ãµes
        for (const item of items) {
          const category = categories.find(c => c.id === item.category_id);
          
          // Adicionar item ao cache
          investmentItemsCache.push({
            id: item.id,
            item_name: item.item_name,
            category_name: category.category_name,
            category_id: category.id
          });
          
          // Se for item de Imobilizado, usar valores das estruturas
          if (item.category_id === 2) {
            let estruturaData = null;
            
            // Mapear itens para dados de estruturas
            if (item.item_name === 'Instalações' && investimentosEstruturasData.instalacoes) {
              estruturaData = investimentosEstruturasData.instalacoes;
            } else if (item.item_name === 'Máquinas e Equipamentos' && investimentosEstruturasData.maquinas) {
              estruturaData = investimentosEstruturasData.maquinas;
            } else if (item.item_name === 'Outros Investimentos' && investimentosEstruturasData.outros) {
              estruturaData = investimentosEstruturasData.outros;
            }
            
            if (estruturaData && estruturaData.total > 0) {
              const estruturaTotal = parseFloat(estruturaData.total) || 0;
              itemTotals[item.id] = estruturaTotal;
              
              // Usar dados por mês das parcelas
              const porMes = estruturaData.por_mes || {};
              itemsByMonth[item.id] = porMes;
              
              console.log(`  ðŸ—ï¸ Estruturas - ${item.item_name}: R$ ${estruturaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
              console.log(`     DistribuiÃ§Ã£o mensal:`, porMes);
            }
          }
          
          try {
            // Buscar contribuiÃ§Ãµes deste item (Capital de Giro)
            const contribResponse = await fetch(`/pev/api/implantacao/${planId}/finance/investment/contributions?item_id=${item.id}`);
            const contribResult = await contribResponse.json();
            
            console.log(`[ITEMS] Item ${item.item_name} (ID: ${item.id}):`, contribResult);
            
            if (contribResult.success && contribResult.data && contribResult.data.length > 0) {
              let total = 0;
              const monthlyData = {};
              
              contribResult.data.forEach(contrib => {
                const amount = parseFloat(contrib.amount || 0);
                total += amount;
                
                // Agrupar por mês
                const date = new Date(contrib.contribution_date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                  monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += amount;
              });
              
              itemTotals[item.id] = total;
              itemsByMonth[item.id] = monthlyData;
              
              console.log(`  💰 Total: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
            } else {
              console.log(`  ℹ️ Sem contribuiÃ§Ãµes`);
            }
          } catch (error) {
            console.error(`âŒ Erro ao buscar contribuiÃ§Ãµes do item ${item.item_name}:`, error);
          }
        }
        
        console.log('📊 Totais por item:', itemTotals);
        console.log('📊 Dados mensais:', itemsByMonth);
        
        // Renderizar planilha por período
        renderInvestmentSpreadsheet(categories, itemsByMonth, itemTotals);
        
        // Renderizar fluxo de caixa do investimento
        renderInvestmentCashflow(categories, itemsByMonth, itemTotals);
        
        console.log('[OK] Investment data loaded successfully');
        console.log(`[ITEMS] Investment items cached: ${investmentItemsCache.length}`, investmentItemsCache);
        
      } catch (error) {
        console.error('âŒ Error loading investment data:', error);
      }
    }
    
    async function renderInvestmentSpreadsheet(categories, itemsByMonth, itemTotals) {
      try {
        console.log('ðŸŽ¨ Renderizando planilha de investimentos...');
        console.log('ðŸ“‹ Categories:', categories);
        console.log('ðŸ“‹ Items cache:', investmentItemsCache);
        console.log('ðŸ“‹ Items by month:', itemsByMonth);
        console.log('ðŸ“‹ Item totals:', itemTotals);
        
        // Gerar prÃ³ximos 12 meses
        const months = [];
        const today = new Date();
        for (let i = 0; i < 12; i++) {
          const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
          months.push({
            key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
            label: date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })
          });
        }
        
        // Calcular totais por mês
        const monthlyTotals = {};
        months.forEach(m => monthlyTotals[m.key] = 0);
        
        // Array para armazenar dados das linhas
        const rowsData = [];
        
        // Usar os itens do cache ao invÃ©s de buscar via API
        for (const item of investmentItemsCache) {
          const category = categories.find(c => c.id === item.category_id);
          const monthlyData = itemsByMonth[item.id] || {};
          // Usar itemTotals se disponÃ­vel (para investimentos de estruturas), senÃ£o calcular da monthlyData
          const total = itemTotals[item.id] || Object.values(monthlyData).reduce((sum, val) => sum + val, 0);
          
          // Somar aos totais mensais
          months.forEach(month => {
            const value = monthlyData[month.key] || 0;
            monthlyTotals[month.key] += value;
          });
          
          rowsData.push({
            category: category ? category.category_name : 'Outros',
            item: item.item_name,
            total: total,
            monthlyData: monthlyData
          });
          
          console.log(`  📊 ${item.item_name}: Total R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
        }
        
        // Renderizar headers dos meses
        const headerRow = document.getElementById('month-headers');
        headerRow.innerHTML = months.map(m => `<th style="min-width: 120px;">${m.label}</th>`).join('');
        
        // Renderizar linha de totais por mês (serÃ¡ preenchida depois do loop com totalGeral)
        const totalRow = document.getElementById('month-totals-row');
        // Temporariamente vazio, serÃ¡ preenchido apÃ³s calcular totalGeral
        
        // Renderizar colunas fixas (Categoria, Item, Total)
        const tbodyFixed = document.getElementById('spreadsheet-tbody-fixed');
        tbodyFixed.innerHTML = '';
        
        // Renderizar valores por período
        const tbody = document.getElementById('spreadsheet-tbody');
        tbody.innerHTML = '';
        
        // Calcular total geral
        let totalGeral = 0;
        
        rowsData.forEach(rowData => {
          // Verificar se Ã© linha de Imobilizado para aplicar cor verde claro
          const isImobilizado = rowData.category === 'Imobilizado';
          const bgColor = isImobilizado ? 'background: rgba(34, 197, 94, 0.08);' : '';
          
          // Somar ao total geral
          totalGeral += rowData.total;
          
          // Linha fixa
          const rowFixed = document.createElement('tr');
          rowFixed.innerHTML = `
            <td style="border-left: none; ${bgColor}">${rowData.category}</td>
            <td style="${bgColor}">${rowData.item}</td>
            <td style="border-right: none; ${bgColor}"><strong>R$ ${rowData.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
          `;
          tbodyFixed.appendChild(rowFixed);
          
          // Linha com valores por período
          const row = document.createElement('tr');
          row.innerHTML = months.map(month => {
            const value = rowData.monthlyData[month.key] || 0;
            const displayValue = value > 0 ? `R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-';
            return `<td style="min-width: 120px; ${bgColor}">${displayValue}</td>`;
          }).join('');
          tbody.appendChild(row);
        });
        
        // Preencher a linha de totais mensais
        totalRow.innerHTML = months.map(m => {
          const total = monthlyTotals[m.key];
          const displayTotal = total > 0 ? `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : '-';
          return `<th style="background: rgba(34, 197, 94, 0.15); font-weight: 700; color: #166534; min-width: 120px;">${displayTotal}</th>`;
        }).join('');
        
        // Adicionar total geral na parte fixa da tabela (na linha do thead que estÃ¡ invisÃ­vel)
        const fixedTable = document.getElementById('spreadsheet-tbody-fixed').closest('table');
        const fixedThead = fixedTable.querySelector('thead');
        const totalRowFixed = fixedThead.querySelectorAll('tr')[1]; // Segunda linha do thead
        
        if (totalRowFixed) {
          totalRowFixed.style.visibility = 'visible';
          totalRowFixed.innerHTML = `
            <th style="border-left: none; background: rgba(34, 197, 94, 0.15); font-weight: 700; color: #166534;"></th>
            <th style="background: rgba(34, 197, 94, 0.15); font-weight: 700; color: #166534;"></th>
            <th style="border-right: none; background: rgba(34, 197, 94, 0.15); font-weight: 700; color: #166534; font-size: 15px;">
              R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            </th>
          `;
        }
        
        console.log(`💰 Total Geral de Investimentos: R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
        
      } catch (error) {
        console.error('Error rendering spreadsheet:', error);
      }
    }

    async function renderInvestmentCashflow(categories, itemsByMonth, itemTotals) {
      try {
        // Buscar fontes de recursos
        const fundingResponse = await fetch(`/pev/api/implantacao/${planId}/finance/funding_sources`);
        const fundingResult = await fundingResponse.json();
        
        const fundingSources = fundingResult.success ? fundingResult.data : [];
        
        // Gerar prÃ³ximos 12 meses
        const months = [];
        const today = new Date();
        for (let i = 0; i < 12; i++) {
          const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
          months.push({
            key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
            label: date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })
          });
        }
        
        // Processar dados por mês
        const cashflowData = months.map(month => {
          let capitalGiro = 0;
          let imobilizado = 0;
          let funding = 0;
          
          // Calcular investimentos por categoria
          for (const category of categories) {
            for (const itemId in itemsByMonth) {
              const item = investmentItemsCache.find(i => i.id == itemId);
              if (item && item.category_id === category.id) {
                const monthlyData = itemsByMonth[itemId];
                const value = monthlyData[month.key] || 0;
                
                if (category.category_type === 'capital_giro') {
                  capitalGiro += value;
                } else if (category.category_type === 'imobilizado') {
                  imobilizado += value;
                }
              }
            }
          }
          
          // Calcular fontes de recursos para este mês
          fundingSources.forEach(source => {
            const date = new Date(source.contribution_date);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (monthKey === month.key) {
              funding += parseFloat(source.amount || 0);
            }
          });
          
          const totalInvestments = capitalGiro + imobilizado;
          const netBalance = funding - totalInvestments;
          
          return {
            period: month.label,
            capitalGiro,
            imobilizado,
            totalInvestments,
            funding,
            netBalance
          };
        });
        
        // Calcular saldo acumulado
        let accumulatedBalance = 0;
        cashflowData.forEach(row => {
          accumulatedBalance += row.netBalance;
          row.accumulatedBalance = accumulatedBalance;
        });
        
        // Renderizar tabela
        const tbody = document.getElementById('investment-cashflow-tbody');
        tbody.innerHTML = '';
        
        cashflowData.forEach(row => {
          const tr = document.createElement('tr');
          
          const formatCurrency = (value) => {
            const formatted = Math.abs(value).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            const sign = value < 0 ? '-' : '';
            return `${sign}R$ ${formatted}`;
          };
          
          const getValueStyle = (value) => {
            if (value < 0) return 'color: #ef4444;'; // red
            if (value > 0) return 'color: #22c55e;'; // green
            return '';
          };
          
          tr.innerHTML = `
            <td><strong>${row.period}</strong></td>
            <td>${formatCurrency(row.capitalGiro)}</td>
            <td>${formatCurrency(row.imobilizado)}</td>
            <td><strong>${formatCurrency(row.totalInvestments)}</strong></td>
            <td style="${getValueStyle(row.funding)}">${formatCurrency(row.funding)}</td>
            <td style="${getValueStyle(row.netBalance)}"><strong>${formatCurrency(row.netBalance)}</strong></td>
            <td style="${getValueStyle(row.accumulatedBalance)}; font-weight: 700;"><strong>${formatCurrency(row.accumulatedBalance)}</strong></td>
          `;
          
          tbody.appendChild(tr);
        });
        
      } catch (error) {
        console.error('âŒ Error rendering investment cashflow:', error);
      }
    }

    // ==================== NOVA FUNÇÃO SIMPLIFICADA DE INVESTIMENTOS ====================
    function renderInvestmentsSimple() {
      console.log('[INVEST] Renderizando investimentos (versão simplificada)...');
      console.log('[INVEST] Dados:', investimentosEstruturasData);
      
      const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL',
          minimumFractionDigits: 2
        }).format(value || 0);
      };
      
      // Definir blocos e mapeamento
      const blocos = [
        { nome: 'Caixa', key: 'caixa', elementId: 'invest-caixa-value' },
        { nome: 'Estoques', key: 'estoques', elementId: 'invest-estoques-value' },
        { nome: 'Instalações', key: 'instalacoes', elementId: 'invest-instalacoes-value' },
        { nome: 'Máquinas e Equipamentos', key: 'maquinas', elementId: 'invest-maquinas-value' }
      ];
      
      // Calcular total e renderizar cards
      let totalGeral = 0;
      const dadosBlocos = [];
      const todosMeses = new Set();
      
      blocos.forEach(bloco => {
        const dados = investimentosEstruturasData[bloco.key] || {total: 0, por_mes: {}};
        const total = parseFloat(dados.total) || 0;
        const porMes = dados.por_mes || {};
        
        totalGeral += total;
        dadosBlocos.push({
          nome: bloco.nome,
          total: total,
          porMes: porMes
        });
        
        // Atualizar card individual
        const el = document.getElementById(bloco.elementId);
        if (el) el.textContent = formatCurrency(total);
        
        // Coletar meses
        Object.keys(porMes).forEach(mes => todosMeses.add(mes));
      });
      
      // Atualizar total
      const elTotal = document.getElementById('invest-total-value');
      if (elTotal) elTotal.textContent = formatCurrency(totalGeral);
      
      // Ordenar meses
      const mesesOrdenados = Array.from(todosMeses).sort();
      
      console.log('[INVEST] Total:', totalGeral);
      console.log('[INVEST] Meses:', mesesOrdenados);
      
      // Renderizar planilha - IDS ANTIGOS (spreadsheet-tbody-fixed, month-headers, spreadsheet-tbody)
      const tbodyFixed = document.getElementById('spreadsheet-tbody-fixed');
      const headerRow = document.getElementById('month-headers');
      const tbody = document.getElementById('spreadsheet-tbody');
      
      if (!tbodyFixed || !headerRow || !tbody) {
        console.warn('[INVEST] Elementos da planilha não encontrados');
        return;
      }
      
      // Headers dos meses
      if (mesesOrdenados.length === 0) {
        headerRow.innerHTML = '<th style="min-width: 200px;">Sem dados mensais</th>';
      } else {
        headerRow.innerHTML = mesesOrdenados.map(mes => {
          const [ano, mesNum] = mes.split('-');
          const data = new Date(parseInt(ano), parseInt(mesNum) - 1, 1);
          const mesAbrev = data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
          return `<th style="min-width: 100px; text-align: right;">${mesAbrev}</th>`;
        }).join('');
      }
      
      // Linha de TOTAL
      let htmlFixed = '<tr style="background: rgba(59, 130, 246, 0.08); font-weight: 600;">';
      htmlFixed += '<td colspan="2"><strong>TOTAL</strong></td>';
      htmlFixed += `<td style="text-align: right; color: #2563eb;"><strong>${formatCurrency(totalGeral)}</strong></td>';
      htmlFixed += '</tr>';
      
      let htmlMonths = '<tr style="background: rgba(59, 130, 246, 0.08);">';
      if (mesesOrdenados.length === 0) {
        htmlMonths += '<td style="text-align: center;">-</td>';
      } else {
        mesesOrdenados.forEach(mes => {
          const totalMes = dadosBlocos.reduce((sum, bloco) => sum + (parseFloat(bloco.porMes[mes]) || 0), 0);
          htmlMonths += `<td style="text-align: right; font-weight: 600;">${totalMes > 0 ? formatCurrency(totalMes) : '-'}</td>`;
        });
      }
      htmlMonths += '</tr>';
      
      // Linhas de cada bloco
      dadosBlocos.forEach(bloco => {
        if (bloco.total <= 0) return;
        
        htmlFixed += '<tr>';
        htmlFixed += '<td colspan="2">' + bloco.nome + '</td>';
        htmlFixed += `<td style="text-align: right; font-weight: 600; color: #059669;">${formatCurrency(bloco.total)}</td>`;
        htmlFixed += '</tr>';
        
        htmlMonths += '<tr>';
        if (mesesOrdenados.length === 0) {
          htmlMonths += '<td style="text-align: center;">-</td>';
        } else {
          mesesOrdenados.forEach(mes => {
            const valor = parseFloat(bloco.porMes[mes]) || 0;
            htmlMonths += `<td style="text-align: right;">${valor > 0 ? formatCurrency(valor) : '-'}</td>`;
          });
        }
        htmlMonths += '</tr>';
      });
      
      // Atualizar tabelas
      tbodyFixed.innerHTML = htmlFixed;
      tbody.innerHTML = htmlMonths;
      
      console.log('[OK] Planilha de investimentos renderizada!');
    }
    
    // Carregar dados ao inicializar
    // DESABILITADO: APIs não existem, usar dados do backend
    // loadFundingSources();
    // loadCapitalGiroContributions();
    
    // NOVA VERSÃO SIMPLIFICADA - usar dados do backend diretamente
    console.log('[INIT] Verificando investimentosEstruturasData:', investimentosEstruturasData);
    console.log('[INIT] Tipo:', typeof investimentosEstruturasData);
    console.log('[INIT] É objeto?', investimentosEstruturasData && typeof investimentosEstruturasData === 'object');
    
    if (investimentosEstruturasData && typeof investimentosEstruturasData === 'object') {
      console.log('[INIT] Chamando renderInvestmentsSimple...');
      renderInvestmentsSimple();
    } else {
      console.error('[INIT] investimentosEstruturasData não disponível ou inválido!');
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
{% endblock %}



