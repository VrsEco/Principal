{% extends "base.html" %}
{% block title %}Dados da Organizacao | {{ plan.name }}{% endblock %}
{% block body %}
  {% set active_nav = 'projetos' %}
  {{ super() }}
{% endblock %}
{% block content %}
<div class="project-layout plan-layout company-layout" data-sidebar-toggle>
  {% set sidebar_meta %}
    <span class="summary-eyebrow">Dados corporativos</span>
    <p>{{ plan.company }} atua fisicamente em {{ coverage_physical_label }} e online em {{ coverage_online_label }}.</p>
    <div class="plan-engagement-card">
      <span class="chip-label">Progresso</span>
      <span class="chip-value">{{ plan.progress }}%</span>
      <span class="chip-meta">Dados preenchidos</span>
    </div>
  {% endset %}
  {% include 'plan_sidebar.html' %}

  <section class="project-content company-content">
    <!-- Se√ß√£o 1: Cadastro da Empresa -->
    <details class="interview-section surface-card company-form" open>
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Cadastro</span>
          <h3>Identidade da empresa</h3>
          <p>Configure as informa√ß√µes corporativas, cobertura de atua√ß√£o e dados financeiros da empresa.</p>
        </div>
        <div class="interview-progress alignment-progress">
          <div>
            <span class="chip-label">Cobertura</span>
            <span class="interview-count">{{ coverage_physical_label }}</span>
          </div>
          <div>
            <span class="chip-label">Online</span>
            <span class="interview-count">{{ coverage_online_label }}</span>
          </div>
          <div class="section-status-controls">
            <!-- Bot√£o Concluir Todas - sempre presente no DOM -->
            <button class="button button-small button-warning" onclick="closeCompanySection()" title="Concluir todas as se√ß√µes da p√°gina" {% if not company_section_open|default(true) %}style="display: none;"{% endif %}>
              üéØ Concluir Todas
              </button>
            
            <!-- Bot√£o Reabrir Todas - sempre presente no DOM -->
            <button class="button button-small button-success" onclick="openCompanySection()" title="Reabrir todas as se√ß√µes da p√°gina" {% if company_section_open|default(true) %}style="display: none;"{% endif %}>
              üéØ Reabrir Todas
              </button>
            
            <!-- Informa√ß√µes de fechamento - sempre presente no DOM -->
              {% if company_section_status %}
              <span class="section-closed-info" {% if company_section_open|default(true) %}style="display: none;"{% endif %}>
                  Conclu√≠da por {{ company_section_status.closed_by or 'Usu√°rio' }} em {{ company_section_status.closed_at[:10] if company_section_status.closed_at else 'Data n√£o informada' }}
                </span>
            {% endif %}
          </div>
        </div>
      </summary>
      <div class="interview-content">
        {% if not company_section_open|default(true) %}
        <div class="section-closed-notice">
          <p>üéØ Esta se√ß√£o foi conclu√≠da e n√£o permite mais edi√ß√µes.</p>
        </div>
        {% endif %}
        <form class="company-form-fields" action="/plans/{{ plan.id }}/company" method="post" enctype="multipart/form-data">
          
          <!-- Campos b√°sicos e econ√¥micos removidos -->
          <!-- Agora gerenciados no Cadastro Centralizado -->
          
          <div class="financial-editor">
            <span class="card-subtitle">Faturamento / Margem por produto</span>
            <table class="financial-editor-table" id="financial-table">
              <thead>
                <tr>
                  <th>Linha / Produto</th>
                  <th>Faturamento (R$)</th>
                  <th>Margem de contribuicao (%)</th>
                  <th>Tamanho do mercado / Market share / Concorrencia</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="financial-tbody">
                {% for item in company_data.financials|default([]) %}
                <tr class="financial-row">
                  <td><input type="text" name="financial_line_{{ loop.index }}" value="{{ item.line }}" class="financial-input" /></td>
                  <td><input type="number" name="financial_revenue_{{ loop.index }}" value="{{ item.revenue }}" placeholder="0.00" step="0.01" min="0" class="financial-input revenue-input" /></td>
                  <td><input type="number" name="financial_margin_{{ loop.index }}" value="{{ item.margin }}" placeholder="0" step="0.01" min="0" max="100" class="financial-input margin-input" /></td>
                  <td><textarea name="financial_market_{{ loop.index }}" rows="2" placeholder="Descreva o tamanho do mercado, market share e concorrencia" class="financial-input">{{ item.market|default('') }}</textarea></td>
                  <td><button type="button" class="button-remove-row" onclick="removeFinancialRow(this)">√ó</button></td>
                </tr>
                {% endfor %}
                <tr class="financial-total-row">
                  <td><strong>Total</strong></td>
                  <td><input type="text" name="financial_total_revenue" value="{% if company_data.financial_total_revenue not in (None, '') %}{{ company_data.financial_total_revenue|format_number_br }}{% endif %}" readonly class="total-input" /></td>
                  <td><input type="text" name="financial_total_margin" value="{% if company_data.financial_total_margin not in (None, '') %}{{ company_data.financial_total_margin|format_percent_br }}{% endif %}" readonly class="total-input" /></td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="button button-ghost" id="add-financial-row">+ Adicionar linha</button>
          </div>

          <!-- Campos removidos: Todos os dados b√°sicos e econ√¥micos -->
          <!-- Agora gerenciados centralmente em /companies/<id> -->
          <div class="form-field" style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 24px; margin: 20px 0;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <span style="font-size: 32px;">‚ÑπÔ∏è</span>
              <div>
                <strong style="color: #1e40af; font-size: 18px; display: block;">Dados da Empresa - Cadastro Centralizado</strong>
                <span style="color: #64748b; font-size: 14px;">Os dados da empresa agora s√£o gerenciados em um √∫nico lugar</span>
              </div>
            </div>
            
            <p style="color: #475569; line-height: 1.6; margin-bottom: 20px; background: white; padding: 12px; border-radius: 8px;">
              üìç <strong>Acesse o Cadastro Centralizado</strong> para gerenciar todos os dados da empresa de forma organizada e integrada.
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div style="background: white; padding: 16px; border-radius: 8px;">
                <strong style="color: #1e40af; display: block; margin-bottom: 8px;">üìã Dados B√°sicos</strong>
                <ul style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0; padding-left: 20px;">
                  <li>Nome fantasia</li>
                  <li>Raz√£o social</li>
                  <li>Setor/Ind√∫stria</li>
                  <li>Porte da empresa</li>
                </ul>
              </div>
              
              <div style="background: white; padding: 16px; border-radius: 8px;">
                <strong style="color: #1e40af; display: block; margin-bottom: 8px;">üéØ MVV</strong>
                <ul style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0; padding-left: 20px;">
                  <li>Miss√£o</li>
                  <li>Vis√£o</li>
                  <li>Valores</li>
                </ul>
              </div>
              
              <div style="background: white; padding: 16px; border-radius: 8px;">
                <strong style="color: #1e40af; display: block; margin-bottom: 8px;">üí∞ Dados Econ√¥micos</strong>
                <ul style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0; padding-left: 20px;">
                  <li>CNPJ, Cidade, Estado</li>
                  <li>CNAEs / Atividades</li>
                  <li>Cobertura f√≠sica/online</li>
                  <li>Experi√™ncia (total e segmento)</li>
                </ul>
              </div>
              
              <div style="background: white; padding: 16px; border-radius: 8px;">
                <strong style="color: #1e40af; display: block; margin-bottom: 8px;">üë• Estrutura Organizacional</strong>
                <ul style="color: #475569; font-size: 14px; line-height: 1.6; margin: 0; padding-left: 20px;">
                  <li>Fun√ß√µes/Cargos (com hierarquia)</li>
                  <li>Colaboradores</li>
                  <li>Organograma (gerado automaticamente)</li>
                </ul>
              </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
              {% if plan.company_id or company.id %}
              <a href="/companies/{{ plan.company_id or company.id }}" class="button button-primary" target="_blank" style="font-size: 16px; padding: 14px 28px;">
                <span>‚öôÔ∏è</span> Acessar Cadastro Centralizado da Empresa
              </a>
              {% else %}
              <span style="color: #64748b;">Vincule uma empresa ao plano para acessar o cadastro centralizado</span>
              {% endif %}
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="button button-primary" {% if not company_section_open|default(true) %}disabled{% endif %}>Salvar informacoes</button>
            <button type="reset" class="button button-ghost" {% if not company_section_open|default(true) %}disabled{% endif %}>Descartar alteracoes</button>
          </div>
        </form>
      </div>
    </details>

    <!-- Se√ß√£o 2: An√°lises -->
    <details class="interview-section surface-card company-ai">
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">An√°lises</span>
          <h3>Buscas e an√°lises de IA</h3>
          <p>Gere insights automatizados sobre mercado, concorr√™ncia e oportunidades estrat√©gicas.</p>
        </div>
        <div class="interview-progress alignment-progress">
          <div>
            <span class="chip-label">Status</span>
            <span class="interview-count">Em desenvolvimento</span>
          </div>
        </div>
      </summary>
      <div class="interview-content">
        {% if not company_section_open|default(true) %}
        <div class="section-closed-notice">
          <p>üéØ Esta se√ß√£o foi conclu√≠da e n√£o permite mais edi√ß√µes.</p>
        </div>
        {% endif %}
        
        <form class="analyses-form-fields" action="#" method="post">
          <label class="form-field">
            <span>Insights e An√°lise da IA</span>
            <textarea name="ai_insights" rows="6" placeholder="As an√°lises geradas ficar√£o registradas aqui" {% if not company_section_open|default(true) %}disabled{% endif %}>{{ company_data.ai_insights|default('') }}</textarea>
          </label>
          <label class="form-field">
            <span>An√°lises e Impress√µes do Consultor</span>
            <textarea name="consultant_analysis" rows="8" placeholder="Vers√£o detalhada: Registre suas an√°lises completas, impress√µes e insights sobre a empresa, mercado, oportunidades e desafios identificados durante o processo de planejamento estrat√©gico." {% if not company_section_open|default(true) %}disabled{% endif %}>{{ company_data.consultant_analysis|default('') }}</textarea>
          </label>
          <div class="form-actions">
            <button type="button" class="button button-primary" onclick="saveAnalyses()" {% if not company_section_open|default(true) %}disabled{% endif %}>Salvar an√°lises</button>
            <button type="button" class="button button-primary" onclick="generateAIInsights()" {% if not company_section_open|default(true) %}disabled{% endif %}>Gerar buscas e an√°lises de IA</button>
            <button type="button" class="button button-ghost" onclick="resetAnalysesForm()" {% if not company_section_open|default(true) %}disabled{% endif %}>Descartar altera√ß√µes</button>
          </div>
        </form>
      </div>
    </details>

    <!-- Se√ß√£o 3: Resumo Executivo -->
    <details class="interview-section surface-card company-summary">
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Resumo Executivo</span>
          <h3>Vis√£o consolidada</h3>
          <p>Visualize um resumo completo dos dados corporativos e financeiros da empresa.</p>
        </div>
        <div class="interview-progress alignment-progress">
          <div>
            <span class="chip-label">Dados</span>
            <span class="interview-count">Consolidados</span>
          </div>
        </div>
      </summary>
      <div class="interview-content">
        {% if not company_section_open|default(true) %}
        <div class="section-closed-notice">
          <p>üéØ Esta se√ß√£o foi conclu√≠da e n√£o permite mais edi√ß√µes.</p>
        </div>
        {% endif %}
        <div class="summary-grid">
          <div class="summary-block">
            <span class="chip-label">Nome fantasia</span>
            <strong>{{ company_data.trade_name|default(plan.company) }}</strong>
            <span class="chip-label">Razao social</span>
            <strong>{{ company_data.legal_name|default('-') }}</strong>
          </div>
          <div class="summary-block">
            <span class="chip-label">CNPJ</span>
            <strong>{{ (company_data.cnpj|format_cnpj) or '-' }}</strong>
            <span class="chip-label">Atuacao fisica</span>
            <strong>{{ coverage_physical_label }}</strong>
            <span class="chip-label">Atuacao online</span>
            <strong>{{ coverage_online_label }}</strong>
          </div>
          <div class="summary-block">
            <span class="chip-label">Experiencia total</span>
            <strong>{{ company_data.experience_total|default('-') }}</strong>
            <span class="chip-label">Experiencia no segmento</span>
            <strong>{{ company_data.experience_segment|default('-') }}</strong>
          </div>
        </div>
        <div class="financial-table-wrapper">
          <table class="financial-table">
            <thead>
              <tr>
                <th>Linha / Produto</th>
                <th>Faturamento</th>
                <th>Margem de contribuicao</th>
              </tr>
            </thead>
            <tbody>
              {% for item in company_data.financials|default([]) %}
              <tr>
                <td>{{ item.line }}</td>
                <td>{{ item.revenue|format_number_br }}</td>
                <td>{{ item.margin|format_percent_br }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="table-empty">Nenhum dado de faturamento informado.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="financial-summary">
          <div class="summary-block">
            <span class="chip-label">Faturamento total</span>
            <strong>{{ company_data.financial_total_revenue|format_number_br }}</strong>
            <span class="chip-label">Margem total</span>
            <strong>{{ company_data.financial_total_margin|format_percent_br }}</strong>
          </div>
        </div>
        
        
        {% if company_data.ai_insights %}
        <div class="ai-summary">
          <div class="summary-block summary-notes">
            <span class="chip-label">Insights da IA</span>
            <p>{{ company_data.ai_insights|nl2br|safe }}</p>
          </div>
        </div>
        {% endif %}
        
        {% if company_data.consultant_analysis %}
        <div class="consultant-summary">
          <div class="summary-block summary-notes">
            <span class="chip-label">Resumo do Consultor</span>
            <p>{{ company_data.consultant_analysis|nl2br|safe }}</p>
          </div>
        </div>
        {% endif %}
      </div>
    </details>
  </section>
</div>

<!-- Modal para visualiza√ß√£o de PDF -->
<div id="pdfModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Visualizar PDF</h3>
      <button type="button" class="modal-close" onclick="closePDFModal()">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="pdfViewer" src="" width="100%" height="600px" style="border: none;"></iframe>
    </div>
  </div>
</div>

<script>
const originalAiInsights = {{ company_data.ai_insights|default("")|tojson }};
const originalConsultantAnalysis = {{ company_data.consultant_analysis|default("")|tojson }};

document.addEventListener('DOMContentLoaded', function() {
    let financialRowIndex = {{ company_data.financials|default([])|length }};
    
    // Adicionar nova linha de faturamento
    document.getElementById('add-financial-row').addEventListener('click', function() {
        const tbody = document.getElementById('financial-tbody');
        const totalRow = tbody.querySelector('.financial-total-row');
        
        const newRow = document.createElement('tr');
        newRow.className = 'financial-row';
        financialRowIndex++;
        
        newRow.innerHTML = `
            <td><input type="text" name="financial_line_${financialRowIndex}" value="" class="financial-input" /></td>
            <td><input type="number" name="financial_revenue_${financialRowIndex}" value="" placeholder="0.00" step="0.01" min="0" class="financial-input revenue-input" /></td>
            <td><input type="number" name="financial_margin_${financialRowIndex}" value="" placeholder="0" step="0.01" min="0" max="100" class="financial-input margin-input" /></td>
            <td><textarea name="financial_market_${financialRowIndex}" rows="2" placeholder="Descreva o tamanho do mercado, market share e concorrencia" class="financial-input"></textarea></td>
            <td><button type="button" class="button-remove-row" onclick="removeFinancialRow(this)">√ó</button></td>
        `;
        
        tbody.insertBefore(newRow, totalRow);
        
        // Adicionar event listeners para c√°lculo autom√°tico
        addCalculationListeners(newRow);
    });
    
    // Adicionar event listeners para linhas existentes
    document.querySelectorAll('.financial-row').forEach(row => {
        addCalculationListeners(row);
    });
    
    function addCalculationListeners(row) {
        const revenueInput = row.querySelector('.revenue-input');
        const marginInput = row.querySelector('.margin-input');
        
        if (revenueInput) {
            revenueInput.addEventListener('input', calculateTotals);
        }
        if (marginInput) {
            marginInput.addEventListener('input', calculateTotals);
        }
    }
    
    function calculateTotals() {
        const rows = document.querySelectorAll('.financial-row');
        let totalRevenue = 0;
        let totalWeightedMargin = 0;
        let totalRevenueForMargin = 0;
        
        rows.forEach(row => {
            const revenueInput = row.querySelector('.revenue-input');
            const marginInput = row.querySelector('.margin-input');
            
            if (revenueInput && marginInput) {
                const revenue = parseFloat(revenueInput.value) || 0;
                const margin = parseFloat(marginInput.value) || 0;
                
                totalRevenue += revenue;
                totalWeightedMargin += (revenue * margin / 100);
                totalRevenueForMargin += revenue;
            }
        });
        
        // Atualizar totais
        const totalRevenueInput = document.querySelector('input[name="financial_total_revenue"]');
        const totalMarginInput = document.querySelector('input[name="financial_total_margin"]');
        
        if (totalRevenueInput) {
            totalRevenueInput.value = totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        if (totalMarginInput && totalRevenueForMargin > 0) {
            const averageMargin = (totalWeightedMargin / totalRevenueForMargin) * 100;
            totalMarginInput.value = averageMargin.toFixed(2) + '%';
        }
    }
    
// Fun√ß√£o global para remover linha
    window.removeFinancialRow = function(button) {
        const row = button.closest('tr');
        row.remove();
        calculateTotals();
    };
    
    // Calcular totais iniciais
    calculateTotals();
});

function closeCompanySection() {
    const notes = prompt('Motivo da conclus√£o de todas as se√ß√µes (opcional):');

    fetch(`/plans/{{ plan.id }}/sections/company/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'closed',
            closed_by: 'Usu√°rio',
            notes: notes || ''
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Todas as se√ß√µes foram conclu√≠das com sucesso!', 'success');
                // Atualizar interface sem recarregar a p√°gina
                updateSectionStatus('closed');
            } else {
                showMessage('Erro ao concluir se√ß√£o: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showMessage('Erro ao concluir se√ß√£o de cadastro.', 'error');
        });
}

function openCompanySection() {
    if (confirm('Reabrir todas as se√ß√µes permite novas edi√ß√µes em todos os campos. Deseja continuar?')) {
        fetch(`/plans/{{ plan.id }}/sections/company/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'open',
                closed_by: null,
                notes: ''
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Todas as se√ß√µes foram reabertas com sucesso!', 'success');
                    // Atualizar interface sem recarregar a p√°gina
                    updateSectionStatus('open');
                } else {
                    showMessage('Erro ao reabrir se√ß√£o: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showMessage('Erro ao reabrir se√ß√£o de cadastro.', 'error');
            });
    }
}

// Adicionar estilos CSS para campos desabilitados
const style = document.createElement('style');
style.textContent = `
    .disabled, input:disabled, textarea:disabled, select:disabled, button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #f5f5f5 !important;
        color: #666 !important;
    }
    
    .section-closed-notice {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
        color: #856404;
        text-align: center;
    }
    
    .section-closed-notice p {
        margin: 0;
        font-weight: 500;
    }
`;
document.head.appendChild(style);

function updateSectionStatus(status) {
    console.log('Atualizando status da se√ß√£o para:', status);
    
    // Atualizar todos os campos da se√ß√£o 1 (Cadastro)
    const section1Inputs = document.querySelectorAll('.company-form input, .company-form textarea, .company-form select');
    const section1Buttons = document.querySelectorAll('.company-form button');
    
    // Atualizar todos os campos da se√ß√£o 2 (An√°lises)
    const section2Inputs = document.querySelectorAll('.company-ai input, .company-ai textarea, .company-ai select');
    const section2Buttons = document.querySelectorAll('.company-ai button');
    
    // Buscar bot√µes de controle - agora sempre existem no DOM
    const closeButton = document.querySelector('.section-status-controls button[onclick="closeCompanySection()"]');
    const openButton = document.querySelector('.section-status-controls button[onclick="openCompanySection()"]');
    const statusInfo = document.querySelector('.section-closed-info');
    
    console.log('Bot√µes encontrados:', { 
        closeButton: closeButton ? 'encontrado' : 'n√£o encontrado',
        openButton: openButton ? 'encontrado' : 'n√£o encontrado',
        statusInfo: statusInfo ? 'encontrado' : 'n√£o encontrado'
    });
    
    if (status === 'closed') {
        // Travar todos os campos
        [...section1Inputs, ...section2Inputs].forEach(input => {
            input.disabled = true;
            input.classList.add('disabled');
        });
        
        // Desabilitar bot√µes das se√ß√µes (exceto bot√µes de controle)
        [...section1Buttons, ...section2Buttons].forEach(button => {
            if (button.classList && button.classList.contains('btn-view')) {
                button.disabled = false;
                button.classList.remove('disabled');
                return;
            }
            // N√£o desabilitar bot√µes de controle
            if (!button.onclick || (!button.onclick.toString().includes('closeCompanySection') && 
                                   !button.onclick.toString().includes('openCompanySection'))) {
                button.disabled = true;
                button.classList.add('disabled');
            }
        });
        
        // Mostrar bot√£o Reabrir e ocultar bot√£o Concluir
        if (closeButton) {
            closeButton.style.display = 'none';
            closeButton.disabled = false; // Garantir que est√° habilitado
            closeButton.classList.remove('disabled');
            console.log('Bot√£o Concluir Todas ocultado');
        }
        if (openButton) {
            openButton.style.display = 'inline-block';
            openButton.disabled = false; // Garantir que est√° habilitado
            openButton.classList.remove('disabled');
            console.log('Bot√£o Reabrir Todas mostrado e habilitado');
        }
        
        // Mostrar avisos de se√ß√£o fechada
        const closedNotices = document.querySelectorAll('.section-closed-notice');
        closedNotices.forEach(notice => {
            notice.style.display = 'block';
        });
        
        // Mostrar informa√ß√µes de fechamento
        if (statusInfo) {
            statusInfo.style.display = 'inline';
        }
        
    } else if (status === 'open') {
        // Liberar todos os campos
        [...section1Inputs, ...section2Inputs].forEach(input => {
            input.disabled = false;
            input.classList.remove('disabled');
        });
        
        // Habilitar bot√µes das se√ß√µes (exceto bot√µes de controle)
        [...section1Buttons, ...section2Buttons].forEach(button => {
            if (button.classList && button.classList.contains('btn-view')) {
                button.disabled = false;
                button.classList.remove('disabled');
                return;
            }
            // N√£o afetar bot√µes de controle (eles sempre devem estar habilitados)
            if (!button.onclick || (!button.onclick.toString().includes('closeCompanySection') && 
                                   !button.onclick.toString().includes('openCompanySection'))) {
                button.disabled = false;
                button.classList.remove('disabled');
            }
        });
        
        // Mostrar bot√£o Concluir e ocultar bot√£o Reabrir
        if (closeButton) {
            closeButton.style.display = 'inline-block';
            closeButton.disabled = false; // Garantir que est√° habilitado
            closeButton.classList.remove('disabled');
            console.log('Bot√£o Concluir Todas mostrado e habilitado');
        }
        if (openButton) {
            openButton.style.display = 'none';
            openButton.disabled = false; // Garantir que est√° habilitado
            openButton.classList.remove('disabled');
            console.log('Bot√£o Reabrir Todas ocultado');
        }
        
        // Esconder avisos de se√ß√£o fechada
        const closedNotices = document.querySelectorAll('.section-closed-notice');
        closedNotices.forEach(notice => {
            notice.style.display = 'none';
        });
        
        // Esconder informa√ß√µes de fechamento
        if (statusInfo) {
            statusInfo.style.display = 'none';
        }
    }
    
    // Verifica√ß√£o simples: garantir que os bot√µes est√£o corretos
    setTimeout(() => {
        console.log('Verifica√ß√£o final dos bot√µes...');
        if (!closeButton || !openButton) {
            console.log('AVISO: Algum bot√£o n√£o foi encontrado, mas isso n√£o deve acontecer agora');
        } else {
            console.log('‚úÖ Ambos os bot√µes encontrados e atualizados com sucesso');
        }
    }, 100);
}

// Fun√ß√µes de fallback removidas - n√£o s√£o mais necess√°rias
// Agora ambos os bot√µes sempre existem no DOM

function saveAnalyses() {
    const aiInsights = document.querySelector('textarea[name="ai_insights"]').value;
    const consultantAnalysis = document.querySelector('textarea[name="consultant_analysis"]').value;
    
    fetch(`/plans/{{ plan.id }}/company/update-analyses`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ai_insights: aiInsights,
            consultant_analysis: consultantAnalysis
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('An√°lises salvas com sucesso!', 'success');
        } else {
            showMessage('Erro ao salvar an√°lises: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao salvar an√°lises.', 'error');
    });
}

function generateAIInsights() {
    if (confirm('Gerar an√°lises de IA baseadas nos dados da empresa? Isso pode substituir o conte√∫do atual do campo "Insights e An√°lise da IA".')) {
        showMessage('Gerando an√°lises de IA...', 'info');
        
        fetch(`/plans/{{ plan.id }}/company/generate-ai-insights`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preencher o campo de insights da IA com o resultado
                const aiInsightsField = document.querySelector('textarea[name="ai_insights"]');
                if (aiInsightsField) {
                    aiInsightsField.value = data.insights;
                }
                showMessage('An√°lises de IA geradas com sucesso!', 'success');
            } else {
                showMessage('Erro ao gerar an√°lises de IA: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showMessage('Erro ao gerar an√°lises de IA.', 'error');
        });
    }
}

function resetAnalysesForm() {
    if (confirm('Tem certeza que deseja descartar todas as altera√ß√µes?')) {
        const aiField = document.querySelector('textarea[name="ai_insights"]');
        if (aiField) {
            aiField.value = originalAiInsights || '';
        }
        const consultantField = document.querySelector('textarea[name="consultant_analysis"]');
        if (consultantField) {
            consultantField.value = originalConsultantAnalysis || '';
        }
        showMessage('Altera√ß√µes descartadas.', 'info');
    }
}


// Fun√ß√µes para gerenciar PDFs
function viewPDF(filename) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfViewer');
    
    // Usar PDF.js para visualiza√ß√£o
    iframe.src = `/uploads/${filename}#toolbar=1&navpanes=1&scrollbar=1`;
    modal.style.display = 'block';
    
    // Adicionar classe para anima√ß√£o
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

function closePDFModal() {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfViewer');
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        iframe.src = ''; // Limpar o iframe
    }, 300);
}

function deleteFile(fileType, filename) {
    if (confirm(`Tem certeza que deseja excluir o arquivo "${filename}"?`)) {
        fetch(`/plans/{{ plan.id }}/company/delete-file`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_type: fileType,
                filename: filename
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recarregar a p√°gina para atualizar a interface
                location.reload();
            } else {
                alert('Erro ao excluir arquivo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir arquivo');
        });
    }
}

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('pdfModal');
    if (event.target === modal) {
        closePDFModal();
    }
}

// Fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closePDFModal();
    }
});
</script>

{% endblock %}
