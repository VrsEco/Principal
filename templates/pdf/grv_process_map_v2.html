<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Processos - {{ company.get('name') or 'Empresa' }}</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <style>
    :root {
      color-scheme: light;
    }

    @page {
      size: A4 portrait;
      margin: 8mm 6mm 8mm 6mm;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Calibri", "Segoe UI", "Inter", Arial, sans-serif;
      font-size: 7.5pt;
      line-height: 1.1;
      background: #ffffff;
      color: #1e293b;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      padding-top: 3mm;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Container Principal */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .areas-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-top: 8px;
    }

    /* Layout Principal - Áreas Verticais + Macros em Grid */
    .area-section {
      display: flex;
      page-break-inside: avoid;
      border: 1.5px solid;
      border-radius: 4px;
      overflow: hidden;
      min-height: auto;
    }

    /* Área - Barra Lateral Vertical */
    .area-sidebar {
      width: 50px;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 6px;
      font-weight: 700;
      font-size: 7.5pt;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-right: 1.5px solid;
    }

    /* Container dos Macroprocessos */
    .macros-container {
      flex: 1;
      padding: 6px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      column-gap: 4px;
      row-gap: 6px;
      align-content: start;
    }

    /* Macroprocesso - Retângulo Vertical */
    .macro-box {
      border: 1px solid #cbd5e1;
      border-radius: 3px;
      background: #ffffff;
      padding: 5px;
      display: flex;
      flex-direction: column;
      min-height: auto;
      page-break-inside: avoid;
    }

    .macro-header {
      text-align: center;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 5px;
      flex-shrink: 0;
    }

    .macro-title {
      font-size: 6.5pt;
      font-weight: 700;
      color: #1e40af;
      line-height: 1.2;
      word-wrap: break-word;
    }

    .macro-footer {
      margin-top: 5px;
      padding-top: 4px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      font-size: 5.5pt;
      color: #64748b;
      flex-shrink: 0;
    }

    /* Processos - Grid 2 por linha */
    .processes-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      column-gap: 3px;
      row-gap: 4px;
      flex: 1;
    }

    /* Processo - Card com badges laterais - TAMANHO FIXO para 3 linhas */
    .process-card {
      border: 1px solid #cbd5e1;
      border-radius: 2px;
      background: #f8fafc;
      padding: 4px 3px;
      display: flex;
      gap: 3px;
      align-items: center;
      height: 38px;
      page-break-inside: avoid;
    }

    /* Badges Laterais - Estruturação e Desempenho */
    .process-badges {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex-shrink: 0;
    }

    .badge-indicator {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 0.5px solid rgba(0,0,0,0.1);
    }

    /* Cores dos Badges - Estruturação */
    .badge-scope { background: #94a3b8; }
    .badge-progress { background: #f59e0b; }
    .badge-stabilized { background: #10b981; }

    /* Cores dos Badges - Desempenho */
    .badge-critical { background: #ef4444; }
    .badge-below { background: #f59e0b; }
    .badge-satisfactory { background: #10b981; }

    /* Conteúdo do Processo */
    .process-content {
      flex: 1;
      min-width: 0;
    }

    .process-code {
      font-size: 4.5pt;
      color: #64748b;
      text-align: center;
      margin-top: 1px;
      font-weight: 500;
      line-height: 1;
    }

    .process-name {
      font-size: 5pt;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.05;
      word-wrap: break-word;
      text-align: center;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Empty State */
    .empty-macros {
      grid-column: 1 / -1;
      padding: 8px;
      text-align: center;
      color: #94a3b8;
      font-style: italic;
      font-size: 6pt;
    }

    .empty-processes {
      grid-column: 1 / -1;
      padding: 6px;
      text-align: center;
      color: #94a3b8;
      font-style: italic;
      font-size: 5.5pt;
      border: 1px dashed #cbd5e1;
      border-radius: 2px;
    }

    /* Legenda - Horizontal no Topo */
    .legend-section {
      padding: 3px 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 2px;
      margin-bottom: 8px;
      page-break-inside: avoid;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: nowrap;
    }

    .legend-title {
      font-size: 5pt;
      font-weight: 700;
      color: #334155;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .legend-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    .legend-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-group-title {
      font-weight: 600;
      font-size: 4.5pt;
      color: #334155;
      margin-right: 2px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 4.5pt;
    }

    .legend-badge {
      width: 6px;
      height: 6px;
      border-radius: 1px;
      border: 0.5px solid rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .legend-separator {
      width: 1px;
      height: 12px;
      background: #cbd5e1;
      margin: 0 2px;
    }

    /* Print Optimization */
    @media print {
      body {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .area-section {
        page-break-inside: avoid;
      }

      .macro-box {
        page-break-inside: avoid;
      }

      .process-card {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <!-- Legenda Horizontal no Topo -->
    <section class="legend-section">
      <div class="legend-title">Legenda:</div>
      <div class="legend-content">
        <!-- Estruturação -->
        <div class="legend-group">
          <span class="legend-group-title">Estrut.:</span>
          <div class="legend-item">
            <div class="legend-badge badge-stabilized"></div>
            <span>Estab.</span>
          </div>
          <div class="legend-item">
            <div class="legend-badge badge-progress"></div>
            <span>And.</span>
          </div>
          <div class="legend-item">
            <div class="legend-badge badge-scope"></div>
            <span>F.Esc.</span>
          </div>
        </div>

        <div class="legend-separator"></div>

        <!-- Desempenho -->
        <div class="legend-group">
          <span class="legend-group-title">Desemp.:</span>
          <div class="legend-item">
            <div class="legend-badge badge-satisfactory"></div>
            <span>Satisf.</span>
          </div>
          <div class="legend-item">
            <div class="legend-badge badge-below"></div>
            <span>Abaixo</span>
          </div>
          <div class="legend-item">
            <div class="legend-badge badge-critical"></div>
            <span>Crítico</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Areas with Macros and Processes -->
    <div class="areas-wrapper">
      {% if not areas %}
        <div style="padding: 40px; text-align: center; color: #94a3b8; font-style: italic; border: 1px dashed #cbd5e1; border-radius: 6px;">
          Nenhum processo foi mapeado para esta empresa.
        </div>
      {% else %}
        {% for area in areas %}
      <section class="area-section" style="border-color: {{ area.color }};">
        <!-- Área - Sidebar Vertical -->
        <div class="area-sidebar" style="background: linear-gradient(180deg, {{ area.color }} 0%, {{ area.color_soft }} 100%); border-right-color: {{ area.color }}; color: #ffffff;">
          {{ area.display_name }}
        </div>

        <!-- Macroprocessos Container -->
        <div class="macros-container">
          {% if not area.macros %}
            <div class="empty-macros">Nenhum macroprocesso cadastrado para esta área.</div>
          {% else %}
            {% for macro in area.macros %}
              <div class="macro-box">
                <!-- Macro Header -->
                <div class="macro-header">
                  <div class="macro-title">{{ macro.display_name }}</div>
                </div>

                <!-- Processes Grid -->
                <div class="processes-grid">
                  {% if not macro.processes %}
                    <div class="empty-processes">Sem processos</div>
                  {% else %}
                    {% for proc in macro.processes %}
                      <div class="process-card">
                        <!-- Badges Laterais -->
                        <div class="process-badges">
                          <!-- Badge Estruturação -->
                          {% set struct_class = 'scope' %}
                          {% if 'Map | Impl | Estabn' in proc.structuring.label %}
                            {% set struct_class = 'progress' %}
                          {% elif proc.structuring.label == 'Estabilizado' %}
                            {% set struct_class = 'stabilized' %}
                          {% endif %}
                          <div class="badge-indicator badge-{{ struct_class }}" title="Estruturação: {{ proc.structuring.label }}"></div>

                          <!-- Badge Desempenho -->
                          {% set perf_class = 'scope' %}
                          {% if proc.performance.label == 'Crítico' %}
                            {% set perf_class = 'critical' %}
                          {% elif proc.performance.label == 'Abaixo' %}
                            {% set perf_class = 'below' %}
                          {% elif proc.performance.label == 'Satisfatório' %}
                            {% set perf_class = 'satisfactory' %}
                          {% endif %}
                          <div class="badge-indicator badge-{{ perf_class }}" title="Desempenho: {{ proc.performance.label }}"></div>
                        </div>

                        <!-- Conteúdo do Processo - NOME EM CIMA, CÓDIGO EMBAIXO -->
                        <div class="process-content">
                          <div class="process-name">
                            {% if ' - ' in proc.display_name %}
                              {{ proc.display_name.split(' - ')[1] }}
                            {% else %}
                              {{ proc.display_name }}
                            {% endif %}
                          </div>
                          <div class="process-code">
                            {% if ' - ' in proc.display_name %}
                              {{ proc.display_name.split(' - ')[0] }}
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>

                <!-- Macro Footer -->
                {% if macro.owner %}
                  <div class="macro-footer">
                    Dono: {{ macro.owner }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>
        </section>
      {% endfor %}
      {% endif %}
    </div>
  </div>

</body>
</html>
