{% extends "base.html" %}
{% block title %}GRV | Gestão de Ocorrências{% endblock %}
{% block body %}{% set active_nav = 'routine-incidents' %}{{ super() }}{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
  .incidents-shell {
    display: grid;
    grid-template-columns: 250px minmax(0, 1fr);
    gap: 18px;
    align-items: start;
  }

  .incidents-main {
    background: #ffffff;
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    padding: 22px 24px;
    box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    display: grid;
    gap: 20px;
  }

  .incident-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .incident-header h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .incident-description {
    color: #64748b;
    font-size: 13px;
    margin-top: 6px;
    max-width: 520px;
    line-height: 1.5;
  }

  .incident-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .incident-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 0.04em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .incident-button.primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff;
    box-shadow: 0 16px 28px rgba(37, 99, 235, 0.25);
  }

  .incident-button.primary:hover {
    transform: translateY(-2px);
  }

  .incident-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }

  .incident-card {
    border-radius: 12px;
    border: 1px solid rgba(59, 130, 246, 0.18);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.08));
    padding: 16px 18px;
    display: grid;
    gap: 6px;
  }

  .incident-card span.label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #2563eb;
    font-weight: 600;
  }

  .incident-card span.value {
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .incident-card small {
    color: #475569;
    font-size: 11px;
  }

  .incident-table-wrapper {
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    overflow: hidden;
    background: #f8fafc;
  }

  table.incident-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  table.incident-table thead {
    background: rgba(15, 23, 42, 0.05);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 11px;
    color: #475569;
  }

  table.incident-table th,
  table.incident-table td {
    padding: 12px 16px;
    text-align: left;
    vertical-align: middle;
  }

  table.incident-table tbody tr {
    background: #ffffff;
    border-bottom: 1px solid rgba(15, 23, 42, 0.05);
    transition: background 0.2s ease;
  }

  table.incident-table tbody tr:hover {
    background: rgba(59, 130, 246, 0.06);
  }

  .incident-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
  }

  .incident-pill.highlight {
    background: rgba(59, 130, 246, 0.14);
    color: #2563eb;
  }

  .incident-table-actions {
    display: flex;
    gap: 10px;
  }

  .incident-link {
    border: none;
    background: transparent;
    font-size: 12px;
    color: #2563eb;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
  }

  .incident-link.danger {
    color: #dc2626;
  }

  .incident-empty {
    padding: 40px;
    text-align: center;
    color: #94a3b8;
    font-size: 13px;
  }

  /* Modal */
  .incident-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
    padding: 20px;
  }

  .incident-modal-backdrop.open {
    display: flex;
  }

  .incident-modal {
    background: #ffffff;
    border-radius: 16px;
    width: min(600px, 100%);
    max-height: 90vh;
    overflow-y: auto;
    padding: 26px;
    box-shadow: 0 24px 48px rgba(15, 23, 42, 0.25);
    display: grid;
    gap: 18px;
  }

  .incident-modal header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
  }

  .incident-modal header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #0f172a;
  }

  .incident-modal header button {
    border: none;
    background: transparent;
    font-size: 22px;
    cursor: pointer;
    color: #94a3b8;
  }

  .incident-form {
    display: grid;
    gap: 16px;
  }

  .incident-form .field {
    display: grid;
    gap: 6px;
  }

  .incident-form label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    color: #475569;
  }

  .incident-form input,
  .incident-form select,
  .incident-form textarea {
    border-radius: 10px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    padding: 10px 12px;
    font-size: 13px;
    transition: border 0.2s ease;
    font-family: inherit;
  }

  .incident-form textarea {
    resize: vertical;
    min-height: 80px;
  }

  .incident-form input:focus,
  .incident-form select:focus,
  .incident-form textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
  }

  .incident-form footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .incident-form footer button {
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }

  .incident-form footer .secondary {
    background: rgba(148, 163, 184, 0.18);
    color: #475569;
  }

  .incident-form footer .primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
  }

  @media (max-width: 1280px) {
    .incident-shell {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  @media (max-width: 720px) {
    .incident-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .incident-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .incident-summary {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-layout plan-layout incident-shell" data-sidebar-toggle>
  {% include 'routines_sidebar.html' %}

  <section class="project-content plan-content incident-main">
    <header class="incident-header">
      <div>
        <h1>Gestão de Ocorrências</h1>
        <p class="incident-description">
          Registre e acompanhe situações positivas ou negativas relacionadas a colaboradores, processos e projetos da empresa.
        </p>
      </div>
      <div class="incident-actions">
        <button id="refreshButton" class="incident-button" type="button">🔄 Atualizar</button>
        <button id="newIncidentButton" class="incident-button primary" type="button">➕ Nova Ocorrência</button>
      </div>
    </header>

    <section class="incident-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; padding: 18px; background: rgba(59, 130, 246, 0.04); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.1);">
      <div class="filter-field" style="display: grid; gap: 6px;">
        <label for="filterType" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: #475569;">Tipo</label>
        <select id="filterType" style="border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.35); padding: 8px 12px; font-size: 13px;">
          <option value="">Todos</option>
          <option value="positive">Positivo</option>
          <option value="negative">Negativo</option>
        </select>
      </div>
      <div class="filter-field" style="display: grid; gap: 6px;">
        <label for="filterEmployee" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: #475569;">Colaborador</label>
        <select id="filterEmployee" style="border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.35); padding: 8px 12px; font-size: 13px;">
          <option value="">Todos</option>
          {% for emp in employees %}
          <option value="{{ emp.id }}">{{ emp.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-field" style="display: grid; gap: 6px;">
        <label for="filterProcess" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: #475569;">Processo</label>
        <select id="filterProcess" style="border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.35); padding: 8px 12px; font-size: 13px;">
          <option value="">Todos</option>
          {% for proc in processes %}
          <option value="{{ proc.id }}">{{ proc.code or proc.id }} - {{ proc.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-field" style="display: grid; gap: 6px;">
        <label for="filterProject" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: #475569;">Projeto</label>
        <select id="filterProject" style="border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.35); padding: 8px 12px; font-size: 13px;">
          <option value="">Todos</option>
          {% for proj in projects %}
          <option value="{{ proj.id }}">{{ proj.code or proj.id }} - {{ proj.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-field" style="display: grid; gap: 6px;">
        <label for="searchInput" style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: #475569;">Buscar</label>
        <input id="searchInput" type="text" placeholder="Digite para buscar..." style="border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.35); padding: 8px 12px; font-size: 13px;">
      </div>
    </section>

    <section id="incidentSummary" class="incident-summary"></section>

    <div class="incident-table-wrapper">
      <table class="incident-table">
        <thead>
          <tr>
            <th>Ocorrência</th>
            <th>Tipo</th>
            <th>Colaborador</th>
            <th>Vínculo</th>
            <th>Pontuação</th>
            <th style="width: 120px;">Ações</th>
          </tr>
        </thead>
        <tbody id="incidentTableBody">
          <tr>
            <td colspan="6" class="incident-empty">Carregando ocorrências...</td>
          </tr>
        </tbody>
      </table>
  </div>
  </section>
</div>

<div id="incidentModal" class="incident-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="incident-modal">
    <header>
      <h2 id="modalTitle">Novo Ocorrência</h2>
      <button type="button" id="closeModalButton" aria-label="Fechar">×</button>
    </header>
    <form id="incidentForm" class="incident-form">
        <input type="hidden" id="incidentId">
      <div class="field">
        <label for="incidentCode">Código *</label>
        <input id="incidentCode" type="text" placeholder="Ex: PORT-001" required>
        </div>
      <div class="field">
        <label for="incidentName">Nome do Ocorrência *</label>
        <input id="incidentName" type="text" placeholder="Ex: Transformação Digital" required>
          </div>
      <div class="field">
        <label for="incidentResponsible">Responsável</label>
        <select id="incidentResponsible">
          <option value="">Selecione um responsável</option>
            </select>
          </div>
      <div class="field">
        <label for="incidentNotes">Observações</label>
        <textarea id="incidentNotes" placeholder="Detalhes relevantes sobre o portfólio"></textarea>
        </div>
      <footer>
        <button type="button" class="secondary" id="cancelModalButton">Cancelar</button>
        <button type="submit" class="primary">Salvar Ocorrência</button>
      </footer>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
const companyId = {{ company.id }};
  const summaryContainer = document.getElementById('incidentSummary');
  const tableBody = document.getElementById('incidentTableBody');
  const refreshButton = document.getElementById('refreshButton');
  const newButton = document.getElementById('newIncidentButton');
  const modalBackdrop = document.getElementById('incidentModal');
  const modalTitle = document.getElementById('modalTitle');
  const form = document.getElementById('incidentForm');
  const cancelBtn = document.getElementById('cancelModalButton');
  const closeBtn = document.getElementById('closeModalButton');

  const fieldId = document.getElementById('incidentId');
  const fieldCode = document.getElementById('incidentCode');
  const fieldName = document.getElementById('incidentName');
  const fieldResponsible = document.getElementById('incidentResponsible');
  const fieldNotes = document.getElementById('incidentNotes');

  let incidents = [];
  let employees = [];

  loadEmployees();
  loadIncidents();

  refreshButton.addEventListener('click', () => {
    loadIncidents(true);
  });

  newButton.addEventListener('click', () => openModal());
  cancelBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (event) => {
    if (event.target === modalBackdrop) {
      closeModal();
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = {
      code: fieldCode.value.trim(),
      name: fieldName.value.trim(),
      responsible_id: fieldResponsible.value || null,
      notes: fieldNotes.value.trim()
    };

    if (!payload.code || !payload.name) {
      showMessage('Informe código e nome do portfólio.', 'error');
    return;
  }

    try {
      const isEdit = Boolean(fieldId.value);
      const url = isEdit
        ? `/api/companies/${companyId}/incidents/${fieldId.value}`
        : `/api/companies/${companyId}/incidents`;
      const method = isEdit ? 'PUT' : 'POST';
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Falha ao salvar portfólio');
      }

      showMessage(data.message || 'Ocorrência salvo com sucesso', 'success');
      closeModal();
      await loadIncidents(true);
    } catch (error) {
      console.error(error);
      showMessage(error.message, 'error');
    }
  });

  function openModal(incident) {
    modalBackdrop.classList.add('open');
    modalBackdrop.setAttribute('aria-hidden', 'false');

    if (incident) {
      modalTitle.textContent = 'Editar Ocorrência';
      fieldId.value = incident.id;
      fieldCode.value = incident.code;
      fieldName.value = incident.name;
      fieldResponsible.value = incident.responsible_id || '';
      fieldNotes.value = incident.notes || '';
    } else {
      modalTitle.textContent = 'Novo Ocorrência';
      fieldId.value = '';
      form.reset();
    }

    fieldCode.focus();
  }

function closeModal() {
    modalBackdrop.classList.remove('open');
    modalBackdrop.setAttribute('aria-hidden', 'true');
    form.reset();
    fieldId.value = '';
  }

  async function loadEmployees() {
    try {
      const response = await fetch(`/api/companies/${companyId}/employees`);
      const data = await response.json();
      if (data.success) {
        employees = data.employees || [];
        const options = ['<option value="">Selecione um responsável</option>']
          .concat(employees.map((emp) => `<option value="${emp.id}">${emp.name}</option>`));
        fieldResponsible.innerHTML = options.join('');
    }
  } catch (error) {
      console.error('Erro ao carregar colaboradores', error);
    }
  }

  async function loadIncidents(showToast = false) {
    try {
      tableBody.innerHTML = '<tr><td colspan="6" class="incident-empty">Carregando portfólios...</td></tr>';
      const response = await fetch(`/api/companies/${companyId}/incidents`);
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Erro ao listar portfólios');
      }
      incidents = data.incidents || [];
      renderSummary();
      renderTable();
      if (showToast) {
        showMessage('Ocorrências atualizados.', 'info');
    }
  } catch (error) {
      console.error(error);
      tableBody.innerHTML = `<tr><td colspan="6" class="incident-empty">${error.message}</td></tr>`;
    }
  }

  function renderSummary() {
    if (!incidents.length) {
      summaryContainer.innerHTML = `
        <article class="incident-card">
          <span class="label">Ocorrências</span>
          <span class="value">0</span>
          <small>Registre o primeiro portfólio para começar.</small>
        </article>`;
      return;
    }

    const total = incidents.length;
    const withResponsible = incidents.filter((p) => p.responsible_name).length;
    const notesCount = incidents.filter((p) => p.notes).length;
    const projectTotal = incidents.reduce((sum, item) => sum + (item.project_count || 0), 0);

    summaryContainer.innerHTML = `
      <article class="incident-card">
        <span class="label">Ocorrências ativos</span>
        <span class="value">${total}</span>
        <small>Total cadastrado para a empresa</small>
      </article>
      <article class="incident-card">
        <span class="label">Responsáveis definidos</span>
        <span class="value">${withResponsible}</span>
        <small>${withResponsible ? 'Ocorrências com owner definido' : 'Nenhum responsável associado'}</small>
      </article>
      <article class="incident-card">
        <span class="label">Notas registradas</span>
        <span class="value">${notesCount}</span>
        <small>Ocorrências com contexto adicional</small>
      </article>
      <article class="incident-card">
        <span class="label">Projetos vinculados</span>
        <span class="value">${projectTotal}</span>
        <small>Total informado nas integrações</small>
      </article>`;
  }

  function renderTable() {
    if (!incidents.length) {
      tableBody.innerHTML = '<tr><td colspan="6" class="incident-empty">Nenhum portfólio cadastrado até o momento.</td></tr>';
      return;
    }

    tableBody.innerHTML = incidents.map((incident) => {
      const responsible = incident.responsible_name || '<span class="incident-pill">—</span>';
      const notes = incident.notes ? incident.notes : '<span style="color:#94a3b8; font-size:12px;">Sem notas</span>';
      const projects = incident.project_count != null ? incident.project_count : 0;
      return `
        <tr>
          <td>
            <div style="display:grid; gap:4px;">
              <strong style="color:#0f172a; font-size:14px;">${incident.name}</strong>
              <span style="color:#64748b; font-size:12px;">Criado em ${formatDate(incident.created_at)}</span>
            </div>
          </td>
          <td><span class="incident-pill highlight">${incident.code}</span></td>
          <td>${responsible}</td>
          <td>${projects}</td>
          <td>${notes}</td>
          <td>
            <div class="incident-table-actions">
              <button class="incident-link" type="button" data-action="edit" data-id="${incident.id}">Editar</button>
              <button class="incident-link danger" type="button" data-action="remove" data-id="${incident.id}">Excluir</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  tableBody.addEventListener('click', async (event) => {
    const button = event.target.closest('button[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    const incidentId = button.dataset.id;
    const incident = incidents.find((item) => String(item.id) === String(incidentId));
    if (!incident) return;

    if (action === 'edit') {
      openModal(incident);
      return;
    }

    if (action === 'remove') {
      const confirmDelete = confirm(`Deseja realmente excluir o portfólio "${incident.name}"?`);
      if (!confirmDelete) return;
      try {
        const response = await fetch(`/api/companies/${companyId}/incidents/${incidentId}`, { method: 'DELETE' });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.message || 'Erro ao excluir portfólio');
        }
        showMessage(data.message || 'Ocorrência removido', 'success');
        await loadIncidents(true);
      } catch (error) {
        console.error(error);
        showMessage(error.message, 'error');
      }
    }
  });

  function formatDate(value) {
    if (!value) return '—';
    try {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString('pt-BR');
    } catch (error) {
      return value;
    }
  }
});
</script>
{% endblock %}
