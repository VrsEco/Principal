{% extends "base.html" %}
{% block title %}GRV | Portfólios{% endblock %}
{% block body %}{% set active_nav = 'project-portfolios' %}{{ super() }}{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
  .portfolio-shell {
    display: grid;
    grid-template-columns: 250px minmax(0, 1fr);
    gap: 18px;
    align-items: start;
  }

  .portfolio-main {
    background: #ffffff;
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    padding: 22px 24px;
    box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
    display: grid;
    gap: 20px;
  }

  .portfolio-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .portfolio-header h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .portfolio-description {
    color: #64748b;
    font-size: 13px;
    margin-top: 6px;
    max-width: 520px;
    line-height: 1.5;
  }

  .portfolio-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .portfolio-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 0.04em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .portfolio-button.primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff;
    box-shadow: 0 16px 28px rgba(37, 99, 235, 0.25);
  }

  .portfolio-button.primary:hover {
    transform: translateY(-2px);
  }

  .portfolio-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
  }

  .portfolio-card {
    border-radius: 12px;
    border: 1px solid rgba(59, 130, 246, 0.18);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(14, 116, 144, 0.08));
    padding: 16px 18px;
    display: grid;
    gap: 6px;
  }

  .portfolio-card span.label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #2563eb;
    font-weight: 600;
  }

  .portfolio-card span.value {
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .portfolio-card small {
    color: #475569;
    font-size: 11px;
  }

  .portfolio-table-wrapper {
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    overflow: hidden;
    background: #f8fafc;
  }

  table.portfolio-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  table.portfolio-table thead {
    background: rgba(15, 23, 42, 0.05);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 11px;
    color: #475569;
  }

  table.portfolio-table th,
  table.portfolio-table td {
    padding: 12px 16px;
    text-align: left;
    vertical-align: middle;
  }

  table.portfolio-table tbody tr {
    background: #ffffff;
    border-bottom: 1px solid rgba(15, 23, 42, 0.05);
    transition: background 0.2s ease;
  }

  table.portfolio-table tbody tr:hover {
    background: rgba(59, 130, 246, 0.06);
  }

  .portfolio-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
  }

  .portfolio-pill.highlight {
    background: rgba(59, 130, 246, 0.14);
    color: #2563eb;
  }

  .portfolio-table-actions {
    display: flex;
    gap: 10px;
  }

  .portfolio-link {
    border: none;
    background: transparent;
    font-size: 12px;
    color: #2563eb;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
  }

  .portfolio-link.danger {
    color: #dc2626;
  }

  .portfolio-empty {
    padding: 40px;
    text-align: center;
    color: #94a3b8;
    font-size: 13px;
  }

  /* Modal */
  .portfolio-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
    padding: 20px;
  }

  .portfolio-modal-backdrop.open {
    display: flex;
  }

  .portfolio-modal {
    background: #ffffff;
    border-radius: 16px;
    width: min(600px, 100%);
    max-height: 90vh;
    overflow-y: auto;
    padding: 26px;
    box-shadow: 0 24px 48px rgba(15, 23, 42, 0.25);
    display: grid;
    gap: 18px;
  }

  .portfolio-modal header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
  }

  .portfolio-modal header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #0f172a;
  }

  .portfolio-modal header button {
    border: none;
    background: transparent;
    font-size: 22px;
    cursor: pointer;
    color: #94a3b8;
  }

  .portfolio-form {
    display: grid;
    gap: 16px;
  }

  .portfolio-form .field {
    display: grid;
    gap: 6px;
  }

  .portfolio-form label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    color: #475569;
  }

  .portfolio-form input,
  .portfolio-form select,
  .portfolio-form textarea {
    border-radius: 10px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    padding: 10px 12px;
    font-size: 13px;
    transition: border 0.2s ease;
    font-family: inherit;
  }

  .portfolio-form textarea {
    resize: vertical;
    min-height: 80px;
  }

  .portfolio-form input:focus,
  .portfolio-form select:focus,
  .portfolio-form textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
  }

  .portfolio-form footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .portfolio-form footer button {
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
  }

  .portfolio-form footer .secondary {
    background: rgba(148, 163, 184, 0.18);
    color: #475569;
  }

  .portfolio-form footer .primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
  }

  @media (max-width: 1280px) {
    .portfolio-shell {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  @media (max-width: 720px) {
    .portfolio-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .portfolio-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .portfolio-summary {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="project-layout plan-layout portfolio-shell" data-sidebar-toggle>
  {# Sidebar focado em projetos #}
  {% set active_id = 'project-portfolios' %}
  {% include 'projects_sidebar.html' %}

  <section class="project-content plan-content portfolio-main">
    <header class="portfolio-header">
      <div>
        <h1>Portfólios da {{ company.name or company.legal_name or 'Empresa' }}</h1>
        <p class="portfolio-description">
          Consolidação dos portfólios estratégicos com visão rápida de responsáveis, códigos e quantidade de projetos associados.
        </p>
      </div>
      <div class="portfolio-actions">
        <button id="refreshButton" class="portfolio-button" type="button">🔄 Atualizar</button>
        <button id="newPortfolioButton" class="portfolio-button primary" type="button">➕ Novo Portfólio</button>
      </div>
    </header>

    <section id="portfolioSummary" class="portfolio-summary"></section>

    <div class="portfolio-table-wrapper">
      <table class="portfolio-table">
        <thead>
          <tr>
            <th>Portfólio</th>
            <th>Código</th>
            <th>Responsável</th>
            <th>Projetos</th>
            <th>Notas</th>
            <th style="width: 120px;">Ações</th>
          </tr>
        </thead>
        <tbody id="portfolioTableBody">
          <tr>
            <td colspan="6" class="portfolio-empty">Carregando portfólios...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>

<div id="portfolioModal" class="portfolio-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="portfolio-modal">
    <header>
      <h2 id="modalTitle">Novo Portfólio</h2>
      <button type="button" id="closeModalButton" aria-label="Fechar">×</button>
    </header>
    <form id="portfolioForm" class="portfolio-form">
      <input type="hidden" id="portfolioId">
      <div class="field">
        <label for="portfolioCode">Código *</label>
        <input id="portfolioCode" type="text" placeholder="Ex: PORT-001" required>
      </div>
      <div class="field">
        <label for="portfolioName">Nome do Portfólio *</label>
        <input id="portfolioName" type="text" placeholder="Ex: Transformação Digital" required>
      </div>
      <div class="field">
        <label for="portfolioResponsible">Responsável</label>
        <select id="portfolioResponsible">
          <option value="">Selecione um responsável</option>
        </select>
      </div>
      <div class="field">
        <label for="portfolioNotes">Observações</label>
        <textarea id="portfolioNotes" placeholder="Detalhes relevantes sobre o portfólio"></textarea>
      </div>
      <footer>
        <button type="button" class="secondary" id="cancelModalButton">Cancelar</button>
        <button type="submit" class="primary">Salvar Portfólio</button>
      </footer>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const companyId = {{ company.id }};
  const summaryContainer = document.getElementById('portfolioSummary');
  const tableBody = document.getElementById('portfolioTableBody');
  const refreshButton = document.getElementById('refreshButton');
  const newButton = document.getElementById('newPortfolioButton');
  const modalBackdrop = document.getElementById('portfolioModal');
  const modalTitle = document.getElementById('modalTitle');
  const form = document.getElementById('portfolioForm');
  const cancelBtn = document.getElementById('cancelModalButton');
  const closeBtn = document.getElementById('closeModalButton');

  const fieldId = document.getElementById('portfolioId');
  const fieldCode = document.getElementById('portfolioCode');
  const fieldName = document.getElementById('portfolioName');
  const fieldResponsible = document.getElementById('portfolioResponsible');
  const fieldNotes = document.getElementById('portfolioNotes');

  let portfolios = [];
  let employees = [];

  loadEmployees();
  loadPortfolios();

  refreshButton.addEventListener('click', () => {
    loadPortfolios(true);
  });

  newButton.addEventListener('click', () => openModal());
  cancelBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (event) => {
    if (event.target === modalBackdrop) {
      closeModal();
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = {
      code: fieldCode.value.trim(),
      name: fieldName.value.trim(),
      responsible_id: fieldResponsible.value || null,
      notes: fieldNotes.value.trim()
    };

    if (!payload.code || !payload.name) {
      showMessage('Informe código e nome do portfólio.', 'error');
      return;
    }

    try {
      const isEdit = Boolean(fieldId.value);
      const url = isEdit
        ? `/api/companies/${companyId}/portfolios/${fieldId.value}`
        : `/api/companies/${companyId}/portfolios`;
      const method = isEdit ? 'PUT' : 'POST';
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Falha ao salvar portfólio');
      }

      showMessage(data.message || 'Portfólio salvo com sucesso', 'success');
      closeModal();
      await loadPortfolios(true);
    } catch (error) {
      console.error(error);
      showMessage(error.message, 'error');
    }
  });

  function openModal(portfolio) {
    modalBackdrop.classList.add('open');
    modalBackdrop.setAttribute('aria-hidden', 'false');

    if (portfolio) {
      modalTitle.textContent = 'Editar Portfólio';
      fieldId.value = portfolio.id;
      fieldCode.value = portfolio.code;
      fieldName.value = portfolio.name;
      fieldResponsible.value = portfolio.responsible_id || '';
      fieldNotes.value = portfolio.notes || '';
    } else {
      modalTitle.textContent = 'Novo Portfólio';
      fieldId.value = '';
      form.reset();
    }

    fieldCode.focus();
  }

  function closeModal() {
    modalBackdrop.classList.remove('open');
    modalBackdrop.setAttribute('aria-hidden', 'true');
    form.reset();
    fieldId.value = '';
  }

  async function loadEmployees() {
    try {
      const response = await fetch(`/api/companies/${companyId}/employees`);
      const data = await response.json();
      if (data.success) {
        employees = data.employees || [];
        const options = ['<option value="">Selecione um responsável</option>']
          .concat(employees.map((emp) => `<option value="${emp.id}">${emp.name}</option>`));
        fieldResponsible.innerHTML = options.join('');
      }
    } catch (error) {
      console.error('Erro ao carregar colaboradores', error);
    }
  }

  async function loadPortfolios(showToast = false) {
    try {
      tableBody.innerHTML = '<tr><td colspan="6" class="portfolio-empty">Carregando portfólios...</td></tr>';
      const response = await fetch(`/api/companies/${companyId}/portfolios`);
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Erro ao listar portfólios');
      }
      portfolios = data.portfolios || [];
      renderSummary();
      renderTable();
      if (showToast) {
        showMessage('Portfólios atualizados.', 'info');
      }
    } catch (error) {
      console.error(error);
      tableBody.innerHTML = `<tr><td colspan="6" class="portfolio-empty">${error.message}</td></tr>`;
    }
  }

  function renderSummary() {
    if (!portfolios.length) {
      summaryContainer.innerHTML = `
        <article class="portfolio-card">
          <span class="label">Portfólios</span>
          <span class="value">0</span>
          <small>Registre o primeiro portfólio para começar.</small>
        </article>`;
      return;
    }

    const total = portfolios.length;
    const withResponsible = portfolios.filter((p) => p.responsible_name).length;
    const notesCount = portfolios.filter((p) => p.notes).length;
    const projectTotal = portfolios.reduce((sum, item) => sum + (item.project_count || 0), 0);

    summaryContainer.innerHTML = `
      <article class="portfolio-card">
        <span class="label">Portfólios ativos</span>
        <span class="value">${total}</span>
        <small>Total cadastrado para a empresa</small>
      </article>
      <article class="portfolio-card">
        <span class="label">Responsáveis definidos</span>
        <span class="value">${withResponsible}</span>
        <small>${withResponsible ? 'Portfólios com owner definido' : 'Nenhum responsável associado'}</small>
      </article>
      <article class="portfolio-card">
        <span class="label">Notas registradas</span>
        <span class="value">${notesCount}</span>
        <small>Portfólios com contexto adicional</small>
      </article>
      <article class="portfolio-card">
        <span class="label">Projetos vinculados</span>
        <span class="value">${projectTotal}</span>
        <small>Total informado nas integrações</small>
      </article>`;
  }

  function renderTable() {
    if (!portfolios.length) {
      tableBody.innerHTML = '<tr><td colspan="6" class="portfolio-empty">Nenhum portfólio cadastrado até o momento.</td></tr>';
      return;
    }

    tableBody.innerHTML = portfolios.map((portfolio) => {
      const responsible = portfolio.responsible_name || '<span class="portfolio-pill">—</span>';
      const notes = portfolio.notes ? portfolio.notes : '<span style="color:#94a3b8; font-size:12px;">Sem notas</span>';
      const projects = portfolio.project_count != null ? portfolio.project_count : 0;
      return `
        <tr>
          <td>
            <div style="display:grid; gap:4px;">
              <strong style="color:#0f172a; font-size:14px;">${portfolio.name}</strong>
              <span style="color:#64748b; font-size:12px;">Criado em ${formatDate(portfolio.created_at)}</span>
            </div>
          </td>
          <td><span class="portfolio-pill highlight">${portfolio.code}</span></td>
          <td>${responsible}</td>
          <td>${projects}</td>
          <td>${notes}</td>
          <td>
            <div class="portfolio-table-actions">
              <button class="portfolio-link" type="button" data-action="edit" data-id="${portfolio.id}">Editar</button>
              <button class="portfolio-link danger" type="button" data-action="remove" data-id="${portfolio.id}">Excluir</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  tableBody.addEventListener('click', async (event) => {
    const button = event.target.closest('button[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    const portfolioId = button.dataset.id;
    const portfolio = portfolios.find((item) => String(item.id) === String(portfolioId));
    if (!portfolio) return;

    if (action === 'edit') {
      openModal(portfolio);
      return;
    }

    if (action === 'remove') {
      const confirmDelete = confirm(`Deseja realmente excluir o portfólio "${portfolio.name}"?`);
      if (!confirmDelete) return;
      try {
        const response = await fetch(`/api/companies/${companyId}/portfolios/${portfolioId}`, { method: 'DELETE' });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.message || 'Erro ao excluir portfólio');
        }
        showMessage(data.message || 'Portfólio removido', 'success');
        await loadPortfolios(true);
      } catch (error) {
        console.error(error);
        showMessage(error.message, 'error');
      }
    }
  });

  function formatDate(value) {
    if (!value) return '—';
    try {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString('pt-BR');
    } catch (error) {
      return value;
    }
  }
});
</script>
{% endblock %}
