{% extends "base.html" %}
{% block title %}OKRs de Área | {{ plan.name }}{% endblock %}

{% block extra_head %}
<style>
.icon-okr, .icon-ai, .icon-suggestions, .icon-estruturante, .icon-aceleracao, .icon-geral {
    display: inline-block;
    margin-right: 6px;
    font-size: 1.1em;
}

.unified-indicator-btn {
    margin-left: 8px;
    background: linear-gradient(135deg, #10b981, #059669);
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    color: white;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.unified-indicator-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.button-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border: none;
    color: white;
}

.button-success:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.okr-kpi-header {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}
</style>
<script src="{{ url_for('static', filename='js/unified-indicator-button.js') }}"></script>
{% endblock %}
{% block body %}
  {% set active_nav = 'projetos' %}
  {{ super() }}
{% endblock %}
{% block content %}
<div class="project-layout plan-layout okr-layout" data-sidebar-toggle>
  {% set sidebar_meta %}
    <span class="summary-eyebrow">Cadência recomendada</span>
    <p>Revise os OKRs táticos junto com os líderes de área a cada ciclo mensal para garantir aderência operacional.</p>
  {% endset %}
  {% include 'plan_sidebar.html' %}

  <section class="project-content okr-content">
    <!-- Referência aos OKRs Globais -->
    <div class="surface-card directional-reference">
      <div class="card-header">
        <h3><span class="icon-okr">🎯</span> OKRs Globais Aprovados</h3>
        <span class="badge">Base para OKRs de ãrea</span>
      </div>
      <div class="card-content">
        <p class="panel-hint">Os OKRs de ãrea devem ser derivados dos OKRs Globais aprovados abaixo:</p>
        {% if global_okrs %}
        <div class="directionals-grid">
          {% for global_okr in global_okrs %}
          <div class="directional-card">
            <div class="directional-header">
              <div class="directional-icon">
                {% if global_okr.type == 'estruturante' %}<span class="icon-estruturante">🏗️</span>{% elif global_okr.type == 'aceleracao' %}<span class="icon-aceleracao">⚡</span>{% else %}<span class="icon-geral">🎯</span>{% endif %}
              </div>
              <div class="directional-title-section">
                <h5 class="directional-title">{{ global_okr.objective or 'OKR Global' }}</h5>
                <span class="directional-type-badge type-{{ (global_okr.type or '').lower() }}">
                  {{ global_okr.type_display or 'Geral' }}
                </span>
              </div>
            </div>
            <p>{{ global_okr.observations or 'Sem observações' }}</p>
            {% if global_okr.owner %}
            <div class="directional-meta">
              <span class="summary-meta">Responsável: {{ global_okr.owner }}</span>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          <div class="empty-icon">⚠️</div>
          <h4>Nenhum OKR Global aprovado encontrado</h4>
          <p>Para criar OKRs de Área, é necessário primeiro completar a seção "OKRs Globais" e obter aprovação dos OKRs estratégicos.</p>
          <div class="empty-hint">
            <span class="hint-icon">💡</span>
            <span>Complete a seção anterior para visualizar os OKRs Globais aprovados</span>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Anã¡lise Preliminar -->
    <details class="interview-section surface-card" {% if preliminary_analysis_section_open %}open{% endif %}>
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Anã¡lise</span>
          <h3>Anã¡lise Preliminar dos OKRs de ãrea</h3>
          <p>Identifique oportunidades de OKRs de ã¡rea baseados nos OKRs globais aprovados.</p>
        </div>
        <div class="interview-progress">
          <span class="chip-label">OKRs</span>
          <span class="interview-count">{{ preliminary_area_okr_records|length }} anã¡lises salvas</span>
          <div class="section-status-controls">
            {% if preliminary_analysis_section_open %}
              <button class="button button-small button-warning" onclick="closePreliminaryAnalysisSection()" title="Concluir anã¡lise preliminar">
                <span>Concluir</span>
              </button>
            {% else %}
              <button class="button button-small button-success" onclick="openPreliminaryAnalysisSection()" title="Reabrir anã¡lise preliminar">
                <span>Reabrir</span>
              </button>
            {% endif %}
          </div>
        </div>
      </summary>
      <div class="interview-content" id="preliminary-analysis-content">
        {% if not preliminary_analysis_section_open %}
        <div class="section-closed-notice">
          <p>ðŸŽ¯ Esta seã§ã£o foi concluã­da e nã£o permite mais ediã§ãµes.</p>
        </div>
        
        <!-- Exibir Anã¡lises Preliminares quando seã§ã£o fechada -->
        {% if preliminary_area_okr_records %}
        <div class="okr-analysis-list">
          {% for record in preliminary_area_okr_records %}
          <div class="okr-analysis-item">
            <p>{{ record.analysis }}</p>
            <div class="okr-analysis-meta">
              <span class="summary-meta">Salvo em: {{ record.created_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
        
        {% if preliminary_analysis_section_open %}
        
        <!-- Botã£o para Gerar Sugestãµes da IA -->
        <div class="ai-suggestions-section">
          <div class="ai-suggestions-header">
            <h4><span class="icon-ai">âš™</span> Sugestãµes da IA</h4>
            <p>Gere sugestãµes inteligentes de OKRs de ã¡rea baseadas nos OKRs globais aprovados.</p>
            <button type="button" class="button button-primary" onclick="generateAISuggestions()" id="ai-suggestions-btn">
              <span>âœ¨ Gerar Sugestãµes da IA</span>
            </button>
          </div>
          
          <!-- Loading state -->
          <div id="ai-loading" class="ai-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Gerando sugestãµes inteligentes...</p>
          </div>
          
          <!-- AI Suggestions Results -->
          <div id="ai-suggestions-results" class="ai-suggestions-results" style="display: none;">
            <h5><span class="icon-suggestions">ðŸ’¡</span> Sugestãµes Geradas pela IA</h5>
            <div id="ai-suggestions-content"></div>
            <div class="ai-suggestions-actions">
              <button type="button" class="button button-secondary" onclick="useAISuggestion()">
                <span>ðŸ“ Usar como Anã¡lise</span>
              </button>
              <button type="button" class="button button-secondary" onclick="regenerateAISuggestions()">
                <span>ðŸ”„ Regenerar</span>
              </button>
            </div>
          </div>
        </div>
        
        <form class="okr-analysis-form" action="{{ url_for('add_preliminary_area_okr_record', plan_id=plan.id) }}" method="post">
          <div class="form-field">
            <span>Anã¡lise de OKR de ãrea</span>
            <textarea name="okr_analysis" id="okr-analysis-textarea" placeholder="Descreva a anã¡lise preliminar do OKR de ã¡rea..." rows="4" required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="button button-primary">Salvar Anã¡lise</button>
          </div>
        </form>
        {% endif %}
        
        {% if preliminary_area_okr_records %}
        <div class="okr-analysis-list">
          {% for record in preliminary_area_okr_records %}
          <div class="okr-analysis-item">
            <p>{{ record.analysis }}</p>
            <div class="okr-analysis-meta">
              <span class="summary-meta">Salvo em: {{ record.created_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </details>

    <!-- Versã£o Preliminar -->
    <details class="interview-section surface-card">
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Workshop</span>
          <h3>Versã£o Preliminar</h3>
          <p>Defina os OKRs de ã¡rea preliminares atravã©s de workshop colaborativo.</p>
        </div>
        <div class="interview-progress">
          <span class="chip-label">OKRs</span>
          <span class="interview-count">{{ workshop_area_okr_records|length }} OKRs definidos</span>
          <div class="section-status-controls">
            {% if workshop_area_section_open %}
              <button class="button button-small button-warning" onclick="closeWorkshopAreaSection()" title="Concluir versã£o preliminar">
                <span>Concluir</span>
              </button>
            {% else %}
              <button class="button button-small button-success" onclick="openWorkshopAreaSection()" title="Reabrir versã£o preliminar">
                <span>Reabrir</span>
              </button>
            {% endif %}
          </div>
        </div>
      </summary>
      <div class="interview-content" id="workshop-area-content">
        {% if not workshop_area_section_open %}
        <div class="section-closed-notice">
          <p>ðŸŽ¯ Esta seã§ã£o foi concluã­da e nã£o permite mais ediã§ãµes.</p>
        </div>
        
        <!-- Exibir Discussãµes da Versã£o Preliminar quando seã§ã£o fechada -->
        {% if area_workshop_discussions %}
        <div class="workshop-discussions-section">
          <h4>ðŸ“ Discussãµes da Versã£o Preliminar</h4>
          <div class="discussions-content">
            <p>{{ area_workshop_discussions }}</p>
          </div>
        </div>
        {% endif %}
        
        <!-- Exibir OKRs da Versã£o Preliminar quando seã§ã£o fechada -->
        {% if workshop_area_okr_records %}
        <div class="okr-workshop-list">
          {% for record in workshop_area_okr_records %}
          <div class="okr-workshop-item">
            <div class="okr-workshop-header">
              <h5>
                {% if record.type == 'estruturante' %}
                  ðŸ—ï¸
                {% elif record.type == 'aceleracao' %}
                  âš¡
                {% else %}
                  ðŸŽ¯
                {% endif %}
                {{ record.objective }}
              </h5>
              <div class="okr-workshop-meta">
                <span class="okr-type">{{ record.type_display or record.type }}</span>
                <span class="okr-owner">{{ record.owner or 'Sem responsã¡vel' }}</span>
                <span class="okr-area">{{ record.area or 'Sem ã¡rea' }}</span>
                {% if record.deadline %}
                <span class="okr-deadline">{% if record.deadline %}{% if record.deadline.strftime is defined %}{{ record.deadline.strftime('%d/%m/%Y') }}{% else %}{{ record.deadline }}{% endif %}{% endif %}</span>
                {% endif %}
              </div>
            </div>
            {% if record.key_results %}
            <div class="okr-key-results">
              <h6>Indicadores:</h6>
              <ul>
                {% for kr in record.key_results %}
                <li>
                  <strong>{{ kr.label or kr.description or 'Indicador' }}</strong>
                  {% if kr.target %}<span class="kr-target">({{ kr.target }})</span>{% endif %}
                  {% if kr.owner %}<span class="kr-owner"> - {{ kr.owner }}</span>{% endif %}
                  {% if kr.deadline %}<span class="kr-deadline"> - {{ kr.deadline }}</span>{% endif %}
                  {% set indicator_key = (kr.indicator_id|string) if kr.indicator_id is not none else '' %}
                  {% set indicator_label = kr.indicator_display or indicator_lookup.get(indicator_key) %}
                  {% if indicator_label %}<span class="kr-indicator"> - Indicador: {{ indicator_label }}</span>{% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if record.observations %}
            <div class="okr-observations">
              <p><strong>Observaã§ãµes:</strong> {{ record.observations }}</p>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
        
        {% if workshop_area_section_open %}
        
        <!-- Campo para Discussãµes da Versã£o Preliminar -->
        <div class="workshop-discussions-section">
          <h4>ðŸ“ Discussãµes da Versã£o Preliminar</h4>
          <form class="workshop-discussions-form" action="{{ url_for('save_area_workshop_discussions', plan_id=plan.id) }}" method="post">
            <div class="form-field">
              <span>Registre as principais discussãµes e decisãµes da versã£o preliminar</span>
              <textarea name="area_workshop_discussions" placeholder="Descreva as discussãµes realizadas durante a definiã§ã£o da versã£o preliminar dos OKRs de ã¡rea, alinhamentos com OKRs globais, definiã§ãµes de responsabilidades e metas por ã¡rea..." rows="8">{{ area_workshop_discussions or '' }}</textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="button button-primary">Salvar Discussãµes</button>
              {% if area_workshop_discussions %}
              <button type="button" class="button button-danger" onclick="deleteAreaWorkshopDiscussions()" title="Excluir discussãµes">
                ðŸ—‘ï¸ Excluir
              </button>
              {% endif %}
            </div>
          </form>
        </div>
        
        <form class="okr-workshop-form" action="{{ url_for('add_area_okr_record', plan_id=plan.id) }}" method="post">
          <div class="form-field">
            <span>OKR Global Base</span>
            <select name="okr_global_ref" {% if global_okrs %}required{% endif %}>
              <option value="">Selecione o OKR Global</option>
              {% for global_okr in global_okrs %}
              <option value="{{ global_okr.id }}">{{ global_okr.objective or 'OKR Global' }} - {{ global_okr.type_display or 'Geral' }}</option>
              {% endfor %}
            </select>
            {% if not global_okrs %}
            <small class="form-hint">âš ï¸ Nenhum OKR Global aprovado encontrado. Complete a seã§ã£o "OKRs Globais" primeiro.</small>
            {% endif %}
          </div>
          
          <div class="form-field">
            <span>ãrea / Squad Responsã¡vel</span>
            <select name="okr_area" required>
              <option value="">Selecione a ã¡rea</option>
              <option value="comercial">Comercial</option>
              <option value="operacional">Operacional</option>
              <option value="administrativo">Administrativo</option>
              <option value="financeiro">Financeiro</option>
              <option value="rh">Recursos Humanos</option>
              <option value="ti">Tecnologia da Informaã§ã£o</option>
              <option value="marketing">Marketing</option>
              <option value="juridico">Jurã­dico</option>
              <option value="outros">Outros</option>
            </select>
          </div>
          
          <div class="form-field">
            <span>Objetivo da ãrea</span>
            <input type="text" name="okr_objective" placeholder="Objetivo estratã©gico preliminar..." required />
          </div>
          
          <div class="form-two-cols">
            <div class="form-field">
              <span>Tipo de OKR</span>
              <select name="okr_type" required>
                <option value="">Selecione o tipo</option>
                <option value="estruturante">Estruturante</option>
                <option value="aceleracao">Aceleraã§ã£o</option>
              </select>
            </div>
            <div class="form-field">
              <span>Responsã¡vel pelo OKR</span>
              <select name="okr_owner_id" id="area-okr-owner-select" data-owner-target="area-okr-owner-name">
                <option value="">Selecione o responsã¡vel</option>
                {% for participant in participants_options %}
                <option value="{{ participant.id }}" data-name="{{ participant.name }}">{{ participant.label }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="okr_owner" id="area-okr-owner-name" value="">
            </div>
          </div>
          
          <div class="form-field">
            <span>Prazo geral do OKR</span>
            <input type="date" name="okr_deadline" />
          </div>
          
          <div class="form-field">
            <span>Observaã§ãµes</span>
            <textarea name="okr_observations" placeholder="Observaã§ãµes adicionais..." rows="3"></textarea>
          </div>
          
          <div class="okr-kpi-grid" id="area-kr-container" data-participants="{{ participants_options|tojson|safe }}" data-indicators="{{ indicators|tojson|safe }}">
            <div class="okr-kpi-header">
              <button type="button" class="button button-small button-success" onclick="openIndicatorFormFromOKR('area-kr-container', '{{ plan.id }}', 'okr-area')" title="Criar indicador completo no formulário">
                <span>📊 Incluir Indicador</span>
              </button>
            </div>
            <div class="key-results-list" id="area-kr-list">
              <!-- Indicadores will be added dynamically here -->
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="button button-primary">Salvar OKR Preliminar</button>
          </div>
        </form>
        {% endif %}
        
        {% if workshop_area_okr_records %}
        <div class="okr-search-bar">
          <div class="search-controls">
            <input type="text" id="workshop-area-search" placeholder="Buscar OKRs..." onkeyup="searchOKRs('workshop-area', this.value)">
            <button type="button" class="button button-small button-secondary" onclick="clearSearch('workshop-area')">
              <span>Limpar</span>
            </button>
          </div>
        </div>
        <div class="okr-workshop-list" id="workshop-area-okr-list">
          {% for record in workshop_area_okr_records %}
          <div class="okr-workshop-item">
            <div class="okr-workshop-header">
              <h5>
                {% if record.type == 'estruturante' %}
                  ðŸ—ï¸
                {% elif record.type == 'aceleracao' %}
                  âš¡
                {% else %}
                  ðŸŽ¯
                {% endif %}
                {{ record.objective }}
              </h5>
              <div class="okr-header-actions">
                <span class="okr-type-badge {{ record.type }}">{{ record.type_display }}</span>
                <div class="okr-action-buttons">
                  <button type="button" class="button button-small button-secondary" onclick="editOKR('workshop-area', {{ record.id }})" title="Editar OKR">
                    <span>âœï¸</span>
                  </button>
                  <button type="button" class="button button-small button-info" onclick="duplicateOKR('workshop-area', '{{ record.id }}')" title="Duplicar OKR">
                    <span>ðŸ“‹</span>
                  </button>
                  <button type="button" class="button button-small button-danger" onclick="deleteOKR('workshop-area', {{ record.id }}, '{{ record.objective }}')" title="Excluir OKR">
                    <span>ðŸ—‘ï¸</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="okr-workshop-body">
              {% if record.global_ref %}
              <p><strong>OKR Global Base:</strong> 
                {% for global_okr in global_okrs %}
                  {% if global_okr.id == record.global_ref %}
                    {{ global_okr.objective or 'OKR Global' }} - {{ global_okr.type_display or 'Geral' }}
                  {% endif %}
                {% endfor %}
              </p>
              {% endif %}
              {% if record.area %}<p><strong>ãrea:</strong> {{ record.area|title }}</p>{% endif %}
              {% if record.owner %}<p><strong>Responsã¡vel:</strong> {{ record.owner }}</p>{% endif %}
              {% if record.deadline %}<p><strong>Prazo:</strong> {% if record.deadline.strftime is defined %}{{ record.deadline.strftime('%d/%m/%Y') }}{% else %}{{ record.deadline }}{% endif %}</p>{% endif %}
              {% if record.observations %}<p><strong>Observaã§ãµes:</strong> {{ record.observations }}</p>{% endif %}
              
              {% if record.key_results %}
              <div class="okr-key-results">
                <p><strong>Indicadores:</strong></p>
                <ul class="okr-kr-list">
                  {% for kr in record.key_results %}
                  <li class="okr-kr-item">
                    <strong>{{ kr.label }}</strong>
                    {% if kr.target %}<span class="kr-meta"> - Meta: {{ kr.target }}</span>{% endif %}
                    {% if kr.deadline %}<span class="kr-meta"> - Prazo: {{ kr.deadline }}</span>{% endif %}
                    {% if kr.owner %}<span class="kr-meta"> - Responsã¡vel: {{ kr.owner }}</span>{% endif %}
                    {% set indicator_key = (kr.indicator_id|string) if kr.indicator_id is not none else '' %}
                    {% set indicator_label = kr.indicator_display or indicator_lookup.get(indicator_key) %}
                    {% if indicator_label %}<span class="kr-meta"> - Indicador: {{ indicator_label }}</span>{% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
            <div class="okr-workshop-meta">
              <span class="summary-meta">Criado em: {{ record.created_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
              {% if record.updated_at and record.updated_at != record.created_at %}
              <span class="summary-meta"> | Atualizado em: {{ record.updated_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </details>

    <!-- Versã£o Final e Aprovaã§ãµes -->
    <details class="interview-section surface-card">
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Aprovaã§ã£o</span>
          <h3>Versã£o Final e Aprovaã§ãµes</h3>
          <p>Cadastre os OKRs de ã¡rea finais e obtenha aprovaã§ã£o da lideranã§a.</p>
        </div>
        <div class="interview-progress">
          <span class="chip-label">OKRs</span>
          <span class="interview-count">{{ final_area_okr_records|length }} OKRs aprovados</span>
          <div class="section-status-controls">
            {% if final_area_section_open %}
              <button class="button button-small button-warning" onclick="closeFinalAreaSection()" title="Concluir versã£o final e aprovaã§ãµes">
                <span>Concluir</span>
              </button>
            {% else %}
              <button class="button button-small button-success" onclick="openFinalAreaSection()" title="Reabrir versã£o final e aprovaã§ãµes">
                <span>Reabrir</span>
              </button>
            {% endif %}
          </div>
        </div>
      </summary>
      <div class="interview-content" id="final-area-content">
        {% if not final_area_section_open %}
        <div class="section-closed-notice">
          <p>ðŸŽ¯ Esta seã§ã£o foi concluã­da e nã£o permite mais ediã§ãµes.</p>
        </div>
        
        <!-- Exibir Discussãµes da Versã£o Final quando seã§ã£o fechada -->
        {% if final_area_discussions %}
        <div class="approval-discussions-section">
          <h4>ðŸ“ Discussãµes da Versã£o Final</h4>
          <div class="discussions-content">
            <p>{{ final_area_discussions }}</p>
          </div>
        </div>
        {% endif %}
        
        <!-- Exibir OKRs da Versã£o Final quando seã§ã£o fechada -->
        {% if final_area_okr_records %}
        <div class="okr-approvals-list">
          {% for record in final_area_okr_records %}
          <div class="okr-approval-item">
            <div class="okr-approval-header">
              <h5>
                {% if record.type == 'estruturante' %}
                  ðŸ—ï¸
                {% elif record.type == 'aceleracao' %}
                  âš¡
                {% else %}
                  ðŸŽ¯
                {% endif %}
                {{ record.objective }}
              </h5>
              <div class="okr-approval-meta">
                <span class="okr-type">{{ record.type_display or record.type }}</span>
                <span class="okr-owner">{{ record.owner or 'Sem responsã¡vel' }}</span>
                <span class="okr-area">{{ record.area or 'Sem ã¡rea' }}</span>
                {% if record.deadline %}
                <span class="okr-deadline">{% if record.deadline %}{% if record.deadline.strftime is defined %}{{ record.deadline.strftime('%d/%m/%Y') }}{% else %}{{ record.deadline }}{% endif %}{% endif %}</span>
                {% endif %}
              </div>
            </div>
            {% if record.key_results %}
            <div class="okr-key-results">
              <h6>Indicadores:</h6>
              <ul>
                {% for kr in record.key_results %}
                <li>
                  <strong>{{ kr.label or kr.description or 'Indicador' }}</strong>
                  {% if kr.target %}<span class="kr-target">({{ kr.target }})</span>{% endif %}
                  {% if kr.owner %}<span class="kr-owner"> - {{ kr.owner }}</span>{% endif %}
                  {% if kr.deadline %}<span class="kr-deadline"> - {{ kr.deadline }}</span>{% endif %}
                  {% set indicator_key = (kr.indicator_id|string) if kr.indicator_id is not none else '' %}
                  {% set indicator_label = kr.indicator_display or indicator_lookup.get(indicator_key) %}
                  {% if indicator_label %}<span class="kr-indicator"> - Indicador: {{ indicator_label }}</span>{% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if record.observations %}
            <div class="okr-observations">
              <p><strong>Observaã§ãµes:</strong> {{ record.observations }}</p>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
        
        {% if final_area_section_open %}
        
        <!-- Campo para Discussãµes da Versã£o Final -->
        <div class="approval-discussions-section">
          <h4>ðŸ“ Discussãµes da Versã£o Final</h4>
          <form class="approval-discussions-form" action="{{ url_for('save_final_area_discussions', plan_id=plan.id) }}" method="post">
            <div class="form-field">
              <span>Registre as discussãµes e decisãµes da versã£o final e aprovaã§ãµes</span>
              <textarea name="final_area_discussions" placeholder="Descreva as discussãµes realizadas durante a definiã§ã£o da versã£o final e aprovaã§ã£o dos OKRs de ã¡rea, feedback da lideranã§a, ajustes solicitados e decisãµes finais..." rows="8">{{ final_area_discussions or '' }}</textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="button button-primary">Salvar Discussãµes</button>
              {% if final_area_discussions %}
              <button type="button" class="button button-danger" onclick="deleteFinalAreaDiscussions()" title="Excluir discussãµes">
                ðŸ—‘ï¸ Excluir
              </button>
              {% endif %}
            </div>
          </form>
        </div>
        
        <form class="okr-approval-form" action="{{ url_for('add_final_area_okr_record', plan_id=plan.id) }}" method="post">
          <div class="form-field">
            <span>OKR Global Base</span>
            <select name="okr_global_ref" {% if global_okrs %}required{% endif %}>
              <option value="">Selecione o OKR Global</option>
              {% for global_okr in global_okrs %}
              <option value="{{ global_okr.id }}">{{ global_okr.objective or 'OKR Global' }} - {{ global_okr.type_display or 'Geral' }}</option>
              {% endfor %}
            </select>
            {% if not global_okrs %}
            <small class="form-hint">âš ï¸ Nenhum OKR Global aprovado encontrado. Complete a seã§ã£o "OKRs Globais" primeiro.</small>
            {% endif %}
          </div>
          
          <div class="form-field">
            <span>ãrea / Squad Responsã¡vel</span>
            <select name="okr_area" required>
              <option value="">Selecione a ã¡rea</option>
              <option value="comercial">Comercial</option>
              <option value="operacional">Operacional</option>
              <option value="administrativo">Administrativo</option>
              <option value="financeiro">Financeiro</option>
              <option value="rh">Recursos Humanos</option>
              <option value="ti">Tecnologia da Informaã§ã£o</option>
              <option value="marketing">Marketing</option>
              <option value="juridico">Jurã­dico</option>
              <option value="outros">Outros</option>
            </select>
          </div>
          
          <div class="form-field">
            <span>Objetivo da ãrea</span>
            <input type="text" name="okr_objective" placeholder="Objetivo estratã©gico final..." required />
          </div>
          
          <div class="form-two-cols">
            <div class="form-field">
              <span>Tipo de OKR</span>
              <select name="okr_type" required>
                <option value="">Selecione o tipo</option>
                <option value="estruturante">Estruturante</option>
                <option value="aceleracao">Aceleraã§ã£o</option>
              </select>
            </div>
            <div class="form-field">
              <span>Responsã¡vel pelo OKR</span>
              <select name="okr_owner_id" id="area-final-okr-owner-select" data-owner-target="area-final-okr-owner-name">
                <option value="">Selecione o responsã¡vel</option>
                {% for participant in participants_options %}
                <option value="{{ participant.id }}" data-name="{{ participant.name }}">{{ participant.label }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="okr_owner" id="area-final-okr-owner-name" value="">
            </div>
          </div>
          
          <div class="form-field">
            <span>Prazo geral do OKR</span>
            <input type="date" name="okr_deadline" />
          </div>
          
          <div class="form-field">
            <span>Observaã§ãµes</span>
            <textarea name="okr_observations" placeholder="Observaã§ãµes adicionais..." rows="3"></textarea>
          </div>
          
          <div class="okr-kpi-grid" id="final-area-kr-container" data-participants="{{ participants_options|tojson|safe }}" data-indicators="{{ indicators|tojson|safe }}">
            <div class="okr-kpi-header">
              <button type="button" class="button button-small button-success" onclick="openIndicatorFormFromOKR('final-area-kr-container', '{{ plan.id }}', 'okr-area')" title="Criar indicador completo no formulário">
                <span>📊 Incluir Indicador</span>
              </button>
            </div>
            <div class="key-results-list" id="final-area-kr-list">
              <!-- Indicadores will be added dynamically here -->
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="button button-primary">Salvar OKR Final</button>
          </div>
        </form>
        {% endif %}
        
        {% if final_area_okr_records %}
        <div class="okr-search-bar">
          <div class="search-controls">
            <input type="text" id="final-area-search" placeholder="Buscar OKRs..." onkeyup="searchOKRs('final-area', this.value)">
            <button type="button" class="button button-small button-secondary" onclick="clearSearch('final-area')">
              <span>Limpar</span>
            </button>
          </div>
        </div>
        <div class="okr-approvals-list" id="final-area-okr-list">
          {% for record in final_area_okr_records %}
          <div class="okr-approval-item">
            <div class="okr-approval-header">
              <h5>
                {% if record.type == 'estruturante' %}
                  ðŸ—ï¸
                {% elif record.type == 'aceleracao' %}
                  âš¡
                {% else %}
                  ðŸŽ¯
                {% endif %}
                {{ record.objective }}
              </h5>
              <div class="okr-header-actions">
                <span class="okr-type-badge {{ record.type }}">{{ record.type_display }}</span>
                <div class="okr-action-buttons">
                  <button type="button" class="button button-small button-secondary" onclick="editOKR('final-area', {{ record.id }})" title="Editar OKR">
                    <span>âœï¸</span>
                  </button>
                  <button type="button" class="button button-small button-info" onclick="duplicateOKR('final-area', '{{ record.id }}')" title="Duplicar OKR">
                    <span>ðŸ“‹</span>
                  </button>
                  <button type="button" class="button button-small button-danger" onclick="deleteOKR('final-area', {{ record.id }}, '{{ record.objective }}')" title="Excluir OKR">
                    <span>ðŸ—‘ï¸</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="okr-approval-body">
              {% if record.global_ref %}
              <p><strong>OKR Global Base:</strong> 
                {% for global_okr in global_okrs %}
                  {% if global_okr.id == record.global_ref %}
                    {{ global_okr.objective or 'OKR Global' }} - {{ global_okr.type_display or 'Geral' }}
                  {% endif %}
                {% endfor %}
              </p>
              {% endif %}
              {% if record.area %}<p><strong>ãrea:</strong> {{ record.area|title }}</p>{% endif %}
              {% if record.owner %}<p><strong>Responsã¡vel:</strong> {{ record.owner }}</p>{% endif %}
              {% if record.deadline %}<p><strong>Prazo:</strong> {% if record.deadline.strftime is defined %}{{ record.deadline.strftime('%d/%m/%Y') }}{% else %}{{ record.deadline }}{% endif %}</p>{% endif %}
              {% if record.observations %}<p><strong>Observaã§ãµes:</strong> {{ record.observations }}</p>{% endif %}
              
              {% if record.key_results %}
              <div class="okr-key-results">
                <p><strong>Indicadores:</strong></p>
                <ul class="okr-kr-list">
                  {% for kr in record.key_results %}
                  <li class="okr-kr-item">
                    <strong>{{ kr.label }}</strong>
                    {% if kr.target %}<span class="kr-meta"> - Meta: {{ kr.target }}</span>{% endif %}
                    {% if kr.deadline %}<span class="kr-meta"> - Prazo: {{ kr.deadline }}</span>{% endif %}
                    {% if kr.owner %}<span class="kr-meta"> - Responsã¡vel: {{ kr.owner }}</span>{% endif %}
                    {% set indicator_key = (kr.indicator_id|string) if kr.indicator_id is not none else '' %}
                    {% set indicator_label = kr.indicator_display or indicator_lookup.get(indicator_key) %}
                    {% if indicator_label %}<span class="kr-meta"> - Indicador: {{ indicator_label }}</span>{% endif %}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
            <div class="okr-approval-meta">
              <span class="summary-meta">Criado em: {{ record.created_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
              {% if record.updated_at and record.updated_at != record.created_at %}
              <span class="summary-meta"> | Atualizado em: {{ record.updated_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </details>

    <!-- Consolidaã§ã£o Final -->
    <details class="interview-section surface-card" open>
      <summary class="interview-summary-bar">
        <div class="interview-summary-text">
          <span class="section-eyebrow">Consolidaã§ã£o</span>
          <h3>Consolidaã§ã£o Final - OKRs de Area Consolidados do Plano</h3>
          <p>Visualize todos os OKRs de ã¡rea aprovados e consolidados.</p>
        </div>
        <div class="interview-progress">
          <span class="chip-label">OKRs</span>
          <span class="interview-count">{{ final_area_okr_records|length }} OKRs consolidados</span>
        </div>
      </summary>
      <div class="interview-content">
        {% if final_area_okr_records %}
        <div class="directionals-grid okr-consolidated-grid">
          {% for record in final_area_okr_records %}
          <div class="directional-card okr-consolidated-card">
            <div class="directional-header">
              <div class="directional-icon">
                {% if record.type == 'estruturante' %}
                  ðŸ—ï¸
                {% elif record.type == 'aceleracao' %}
                  âš¡
                {% else %}
                  ðŸŽ¯
                {% endif %}
              </div>
              <div class="directional-title-section">
                <h5 class="directional-title">{{ record.objective or 'OKR de ãrea' }}</h5>
                <span class="directional-type-badge type-{{ (record.type or '').lower() }}">
                  {{ record.type_display or 'OKR' }}
                </span>
              </div>
            </div>
            <p><strong>ãrea:</strong> {{ record.area|title or 'Nã£o definida' }}</p>
            {% if record.owner %}<p><strong>Responsã¡vel:</strong> {{ record.owner }}</p>{% endif %}
            {% if record.deadline %}<p><strong>Prazo:</strong> {% if record.deadline.strftime is defined %}{{ record.deadline.strftime('%d/%m/%Y') }}{% else %}{{ record.deadline }}{% endif %}</p>{% endif %}
            {% if record.observations %}<p><strong>Observaã§ãµes:</strong> {{ record.observations }}</p>{% endif %}
            {% if record.key_results %}
            <div class="okr-key-results">
              <p><strong>Indicadores:</strong></p>
              <ul class="okr-kr-list">
                {% for kr in record.key_results %}
                <li class="okr-kr-item">
                  <strong>{{ kr.label }}</strong>
                  {% if kr.target %}<span class="kr-meta"> - Meta: {{ kr.target }}</span>{% endif %}
                  {% if kr.deadline %}<span class="kr-meta"> - Prazo: {{ kr.deadline }}</span>{% endif %}
                  {% if kr.owner %}<span class="kr-meta"> - Responsã¡vel: {{ kr.owner }}</span>{% endif %}
                    {% set indicator_key = (kr.indicator_id|string) if kr.indicator_id is not none else '' %}
                    {% set indicator_label = kr.indicator_display or indicator_lookup.get(indicator_key) %}
                    {% if indicator_label %}<span class="kr-meta"> - Indicador: {{ indicator_label }}</span>{% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            <div class="directional-meta">
              {% if record.created_at %}<span class="summary-meta">Criado em: {{ record.created_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>{% endif %}
              {% if record.updated_at and record.updated_at != record.created_at %}
              <span class="summary-meta"> | Atualizado em: {{ record.updated_at.strftime('%d/%m/%Y ã s %H:%M') }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state enhanced">
          <div class="empty-icon">ðŸŽ¯</div>
          <h4>Nenhum OKR de ãrea Consolidado</h4>
          <p>Os OKRs de ã¡rea aparecerã£o aqui apã³s serem aprovados na seã§ã£o anterior.</p>
          <div class="empty-hint">
            <span class="hint-icon">ðŸ’¡</span>
            <span>Complete o processo de aprovaã§ã£o para visualizar os OKRs consolidados.</span>
          </div>
        </div>
        {% endif %}
      </div>
    </details>
  </section>
</div>

<script>
// JavaScript functions for OKR Area sections
function closePreliminaryAnalysisSection() {
    if (confirm('Tem certeza que deseja concluir a anã¡lise preliminar? Esta aã§ã£o nã£o pode ser desfeita.')) {
        fetch('{{ url_for("update_area_preliminary_analysis_section_status", plan_id=plan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'closed',
                conclusion_reason: 'Anã¡lise preliminar concluã­da'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao concluir seã§ã£o: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao concluir seã§ã£o');
        });
    }
}

function openPreliminaryAnalysisSection() {
    fetch('{{ url_for("update_area_preliminary_analysis_section_status", plan_id=plan.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'open'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao reabrir seã§ã£o: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao reabrir seã§ã£o');
    });
}

function closeWorkshopAreaSection() {
    if (confirm('Tem certeza que deseja concluir a versã£o preliminar? Esta aã§ã£o nã£o pode ser desfeita.')) {
        fetch('{{ url_for("update_workshop_area_section_status", plan_id=plan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'closed',
                conclusion_reason: 'Versã£o preliminar concluã­da'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao concluir versã£o preliminar: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao concluir versã£o preliminar');
        });
    }
}

function openWorkshopAreaSection() {
    fetch('{{ url_for("update_workshop_area_section_status", plan_id=plan.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'open'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao reabrir versã£o preliminar: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao reabrir versã£o preliminar');
    });
}

function closeFinalAreaSection() {
    if (confirm('Tem certeza que deseja concluir a versã£o final e aprovaã§ãµes? Esta aã§ã£o nã£o pode ser desfeita.')) {
        fetch('{{ url_for("update_final_area_section_status", plan_id=plan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'closed',
                conclusion_reason: 'Versã£o final e aprovaã§ãµes concluã­das'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao concluir versã£o final e aprovaã§ãµes: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao concluir versã£o final e aprovaã§ãµes');
        });
    }
}

function openFinalAreaSection() {
    fetch('{{ url_for("update_final_area_section_status", plan_id=plan.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'open'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao reabrir versã£o final e aprovaã§ãµes: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao reabrir versã£o final e aprovaã§ãµes');
    });
}

// AI Suggestions functionality
let currentAISuggestions = '';

function generateAISuggestions() {
    const btn = document.getElementById('ai-suggestions-btn');
    const loading = document.getElementById('ai-loading');
    const results = document.getElementById('ai-suggestions-results');
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span>â³ Gerando...</span>';
    loading.style.display = 'block';
    results.style.display = 'none';
    
    // Make API call
    fetch('{{ url_for("generate_ai_area_okr_suggestions", plan_id=plan.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        loading.style.display = 'none';
        
        if (data.success) {
            currentAISuggestions = data.suggestions;
            document.getElementById('ai-suggestions-content').innerHTML = 
                '<div class="ai-suggestion-text">' + data.suggestions.replace(/\n/g, '<br>') + '</div>';
            results.style.display = 'block';
        } else {
            alert('Erro ao gerar sugestãµes: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loading.style.display = 'none';
        alert('Erro ao gerar sugestãµes da IA');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<span>âœ¨ Gerar Sugestãµes da IA</span>';
    });
}

function useAISuggestion() {
    if (currentAISuggestions) {
        document.getElementById('okr-analysis-textarea').value = currentAISuggestions;
        document.getElementById('ai-suggestions-results').style.display = 'none';
    }
}

function regenerateAISuggestions() {
    generateAISuggestions();
}

// Search functionality
function searchOKRs(type, query) {
    const listId = type === 'workshop-area' ? 'workshop-area-okr-list' : 'final-area-okr-list';
    const list = document.getElementById(listId);
    const items = list.querySelectorAll('.okr-workshop-item, .okr-approval-item');
    
    if (!query.trim()) {
        // Show all items
        items.forEach(item => {
            item.style.display = 'block';
        });
        return;
    }
    
    const queryLower = query.toLowerCase();
    items.forEach(item => {
        const objective = item.querySelector('h5').textContent.toLowerCase();
        const owner = item.querySelector('p') ? item.querySelector('p').textContent.toLowerCase() : '';
        const observations = item.querySelectorAll('p')[1] ? item.querySelectorAll('p')[1].textContent.toLowerCase() : '';
        
        if (objective.includes(queryLower) || owner.includes(queryLower) || observations.includes(queryLower)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearSearch(type) {
    const searchInput = document.getElementById(`${type}-search`);
    searchInput.value = '';
    searchOKRs(type, '');
}

// Edit OKR functionality
let currentEditType = '';
let currentEditId = '';
let editManager = null;

function editOKR(type, id) {
    currentEditType = type;
    currentEditId = id;
    
    // Fetch OKR data
    fetch(`/plans/{{ plan.id }}/get-area-okr-data-v2/${type}/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateEditModal(data.okr);
                showEditModal();
            } else {
                alert('Erro ao carregar dados do OKR: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar dados do OKR');
        });
}

function populateEditModal(okr) {
    document.getElementById('edit-okr-global-ref').value = okr.global_ref || '';
    document.getElementById('edit-okr-objective').value = okr.objective || '';
    document.getElementById('edit-okr-type').value = okr.type || '';
    document.getElementById('edit-okr-area').value = okr.area || '';
    const ownerHidden = document.getElementById('edit-okr-owner');
    if (ownerHidden) {
        ownerHidden.value = okr.owner || '';
    }
    const ownerSelect = document.getElementById('edit-okr-owner-select');
    if (ownerSelect) {
        ownerSelect.value = okr.owner_id ? String(okr.owner_id) : '';
        ownerSelect.dispatchEvent(new Event('change'));
        if (!ownerSelect.value && ownerHidden && okr.owner) {
            ownerHidden.value = okr.owner;
        }
    }
    document.getElementById('edit-okr-deadline').value = okr.deadline || '';
    document.getElementById('edit-okr-observations').value = okr.observations || '';
    
    // Set form action
    const form = document.getElementById('edit-area-okr-form');
    form.action = `/plans/{{ plan.id }}/edit-area-okr-record/${currentEditId}`;
    
    // Clear and populate Indicadores
    const editContainer = document.getElementById('edit-area-kr-container');
    const editList = document.getElementById('edit-area-kr-list');
    editList.innerHTML = '';
    
    // Initialize edit manager if not exists
    if (!editManager) {
        editManager = new KeyResultsManager('edit-area-kr-container', {
            minResults: 0,
            maxResults: 10,
            required: false
        });
        // Store globally for consistency
        window.keyResultsManager_edit_area_kr_container = editManager;
    }
    
    // Add existing Indicadores
    if (okr.key_results && okr.key_results.length > 0) {
        editManager.setKeyResults(okr.key_results);
    } else {
        // Add one empty Indicador
        editManager.addKeyResult();
    }
}

function showEditModal() {
    document.getElementById('edit-area-okr-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeEditModal() {
    document.getElementById('edit-area-okr-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function duplicateOKR(type, id) {
    if (confirm('Deseja duplicar este OKR?')) {
        fetch(`/plans/{{ plan.id }}/duplicate-area-okr-record/${type}/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao duplicar OKR: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao duplicar OKR');
        });
    }
}

function deleteAreaWorkshopDiscussions() {
    if (confirm('Tem certeza que deseja excluir as discussãµes do workshop de ã¡rea? Esta aã§ã£o nã£o pode ser desfeita.')) {
        fetch('{{ url_for("delete_area_workshop_discussions", plan_id=plan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao excluir discussãµes');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao excluir discussãµes');
        });
    }
}

function deleteFinalAreaDiscussions() {
    if (confirm('Tem certeza que deseja excluir as discussãµes da versã£o final de ã¡rea? Esta aã§ã£o nã£o pode ser desfeita.')) {
        fetch('{{ url_for("delete_final_area_discussions", plan_id=plan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erro ao excluir discussãµes');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao excluir discussãµes');
        });
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('edit-area-okr-modal');
    if (event.target === modal) {
        closeEditModal();
    }
}

</script>

<!-- Edit Area OKR Modal -->
<div id="edit-area-okr-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="edit-modal-title">Editar OKR de ãrea</h3>
      <span class="close" onclick="closeEditModal()">&times;</span>
    </div>
    <form id="edit-area-okr-form" method="post">
      <div class="modal-body">
        <div class="form-field">
          <span>OKR Global Base</span>
          <select id="edit-okr-global-ref" name="okr_global_ref" required>
            <option value="">Selecione o OKR Global</option>
            {% for okr in global_okrs %}
            <option value="{{ okr.id }}">{{ okr.objective or 'OKR Global' }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <span>Objetivo do OKR de ãrea</span>
          <input type="text" id="edit-okr-objective" name="okr_objective" placeholder="Objetivo do OKR de ã¡rea..." required />
        </div>
        <div class="form-two-cols">
          <div class="form-field">
            <span>Tipo</span>
            <select id="edit-okr-type" name="okr_type" required>
              <option value="">Selecione o tipo</option>
              <option value="estruturante">Estruturante</option>
              <option value="aceleracao">Aceleraã§ã£o</option>
            </select>
          </div>
          <div class="form-field">
            <span>ãrea</span>
            <select id="edit-okr-area" name="okr_area" required>
              <option value="">Selecione a ã¡rea</option>
              <option value="comercial">Comercial</option>
              <option value="operacional">Operacional</option>
              <option value="administrativo">Administrativo</option>
            </select>
          </div>
        </div>
        <div class="form-two-cols">
          <div class="form-field">
            <span>Responsã¡vel</span>
            <select id="edit-okr-owner-select" name="okr_owner_id" data-owner-target="edit-okr-owner">
              <option value="">Selecione o responsã¡vel</option>
              {% for participant in participants_options %}
              <option value="{{ participant.id }}" data-name="{{ participant.name }}">{{ participant.label }}</option>
              {% endfor %}
            </select>
            <input type="hidden" id="edit-okr-owner" name="okr_owner" value="">
          </div>
          <div class="form-field">
            <span>Prazo</span>
            <input type="date" id="edit-okr-deadline" name="okr_deadline" />
          </div>
        </div>
        <div class="form-field">
          <span>Observaã§ãµes</span>
          <textarea id="edit-okr-observations" name="okr_observations" placeholder="Observaã§ãµes adicionais..." rows="3"></textarea>
        </div>
        
        <div class="okr-kpi-grid" id="edit-area-kr-container" data-participants="{{ participants_options|tojson|safe }}" data-indicators="{{ indicators|tojson|safe }}">
          <div class="okr-kpi-header">
            <button type="button" class="button button-small button-success" onclick="openIndicatorFormFromOKR('edit-area-kr-container', '{{ plan.id }}', 'okr-area')" title="Criar indicador completo no formulário">
              <span>📊 Incluir Indicador</span>
            </button>
          </div>
          <div class="key-results-list" id="edit-area-kr-list">
            <!-- Indicadores will be added dynamically here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="button button-secondary" onclick="closeEditModal()">Cancelar</button>
        <button type="submit" class="button button-primary">Salvar Alteraã§ãµes</button>
      </div>
    </form>
  </div>
</div>

<!-- Indicadores Management Script -->
<script src="{{ url_for('static', filename='js/key-results.js') }}"></script>

<script>
// Function to open indicator form with OKR context
function openIndicatorFormFromOKR(containerType, planId, pageType) {
    try {
        console.log('openIndicatorFormFromOKR called:', {containerType, planId, pageType});
        
        // Get company_id from the current URL or context
        const companyId = {{ plan.company_id if plan and plan.company_id else 'null' }};
        console.log('Company ID:', companyId);
        
        if (!companyId) {
            alert('Empresa não identificada. Por favor, recarregue a página.');
            return;
        }
        
        // Check if we're in an edit context with a saved OKR
        const hasOkrId = (typeof currentEditId !== 'undefined') && currentEditId && currentEditId > 0;
        console.log('Has OKR ID:', hasOkrId, 'currentEditId:', typeof currentEditId !== 'undefined' ? currentEditId : 'undefined');
        
        // If we don't have an OKR ID, we need to save first
        if (!hasOkrId) {
            console.log('No OKR ID, showing save modal');
            showSaveOkrBeforeIndicatorModal(containerType, planId, pageType, companyId);
            return;
        }
        
        // Build URL with context parameters
        const params = new URLSearchParams({
            plan_id: planId,
            page_type: pageType,
            okr_id: currentEditId,
            okr_level: 'area'
        });
        
        const url = `/grv/company/${companyId}/indicators/form?${params.toString()}`;
        console.log('Opening indicator form:', url);
        
        // Open in a new window
        const width = 800;
        const height = 900;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        window.open(
            url,
            'indicatorForm',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );
    } catch (error) {
        console.error('Error in openIndicatorFormFromOKR:', error);
        alert('Erro ao abrir formulário de indicadores: ' + error.message);
    }
}

// Show modal asking to save OKR before creating indicator
function showSaveOkrBeforeIndicatorModal(containerType, planId, pageType, companyId) {
    try {
        console.log('showSaveOkrBeforeIndicatorModal called');
        
        const modalHtml = `
            <div id="save-okr-before-indicator-modal" class="modal" style="display: block;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>&#9888;&#65039; Salvar OKR Primeiro</h3>
                    </div>
                    <div class="modal-body">
                        <p style="margin: 16px 0; line-height: 1.6;">
                            Para adicionar ou associar um indicador, é necessário salvar o OKR primeiro.
                        </p>
                        <p style="margin: 16px 0; line-height: 1.6; color: #64748b; font-size: 14px;">
                            O sistema irá validar os campos obrigatórios, salvar o OKR e então abrir o formulário de indicadores com o Planejamento e OKR já preenchidos.
                        </p>
                    </div>
                    <div class="modal-footer" style="justify-content: center; gap: 12px;">
                        <button type="button" class="button button-secondary" onclick="closeSaveOkrModal()">Cancelar</button>
                        <button type="button" class="button button-primary" onclick="saveOkrAndOpenIndicatorForm('${containerType}', '${planId}', '${pageType}', ${companyId})">&#128190; Salvar e Continuar</button>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('save-okr-before-indicator-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.body.style.overflow = 'hidden';
        console.log('Modal added successfully');
    } catch (error) {
        console.error('Error in showSaveOkrBeforeIndicatorModal:', error);
        alert('Erro ao mostrar modal: ' + error.message);
    }
}

function closeSaveOkrModal() {
    const modal = document.getElementById('save-okr-before-indicator-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }
}

async function saveOkrAndOpenIndicatorForm(containerType, planId, pageType, companyId) {
    // Determine which form we're working with
    let form;
    let okrType;
    
    if (containerType === 'area-kr-container') {
        form = document.querySelector('.okr-workshop-form');
        okrType = 'workshop';
    } else if (containerType === 'final-area-kr-container') {
        form = document.querySelector('.okr-approval-form');
        okrType = 'approval';
    } else if (containerType === 'edit-area-kr-container') {
        form = document.getElementById('edit-okr-form');
        okrType = typeof currentEditType !== 'undefined' ? currentEditType : 'workshop';
    }
    
    if (!form) {
        alert('Formulário não encontrado. Por favor, recarregue a página.');
        closeSaveOkrModal();
        return;
    }
    
    // Validate required fields
    const objective = form.querySelector('[name="okr_objective"]')?.value?.trim();
    const type = form.querySelector('[name="okr_type"]')?.value;
    const department = form.querySelector('[name="okr_department"]')?.value;
    const globalOkr = form.querySelector('[name="okr_global_ref"]')?.value;
    
    const missingFields = [];
    if (!objective) missingFields.push('Objetivo do OKR');
    if (!type) missingFields.push('Tipo');
    if (!department) missingFields.push('Área/Departamento');
    if (!globalOkr) missingFields.push('OKR Global Base');
    
    if (missingFields.length > 0) {
        alert(`⚠️ Por favor, preencha os seguintes campos obrigatórios antes de continuar:\n\n• ${missingFields.join('\n• ')}`);
        closeSaveOkrModal();
        return;
    }
    
    // Show loading state
    const saveButton = document.querySelector('#save-okr-before-indicator-modal .button-primary');
    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '⏳ Salvando...';
    }
    
    try {
        // Create FormData from the form
        const formData = new FormData(form);
        
        // Save intent to open indicator form after reload
        sessionStorage.setItem('openIndicatorFormAfterSave', JSON.stringify({
            planId: planId,
            pageType: pageType,
            companyId: companyId,
            okrObjective: objective,
            timestamp: Date.now()
        }));
        
        // Submit the form via fetch to get the response
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Erro ao salvar OKR');
        }
        
        // Close the modal
        closeSaveOkrModal();
        
        // Reload the page - the intent will be picked up on page load
        window.location.reload();
        
    } catch (error) {
        console.error('Error saving OKR:', error);
        alert('❌ Erro ao salvar o OKR. Por favor, tente novamente.');
        sessionStorage.removeItem('openIndicatorFormAfterSave');
        closeSaveOkrModal();
    }
}

// Check on page load if we should open indicator form
document.addEventListener('DOMContentLoaded', function() {
    const intent = sessionStorage.getItem('openIndicatorFormAfterSave');
    
    if (intent) {
        try {
            const data = JSON.parse(intent);
            
            // Check if intent is recent (within last 10 seconds)
            if (Date.now() - data.timestamp < 10000) {
                // Clear the intent
                sessionStorage.removeItem('openIndicatorFormAfterSave');
                
                // Find the most recently created OKR with matching objective
                const okrItems = document.querySelectorAll('.okr-workshop-item, .okr-approval-item');
                
                let foundOkrId = null;
                for (const item of okrItems) {
                    const objectiveElement = item.querySelector('h5');
                    if (objectiveElement && objectiveElement.textContent.includes(data.okrObjective)) {
                        // Try to extract OKR ID from the edit button
                        const editButton = item.querySelector('[onclick*="editOKR"]');
                        if (editButton) {
                            const onclickAttr = editButton.getAttribute('onclick');
                            const match = onclickAttr.match(/editOKR\('(\w+)',\s*(\d+)\)/);
                            if (match) {
                                foundOkrId = match[2];
                                break;
                            }
                        }
                        break;
                    }
                }
                
                if (foundOkrId) {
                    // Build URL with OKR ID
                    const params = new URLSearchParams({
                        plan_id: data.planId,
                        page_type: data.pageType,
                        okr_id: foundOkrId,
                        okr_level: 'area'
                    });
                    
                    const url = `/grv/company/${data.companyId}/indicators/form?${params.toString()}`;
                    
                    // Show success message and open form
                    setTimeout(() => {
                        alert('✅ OKR salvo com sucesso! Abrindo formulário de indicadores...');
                        
                        const width = 800;
                        const height = 900;
                        const left = (screen.width - width) / 2;
                        const top = (screen.height - height) / 2;
                        
                        window.open(
                            url,
                            'indicatorForm',
                            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                        );
                    }, 500);
                } else {
                    // If we couldn't find the OKR ID, just show success message
                    alert('✅ OKR salvo com sucesso! Para adicionar indicadores, edite o OKR e clique no botão verde "📊 Novo Indicador Completo".');
                }
            } else {
                // Intent expired, remove it
                sessionStorage.removeItem('openIndicatorFormAfterSave');
            }
        } catch (error) {
            console.error('Error processing indicator form intent:', error);
            sessionStorage.removeItem('openIndicatorFormAfterSave');
        }
    }
});
</script>

{% endblock %}
