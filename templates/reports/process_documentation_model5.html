<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book do Processo - {{ process.code or 'PROCESSO' }} - {{ process.name }}</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <style>
    @page {
      size: A4;
      margin: 5mm 5mm 5mm 5mm; /* Margens do modelo ID.5 */
    }

    @page {
      @top-center {
        content: element(report-header);
      }
      @bottom-center {
        content: element(report-footer);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 10pt;
      line-height: 1.6;
      color: #333;
      background: #fff;
      padding-top: 35mm; /* Espa√ßo para cabe√ßalho */
      padding-bottom: 20mm; /* Espa√ßo para rodap√© */
    }

    /* Cabe√ßalho - Modelo ID.5: 4 linhas x 3 colunas */
    .report-header {
      position: running(report-header);
      border: 2px solid #333;
      padding: 8px;
      margin: 0;
      background: #fff;
      height: 30mm;
      box-sizing: border-box;
      display: grid;
      grid-template-rows: auto auto auto auto; /* 4 linhas */
      grid-template-columns: 1fr; /* Para primeira linha que ocupa todas as colunas */
      gap: 3px;
    }

    /* Primeira linha: ocupa todas as 3 colunas */
    .header-row-1 {
      grid-column: 1 / -1;
      font-size: 12pt;
      font-weight: bold;
      color: #333;
      text-align: center;
      padding: 4px 0;
      border-bottom: 1px solid #ddd;
    }

    /* Linhas 2-4: divididas em 3 colunas */
    .header-grid {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 80px 1fr 1fr; /* Primeira coluna menor para logo */
      grid-template-rows: repeat(3, 1fr);
      gap: 6px;
      height: 100%;
    }

    /* Logo na primeira coluna ocupando 3 linhas */
    .header-logo {
      grid-column: 1;
      grid-row: 1 / 4;
      border: 1px solid #ccc;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8pt;
      color: #999;
      background: #f9f9f9;
      text-align: center;
    }

    .header-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Segunda linha: Empresa (colunas 2-3) */
    .header-empresa {
      grid-column: 2 / 4;
      grid-row: 1;
      display: flex;
      align-items: center;
      font-size: 9pt;
      padding: 2px 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .header-empresa strong {
      color: #495057;
      margin-right: 8px;
    }

    /* Terceira linha: Macroprocesso (colunas 2-3) */
    .header-macro {
      grid-column: 2 / 4;
      grid-row: 2;
      display: flex;
      align-items: center;
      font-size: 9pt;
      padding: 2px 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .header-macro strong {
      color: #495057;
      margin-right: 8px;
    }

    /* Quarta linha: Dono do Processo (colunas 2-3) */
    .header-dono {
      grid-column: 2 / 4;
      grid-row: 3;
      display: flex;
      align-items: center;
      font-size: 9pt;
      padding: 2px 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .header-dono strong {
      color: #495057;
      margin-right: 8px;
    }

    /* Rodap√© - Modelo ID.5: 1 linha x 2 colunas */
    .report-footer {
      position: running(report-footer);
      height: 15mm;
      border-top: 1px solid #333;
      font-size: 9pt;
      color: #666;
      background: #fff;
      display: grid;
      grid-template-columns: 1fr 1fr; /* 2 colunas */
      align-items: center;
      padding: 6px 12px;
      gap: 20px;
    }

    .footer-col-1 {
      text-align: left;
      font-weight: 600;
      color: #333;
    }

    .footer-col-2 {
      text-align: right;
      font-size: 8pt;
      color: #666;
    }

    /* Conte√∫do principal */
    .report-content {
      margin-top: 0;
    }

    /* Section Title */
    .section-title {
      font-size: 11pt;
      font-weight: 600;
      color: #444;
      margin: 20px 0 15px 0;
      padding-bottom: 6px;
      border-bottom: 1px solid #ccc;
      page-break-after: avoid;
      page-break-inside: avoid;
    }

    .section-title:first-of-type {
      margin-top: 0;
    }

    /* Flow Container */
    .flow-container {
      margin: 15px 0 20px 0;
      page-break-inside: avoid;
    }

    .flow-content {
      padding: 12px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .flow-content img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
    }

    .flow-content iframe {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      display: block;
    }

    /* Activity Block */
    .activity-block {
      margin-bottom: 25px;
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .activity-block:first-of-type {
      margin-top: 0;
    }

    .activity-block:last-of-type {
      margin-bottom: 20px;
    }

    .activity-header {
      background: #f5f5f5;
      padding: 8px 16px;
      border-left: 4px solid #666;
      border-bottom: 1px solid #ddd;
    }

    .activity-code {
      font-size: 9pt;
      font-weight: 600;
      color: #666;
      font-family: 'Courier New', monospace;
    }

    .activity-name {
      font-size: 11pt;
      font-weight: 600;
      color: #000;
      margin-top: 3px;
    }

    /* Step */
    .step {
      padding: 12px 16px;
      background: #fafafa;
      border-bottom: 1px solid #e5e5e5;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .step:last-of-type {
      border-bottom: none;
    }

    .step-header {
      font-weight: 600;
      font-size: 9pt;
      color: #777;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #e5e5e5;
    }

    .step-content {
      display: grid;
      gap: 15px;
      align-items: start;
    }
    
    /* Layout dual: lado a lado com largura customizada */
    .step-content[style*="grid-template-columns"] {
      display: grid;
      gap: 15px;
      align-items: start;
    }

    .step-content.no-image {
      grid-template-columns: 1fr;
    }

    .step-image {
      background: #fff;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
      text-align: center;
      height: fit-content;
    }

    .step-image img {
      max-width: 100%;
      height: auto;
      max-height: 350px;
      object-fit: contain;
      display: block;
      width: 100%;
    }

    .step-text {
      font-size: 9.5pt;
      line-height: 1.7;
      color: #333;
      text-align: justify;
      min-width: 0;
    }

    /* Indicators Table */
    .indicators-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 9pt;
    }

    .indicators-table th,
    .indicators-table td {
      border: 1px solid #ddd;
      padding: 10px 12px;
      text-align: left;
    }

    .indicators-table th {
      background: #f0f0f0;
      font-weight: 600;
      color: #333;
    }

    /* Routine Items */
    .routine-item {
      background: #fafafa;
      border-left: 4px solid #888;
      padding: 15px 18px;
      margin-bottom: 15px;
    }

    .routine-item .title {
      font-weight: 600;
      font-size: 11pt;
      color: #333;
      margin-bottom: 6px;
    }

    .routine-item .meta {
      font-size: 9pt;
      color: #666;
      margin-bottom: 10px;
    }

    .routine-item .description {
      font-size: 9.5pt;
      line-height: 1.6;
      color: #555;
    }

    /* Routine Schedules */
    .routine-schedules {
      margin: 20px 0;
    }

    .routine-schedule-item {
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .routine-schedule-item:last-child {
      margin-bottom: 0;
    }

    .schedule-trigger, .schedule-deadline {
      font-size: 9pt;
    }

    .schedule-trigger strong {
      color: #2563eb;
      font-weight: 600;
    }

    .schedule-deadline strong {
      color: #059669;
      font-weight: 600;
    }

    .routine-empty {
      text-align: center;
      padding: 25px;
      color: #999;
      font-style: italic;
      background: #f9f9f9;
      border: 1px dashed #ddd;
      border-radius: 6px;
    }

    /* Utilities */
    .text-muted {
      color: #999;
    }

    /* Print adjustments */
    @media print {
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
        margin: 0;
        padding-top: 35mm;
        padding-bottom: 20mm;
      }
      
      .flow-content iframe {
        height: 500px;
      }

      .step {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        orphans: 3;
        widows: 3;
      }
      
      .activity-block {
        page-break-inside: auto;
        break-inside: auto;
      }
      
      .step-content {
        page-break-inside: avoid;
        break-inside: avoid;
      }
    }
  </style>
</head>
<body data-process-code="{{ process.code or '' }}" data-process-name="{{ process.name or '' }}">
  <!-- Cabe√ßalho: 4 linhas x 3 colunas -->
  <div class="report-header">
    <!-- Primeira linha: Book do Processo (3 colunas) -->
    <div class="header-row-1">
      Book do Processo: {{ process.code or '' }}{% if process.code %} - {% endif %}{{ process.name }}
    </div>
    
    <!-- Linhas 2-4: Grade 3 colunas -->
    <div class="header-grid">
      <!-- Logo (primeira coluna, 3 linhas) -->
      <div class="header-logo">
        {% if company and company.logo %}
        <img src="{{ request.url_root.rstrip('/') }}/uploads/{{ company.logo }}" alt="Logo {{ company.name }}" />
        {% else %}
        LOGO<br>DA<br>EMPRESA
        {% endif %}
      </div>
      
      <!-- Segunda linha: Empresa (colunas 2-3) -->
      <div class="header-empresa">
        <strong>Empresa:</strong>
        <span>{{ company.name if company else 'N/A' }}</span>
      </div>
      
      <!-- Terceira linha: Macroprocesso (colunas 2-3) -->
      <div class="header-macro">
        <strong>Macroprocesso:</strong>
        <span>{{ macro.code if macro else 'N/A' }}{% if macro and macro.name %} - {{ macro.name }}{% endif %}</span>
      </div>
      
      <!-- Quarta linha: Dono do Processo (colunas 2-3) -->
      <div class="header-dono">
        <strong>Dono do Processo:</strong>
        <span>{{ macro.owner if macro and macro.owner else 'N√£o definido' }}</span>
      </div>
    </div>
  </div>

  <!-- Conte√∫do principal -->
  <main class="report-content">
  
  <!-- Flow Section -->
  {% if 'flow' in sections and process.flow_document %}
  <h2 class="section-title">Fluxo do Processo</h2>
  <div class="flow-container">
    <div class="flow-content">
      {% set flow_path = process.flow_document %}
      {% set filename = flow_path.replace('\\', '/').split('/')[-1] %}
      {% set flow_ext = filename.split('.')[-1].lower() if '.' in filename else '' %}
      
      {% if flow_ext in ['png', 'jpg', 'jpeg', 'svg', 'webp', 'gif'] %}
      <img src="{{ request.url_root.rstrip('/') }}/uploads/{{ flow_path }}" alt="Fluxo do Processo" />
      {% elif flow_ext == 'pdf' %}
      <iframe src="{{ request.url_root.rstrip('/') }}/uploads/{{ flow_path }}#toolbar=0&navpanes=0&scrollbar=0&view=FitH"></iframe>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- POP Activities -->
  {% if 'pop' in sections %}
  <h2 class="section-title">Atividades e Procedimentos</h2>

  {% if activities and activities|length > 0 %}
    {% for activity in activities %}
    <div class="activity-block">
      <div class="activity-header">
        <div class="activity-code">{{ activity.code or 'SEM C√ìDIGO' }}</div>
        <div class="activity-name">{{ activity.name }}</div>
      </div>

      {% if activity.entries and activity.entries|length > 0 %}
        {% for entry in activity.entries %}
        <div class="step">
          <div class="step-header">Passo {{ loop.index }}</div>
          {% if entry.image_url and entry.layout == 'dual' %}
          {% set img_width = entry.image_width or 280 %}
          <div class="step-content" style="grid-template-columns: {{ img_width }}px 1fr;">
            <div class="step-image">
              <img src="{{ entry.image_url }}" alt="Passo {{ loop.index }}" onerror="console.error('Erro ao carregar imagem:', this.src); this.parentElement.innerHTML='<p style=\'color:#999;font-size:8pt;\'>Imagem n√£o dispon√≠vel</p>';" />
            </div>
            <div class="step-text">
              {{ entry.text_content or 'Sem descri√ß√£o' }}
            </div>
          </div>
          {% else %}
          <div class="step-content no-image">
            {% if entry.image_url %}
            <div class="step-image" style="max-width: 450px; margin: 0 auto 12px;">
              <img src="{{ entry.image_url }}" alt="Passo {{ loop.index }}" onerror="console.error('Erro ao carregar imagem:', this.src); this.parentElement.innerHTML='<p style=\'color:#999;font-size:8pt;\'>Imagem n√£o dispon√≠vel<br>URL: {{ entry.image_url }}</p>';" />
            </div>
            {% endif %}
            <div class="step-text">
              {{ entry.text_content or 'Sem descri√ß√£o' }}
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% endif %}
    </div>
    {% endfor %}
  {% else %}
  <p class="text-muted" style="text-align: center; padding: 25px;">Nenhuma atividade cadastrada no POP.</p>
  {% endif %}
  {% endif %}

  <!-- Indicators Section -->
  {% if 'indicators' in sections %}
  <h2 class="section-title">Indicadores do Processo</h2>
  
  <table class="indicators-table">
    <thead>
      <tr>
        <th style="width: 30%;">Indicador</th>
        <th style="width: 20%;">Meta</th>
        <th style="width: 25%;">Respons√°vel</th>
        <th style="width: 25%;">Periodicidade</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>SLA de atendimento</td>
        <td>95% em at√© 24h</td>
        <td>{{ macro.owner if macro and macro.owner else 'Equipe' }}</td>
        <td>Semanal</td>
      </tr>
      <tr>
        <td>Taxa de retrabalho</td>
        <td>&lt; 3%</td>
        <td>Qualidade</td>
        <td>Mensal</td>
      </tr>
    </tbody>
  </table>
  {% endif %}

  <!-- Routine Section -->
  {% if 'routine' in sections %}
  <h2 class="section-title">üìÖ Rotinas e Colaboradores</h2>

  {% if routines_with_collaborators %}
  <div class="routine-schedules">
    {% for routine in routines_with_collaborators %}
    <div class="routine-schedule-item" style="page-break-inside: avoid; margin-bottom: 25px; border: 1px solid #ddd; padding: 18px; border-radius: 10px;">
      <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
        <h3 style="font-size: 12pt; font-weight: bold; color: #1e3a8a; margin-bottom: 5px;">{{ routine.name }}</h3>
        {% if routine.description %}
        <p style="font-size: 9.5pt; color: #666; margin-top: 5px;">{{ routine.description }}</p>
        {% endif %}
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 9.5pt;">
        <div>
          <strong style="color: #4b5563;">Agendamento:</strong><br>
          <span style="color: #1e40af;">
            {% if routine.schedule_type == 'daily' %}Di√°rio
            {% elif routine.schedule_type == 'weekly' %}Semanal
            {% elif routine.schedule_type == 'monthly' %}Mensal
            {% elif routine.schedule_type == 'quarterly' %}Trimestral
            {% elif routine.schedule_type == 'yearly' %}Anual
            {% elif routine.schedule_type == 'specific' %}Data Espec√≠fica
            {% else %}{{ routine.schedule_type }}
            {% endif %}
          </span>
          {% if routine.schedule_value %}
          <br><span style="color: #6b7280; font-size: 8.5pt;">{{ routine.schedule_value }}</span>
          {% endif %}
        </div>
        
        <div>
          <strong style="color: #4b5563;">Prazo:</strong><br>
          {% if routine.deadline_days or routine.deadline_hours %}
            <span style="color: #92400e;">
              {% if routine.deadline_days %}{{ routine.deadline_days }} dias{% endif %}
              {% if routine.deadline_days and routine.deadline_hours %} + {% endif %}
              {% if routine.deadline_hours %}{{ routine.deadline_hours }}h{% endif %}
            </span>
          {% else %}
            <span style="color: #9ca3af;">N√£o definido</span>
          {% endif %}
        </div>
        
        <div>
          <strong style="color: #4b5563;">Total de Horas:</strong><br>
          <span style="color: #1e40af; font-weight: bold;">{{ routine.total_hours or 0 }}h</span>
        </div>
      </div>
      
      {% if routine.collaborators %}
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <strong style="font-size: 10.5pt; color: #374151; display: block; margin-bottom: 10px;">üë• Colaboradores ({{ routine.collaborators|length }})</strong>
        <table style="width: 100%; border-collapse: collapse; font-size: 9.5pt;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 8px; text-align: left; border: 1px solid #d1d5db; font-weight: 600;">Colaborador</th>
              <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600; width: 100px;">Horas √öteis</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #d1d5db; font-weight: 600;">Observa√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for collab in routine.collaborators %}
            <tr>
              <td style="padding: 8px; border: 1px solid #d1d5db;">
                <strong>{{ collab.employee_name }}</strong>
                {% if collab.employee_email %}
                <br><span style="font-size: 8.5pt; color: #6b7280;">{{ collab.employee_email }}</span>
                {% endif %}
              </td>
              <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">
                <strong style="color: #1e40af;">{{ collab.hours_used }}h</strong>
              </td>
              <td style="padding: 8px; border: 1px solid #d1d5db; color: #4b5563;">
                {{ collab.notes or '-' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; text-align: center; font-size: 9.5pt; color: #9ca3af;">
        Nenhum colaborador vinculado a esta rotina
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="routine-empty">
    <p>Nenhuma rotina cadastrada para este processo.</p>
  </div>
  {% endif %}
  {% endif %}
  </main>

  <!-- Rodap√©: 1 linha x 2 colunas -->
  <footer class="report-footer">
    <div class="footer-col-1">
      Sistema de Gest√£o Versus
    </div>
    <div class="footer-col-2">
      Vers√£o: 1.0 | P√°gina <span id="current-page">XX</span> de <span id="total-pages">XX</span> | emitido em {{ print_date }}
    </div>
  </footer>

  <script>
    // Script para pagina√ß√£o no rodap√©
    (function() {
      'use strict';
      
      function formatPageNumber(num) {
        return num.toString().padStart(2, '0');
      }
      
      function getCurrentPage() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const pageHeight = window.innerHeight;
        return Math.max(1, Math.floor(scrollTop / pageHeight) + 1);
      }
      
      function getTotalPages() {
        const pageHeight = window.innerHeight;
        const documentHeight = document.body.scrollHeight;
        return Math.max(1, Math.ceil(documentHeight / pageHeight));
      }
      
      function updateFooterPagination() {
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        
        if (!currentPageEl || !totalPagesEl) return;
        
        const currentPage = getCurrentPage();
        const totalPages = getTotalPages();
        
        currentPageEl.textContent = formatPageNumber(currentPage);
        totalPagesEl.textContent = formatPageNumber(totalPages);
      }
      
      // Inicializar pagina√ß√£o no rodap√©
      window.addEventListener('load', function() {
        updateFooterPagination();
      });
      
      // Atualizar pagina√ß√£o no scroll
      window.addEventListener('scroll', updateFooterPagination);
      
      // Atualizar pagina√ß√£o no resize
      window.addEventListener('resize', updateFooterPagination);
    })();
  </script>

</body>
</html>
