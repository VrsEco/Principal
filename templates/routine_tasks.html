{% extends "base.html" %}
{% block title %}Tarefas da Rotina{% endblock %}
{% block body %}
  {% set active_nav = 'dashboard' %}
  {{ super() }}
{% endblock %}

{% block extra_head %}
  {{ super() }}
  <style>
    .tasks-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 0 64px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 24px;
      flex-wrap: wrap;
    }
    
    .tasks-heading h1 {
      margin: 0;
    }
    
    .tasks-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      padding: 20px;
      border-radius: 12px;
      background: var(--color-surface, #fff);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-sm);
    }
    
    .stat-card-label {
      font-size: 13px;
      color: var(--color-muted);
      margin-bottom: 8px;
    }
    
    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-text);
    }
    
    .stat-card.overdue .stat-card-value {
      color: #ef4444;
    }
    
    .stat-card.upcoming .stat-card-value {
      color: #f59e0b;
    }
    
    .stat-card.completed .stat-card-value {
      color: var(--color-accent);
    }
    
    .tasks-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .filter-button {
      padding: 10px 20px;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      background: var(--color-surface);
      color: var(--color-text);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-button:hover {
      border-color: var(--color-accent);
      background: rgba(58, 241, 174, 0.05);
    }
    
    .filter-button.active {
      border-color: var(--color-accent);
      background: rgba(58, 241, 174, 0.1);
      color: var(--color-accent);
    }
    
    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .task-item {
      padding: 20px;
      border-radius: 12px;
      background: var(--color-surface, #fff);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-sm);
      display: flex;
      gap: 16px;
      align-items: flex-start;
      transition: all 0.2s;
    }
    
    .task-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }
    
    .task-item.overdue {
      border-left: 4px solid #ef4444;
    }
    
    .task-item.in_progress {
      border-left: 4px solid #f59e0b;
    }
    
    .task-item.completed {
      border-left: 4px solid var(--color-accent);
      opacity: 0.7;
    }
    
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .task-checkbox.checked {
      background: var(--color-accent);
      border-color: var(--color-accent);
      position: relative;
    }
    
    .task-checkbox.checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--color-bg);
      font-weight: bold;
    }
    
    .task-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .task-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0;
    }
    
    .task-description {
      font-size: 14px;
      color: var(--color-muted);
      margin: 0;
    }
    
    .task-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--color-muted);
    }
    
    .task-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .task-deadline {
      color: var(--color-text);
      font-weight: 500;
    }
    
    .task-deadline.overdue {
      color: #ef4444;
      font-weight: 600;
    }
    
    .task-deadline.soon {
      color: #f59e0b;
      font-weight: 600;
    }
    
    .task-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-badge.pending {
      background: rgba(156, 163, 175, 0.2);
      color: #6b7280;
    }
    
    .status-badge.in_progress {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }
    
    .status-badge.completed {
      background: rgba(58, 241, 174, 0.2);
      color: var(--color-accent);
    }
    
    .status-badge.overdue {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    .empty-tasks {
      padding: 72px 24px;
      text-align: center;
      border: 1px dashed var(--color-border);
      border-radius: 16px;
      background: var(--color-surface);
    }
  </style>
{% endblock %}

{% block content %}
<section class="tasks-page">
  <header class="tasks-header">
    <div class="tasks-heading">
      <span class="section-eyebrow">Gest√£o da Rotina</span>
      <h1>Tarefas - {{ company.name }}</h1>
      <p>Acompanhe e gerencie todas as tarefas geradas pelas rotinas autom√°ticas.</p>
    </div>
    <a href="/companies/{{ company.id }}/routines" class="button button-ghost">Gerenciar Rotinas</a>
  </header>

  <div class="tasks-stats">
    <div class="stat-card overdue">
      <div class="stat-card-label">Atrasadas</div>
      <div class="stat-card-value" id="overdueCount">0</div>
    </div>
    <div class="stat-card upcoming">
      <div class="stat-card-label">Em Andamento</div>
      <div class="stat-card-value" id="inProgressCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label">Pendentes</div>
      <div class="stat-card-value" id="pendingCount">0</div>
    </div>
    <div class="stat-card completed">
      <div class="stat-card-label">Conclu√≠das</div>
      <div class="stat-card-value" id="completedCount">0</div>
    </div>
  </div>

  <div class="tasks-filter">
    <button class="filter-button active" data-filter="all" onclick="filterTasks('all')">Todas</button>
    <button class="filter-button" data-filter="overdue" onclick="filterTasks('overdue')">Atrasadas</button>
    <button class="filter-button" data-filter="in_progress" onclick="filterTasks('in_progress')">Em Andamento</button>
    <button class="filter-button" data-filter="pending" onclick="filterTasks('pending')">Pendentes</button>
    <button class="filter-button" data-filter="completed" onclick="filterTasks('completed')">Conclu√≠das</button>
  </div>

  <div id="tasksContainer" class="tasks-list">
    <!-- Tarefas ser√£o carregadas aqui -->
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const companyId = {{ company.id }};
  let allTasks = [];
  let currentFilter = 'all';
  
  document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
  });
  
  async function loadTasks() {
    try {
      const response = await fetch(`/api/companies/${companyId}/routine-tasks`);
      const data = await response.json();
      
      if (data.success) {
        allTasks = data.tasks;
        updateStats();
        displayTasks(currentFilter);
      }
    } catch (error) {
      console.error('Erro ao carregar tarefas:', error);
    }
  }
  
  function updateStats() {
    const stats = {
      overdue: 0,
      in_progress: 0,
      pending: 0,
      completed: 0
    };
    
    allTasks.forEach(task => {
      if (stats[task.status] !== undefined) {
        stats[task.status]++;
      }
    });
    
    document.getElementById('overdueCount').textContent = stats.overdue;
    document.getElementById('inProgressCount').textContent = stats.in_progress;
    document.getElementById('pendingCount').textContent = stats.pending;
    document.getElementById('completedCount').textContent = stats.completed;
  }
  
  function filterTasks(filter) {
    currentFilter = filter;
    
    document.querySelectorAll('.filter-button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    
    displayTasks(filter);
  }
  
  function displayTasks(filter) {
    const container = document.getElementById('tasksContainer');
    
    let tasks = allTasks;
    if (filter !== 'all') {
      tasks = allTasks.filter(task => task.status === filter);
    }
    
    if (tasks.length === 0) {
      container.innerHTML = `
        <div class="empty-tasks">
          <h3>Nenhuma tarefa encontrada</h3>
          <p>N√£o h√° tarefas com este filtro no momento.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = tasks.map(task => {
      const deadline = new Date(task.deadline_date);
      const now = new Date();
      const isOverdue = deadline < now && task.status !== 'completed';
      const isSoon = (deadline - now) < 24 * 60 * 60 * 1000 && task.status !== 'completed';
      
      return `
        <div class="task-item ${task.status}">
          <div class="task-checkbox ${task.status === 'completed' ? 'checked' : ''}" 
               onclick="toggleTaskStatus(${task.id}, '${task.status}')">
          </div>
          
          <div class="task-content">
            <h3 class="task-title">${task.title}</h3>
            ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
            
            <div class="task-meta">
              <div class="task-meta-item">
                üìÖ Agendada: ${formatDate(task.scheduled_date)}
              </div>
              <div class="task-meta-item">
                ‚è∞ Prazo: 
                <span class="task-deadline ${isOverdue ? 'overdue' : isSoon ? 'soon' : ''}">
                  ${formatDate(task.deadline_date)}
                  ${isOverdue ? ' (ATRASADA)' : isSoon ? ' (URGENTE)' : ''}
                </span>
              </div>
              ${task.completed_at ? `
                <div class="task-meta-item">
                  ‚úì Conclu√≠da: ${formatDate(task.completed_at)}
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="task-actions">
            <span class="status-badge ${task.status}">
              ${getStatusLabel(task.status)}
            </span>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function getStatusLabel(status) {
    const labels = {
      'pending': 'Pendente',
      'in_progress': 'Em Andamento',
      'completed': 'Conclu√≠da',
      'overdue': 'Atrasada'
    };
    return labels[status] || status;
  }
  
  async function toggleTaskStatus(taskId, currentStatus) {
    let newStatus;
    
    if (currentStatus === 'completed') {
      newStatus = 'pending';
    } else if (currentStatus === 'pending') {
      newStatus = 'in_progress';
    } else if (currentStatus === 'in_progress') {
      newStatus = 'completed';
    } else {
      newStatus = 'in_progress';
    }
    
    try {
      const response = await fetch(`/api/routine-tasks/${taskId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: newStatus,
          completed_by: 'Usu√°rio'
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        loadTasks();
      } else {
        alert('Erro ao atualizar status: ' + data.error);
      }
    } catch (error) {
      alert('Erro ao atualizar status: ' + error.message);
    }
  }
</script>
{% endblock %}



