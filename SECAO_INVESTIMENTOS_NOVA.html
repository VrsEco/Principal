<!-- ==================== SE√á√ÉO INVESTIMENTOS RECONSTRU√çDA ==================== -->
<!-- Substituir a se√ß√£o atual de Investimentos por esta -->

<article class="finance-card">
  <div class="section-header">
    <h2>üíº Investimentos</h2>
  </div>
  
  <!-- Card de Resumo de Investimentos -->
  <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 12px; padding: 20px; color: white; margin-bottom: 24px;">
    <div style="font-size: 13px; font-weight: 500; opacity: 0.9; margin-bottom: 16px;">
      üìä Investimentos Totais das Estruturas
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
      <!-- Instala√ß√µes -->
      <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Instala√ß√µes</div>
        <div style="font-size: 18px; font-weight: 700;" id="invest-instalacoes-value">R$ 0,00</div>
      </div>
      
      <!-- M√°quinas e Equipamentos -->
      <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">M√°quinas e Equipamentos</div>
        <div style="font-size: 18px; font-weight: 700;" id="invest-maquinas-value">R$ 0,00</div>
      </div>
      
      <!-- Estoques -->
      <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Estoques</div>
        <div style="font-size: 18px; font-weight: 700;" id="invest-estoques-value">R$ 0,00</div>
      </div>
      
      <!-- Caixa -->
      <div style="background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px;">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">Caixa</div>
        <div style="font-size: 18px; font-weight: 700;" id="invest-caixa-value">R$ 0,00</div>
      </div>
      
      <!-- Total -->
      <div style="background: rgba(255, 255, 255, 0.25); border-radius: 8px; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3);">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">üí∞ Total de Investimentos</div>
        <div style="font-size: 18px; font-weight: 700;" id="invest-total-value">R$ 0,00</div>
      </div>
    </div>
    
    <div style="font-size: 11px; opacity: 0.8; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
      ‚ÑπÔ∏è Valores calculados com base nas estruturas cadastradas
    </div>
  </div>
  
  <!-- Planilha de Investimentos por M√™s -->
  <div style="margin-top: 24px;">
    <h3 style="margin: 0 0 16px; color: #0f172a; font-size: 16px;">üìà Distribui√ß√£o por Per√≠odo</h3>
    
    <div style="display: flex; border: 1px solid rgba(148, 163, 184, 0.28); border-radius: 8px; overflow: hidden;">
      <!-- Parte FIXA √† esquerda -->
      <div style="flex-shrink: 0; background: white;">
        <table class="finance-table" style="border: none; margin: 0;">
          <thead>
            <tr>
              <th style="border-left: none; border-top: none; min-width: 180px;">Bloco</th>
              <th style="border-top: none; border-right: none; min-width: 120px;">Total</th>
            </tr>
          </thead>
          <tbody id="invest-table-fixed">
            <tr>
              <td colspan="2" style="text-align: center; padding: 24px; color: #64748b;">
                Carregando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Parte com SCROLL √† direita -->
      <div style="overflow-x: auto; flex-grow: 1; background: #fafafa;">
        <table class="finance-table" style="border: none; margin: 0; width: auto;">
          <thead>
            <tr id="invest-month-headers">
              <!-- Meses ser√£o preenchidos via JavaScript -->
            </tr>
          </thead>
          <tbody id="invest-table-months">
            <tr>
              <td style="text-align: center; padding: 24px; color: #64748b;">
                Carregando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.08); border-radius: 8px; border-left: 3px solid #22c55e;">
    <p style="margin: 0; font-size: 12px; color: #166534; line-height: 1.5;">
      <strong>‚ÑπÔ∏è Valores Autom√°ticos:</strong> Os investimentos s√£o calculados automaticamente com base nos dados cadastrados em 
      <a href="{{ url_for('pev.implantacao_estruturas', plan_id=plan_id) }}" style="color: #059669; text-decoration: underline; font-weight: 600;">Estruturas de Execu√ß√£o</a>.
    </p>
  </div>
</article>

<script>
// ==================== JAVASCRIPT DA SE√á√ÉO INVESTIMENTOS ====================

function renderInvestmentsSection() {
  console.log('[INVEST] Renderizando se√ß√£o de investimentos...');
  console.log('[INVEST] Dados recebidos:', investimentosEstruturasData);
  
  // Definir blocos e seus mapeamentos
  const blocos = [
    { nome: 'Instala√ß√µes', key: 'instalacoes', id: 'instalacoes' },
    { nome: 'M√°quinas e Equipamentos', key: 'maquinas', id: 'maquinas' },
    { nome: 'Outros Investimentos', key: 'outros', id: 'outros' },
    { nome: 'Caixa', key: 'caixa', id: 'caixa' },
    { nome: 'Receb√≠veis', key: 'recebiveis', id: 'recebiveis' },
    { nome: 'Estoques', key: 'estoques', id: 'estoques' }
  ];
  
  // Extrair dados e calcular totais
  let totalGeral = 0;
  const dadosBlocos = [];
  const todosMeses = new Set();
  
  blocos.forEach(bloco => {
    const dados = investimentosEstruturasData[bloco.key] || {total: 0, por_mes: {}};
    const total = parseFloat(dados.total) || 0;
    const porMes = dados.por_mes || {};
    
    totalGeral += total;
    dadosBlocos.push({
      nome: bloco.nome,
      id: bloco.id,
      total: total,
      porMes: porMes
    });
    
    // Coletar todos os meses
    Object.keys(porMes).forEach(mes => todosMeses.add(mes));
  });
  
  // Ordenar meses
  const mesesOrdenados = Array.from(todosMeses).sort();
  
  console.log('[INVEST] Total geral:', totalGeral);
  console.log('[INVEST] Meses encontrados:', mesesOrdenados);
  
  // ========== RENDERIZAR CARDS DE RESUMO ==========
  const formatCurrency = (value) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 2
    }).format(value || 0);
  };
  
  // Atualizar cards individuais
  document.getElementById('invest-instalacoes-value').textContent = 
    formatCurrency(investimentosEstruturasData.instalacoes?.total || 0);
  document.getElementById('invest-maquinas-value').textContent = 
    formatCurrency(investimentosEstruturasData.maquinas?.total || 0);
  document.getElementById('invest-estoques-value').textContent = 
    formatCurrency(investimentosEstruturasData.estoques?.total || 0);
  document.getElementById('invest-caixa-value').textContent = 
    formatCurrency(investimentosEstruturasData.caixa?.total || 0);
  document.getElementById('invest-total-value').textContent = 
    formatCurrency(totalGeral);
  
  // ========== RENDERIZAR PLANILHA ==========
  
  // Headers dos meses (parte com scroll)
  const headerRow = document.getElementById('invest-month-headers');
  if (mesesOrdenados.length === 0) {
    headerRow.innerHTML = '<th style="min-width: 200px;">Sem dados mensais</th>';
  } else {
    headerRow.innerHTML = mesesOrdenados.map(mes => {
      const [ano, mesNum] = mes.split('-');
      const data = new Date(parseInt(ano), parseInt(mesNum) - 1, 1);
      const mesAbrev = data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
      return `<th style="min-width: 100px; text-align: right;">${mesAbrev}</th>`;
    }).join('');
  }
  
  // Linhas da parte fixa (Bloco + Total)
  const tbodyFixed = document.getElementById('invest-table-fixed');
  let htmlFixed = '';
  
  // Linhas da parte com scroll (Valores por m√™s)
  const tbodyMonths = document.getElementById('invest-table-months');
  let htmlMonths = '';
  
  // Linha de TOTAL primeiro
  htmlFixed += '<tr style="background: rgba(59, 130, 246, 0.08); font-weight: 600;">';
  htmlFixed += '<td><strong>TOTAL</strong></td>';
  htmlFixed += `<td style="text-align: right; color: #2563eb;"><strong>${formatCurrency(totalGeral)}</strong></td>`;
  htmlFixed += '</tr>';
  
  htmlMonths += '<tr style="background: rgba(59, 130, 246, 0.08);">';
  if (mesesOrdenados.length === 0) {
    htmlMonths += '<td style="text-align: center;">-</td>';
  } else {
    mesesOrdenados.forEach(mes => {
      const totalMes = dadosBlocos.reduce((sum, bloco) => sum + (parseFloat(bloco.porMes[mes]) || 0), 0);
      htmlMonths += `<td style="text-align: right; font-weight: 600;">${totalMes > 0 ? formatCurrency(totalMes) : '-'}</td>`;
    });
  }
  htmlMonths += '</tr>';
  
  // Linhas de cada bloco
  dadosBlocos.forEach(bloco => {
    if (bloco.total <= 0) return; // Pular blocos sem valor
    
    // Parte fixa
    htmlFixed += '<tr>';
    htmlFixed += `<td>${bloco.nome}</td>`;
    htmlFixed += `<td style="text-align: right; font-weight: 600; color: #059669;">${formatCurrency(bloco.total)}</td>`;
    htmlFixed += '</tr>';
    
    // Parte com scroll
    htmlMonths += '<tr>';
    if (mesesOrdenados.length === 0) {
      htmlMonths += '<td style="text-align: center;">-</td>';
    } else {
      mesesOrdenados.forEach(mes => {
        const valor = parseFloat(bloco.porMes[mes]) || 0;
        htmlMonths += `<td style="text-align: right;">${valor > 0 ? formatCurrency(valor) : '-'}</td>`;
      });
    }
    htmlMonths += '</tr>';
  });
  
  // Se n√£o houver dados, mostrar mensagem
  if (totalGeral === 0) {
    htmlFixed = `
      <tr>
        <td colspan="2" style="text-align: center; padding: 32px; color: #64748b;">
          <div style="font-size: 48px; margin-bottom: 8px;">üì¶</div>
          <div style="font-size: 14px; font-weight: 600;">Nenhum investimento cadastrado</div>
          <div style="font-size: 12px; margin-top: 8px;">
            Cadastre estruturas em <a href="{{ url_for('pev.implantacao_estruturas', plan_id=plan_id) }}" style="color: #3b82f6; text-decoration: underline;">Estruturas de Execu√ß√£o</a>
          </div>
        </td>
      </tr>
    `;
    htmlMonths = '<tr><td style="text-align: center; padding: 32px;">-</td></tr>';
  }
  
  tbodyFixed.innerHTML = htmlFixed;
  tbodyMonths.innerHTML = htmlMonths;
  
  console.log('[OK] Se√ß√£o de investimentos renderizada!');
}

// Chamar ao carregar a p√°gina
if (investimentosEstruturasData) {
  renderInvestmentsSection();
}
</script>

